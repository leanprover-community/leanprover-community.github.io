<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://leanprover-community.github.io//css/lean.css" >
  <link rel="shortcut icon" href="https://leanprover-community.github.io//img/favicon.ico">
  <link rel="search" type="application/opensearchdescription+xml" title="mathlib docs" href="https://leanprover-community.github.io//opensearch.xml">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather&family=Open+Sans&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
    

	<script>
                function buildShortcutsForStructures(names) {
                        const o = {}
                        names.forEach(name => o[name] = `\\mathbb\{${name}\}`)
                        return o
                }
		MathJax = {
			  tex: {
                                  macros: {
                                          ...buildShortcutsForStructures(["R", "Q", "Z", "N", "C"]),
                                  },
				      inlineMath: [['$', '$'], ['\\(', '\\)']]
				    },
		};
	</script>
	<script type="text/javascript" id="MathJax-script" async
		  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
	</script>

	<title>The Lean Github ecosystem</title>
  </head>
  <body>
  <nav class="navbar navbar-expand-lg navbar-light bg-gradient-light d-md-none">
    <div class="d-flex flex-grow-1">
		<a class="navbar-brand" href="https://leanprover-community.github.io/index.html">Lean Community
    </a>
    </div>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  </nav>

<div id="mainbox">

  <main>
    
<h1 id="the-lean-github-ecosystem" class="markdown-heading">The Lean Github ecosystem <a class="hover-link" href="#the-lean-github-ecosystem">#</a></h1>
<p>Documentation of the branches, tags, and CI workflows relevant for making pull requests to Lean, Std, and
Mathlib.</p>
<ul>
<li><a href="#things-you-need-to-know">Things you need to know</a> is relevant for everyone</li>
<li><a href="#tags-and-branches">Tags and branches</a> is for &quot;experts only&quot; who are making or fixing
breaking changes in Lean, or who want to understand the inner workings of Mathlib CI.</li>
</ul>
<h2 id="things-you-need-to-know" class="markdown-heading">Things you need to know <a class="hover-link" href="#things-you-need-to-know">#</a></h2>
<ul>
<li>
<p>If you are making a pull request to <code>leanprover/lean4</code> which may involve breaking changes,
please rebase your PR onto the <code>nightly-with-mathlib</code> branch. This will enable combined CI with Mathlib.</p>
</li>
<li>
<p>If you are making a pull request to <code>leanprover-community/mathlib4</code>,
please ask for &quot;write&quot; access to the repository via the <a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/github.20permission">zulip chat</a>, and push your branch to that repo.
This will enable Mathlib's <code>.olean</code> cache to include your pull request.</p>
</li>
</ul>
<h2 id="tags-and-branches" class="markdown-heading">Tags and branches <a class="hover-link" href="#tags-and-branches">#</a></h2>
<h3 id="leanproverlean4" class="markdown-heading"><code>leanprover/lean4</code> <a class="hover-link" href="#leanproverlean4">#</a></h3>
<ul>
<li>Development occurs on the <code>master</code> branch.</li>
<li>Stable releases and release candidates have tags, e.g. <code>v4.2.0</code> or <code>v4.3.0-rc1</code>.
<ul>
<li>To use one of these releases in a project, your <code>lean-toolchain</code> file should contain e.g. <code>leanprover/lean4:v4.2.0</code>.</li>
</ul>
</li>
<li>Stable releases arrive at the end of each month, and are identical to the last release candidate.</li>
<li>The first release candidate of the next version is released immediately after the stable release.</li>
<li>Each version has a <code>releases/v4.X.0</code> feature branch, which may contain
<ul>
<li>additional commits for release notes</li>
<li>cherry picked commits from <code>master</code> for critical fixes released via release candidates.</li>
</ul>
</li>
<li>We make a regular nightly release from <code>master</code>, which has a tag e.g. <code>nightly-2023-11-01</code> on the
<code>leanprover/lean4-nightly</code> repository.
<ul>
<li>To use a nightly release in a project, your <code>lean-toolchain</code> file should contain e.g. <code>leanprover/lean4:nightly-2023-11-01</code>. (Note that it should not be <code>leanprover/lean4-nightly:nightly-2023-11-01</code>, because <code>elan</code> applies some magic wisdom here.)</li>
</ul>
</li>
<li>There is a <code>nightly</code> branch on <code>leanprover/lean4</code> which follows the most recent commit which was
used to construct a nightly release.</li>
<li>Every PR automatically receives a toolchain after it builds successfully. The PR will then have label <code>toolchain-available</code>.
To use PR #NNNN in a project, your <code>lean-toolchain</code> file should contain
<code>leanprover/lean4-pr-releases:pr-release-NNNN</code>.</li>
<li>For any PR that potentially affects Std or Mathlib, you should base your PR off the HEAD of the <code>nightly-with-mathlib</code> branch.
In that case, a <code>lean-pr-testing-NNNN</code> Mathlib branch is created, described in detail below, and results from this branch are
reported via comments in the PR discussion.</li>
</ul>
<h3 id="leanproverstd4-aka-std" class="markdown-heading"><code>leanprover/std4</code> (aka 'Std') <a class="hover-link" href="#leanproverstd4-aka-std">#</a></h3>
<ul>
<li>Development occurs on <code>main</code>.</li>
<li>Std uses the latest stable release or release candidate in its <code>lean-toolchain</code>.
<ul>
<li>Because we release <code>v4.X+1.0-rc1</code> immediately after releasing <code>v4.X.0</code>,
Std is only very briefly on stable releases.</li>
</ul>
</li>
<li>The first commit on <code>main</code> which uses a new toolchain is tagged with the version number of that
toolchain (e.g. <code>v4.2.0</code>).</li>
<li>There is a branch <code>stable</code> which follows the <code>v4.X.0</code> tags.</li>
<li>Std has a branch <code>bump/v4.X.0</code> for the upcoming stable release of Lean,
<ul>
<li>which contains adaptations for breaking changes that have been approved by the maintainers</li>
<li>and which will be using a <code>leanprover-lean4:nightly-YYYY-MM-DD</code> toolchain.</li>
</ul>
</li>
<li>Std has a branch <code>nightly-testing</code> which
<ul>
<li>uses a recent nightly release (this is updated automatically)</li>
<li>has all commits from <code>main</code> merged into it automatically</li>
<li>may have any changes from <code>bump/v4.X.0</code> merged into it manually</li>
<li>may have any other commits, including unreviewed ones, required to keep the <code>nightly-testing</code>
branch working against recent nightly releases.</li>
</ul>
</li>
<li>Failures in CI on the <code>nightly-testing</code> are reported by a bot to zulip in the private
&quot;Mathlib reviewers&quot; channel.</li>
<li>Success in CI on the <code>nightly-testing</code> branch results in the creation of a tag
<code>nightly-testing-YYYY-MM-DD</code> to match that commit, if this tag does not already exist.
<ul>
<li>Thus if <code>nightly-testing-YYYY-MM-DD</code> exists, we know that on it:
<ul>
<li>the <code>lean-toolchain</code> is <code>leanprover/lean4:nightly-YYYY-MM-DD</code>, and</li>
<li>CI succeeds.</li>
</ul>
</li>
</ul>
</li>
<li>When changes are required to Std to adapt to a breaking change in Lean,
you will need to make a branch, and later open a PR from that branch.
(Note that the steps below happen automatically at Mathlib,
but need to be done manually for Std.)
<ul>
<li>If the change was made in <code>leanprover/lean4#NNNN</code>,
then the Std adaptation branch should be called <code>lean-pr-testing-NNNN</code>.</li>
<li>The Std adaptation branch should be based off the tag <code>nightly-testing-YYYY-MM-DD</code>
where <code>YYYY-MM-DD</code> is the date of the nightly release that your Lean PR is based off.</li>
<li>If the <code>nightly-testing-YYYY-MM-DD</code> tag does not yet exist, you will need to wait
(and possibly move forward to a subsequent nightly).
Contact @semorrison for assistance if needed.</li>
<li>Ideally you will push the <code>lean-pr-testing-NNNN</code> branch to the main Std repository;
we can provide write access if needed.</li>
<li>The <code>lean-toolchain</code> on this branch must contain <code>leanprover/lean4-pr-releases:pr-release-NNNN</code>.</li>
<li>You may open a PR from the <code>lean-pr-testing-NNNN</code> branch, either before or after
making the required adaptations.</li>
<li>When opening the PR, remember to set the base branch to <code>nightly-testing</code>.</li>
<li>Please label the PR with the <code>v4.X.0</code> and 'depends on core changes' labels.
(Or ask for this to be done if you don't have write access.)</li>
<li>Once the Lean PR has been merged and published in a nightly release, the Std adaptation PR
<ul>
<li>should have its <code>lean-toolchain</code> updated to <code>leanprover/lean4:nightly-YYYY-MM-DD</code></li>
<li>its changes may be merged manually into <code>nightly-testing</code> as needed to keep <code>nightly-testing</code>
working (do not change the base and merge the PR, we still need it).</li>
</ul>
</li>
<li>Once the Std adaptation PR has been approved,
a maintainer will merge it into <code>bump/v4.X.0</code> (not <code>nightly-testing-YYYY-MM-DD</code>).</li>
</ul>
</li>
<li>It is always allowed to merge <code>bump/v4.X.0</code> into <code>nightly-testing</code>, but not conversely.
(Changes to <code>bump/v4.X.0</code> have been reviewed, but changes to <code>nightly-testing</code> may not have been.)</li>
<li>When it is time to update Std to a new Lean release,
<em>hopefully</em> all that is required is to make a new PR
consisting of squash merging <code>bump/v4.X.0</code> to <code>main</code>.</li>
</ul>
<h3 id="leanprover-communitymathlib4-aka-mathlib" class="markdown-heading"><code>leanprover-community/mathlib4</code> (aka 'Mathlib') <a class="hover-link" href="#leanprover-communitymathlib4-aka-mathlib">#</a></h3>
<ul>
<li>Everything said above about Std applies to Mathlib, except:
<ul>
<li>Development occurs on <code>master</code>.</li>
<li>All PRs to Mathlib should be made from branches of the Mathlib repository itself.
<ul>
<li>This is required for Mathlib's <code>.olean</code> caching mechanism.</li>
<li>Please ask on the <a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/github.20permission">zulip chat</a> for &quot;write&quot; permission to Mathlib.
Please write a sentence about your background and plans.</li>
</ul>
</li>
</ul>
</li>
<li>The <code>nightly-testing-*</code> tags and <code>bump/v4*</code> branches are write protected,
so may only be modified via PRs, maintainers, or the relevant bots.</li>
<li>Note that the <code>nightly-testing</code> branch of Mathlib may use the <code>nightly-testing</code> branch of Std as required.</li>
<li>Similarly a <code>bump/v4.X.0</code> branch of Mathlib may use the <code>bump/v4.X.0</code> branch of Std as required.</li>
<li>Branches <code>lean-pr-testing-NNNN</code> are automatically created for any Lean PR that passes CI,
and is based off a nightly release. (Unlike for Std, where they must be created manually.)</li>
<li>Mathlib adaptation PRs on <code>lean-pr-testing-NNNN</code> branches may need to change the Std dependency
to use a <code>lean-pr-testing-NNNN</code> branch of Std, if Std also experiences breakages.</li>
</ul>
<h3 id="mathlib-nightly-and-bump-branches" class="markdown-heading">Mathlib nightly and bump branches <a class="hover-link" href="#mathlib-nightly-and-bump-branches">#</a></h3>
<p>Every month there is a new Lean release,
and Mathlib aims to migrate to the new Lean release as soon as possible.
To make this process as smooth as possible, we follow the following procedure:</p>
<ul>
<li>The <code>nightly-testing</code> branch of Mathlib uses the nightly toolchain releases of Lean.
In other words, the <code>lean-toolchain</code> file on that branch contains something like <code>leanprover/lean4:nightly-2024-09-26</code>.
<ul>
<li>This branch is not guaranteed to build without errors.</li>
<li>Change to this branch are not reviewed by the Mathlib maintainer team.</li>
<li>This branch is not protected: anybody can push fixes to it.</li>
<li>The purpose of this branch is to adapt Mathlib to changes in the nightly toolchain releases of Lean.</li>
<li>Typically, a PR <code>#NNNN</code> to Lean core will be accompanied by adaptations to Mathlib in a branch <code>lean-pr-testing-NNNN</code>.
Once the Lean core PR lands in a nightly toolchain, the Mathlib branch <code>lean-pr-testing-NNNN</code> can be merged into <code>nightly-testing</code>.
Often one needs to fix merge conflicts in <code>lean-toolchain</code>, <code>lakefile.lean</code>, and/or <code>lake-manifest.json</code>.</li>
<li>If CI fails on this branch, then it posts a message to <a href="https://leanprover.zulipchat.com/#narrow/stream/428973-nightly-testing/topic/Mathlib.20status.20updates">&quot;nightly-testing &gt; Mathlib status updates&quot;</a> on Zulip, indicating the failure.</li>
<li>If CI passes on this branch, then a message is posted to the same thread, indicating success, and giving instructions to create a PR to review the adaptations. (See below.)</li>
</ul>
</li>
<li>The <code>bump/v4.X.Y</code> branches of Mathlib also use nightly toolchain releases of Lean.
<ul>
<li>This branch should always build without errors.</li>
<li>Changes to this branch are reviewed by the Mathlib maintainer team.</li>
<li>This branch is protected: only Mathlib maintainers and certain bots can push to it.</li>
<li>The purpose of this branch is to prepare a parallel version of Mathlib's <code>master</code> branch that builds on the upcoming version of Lean.
Once that version is released, the <code>bump/v4.X.Y</code> branch is merged into <code>master</code>.
This merge is essentially atomic, since the diff has already been reviewed via all the daily adaptation PRs. (See below.)</li>
</ul>
</li>
<li>When <code>nightly-testing</code> passes CI, a bot posts to Zulip with instructions to create an &quot;adaptation PR&quot; to merge changes on <code>nightly-testing</code> into <code>bump/v4.X.Y</code>.
<ul>
<li>This PR can be prepared using <code>scripts/create-adaptation-pr.sh</code> as indicated in the Zulip message.</li>
<li>This PR should be reviewed by the Mathlib maintainer team.</li>
</ul>
</li>
<li>Over the course of the Lean release cycle (i.e., a month), <code>bump/v4.X.Y</code> accumulates adaptations to the future Lean release.
<ul>
<li>But <code>master</code> also accumulates thousands of lines of changes.</li>
<li>Hence <code>master</code> should be merged into <code>bump/v4.X.Y</code> on a regular basis.</li>
<li>At the time of writing, this step is combined into the <code>scripts/create-adaptation-pr.sh</code> process.</li>
<li>Occasionally, merge conflicts occur. These ought to be reviewed by the Mathlib maintainer team, although that currently does not happen.</li>
</ul>
</li>
</ul>
<h3 id="combined-ci-between-lean-and-mathlib" class="markdown-heading">Combined CI between Lean and Mathlib <a class="hover-link" href="#combined-ci-between-lean-and-mathlib">#</a></h3>
<ul>
<li>For every PR to Lean, we attempt to run Mathlib CI against the resulting toolchain.</li>
<li>For this to work, you will need to rebase your PR onto the <code>nightly-with-mathlib</code> branch.
The <code>nightly-with-mathlib</code> branch points to the latest nightly lean release which passes mathlib CI,
and for which a <code>nightly-testing-YYYY-MM-DD</code> tag exists on Mathlib (and possibly Std).</li>
<li>The bot will create a <code>lean-pr-testing-NNNN</code> branch at Mathlib from the <code>nightly-testing-YYYY-MM-DD</code> tag,
or push an empty commit to it if it already exists.</li>
<li>Subsequent CI results from that Mathlib branch will be reported back to the Lean PR
in the form of comments.</li>
<li>If your PR does not branch off a nightly release for which Mathlib builds, a bot will comment on your
PR.
It will try again whenever you push to your PR.</li>
<li>If <code>nightly-with-mathlib</code> is too old for your purposes, you can base off <code>nightly</code>, and mathlib CI
will commence as soon as that nightly release itself passes the Mathlib CI and you push to the PR.</li>
<li>It may be the case that that nightly release never passes the Mathlib CI. In that case you may have
to wait for <code>nightly-with-mathlib</code> to be updated and rebase onto that.</li>
</ul>
<img src="https://leanprover-community.github.io//img/tags_and_branches.png" alt="Overview of branches at Mathlib/Std" width="80%"/>

  </main>

    <nav id="navbar" class="d-md-block bg-light sidebar collapse navbar-light pb-4">
      <div class="d-none d-md-block mt-4"><a class="navbar-brand" href="https://leanprover-community.github.io/index.html">Lean Community</a></div>
      
        <h6 class="sidebar-heading mt-4">Community</h6>
        <ul class="nav">
          <li class="nav-item col-12"><a href="https://leanprover.zulipchat.com/">Zulip chat</a></li>
        
          <li class="nav-item col-12"><a href="https://github.com/leanprover-community/mathlib4">GitHub</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/blog">Blog</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/meet.html">Community information</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/meet.html#community-guidelines">Community guidelines</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/teams.html">Teams</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/papers.html">Papers about Lean</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/lean_projects.html">Projects using Lean</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/teaching/index.html">Teaching using Lean</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/events.html">Events</a></li>
        </ul>
      
        <h6 class="sidebar-heading mt-4">Use Lean</h6>
        <ul class="nav">
          <li class="nav-item col-12"><a href="https://live.lean-lang.org/">Online version (no installation)</a></li>
        
          <li class="nav-item col-12"><a href="https://docs.lean-lang.org/lean4/doc/quickstart.html">Install Lean</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/get_started.html">More options</a></li>
        </ul>
      
        <h6 class="sidebar-heading mt-4">Documentation</h6>
        <ul class="nav">
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/learn.html">Learning resources (start here)</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/documentation.html">Documentation overview</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/mathlib4_docs">API documentation</a></li>
        
          <li class="nav-item col-12"><a href="https://loogle.lean-lang.org/">Declaration search (Loogle)</a></li>
        
          <li class="nav-item col-12"><a href="https://lean-lang.org/doc/reference/latest/">Language reference</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/mathlib-manual/html-multi/">Tactic list</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/glossary.html">Glossary</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/did_you_prove_it.html">Did you really prove it?</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/mwe.html">About MWEs</a></li>
        </ul>
      
        <h6 class="sidebar-heading mt-4">Library overviews</h6>
        <ul class="nav">
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/mathlib-overview.html">Library overview</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/undergrad.html">Undergraduate maths</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/100.html">Wiedijk's 100 theorems</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/1000.html">1000+ theorems</a></li>
        </ul>
      
        <h6 class="sidebar-heading mt-4">Theories</h6>
        <ul class="nav">
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/theories/naturals.html">Natural Numbers</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/theories/linear_algebra.html">Linear Algebra</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/theories/sets.html">Sets and finite sets</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/theories/topology.html">Topology</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/theories/category_theory.html">Category Theory</a></li>
        </ul>
      
        <h6 class="sidebar-heading mt-4">Contributing</h6>
        <ul class="nav">
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/contribute/index.html">Pull request lifecycle</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/queueboard/">Mathlib review and triage dashboard</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/contribute/git.html">Git Guide for Mathlib4 Contributors</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/contribute/naming.html">Naming conventions</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/contribute/style.html">Code style guideline</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/contribute/doc.html">Documentation style</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/contribute/commit.html">Commit conventions</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/contribute/pr-review.html">Pull request review guide</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/mathlib_stats.html">Contribution statistics</a></li>
        
          <li class="nav-item col-12"><a href="https://leanprover-community.github.io/contribute/tags_and_branches.html">Tags and branches</a></li>
        </ul>
      
    </nav>

</div>


  <nav class="footer navbar navbar-expand-lg navbar-light bg-light justify-content-end">
  <ul class="nav">
    <li class="nav-item">
      <a class="nav-link active" href="https://github.com/leanprover-community/leanprover-community.github.io/blob/lean4/templates/contribute/tags_and_branches.md">Suggest edits to this page on GitHub</a>
    </li>
  </ul>
  </nav>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"></script>
    <script src="https://leanprover-community.github.io//js/bootstrap.min.js"></script>
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      mermaid.initialize({ startOnLoad: true });
    </script>
    
  </body>
</html>