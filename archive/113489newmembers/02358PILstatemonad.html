---
layout: archive
title: Lean Prover Zulip Chat Archive
permalink: archive/113489newmembers/02358PILstatemonad.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113489newmembers/index.html">new members</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html">PIL state monad</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">

{% raw %}
<a name="159607175"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159607175" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159607175">cbailey (Feb 28 2019 at 11:41)</a>:</h4>
<p>Can anyone provide an example of how to properly define an instance of the state monad in Lean? I'm having trouble figuring out how exactly Lean wants it. The examples in Programming in Lean seem to have outdated definitions of read/write and no longer work.</p>

<a name="159608048"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159608048" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159608048">Patrick Massot (Feb 28 2019 at 11:56)</a>:</h4>
<p>What do you mean "define an instance"? <code>state</code> is not a class</p>

<a name="159608055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159608055" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159608055">Patrick Massot (Feb 28 2019 at 11:56)</a>:</h4>
<p>What do you actually want to do?</p>

<a name="159608182"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159608182" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159608182">Patrick Massot (Feb 28 2019 at 11:59)</a>:</h4>
<p>For instance, what is the part of PIL (which is indeed outdated) that you'd like to get to work?</p>

<a name="159609231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159609231" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159609231">Patrick Massot (Feb 28 2019 at 12:17)</a>:</h4>
<p>I just had a quick look at section 7.3 of PIL called "The state monad" and I'm confused because it doesn't seem to use anything, it builds everything from scratch. The equivalent of the example at the end using Lean core library is:</p>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">read_x</span> <span class="o">:</span> <span class="n">state</span> <span class="o">(</span><span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="bp">ℕ</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">return</span> <span class="n">s</span><span class="bp">.</span><span class="mi">1</span>

<span class="n">def</span> <span class="n">read_y</span> <span class="o">:</span> <span class="n">state</span> <span class="o">(</span><span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="bp">ℕ</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">return</span> <span class="n">s</span><span class="bp">.</span><span class="mi">2</span><span class="bp">.</span><span class="mi">1</span>


<span class="n">def</span> <span class="n">read_z</span> <span class="o">:</span> <span class="n">state</span> <span class="o">(</span><span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="bp">ℕ</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">return</span> <span class="n">s</span><span class="bp">.</span><span class="mi">2</span><span class="bp">.</span><span class="mi">2</span>

<span class="n">def</span> <span class="n">write_x</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">state</span> <span class="o">(</span><span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">put</span> <span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">s</span><span class="bp">.</span><span class="mi">2</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="n">s</span><span class="bp">.</span><span class="mi">2</span><span class="bp">.</span><span class="mi">2</span><span class="o">),</span>
   <span class="n">return</span> <span class="o">()</span>

<span class="n">def</span> <span class="n">write_y</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">state</span> <span class="o">(</span><span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">put</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">s</span><span class="bp">.</span><span class="mi">2</span><span class="bp">.</span><span class="mi">2</span><span class="o">),</span>
   <span class="n">return</span> <span class="o">()</span>

<span class="n">def</span> <span class="n">write_z</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">state</span> <span class="o">(</span><span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">put</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="n">s</span><span class="bp">.</span><span class="mi">2</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="n">n</span><span class="o">),</span>
   <span class="n">return</span> <span class="o">()</span>

<span class="n">def</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">state</span> <span class="o">(</span><span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span> <span class="bp">×</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="bp">ℕ</span><span class="o">:=</span>
<span class="n">do</span> <span class="n">write_x</span> <span class="mi">5</span><span class="o">,</span>
   <span class="n">write_y</span> <span class="mi">7</span><span class="o">,</span>
   <span class="n">x</span> <span class="err">←</span> <span class="n">read_x</span><span class="o">,</span>
   <span class="n">write_z</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="mi">3</span><span class="o">),</span>
   <span class="n">y</span> <span class="err">←</span> <span class="n">read_y</span><span class="o">,</span>
   <span class="n">z</span> <span class="err">←</span> <span class="n">read_z</span><span class="o">,</span>
   <span class="n">write_y</span> <span class="o">(</span><span class="n">y</span> <span class="bp">+</span> <span class="n">z</span><span class="o">),</span>
   <span class="n">y</span> <span class="err">←</span> <span class="n">read_y</span><span class="o">,</span>
   <span class="n">return</span> <span class="o">(</span><span class="n">y</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span>

<span class="bp">#</span><span class="n">reduce</span> <span class="n">foo</span><span class="bp">.</span><span class="n">run</span> <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</pre></div>

<a name="159609341"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159609341" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159609341">Patrick Massot (Feb 28 2019 at 12:18)</a>:</h4>
<p>No I'm wrong, it does hide a use of the library <code>state</code> in the middle</p>

<a name="159609450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159609450" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159609450">Patrick Massot (Feb 28 2019 at 12:20)</a>:</h4>
<p>Hold on, I'll update my update</p>

<a name="159609502"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159609502" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159609502">Rob Lewis (Feb 28 2019 at 12:21)</a>:</h4>
<p>For any type <code>σ</code>, <code>state σ</code> is the state monad where the state is of type <code>σ</code>. If <code>m</code> is a monad, <code>state_t σ m</code> is the monad that augments <code>m</code> with additional state. If you define <code>my_monad := state (ℕ × ℕ × ℕ)</code>, you should either make it reducible or explicitly define the monad instance (using <code>state_t.monad</code>).</p>

<a name="159609618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159609618" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159609618">Patrick Massot (Feb 28 2019 at 12:23)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">registers</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">z</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span>

<span class="n">def</span> <span class="n">init_reg</span> <span class="o">:</span> <span class="n">registers</span> <span class="o">:=</span> <span class="n">registers</span><span class="bp">.</span><span class="n">mk</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">reducible</span><span class="o">]</span> <span class="n">def</span> <span class="n">reg_state</span> <span class="o">:=</span> <span class="n">state</span> <span class="n">registers</span>

<span class="n">def</span> <span class="n">read_x</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="bp">ℕ</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span> <span class="n">return</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">x</span> <span class="n">s</span><span class="o">)</span>

<span class="n">def</span> <span class="n">read_y</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="bp">ℕ</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span> <span class="n">return</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">y</span> <span class="n">s</span><span class="o">)</span>

<span class="n">def</span> <span class="n">read_z</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="bp">ℕ</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span> <span class="n">return</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">z</span> <span class="n">s</span><span class="o">)</span>

<span class="n">def</span> <span class="n">write_x</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">put</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">mk</span> <span class="n">n</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">y</span> <span class="n">s</span><span class="o">)</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">z</span> <span class="n">s</span><span class="o">))</span>

<span class="n">def</span> <span class="n">write_y</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">put</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">mk</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">x</span> <span class="n">s</span><span class="o">)</span> <span class="n">n</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">z</span> <span class="n">s</span><span class="o">))</span>

<span class="n">def</span> <span class="n">write_z</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">put</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">mk</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">x</span> <span class="n">s</span><span class="o">)</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">y</span> <span class="n">s</span><span class="o">)</span> <span class="n">n</span><span class="o">)</span>


<span class="n">def</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="bp">ℕ</span><span class="o">:=</span>
<span class="n">do</span> <span class="n">write_x</span> <span class="mi">5</span><span class="o">,</span>
   <span class="n">write_y</span> <span class="mi">7</span><span class="o">,</span>
   <span class="n">x</span> <span class="err">←</span> <span class="n">read_x</span><span class="o">,</span>
   <span class="n">write_z</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="mi">3</span><span class="o">),</span>
   <span class="n">y</span> <span class="err">←</span> <span class="n">read_y</span><span class="o">,</span>
   <span class="n">z</span> <span class="err">←</span> <span class="n">read_z</span><span class="o">,</span>
   <span class="n">write_y</span> <span class="o">(</span><span class="n">y</span> <span class="bp">+</span> <span class="n">z</span><span class="o">),</span>
   <span class="n">y</span> <span class="err">←</span> <span class="n">read_y</span><span class="o">,</span>
   <span class="n">return</span> <span class="o">(</span><span class="n">y</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span>

<span class="bp">#</span><span class="n">reduce</span> <span class="n">foo</span><span class="bp">.</span><span class="n">run</span> <span class="o">(</span> <span class="n">registers</span><span class="bp">.</span><span class="n">mk</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="o">)</span>
</pre></div>

<a name="159609694"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159609694" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159609694">Patrick Massot (Feb 28 2019 at 12:24)</a>:</h4>
<p>This is the updated example. Basically <code>read</code> was renamed <code>get</code> and <code>write</code> was renamed <code>put</code></p>

<a name="159609739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159609739" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159609739">Patrick Massot (Feb 28 2019 at 12:25)</a>:</h4>
<p>Note that you can also replace all those explicit calls to <code>register.mk</code> by the angle bracket anonymous constructor notation</p>

<a name="159609859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159609859" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159609859">Patrick Massot (Feb 28 2019 at 12:26)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">registers</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">z</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span>

<span class="n">def</span> <span class="n">init_reg</span> <span class="o">:</span> <span class="n">registers</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="bp">⟩</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">reducible</span><span class="o">]</span> <span class="n">def</span> <span class="n">reg_state</span> <span class="o">:=</span> <span class="n">state</span> <span class="n">registers</span>

<span class="n">def</span> <span class="n">read_x</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="bp">ℕ</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span> <span class="n">return</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">x</span> <span class="n">s</span><span class="o">)</span>

<span class="n">def</span> <span class="n">read_y</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="bp">ℕ</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span> <span class="n">return</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">y</span> <span class="n">s</span><span class="o">)</span>

<span class="n">def</span> <span class="n">read_z</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="bp">ℕ</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span> <span class="n">return</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">z</span> <span class="n">s</span><span class="o">)</span>

<span class="n">def</span> <span class="n">write_x</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">put</span> <span class="bp">⟨</span><span class="n">n</span><span class="o">,</span> <span class="n">registers</span><span class="bp">.</span><span class="n">y</span> <span class="n">s</span><span class="o">,</span> <span class="n">registers</span><span class="bp">.</span><span class="n">z</span> <span class="n">s</span><span class="bp">⟩</span>

<span class="n">def</span> <span class="n">write_y</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">put</span> <span class="bp">⟨</span><span class="n">registers</span><span class="bp">.</span><span class="n">x</span> <span class="n">s</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">registers</span><span class="bp">.</span><span class="n">z</span> <span class="n">s</span><span class="bp">⟩</span>

<span class="n">def</span> <span class="n">write_z</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span>
   <span class="n">put</span> <span class="bp">⟨</span><span class="n">registers</span><span class="bp">.</span><span class="n">x</span> <span class="n">s</span><span class="o">,</span> <span class="n">registers</span><span class="bp">.</span><span class="n">y</span> <span class="n">s</span><span class="o">,</span> <span class="n">n</span><span class="bp">⟩</span>


<span class="n">def</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="bp">ℕ</span><span class="o">:=</span>
<span class="n">do</span> <span class="n">write_x</span> <span class="mi">5</span><span class="o">,</span>
   <span class="n">write_y</span> <span class="mi">7</span><span class="o">,</span>
   <span class="n">x</span> <span class="err">←</span> <span class="n">read_x</span><span class="o">,</span>
   <span class="n">write_z</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="mi">3</span><span class="o">),</span>
   <span class="n">y</span> <span class="err">←</span> <span class="n">read_y</span><span class="o">,</span>
   <span class="n">z</span> <span class="err">←</span> <span class="n">read_z</span><span class="o">,</span>
   <span class="n">write_y</span> <span class="o">(</span><span class="n">y</span> <span class="bp">+</span> <span class="n">z</span><span class="o">),</span>
   <span class="n">y</span> <span class="err">←</span> <span class="n">read_y</span><span class="o">,</span>
   <span class="n">return</span> <span class="o">(</span><span class="n">y</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span>

<span class="bp">#</span><span class="n">reduce</span> <span class="n">foo</span><span class="bp">.</span><span class="n">run</span> <span class="n">init_reg</span>
</pre></div>

<a name="159609951"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159609951" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159609951">cbailey (Feb 28 2019 at 12:28)</a>:</h4>
<p>Ah, that's a huge help, thank you. I guess 'the idiomatic way of defining a monad for (s -&gt; (a x s))' is the goal. I spent a bunch of time trying to create a state_t instance and when I eventually satisfied it, I got 'state_t is not a class' which was unfortunate.</p>

<a name="159610014"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159610014" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159610014">cbailey (Feb 28 2019 at 12:29)</a>:</h4>
<p>The error from the renaming of 'read' and 'get' is what originally sent me down the rabbit hole.</p>

<a name="159610866"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159610866" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159610866">Kevin Buzzard (Feb 28 2019 at 12:44)</a>:</h4>
<p>Yes, unfortunately Programming In Lean needs a major update so that the code actually runs in Lean 3.4.2. I would imagine that PR's fixing chunks of it would be welcome! (but I can't remember where the repo is :-/ )</p>

<a name="159611116"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159611116" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159611116">Patrick Massot (Feb 28 2019 at 12:48)</a>:</h4>
<p>Simon and Jerery are working on it</p>

<a name="159611308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159611308" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159611308">cbailey (Feb 28 2019 at 12:51)</a>:</h4>
<p>The github page for PIL 404s and it's not listed on the lean website anymore <span aria-label="working on it" class="emoji emoji-1f6e0" role="img" title="working on it">:working_on_it:</span></p>

<a name="159622765"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159622765" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159622765">Mario Carneiro (Feb 28 2019 at 15:21)</a>:</h4>
<p><a href="https://github.com/avigad/programming_in_lean" target="_blank" title="https://github.com/avigad/programming_in_lean">https://github.com/avigad/programming_in_lean</a></p>

<a name="159622859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159622859" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159622859">Mario Carneiro (Feb 28 2019 at 15:22)</a>:</h4>
<p>it got relocated approximately the same time as mathlib's relocation</p>

<a name="159654663"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159654663" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159654663">cbailey (Feb 28 2019 at 21:38)</a>:</h4>
<p>Thanks! I made a pull request with the changes suggested by <span class="user-mention" data-user-id="110031">@Patrick Massot</span></p>

<a name="159655053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159655053" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159655053">Koundinya Vajjha (Feb 28 2019 at 21:43)</a>:</h4>
<p><span class="user-mention" data-user-id="126632">@cbailey</span>  could you link your PR? I am interested in seeing this</p>

<a name="159687305"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159687305" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159687305">cbailey (Mar 01 2019 at 08:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116448">@Koundinya Vajjha</span>  <a href="https://github.com/avigad/programming_in_lean/pull/1#issue-257237337" target="_blank" title="https://github.com/avigad/programming_in_lean/pull/1#issue-257237337">https://github.com/avigad/programming_in_lean/pull/1#issue-257237337</a></p>

<a name="159700829"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159700829" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159700829">cbailey (Mar 01 2019 at 11:02)</a>:</h4>
<p>Sorry to resurrect this, but is there any particular reason why the registers example fails to evaluate when nat is replaced with string or char? Reduced example:</p>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">registers</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">string</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">string</span><span class="o">)</span> <span class="o">(</span><span class="n">z</span> <span class="o">:</span> <span class="n">string</span><span class="o">)</span>

<span class="n">def</span> <span class="n">init_reg</span> <span class="o">:</span> <span class="n">registers</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="s2">&quot;a&quot;</span><span class="o">,</span> <span class="s2">&quot;b&quot;</span><span class="o">,</span> <span class="s2">&quot;c&quot;</span><span class="bp">⟩</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">reducible</span><span class="o">]</span> <span class="n">def</span> <span class="n">reg_state</span> <span class="o">:=</span> <span class="n">state</span> <span class="n">registers</span>

<span class="n">def</span> <span class="n">read_x</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="n">string</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span> <span class="n">return</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">x</span> <span class="n">s</span><span class="o">)</span>

<span class="n">def</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="n">string</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">read_x</span><span class="o">,</span>
       <span class="n">return</span> <span class="n">s</span>

<span class="bp">#</span><span class="n">reduce</span> <span class="n">foo</span><span class="bp">.</span><span class="n">run</span> <span class="n">init_reg</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">excessive memory consumption detected at &#39;replace&#39; (potential solution: increase memory consumption threshold)</span>
<span class="cm">-/</span>
</pre></div>

<a name="159704392"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159704392" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159704392">Rob Lewis (Mar 01 2019 at 11:46)</a>:</h4>
<p>Yes, <code>#reduce</code> means kernel normalization. Chars (and thus strings) include proofs of inequalities over <code>nat</code>, reducing them produces huge proof terms. You should use <code>#eval</code> instead (and you'll need to make a <code>has_repr</code> instance for <code>registers</code>).</p>

<a name="159720169"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159720169" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159720169">cbailey (Mar 01 2019 at 14:55)</a>:</h4>
<p>I see, thank you. Is that because of the field on character structs showing that their value is in the correct character id range? I still had quite a struggle getting it to work; I had to import <a href="http://system.io" target="_blank" title="http://system.io">system.io</a> and define a reader from id (string × registers) to io unit to finally get #eval to display it properly. </p>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">rho</span> <span class="o">:</span> <span class="o">(</span><span class="n">string</span> <span class="bp">×</span> <span class="n">registers</span><span class="o">)</span> <span class="bp">→</span> <span class="n">io</span> <span class="n">unit</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="n">put_str</span> <span class="o">(</span><span class="n">repr</span> <span class="n">b</span><span class="o">)</span>

<span class="n">def</span> <span class="n">reg_reader</span> <span class="o">:=</span> <span class="n">reader_t</span><span class="bp">.</span><span class="n">mk</span> <span class="n">rho</span>

<span class="bp">#</span><span class="kn">eval</span> <span class="o">(</span><span class="n">reg_reader</span><span class="bp">.</span><span class="n">run</span> <span class="o">(</span><span class="n">foo</span><span class="bp">.</span><span class="n">run</span> <span class="n">init_reg</span><span class="o">))</span>
</pre></div>

<a name="159723456"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159723456" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159723456">Rob Lewis (Mar 01 2019 at 15:33)</a>:</h4>
<p>Yes, that's why. If you reduce <code>char.val a</code>, you're asking Lean to normalize a proof that <code>97 &lt; 55296</code>, which is approximately 55200 nested applications.</p>

<a name="159723567"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159723567" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159723567">Rob Lewis (Mar 01 2019 at 15:34)</a>:</h4>
<p>There's definitely no need to touch io. In this case, there's an annoying hiccup with <code>id</code> not reducing, but it's not bad.</p>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">registers</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">string</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">string</span><span class="o">)</span> <span class="o">(</span><span class="n">z</span> <span class="o">:</span> <span class="n">string</span><span class="o">)</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_repr</span> <span class="n">registers</span> <span class="o">:=</span>
<span class="bp">⟨λ</span> <span class="n">r</span><span class="o">,</span> <span class="s2">&quot;⟨&quot;</span> <span class="bp">++</span> <span class="n">r</span><span class="bp">.</span><span class="n">x</span> <span class="bp">++</span> <span class="s2">&quot;, &quot;</span> <span class="bp">++</span> <span class="n">r</span><span class="bp">.</span><span class="n">y</span> <span class="bp">++</span> <span class="s2">&quot;, &quot;</span> <span class="bp">++</span> <span class="n">r</span><span class="bp">.</span><span class="n">z</span> <span class="bp">++</span> <span class="s2">&quot;⟩&quot;</span><span class="bp">⟩</span>

<span class="kn">instance</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">has_repr</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_repr</span> <span class="o">(</span><span class="n">id</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">dsimp</span><span class="bp">;</span> <span class="n">apply_instance</span>

<span class="n">def</span> <span class="n">init_reg</span> <span class="o">:</span> <span class="n">registers</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="s2">&quot;a&quot;</span><span class="o">,</span> <span class="s2">&quot;b&quot;</span><span class="o">,</span> <span class="s2">&quot;c&quot;</span><span class="bp">⟩</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">reducible</span><span class="o">]</span> <span class="n">def</span> <span class="n">reg_state</span> <span class="o">:=</span> <span class="n">state</span> <span class="n">registers</span>

<span class="n">def</span> <span class="n">read_x</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="n">string</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">get</span><span class="o">,</span> <span class="n">return</span> <span class="o">(</span><span class="n">registers</span><span class="bp">.</span><span class="n">x</span> <span class="n">s</span><span class="o">)</span>

<span class="n">def</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">reg_state</span> <span class="n">string</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">s</span> <span class="err">←</span> <span class="n">read_x</span><span class="o">,</span>
       <span class="n">return</span> <span class="n">s</span>

<span class="bp">#</span><span class="kn">eval</span> <span class="n">foo</span><span class="bp">.</span><span class="n">run</span> <span class="n">init_reg</span>
</pre></div>

<a name="159725437"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159725437" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159725437">cbailey (Mar 01 2019 at 16:00)</a>:</h4>
<p>Ah yeah, that's definitely a better way of doing it. Is there any reason for using Type* instead of just Type in the instance declaration?</p>

<a name="159725955"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/PIL%20state%20monad/near/159725955" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/02358PILstatemonad.html#159725955">Rob Lewis (Mar 01 2019 at 16:08)</a>:</h4>
<p>It's more general and it doesn't hurt, that's all.</p>


{% endraw %}

{% include archive_update.html %}