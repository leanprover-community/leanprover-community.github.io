---
layout: archive
title: Lean Prover Zulip Chat Archive 
permalink: archive/113489newmembers/76608Castweirdness.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113489newmembers/index.html">new members</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113489newmembers/76608Castweirdness.html">Cast weirdness</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">
{% raw %}
<a name="161236689"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Cast%20weirdness/near/161236689" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/76608Castweirdness.html#161236689">Neil Strickland (Mar 20 2019 at 11:27)</a>:</h4>
<p>Can anyone help me to understand what is going on here?</p>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">L</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">≥</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="k">begin</span>
 <span class="k">have</span> <span class="n">h0</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">=</span> <span class="n">n</span><span class="bp">.</span><span class="n">nat_abs</span> <span class="o">:=</span> <span class="n">int</span><span class="bp">.</span><span class="n">eq_nat_abs_of_zero_le</span> <span class="n">p</span><span class="o">,</span>
 <span class="k">have</span> <span class="n">h1</span> <span class="o">:</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">((</span><span class="mi">1</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:=</span> <span class="n">dec_trivial</span><span class="o">,</span>
 <span class="n">rw</span><span class="o">[</span><span class="n">h0</span><span class="o">,</span><span class="n">h1</span><span class="o">]</span> <span class="n">at</span> <span class="n">q</span><span class="o">,</span>  <span class="c1">-- Now q : ↑(int.nat_abs n) &lt; ↑1</span>
 <span class="k">have</span> <span class="n">h2</span> <span class="o">:</span> <span class="n">n</span><span class="bp">.</span><span class="n">nat_abs</span> <span class="bp">&lt;</span> <span class="mi">1</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">@</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_lt</span> <span class="bp">ℤ</span> <span class="bp">_</span> <span class="n">n</span><span class="bp">.</span><span class="n">nat_abs</span> <span class="mi">1</span><span class="o">)</span><span class="bp">.</span><span class="n">mp</span> <span class="n">q</span><span class="o">,</span>
<span class="kn">end</span>
</pre></div>


<p>Lean rejects <code>h2</code> with a type mismatch error.  It says that <code>q</code> has the following type:</p>
<div class="codehilite"><pre><span></span>  <span class="bp">@</span><span class="n">has_lt</span><span class="bp">.</span><span class="n">lt</span> <span class="n">int</span> <span class="n">int</span><span class="bp">.</span><span class="n">has_lt</span> <span class="o">(</span><span class="bp">@</span><span class="n">coe</span> <span class="n">nat</span> <span class="n">int</span> <span class="o">(</span><span class="bp">@</span><span class="n">coe_to_lift</span> <span class="n">nat</span> <span class="n">int</span> <span class="o">(</span><span class="bp">@</span><span class="n">coe_base</span> <span class="n">nat</span> <span class="n">int</span> <span class="n">int</span><span class="bp">.</span><span class="n">has_coe</span><span class="o">))</span> <span class="o">(</span><span class="n">int</span><span class="bp">.</span><span class="n">nat_abs</span> <span class="n">n</span><span class="o">))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">coe</span> <span class="n">nat</span> <span class="n">int</span> <span class="o">(</span><span class="bp">@</span><span class="n">coe_to_lift</span> <span class="n">nat</span> <span class="n">int</span> <span class="o">(</span><span class="bp">@</span><span class="n">coe_base</span> <span class="n">nat</span> <span class="n">int</span> <span class="n">int</span><span class="bp">.</span><span class="n">has_coe</span><span class="o">))</span> <span class="mi">1</span><span class="o">)</span>
</pre></div>


<p>This seems sensible.  However, it says that <code>q</code> is expected to have a different type, the description of which takes 70 lines or so.  The difference seems to involve some kind of issue with typeclass inference and possibly different coercion functions, but I have not been able to understand this properly.  I have tried a number of other syntax variants without any more success.</p>

<a name="161237321"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Cast%20weirdness/near/161237321" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/76608Castweirdness.html#161237321">Mario Carneiro (Mar 20 2019 at 11:35)</a>:</h4>
<p>The coercion <code>nat -&gt; int</code> is not a specialization of the generic coercion <code>nat -&gt; A</code>, so it has its own theorems</p>

<a name="161237408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Cast%20weirdness/near/161237408" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/76608Castweirdness.html#161237408">Mario Carneiro (Mar 20 2019 at 11:36)</a>:</h4>
<p>I think this one is <code>int.coe_nat_lt</code></p>

<a name="161237746"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Cast%20weirdness/near/161237746" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/76608Castweirdness.html#161237746">Kevin Buzzard (Mar 20 2019 at 11:41)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/blob/master/docs/extras/casts.md" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/master/docs/extras/casts.md">https://github.com/leanprover-community/mathlib/blob/master/docs/extras/casts.md</a></p>
<p>Witness the asymmetry with nat -&gt; int e.g.</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">complex</span><span class="bp">.</span><span class="n">basic</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">3</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="bp">→</span> <span class="n">q</span> <span class="bp">=</span> <span class="mi">3</span> <span class="o">:=</span> <span class="n">int</span><span class="bp">.</span><span class="n">of_nat_inj</span>
<span class="kn">example</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℚ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">3</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="bp">→</span> <span class="n">q</span> <span class="bp">=</span> <span class="mi">3</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">cast_inj</span><span class="bp">.</span><span class="mi">1</span>
<span class="kn">example</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">3</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="bp">→</span> <span class="n">q</span> <span class="bp">=</span> <span class="mi">3</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">cast_inj</span><span class="bp">.</span><span class="mi">1</span>
<span class="kn">example</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℂ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">3</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="bp">→</span> <span class="n">q</span> <span class="bp">=</span> <span class="mi">3</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">cast_inj</span><span class="bp">.</span><span class="mi">1</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℚ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">3</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="bp">→</span> <span class="n">q</span> <span class="bp">=</span> <span class="mi">3</span> <span class="o">:=</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_inj</span><span class="bp">.</span><span class="mi">1</span>
<span class="kn">example</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">3</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="bp">→</span> <span class="n">q</span> <span class="bp">=</span> <span class="mi">3</span> <span class="o">:=</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_inj</span><span class="bp">.</span><span class="mi">1</span>
<span class="kn">example</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℂ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">3</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="bp">→</span> <span class="n">q</span> <span class="bp">=</span> <span class="mi">3</span> <span class="o">:=</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_inj</span><span class="bp">.</span><span class="mi">1</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℚ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">3</span> <span class="o">:</span> <span class="n">ℚ</span><span class="o">)</span> <span class="bp">→</span> <span class="n">q</span> <span class="bp">=</span> <span class="mi">3</span> <span class="o">:=</span> <span class="n">rat</span><span class="bp">.</span><span class="n">cast_inj</span><span class="bp">.</span><span class="mi">1</span>
<span class="kn">example</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℚ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℂ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">3</span> <span class="o">:</span> <span class="n">ℚ</span><span class="o">)</span> <span class="bp">→</span> <span class="n">q</span> <span class="bp">=</span> <span class="mi">3</span> <span class="o">:=</span> <span class="n">rat</span><span class="bp">.</span><span class="n">cast_inj</span><span class="bp">.</span><span class="mi">1</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">ℂ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">3</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">→</span> <span class="n">q</span> <span class="bp">=</span> <span class="mi">3</span> <span class="o">:=</span> <span class="n">complex</span><span class="bp">.</span><span class="n">of_real_inj</span><span class="bp">.</span><span class="mi">1</span>
</pre></div>


<p>The problem is that one of the constructors of int is <code>int.of_nat</code> and so for reasons apparently to do with efficiency they use it as the coercion. Given that "efficiency" and "definition of nat" together imply an immediate contradiction, I've never seen the logic -- but then again IANACS...</p>

<a name="161237831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Cast%20weirdness/near/161237831" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/76608Castweirdness.html#161237831">Mario Carneiro (Mar 20 2019 at 11:42)</a>:</h4>
<p>note that <code>nat</code> is actually the most efficient VM natural numbers type, because of native support</p>

<a name="161237838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Cast%20weirdness/near/161237838" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/76608Castweirdness.html#161237838">Neil Strickland (Mar 20 2019 at 11:42)</a>:</h4>
<p>Thanks.  I now see that it also works to rewrite with <code>int.nat_cast_eq_coe_nat</code> at an appropriate point.</p>

<a name="161238505"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Cast%20weirdness/near/161238505" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/76608Castweirdness.html#161238505">Kevin Buzzard (Mar 20 2019 at 11:52)</a>:</h4>
<p>Just in case you didn't know:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">linarith</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">≥</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">linarith</span>
</pre></div>


{% endraw %}
