---
layout: archive
title: Lean Prover Zulip Chat Archive 
permalink: archive/144837PRreviews/84759766cacheolean.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/144837PRreviews/index.html">PR reviews</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html">#766 cache-olean</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">
{% raw %}
<a name="161835113"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161835113" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161835113">Scott Morrison (Mar 27 2019 at 07:23)</a>:</h4>
<p><span class="user-mention" data-user-id="110026">@Simon Hudon</span>, what is the reasoning for not storing the cache in <code>cache-olean --build</code> when the build fails? Surely many people often spend a long time working on a branch that is failing, before everything comes good.</p>

<a name="161836179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161836179" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161836179">Kevin Buzzard (Mar 27 2019 at 07:46)</a>:</h4>
<p>Why is it Simon's job to store stuff that the community in general is not interested in?</p>

<a name="161836200"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161836200" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161836200">Mario Carneiro (Mar 27 2019 at 07:47)</a>:</h4>
<p>I think <code>cache-olean</code> stores stuff locally</p>

<a name="161851231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161851231" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161851231">Simon Hudon (Mar 27 2019 at 11:48)</a>:</h4>
<p><span class="user-mention" data-user-id="110087">@Scott Morrison</span> I think you're right. We could change that. I'm wondering if we could also store the cache when the user interrupts the build (e.g. with <code>ctrl+C</code>) but I'm not sure if there's a way to do that.</p>

<a name="161851396"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161851396" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161851396">Johan Commelin (Mar 27 2019 at 11:50)</a>:</h4>
<p>We would you need that second feature?</p>

<a name="161851404"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161851404" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161851404">Johan Commelin (Mar 27 2019 at 11:50)</a>:</h4>
<p>Lean will pick up from where you stopped, right?</p>

<a name="161852041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161852041" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161852041">Simon Hudon (Mar 27 2019 at 12:00)</a>:</h4>
<p>That's right</p>

<a name="161892737"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161892737" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161892737">Scott Morrison (Mar 27 2019 at 19:28)</a>:</h4>
<p>at least on OS X this happens already; the first ctrl-C stops the build, but python continues.</p>

<a name="161899616"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161899616" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161899616">Scott Morrison (Mar 27 2019 at 20:54)</a>:</h4>
<p>Okay, we now store the cache even when the build fails (or is cancelled by ctrl-c).</p>

<a name="161899623"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161899623" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161899623">Scott Morrison (Mar 27 2019 at 20:54)</a>:</h4>
<p>I'm pretty happy with this now. I need to write some docs.</p>

<a name="161899667"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161899667" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161899667">Scott Morrison (Mar 27 2019 at 20:55)</a>:</h4>
<p>I would also like --fetch to work more often. :-) If travis has seen that commit, there could be a cached copy of the oleans!</p>

<a name="161899732"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161899732" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161899732">Scott Morrison (Mar 27 2019 at 20:56)</a>:</h4>
<p>I might also try writing <code>--list</code>, which shows the status of the cache for each local branch. But I won't hold up the PR to do that.</p>

<a name="161900277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161900277" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161900277">Patrick Massot (Mar 27 2019 at 21:03)</a>:</h4>
<p>Of course we would like cached olean for everything that Travis once compiled. It would help PR reviewing a lot (at least for me). For instance I compiled the convexity PR (but haven't found time to carefully look at it). But there are storage issues. GitHub won't let us store infinitely many releases</p>

<a name="161901566"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161901566" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161901566">Scott Morrison (Mar 27 2019 at 21:21)</a>:</h4>
<p>If storage is the only requirement, I have a server that we could use. I'm not concerned about storage or bandwidth, and I'd be happy to allow uploads in some moderately controlled fashion.</p>

<a name="161901575"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161901575" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161901575">Scott Morrison (Mar 27 2019 at 21:21)</a>:</h4>
<p>For cached oleans, high reliability is not necessary.</p>

<a name="161905664"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161905664" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161905664">Simon Hudon (Mar 27 2019 at 22:23)</a>:</h4>
<p>That would be nice. We can get Travis to upload the cache then and decide to delete caches older than 1 or 2 months</p>

<a name="161925977"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161925977" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161925977">Scott Morrison (Mar 28 2019 at 05:48)</a>:</h4>
<p>maybe the right approach is to not directly upload to my server, which sounds hard to manage, security wise</p>

<a name="161926005"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161926005" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161926005">Scott Morrison (Mar 28 2019 at 05:50)</a>:</h4>
<p>Instead perhaps we could have travis post everything it builds somewhere (along with the olean artifacts from master?) but deleting them after a few days. I can then have my machine poll that supply of caches, and copy them to a publicly accessible location, where it can store them for much longer.</p>

<a name="161926060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161926060" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161926060">Scott Morrison (Mar 28 2019 at 05:50)</a>:</h4>
<p>I can certainly set up the "scrape the following webpage for artifacts, post them online" step, if someone else, presumably <span class="user-mention" data-user-id="110026">@Simon Hudon</span> could handle the travis part.</p>

<a name="161926279"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161926279" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161926279">Scott Morrison (Mar 28 2019 at 05:57)</a>:</h4>
<p>Another issue we need to fix with this PR eventually: hitting Ctrl-C can break the cache, and result in ... crap all over your repository :-) I'm not a python ninja, but <a href="https://stackoverflow.com/questions/842557/how-to-prevent-a-block-of-code-from-being-interrupted-by-keyboardinterrupt-in-py" target="_blank" title="https://stackoverflow.com/questions/842557/how-to-prevent-a-block-of-code-from-being-interrupted-by-keyboardinterrupt-in-py">https://stackoverflow.com/questions/842557/how-to-prevent-a-block-of-code-from-being-interrupted-by-keyboardinterrupt-in-py</a> seems to have some solutions.</p>

<a name="161937168"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/161937168" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#161937168">Scott Morrison (Mar 28 2019 at 09:53)</a>:</h4>
<p>cf <a href="https://github.com/leanprover-community/mathlib/issues/857" target="_blank" title="https://github.com/leanprover-community/mathlib/issues/857">#857</a> and <a href="https://github.com/leanprover-community/mathlib/issues/858" target="_blank" title="https://github.com/leanprover-community/mathlib/issues/858">#858</a> for some improvements</p>

<a name="162155722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162155722" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162155722">Scott Morrison (Mar 31 2019 at 04:39)</a>:</h4>
<p><span class="user-mention" data-user-id="110026">@Simon Hudon</span>, we still have some problems... The post-checkout hooks is working great when I work solely on the commandline, but I often also change branches from VS Code, or from Sourcetree.</p>
<p>Changing branches from VS Code seems to work fine (although if you don't restart the server VS Code gets unhappy --- can we add a hook to prompt restarting the server anytime the olean cache is restored??)</p>

<a name="162155727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162155727" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162155727">Scott Morrison (Mar 31 2019 at 04:39)</a>:</h4>
<p>However changing branches from sourcetree, the post-checkout hook is not being called.</p>

<a name="162156035"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162156035" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162156035">Scott Morrison (Mar 31 2019 at 04:48)</a>:</h4>
<p>The problem is just one I'd seen before --- the environment git is run in from sourcetree doesn't know how to find python3, so our scripts can't run.</p>

<a name="162156433"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162156433" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162156433">Scott Morrison (Mar 31 2019 at 04:59)</a>:</h4>
<p>Okay... it seems that Sourcetree <a href="https://community.atlassian.com/t5/Bitbucket-questions/SourceTree-Hook-failing-because-paths-don-t-seem-to-be-set/qaq-p/274792" target="_blank" title="https://community.atlassian.com/t5/Bitbucket-questions/SourceTree-Hook-failing-because-paths-don-t-seem-to-be-set/qaq-p/274792">doesn't</a> like to put /usr/local/bin/ on the path, and that's where <code>python3</code> lives. I'm going to put</p>
<div class="codehilite"><pre><span></span>export PATH=/usr/local/bin:$PATH
</pre></div>


<p>in our git hooks.</p>

<a name="162175649"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162175649" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162175649">Simon Hudon (Mar 31 2019 at 13:52)</a>:</h4>
<p>Can we use <code>source ~/.profile</code> instead? Or maybe use <code>env</code>?</p>

<a name="162192030"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162192030" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162192030">Scott Morrison (Mar 31 2019 at 21:07)</a>:</h4>
<p>So <code>env</code> isn't working (precisely because <code>/usr/local/bin/</code> is not on the PATH), and <code>source ~/.profile</code> doesn't work, because it seems that on mac OS a shell usually starts with <code>/usr/local/bin</code> on the PATH already. (I checked <code>env -i bash --norc --noprofile</code>, and it's already there.)</p>

<a name="162192157"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162192157" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162192157">Simon Hudon (Mar 31 2019 at 21:11)</a>:</h4>
<p>what if we only add <code>/usr/local/bin</code> to the path and then invoke <code>env</code>?</p>

<a name="162192212"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162192212" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162192212">Scott Morrison (Mar 31 2019 at 21:12)</a>:</h4>
<p>Somehow sourcetree is doing something dumb, and managing to provide a shell without a OS default path.</p>

<a name="162192213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162192213" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162192213">Scott Morrison (Mar 31 2019 at 21:12)</a>:</h4>
<p>I can try raising a bug with them, but I want this to work in the meantime.</p>

<a name="162192222"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162192222" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162192222">Scott Morrison (Mar 31 2019 at 21:13)</a>:</h4>
<blockquote>
<p>what if we only add /usr/local/bin to the path and then invoke env?</p>
</blockquote>
<p>Isn't this what we're doing?</p>

<a name="162192364"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162192364" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162192364">Simon Hudon (Mar 31 2019 at 21:17)</a>:</h4>
<p>Sorry, I think I saw something else on github. That sounds more reasonable. I was hesitant to put <code>~/.mathlib/bin</code> in the path.</p>

<a name="162197400"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162197400" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162197400">Scott Morrison (Mar 31 2019 at 23:34)</a>:</h4>
<p>err... I think <code>~/.mathlib/bin</code> has been put on the path at the beginning of the hook all along, so we can call <code>cache-olean</code>?</p>

<a name="162197495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162197495" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162197495">Simon Hudon (Mar 31 2019 at 23:37)</a>:</h4>
<p>oh</p>

<a name="162197498"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%23766%20cache-olean/near/162197498" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/144837PRreviews/84759766cacheolean.html#162197498">Simon Hudon (Mar 31 2019 at 23:37)</a>:</h4>
<p>Alright, anything goes then</p>


{% endraw %}
