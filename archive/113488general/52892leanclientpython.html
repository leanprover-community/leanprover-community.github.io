---
layout: archive
title: Lean Prover Zulip Chat Archive
permalink: archive/113488general/52892leanclientpython.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html">lean-client-python</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">

{% raw %}
<a name="194858000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194858000" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194858000">Patrick Massot (Apr 21 2020 at 20:35)</a>:</h4>
<p>There have been several people interested in talking to Lean from python. I needed it for <a href="https://github.com/leanprover-community/format_lean" title="https://github.com/leanprover-community/format_lean">format_lean</a>, <span class="user-mention" data-user-id="236489">@Daniel Donnelly</span>  needed it for his diagram chasing project, <span class="user-mention" data-user-id="115715">@Jason Rute</span> wants it for AI, and <span class="user-mention" data-user-id="251825">@Frédéric Le Roux</span> wants it for teaching. So I decided to give it a slightly more serious shot. The resulting embryo is at <a href="https://github.com/PatrickMassot/lean-client-python" title="https://github.com/PatrickMassot/lean-client-python">https://github.com/PatrickMassot/lean-client-python</a>. The core part comes straight from the TypeScript client <a href="https://github.com/leanprover/lean-client-js/blob/master/lean-client-js-core/src/commands.ts" title="https://github.com/leanprover/lean-client-js/blob/master/lean-client-js-core/src/commands.ts">specification of requests and responses</a>. But this is only the trivial part translating back and forth between JSON and python objects. The tricky part is to handle asynchronous communication with Lean. Here the TypeScript client seems to be able to assume a somewhat uniform solution based on promises. I experimented with two opposite setups: Qt's signal/slot call-back hell and trio's async/await hell. </p>
<p>There are demos of both approaches <a href="https://github.com/PatrickMassot/lean-client-python/tree/master/examples" title="https://github.com/PatrickMassot/lean-client-python/tree/master/examples">in the repository</a>. You can see the Qt thing in animated gif action in <a href="https://github.com/PatrickMassot/lean-client-python/blob/master/README.md" title="https://github.com/PatrickMassot/lean-client-python/blob/master/README.md">the README</a>. The trio demo does something similar to what <code>format_lean</code> needs, except that it's robust enough to avoid launching the Lean server with <code>-j0</code> flag (which asks Lean to use only one thread, hence drastically reducing asynchronicity).</p>
<p>I'll probably port <code>format_lean</code> to use this at some point (but there is no hurry for me). I'll push this only if there is interest from the community. I hope this is already a good starting point for interested people (and it's what I promised Frédéric).</p>

<a name="194859388"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194859388" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194859388">Kevin Buzzard (Apr 21 2020 at 20:48)</a>:</h4>
<p>Are there any good factoring algorithms in python?</p>

<a name="194862118"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194862118" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194862118">Patrick Massot (Apr 21 2020 at 21:10)</a>:</h4>
<p>Factoring what?</p>

<a name="194862149"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194862149" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194862149">Kevin Buzzard (Apr 21 2020 at 21:11)</a>:</h4>
<p>positive integers.</p>

<a name="194862175"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194862175" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194862175">Kevin Buzzard (Apr 21 2020 at 21:11)</a>:</h4>
<p>Get Lean to factor positive integers by asking Python what the answer is and then multiplying them together to check</p>

<a name="194862241"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194862241" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194862241">Kevin Buzzard (Apr 21 2020 at 21:12)</a>:</h4>
<p>I get the impression that Rob let us do this in mathematica once, but then mathematica broke his interface :-(</p>

<a name="194862242"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194862242" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194862242">Patrick Massot (Apr 21 2020 at 21:12)</a>:</h4>
<p>This is a job for Rob's bridge.</p>

<a name="194869934"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194869934" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194869934">Jason Rute (Apr 21 2020 at 22:29)</a>:</h4>
<p><span class="user-mention" data-user-id="110031">@Patrick Massot</span> I'll definitely have to look into this more.  Thanks for creating this!  As you mentioned I've been experimenting with similar things.  Here is <a href="https://github.com/jasonrute/communicating-with-lean/blob/master/communicate_with_lean.ipynb" title="https://github.com/jasonrute/communicating-with-lean/blob/master/communicate_with_lean.ipynb">a Python notebook</a> which uses a simple interface to talk to Lean via Python.  See the <code>LeanServer</code> class.  <a href="https://github.com/jasonrute/lean_info_scrapper" title="https://github.com/jasonrute/lean_info_scrapper">This project</a>, which scrapes all the Lean files for data from the Lean server, uses a slightly modified version of the same <code>LeanServer</code> interface.  It would be great to have prebuilt, documented, and tested Python-Lean-Server interface, so I don't have to roll my own.  Let me mention some observations from my work in case they help.  (This is before I've looked too closely at your project)</p>

<a name="194870071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194870071" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194870071">Jason Rute (Apr 21 2020 at 22:30)</a>:</h4>
<p>As for performance (with the Lean server in my Python code):</p>
<ul>
<li>My simple Lean-Python interface starts up a Lean server, <code>lean --server</code>, and sends it requests.  I block until I get a response for that same request and I save all the other responses in a queue which I process later.  If I'm still waiting on information to come from the server, I will just send a dummy request.</li>
<li>I was hoping for faster speeds for the "sync" requests, but there seems to be a 0.1 second delay (probably a sleep statement somewhere).  That put a bit of a damper on "back-and-forth" applications like sending a tactic to Lean, waiting on the response, and then sending a new tactic to Lean based on that.  Each loop takes 0.1 seconds or more even for trivial syncs.</li>
<li>I never got parallelism working correctly.  If I wanted to sync two (or more) files at the same time, I had wait twice as long (about 0.2 seconds).  Also, if I started syncing a lot of separate filenames, then Lean's memory would blow up.  I either had to start the Lean server for each request (which has a fixed overhead) or I think I could "zero-out" a file by syncing it with an empty string.</li>
</ul>

<a name="194870215"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194870215" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194870215">Jason Rute (Apr 21 2020 at 22:32)</a>:</h4>
<p>As for accuracy and robustness (with the Lean server in my Python code):</p>
<ul>
<li>The information coming out of the server is not always accurate/robust.  It isn't ever "wrong", but it can be missing information.  It is difficult to be sure that "sync" hasn't finished processing (or worse is showing information from a previous "sync" request for the same filename).  As for "info" requests, they usually return the right information, but sometimes for large complicated files, they come back empty when they shouldn't or worse they are missing some but not all of the fields.  Also, sometimes there are multiple levels of information when tactic blocks are stacked and it isn't consistent on which level it shows.  I can give some examples if it helps.</li>
<li>The output of the Lean server wasn't always as helpful as I'd like.  The pretty-printed state (even if I used <code>lean --server -D pp.all=true</code>) would often not be valid Lean code.  I provide a detailed list of problems in the "Current Issues" section of <a href="https://github.com/jasonrute/communicating-with-lean/blob/master/communicate_with_lean.ipynb" title="https://github.com/jasonrute/communicating-with-lean/blob/master/communicate_with_lean.ipynb">the notebook</a>.</li>
</ul>

<a name="194870224"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194870224" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194870224">Jason Rute (Apr 21 2020 at 22:32)</a>:</h4>
<p>Also, I should mention that this isn't the only way to for Lean and Python to communicate.  Lean has an io monad which lets it communicate with external processes on the command line, even Python scripts, and to read/write from stdin/stdout.  I believe, this io monad could even be used (in an unsafe manner) inside a tactic so you could theoretically have a tactic which calls a Python Script.  I'm planning on experimenting with this approach as well.</p>

<a name="194871088"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194871088" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194871088">Jason Rute (Apr 21 2020 at 22:44)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> I think in the case of factoring, you could have a Python (or whatever) script which generates the factoring witnesses (I don't know what witnesses show that a number is prime) and then writes a Lean proof as a text string which can be pasted into Lean.  If I understands Patrick's lean-client, the one additionally thing it would give you is a way to automatically check that your proof is valid in Lean, but you could do that automatically by just writing it to a file and telling Lean to check that file.  (Although, I guess having an open server connection would be faster than starting up Lean from scratch.)</p>

<a name="194883968"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194883968" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194883968">Jason Rute (Apr 22 2020 at 02:59)</a>:</h4>
<p><span class="user-mention" data-user-id="110031">@Patrick Massot</span> two questions:  </p>
<p>In your <code>format_lean</code> project, have you encountered times when the response from the lean server was missing data causing incorrect behavior?  For example, it doesn't return a state even though it should.  If so, how do you correct for it?</p>
<p>In <code>format_lean</code>, where does the async help:</p>
<ol>
<li>Does it speed up the lean server execution time to be able to do tasks in parallel?  (As I said above, that didn't seem to be the case for me.  If i sent two sync commands and waited for them both to return messages.  It would take the same time as if I sent one, waited, and then sent the other.  But I may have only been using one thread and that was the problem.)</li>
<li>Does not blocking save significant wall clock time?  I imagine that most of the processing time of <code>format_lean</code> would be in  getting data from Lean via the server, so that most of the time would be waiting for Lean, even with async, but maybe I am mistaken.</li>
<li>Is it just that it makes interacting with the server more natural? The Lean server has responses directly tied to a request ("ok" responses) and other responses which will appear at unpredictable times (e.g. "all_messages" responses).  As I said above, when I called a request, I would wait for the "ok" response associated with that request and then also record all the other responses into a queue.  If I wanted, say an "all_message" response not directly tied to a request, then I would repeatedly send dummy requests (e.g. "info" requests) waiting for the ok response each time until I got the "all_messages" response.  This is hacky, and possibly the largest advantage of an async framework is to avoid hacks like this.</li>
<li>Does it prevent Lean from returning missing data.  I don't understand how servers like this work, but I noticed that I would get more complete information if I waited 0.1 seconds than say read from stdout immediately.  Somehow the lean server new I was trying to read from it.  Maybe by using async, I avoid prematurely asking Lean for data where it sends me incomplete data.</li>
</ol>

<a name="194911872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194911872" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194911872">Patrick Massot (Apr 22 2020 at 10:20)</a>:</h4>
<p>As I wrote, I haven't ported format_lean to use my brand new lean-client-python. I can still answer a couple of questions. I've played only with sync and info requests, using only the tactic state information in info requests. Info requests do trigger empty responses when Lean is not ready because it's still compiling the file. Those empty responses are <code>CommandResponse</code> containing only the <code>InfoRequest</code>'s <code>seq_num</code> and "ok". In particular I couldn't detect a difference between this situation and situations where Lean simply has nothing to declare, for instance because you asked for information about an empty line outside a tactic proof. If you really want information about a file position, you need to wait until Lean is ready. There is no need to send dummy requests for this, you only need to listen carefully and take action when the time is ripe.</p>

<a name="194912328"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194912328" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194912328">Patrick Massot (Apr 22 2020 at 10:26)</a>:</h4>
<p>Also note that <code>SyncRequest</code> trigger a response long before Lean is done. This response only acknowledge that sync has started.</p>

<a name="194912337"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194912337" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194912337">Patrick Massot (Apr 22 2020 at 10:26)</a>:</h4>
<p>You can skim through <a href="https://github.com/PatrickMassot/lean-client-python/blob/master/src/lean_client/commands.py" title="https://github.com/PatrickMassot/lean-client-python/blob/master/src/lean_client/commands.py">commands.py</a>, but the two relevant files for you are <a href="https://github.com/PatrickMassot/lean-client-python/blob/master/src/lean_client/trio_server.py" title="https://github.com/PatrickMassot/lean-client-python/blob/master/src/lean_client/trio_server.py">trio_server.py</a> and <a href="https://github.com/PatrickMassot/lean-client-python/blob/master/examples/trio_example.py" title="https://github.com/PatrickMassot/lean-client-python/blob/master/examples/trio_example.py">trio_example.py</a>. Those are much easier to read than the Qt files, because they are based on async/await. Forget about the <code>async def </code> vs <code>def</code>, it only says a function will be able to use <code>await</code>. The important part is <code>await</code>. There is no call-back here. Each function executes instruction in the order they are written. But whenever an expression is prefixed with <code>await</code>, python will wait for the answer to become available. While waiting other tasks are allowed to run. There is no multi-thread here, and context switching doesn't happen randomly, only while meeting <code>await</code> or in between iterations of a <code>async for</code> loop.</p>

<a name="194912552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194912552" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194912552">Patrick Massot (Apr 22 2020 at 10:29)</a>:</h4>
<p>The next piece of technology is <code>trio.Event</code>. You can create an event, and then <code>await event.wait()</code> waits for the event to trigger. When it does trigger, you don't fire a call-back, but simply move to the next line.</p>

<a name="194912697"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194912697" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194912697">Patrick Massot (Apr 22 2020 at 10:31)</a>:</h4>
<p>You can already understand the logic in <a href="https://github.com/PatrickMassot/lean-client-python/blob/68f5fcf6c6300c245988415a06262b9fadf8eac8/examples/trio_example.py#L12-L22" title="https://github.com/PatrickMassot/lean-client-python/blob/68f5fcf6c6300c245988415a06262b9fadf8eac8/examples/trio_example.py#L12-L22">those lines</a> which is completely linear. We always wait until information becomes available. During this waiting, we continue to listen to Lean output, without sending dummy requests.</p>

<a name="194913091"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194913091" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194913091">Patrick Massot (Apr 22 2020 at 10:37)</a>:</h4>
<p>The listening loop is at <a href="https://github.com/PatrickMassot/lean-client-python/blob/68f5fcf6c6300c245988415a06262b9fadf8eac8/src/lean_client/trio_server.py#L62-L75" title="https://github.com/PatrickMassot/lean-client-python/blob/68f5fcf6c6300c245988415a06262b9fadf8eac8/src/lean_client/trio_server.py#L62-L75">here</a>. It should be very easy to read once you know that <code>self.is_fully_ready</code> is an <code>Event</code> that you trigger using <code>self.is_fully_ready.set()</code>. After doing that each time a function which is waiting for this signal gets a chance of advancing (because some other task is waiting) it will run past its <code>await self.is_fully_ready.wait()</code>. Similarly every request <a href="https://github.com/PatrickMassot/lean-client-python/blob/68f5fcf6c6300c245988415a06262b9fadf8eac8/src/lean_client/trio_server.py#L49" title="https://github.com/PatrickMassot/lean-client-python/blob/68f5fcf6c6300c245988415a06262b9fadf8eac8/src/lean_client/trio_server.py#L49">creates</a> an event in the <code>self.request_events</code> dictionary, and this event <a href="https://github.com/PatrickMassot/lean-client-python/blob/68f5fcf6c6300c245988415a06262b9fadf8eac8/src/lean_client/trio_server.py#L73-L75" title="https://github.com/PatrickMassot/lean-client-python/blob/68f5fcf6c6300c245988415a06262b9fadf8eac8/src/lean_client/trio_server.py#L73-L75">fires</a> when the listening loop gets the answer (which is also stored in another dictionary indexed by seq_num).</p>

<a name="194913226"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194913226" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194913226">Patrick Massot (Apr 22 2020 at 10:38)</a>:</h4>
<p>I <em>think</em> this is all you need to understand those two files. But don't hesitate to ask question and PR documentation or other improvements (if there <em>are</em> contribution then this repo will probably quickly move to the lean community organization where things will be easier).</p>

<a name="194913806"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194913806" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194913806">Patrick Massot (Apr 22 2020 at 10:47)</a>:</h4>
<p>And of course I'd be very happy to read <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> and <span class="user-mention" data-user-id="123965">@Bryan Gin-ge Chen</span> comments about all this (they understand the TypeScript client).</p>

<a name="194919694"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194919694" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194919694">Gabriel Ebner (Apr 22 2020 at 12:02)</a>:</h4>
<p>I think Patrick explained this well.  One more gotcha you should be aware of is that you cannot execute two <code>info</code> commands in parallel: the second one will cancel the first.</p>

<a name="194921271"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194921271" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194921271">Jason Rute (Apr 22 2020 at 12:18)</a>:</h4>
<p><span class="user-mention" data-user-id="110031">@Patrick Massot</span> As for your <code>trio_example.py</code> code, when I run it it returns nothing.  After turning on debugging, I get this:</p>
<div class="codehilite"><pre><span></span>Sending SyncRequest(file_name=&#39;test.lean&#39;, content=None)
Received CurrentTasksResponse(is_running=False, tasks=[], cur_task=None)
Received CurrentTasksResponse(is_running=False, tasks=[], cur_task=None)
Received CurrentTasksResponse(is_running=False, tasks=[], cur_task=None)
Received CurrentTasksResponse(is_running=False, tasks=[], cur_task=None)
Received CurrentTasksResponse(is_running=False, tasks=[], cur_task=None)
Received CurrentTasksResponse(is_running=False, tasks=[], cur_task=None)
Received CurrentTasksResponse(is_running=False, tasks=[], cur_task=None)
Received CurrentTasksResponse(is_running=False, tasks=[], cur_task=None)
Received CommandResponse(seq_num=1)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=1, column=0)
Received CommandResponse(seq_num=2)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=1, column=39)
Received CommandResponse(seq_num=3)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=2, column=0)
Received CommandResponse(seq_num=4)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=2, column=5)
Received CommandResponse(seq_num=5)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=3, column=0)
Received CommandResponse(seq_num=6)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=3, column=21)
Received CommandResponse(seq_num=7)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=4, column=0)
Received CommandResponse(seq_num=8)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=4, column=22)
Received CommandResponse(seq_num=9)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=5, column=0)
Received CommandResponse(seq_num=10)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=5, column=3)
Received CommandResponse(seq_num=11)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=6, column=0)
Received CommandResponse(seq_num=12)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=6, column=0)
Received CommandResponse(seq_num=13)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=7, column=0)
Received CommandResponse(seq_num=14)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=7, column=36)
Received CommandResponse(seq_num=15)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=8, column=0)
Received CommandResponse(seq_num=16)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=8, column=18)
Received CommandResponse(seq_num=17)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=9, column=0)
Received CommandResponse(seq_num=18)
Sending InfoRequest(file_name=&#39;test.lean&#39;, line=9, column=0)
Received CommandResponse(seq_num=19)
</pre></div>

<a name="194921316"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194921316" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194921316">Jason Rute (Apr 22 2020 at 12:19)</a>:</h4>
<p>If I sleep for 1 second after the sync, then it seems to work, although I still want to test it on a larger file.</p>

<a name="194921490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194921490" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194921490">Jason Rute (Apr 22 2020 at 12:20)</a>:</h4>
<p>Also does</p>
<div class="codehilite"><pre><span></span><span class="n">before</span> <span class="o">=</span> <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">state</span><span class="p">(</span><span class="s1">&#39;test.lean&#39;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">after</span> <span class="o">=</span> <span class="k">await</span> <span class="n">server</span><span class="o">.</span><span class="n">state</span><span class="p">(</span><span class="s1">&#39;test.lean&#39;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
</pre></div>


<p>run the risk of calling the info command in parallel (as <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> mentioned) thereby cancelling out the "before" info request if it takes too long?</p>

<a name="194926054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194926054" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194926054">Jason Rute (Apr 22 2020 at 13:01)</a>:</h4>
<p>I tried it with <code>ring_theory/polynomial.lean</code> in mathlib, which is a file which has given me a lot of trouble with stuff like this.  With a 1 second delay it returns nothing.  With a 10 second delay it misses most of the beginning of the file (the first 250 lines or so) and some lines later on as well which have a state.   With a 60 second delay, it starts to go through all the lines correctly, but then stopped processing at line 150 or so and crashed at the command <code>nursery.cancel_scope.cancel()</code> with error:</p>
<div class="codehilite"><pre><span></span>Traceback (most recent call last):
  File &quot;trio_example.py&quot;, line 30, in &lt;module&gt;
    trio.run(main, path)
  File &quot;/Users/jasonrute/Development/lean/test_massot_lean_client/venv/lib/python3.8/site-packages/trio/_core/_run.py&quot;, line 1804, in run
    raise runner.main_task_outcome.error
  File &quot;trio_example.py&quot;, line 26, in main
    nursery.cancel_scope.cancel()
  File &quot;/Users/jasonrute/Development/lean/test_massot_lean_client/venv/lib/python3.8/site-packages/trio/_core/_run.py&quot;, line 730, in __aexit__
    raise combined_error_from_nursery
  File &quot;/Users/jasonrute/Development/lean/test_massot_lean_client/venv/lib/python3.8/site-packages/lean_client/trio_server.py&quot;, line 64, in receiver
    resp = parse_response(line)
  File &quot;/Users/jasonrute/Development/lean/test_massot_lean_client/venv/lib/python3.8/site-packages/lean_client/commands.py&quot;, line 379, in parse_response
    return InfoResponse.from_dict(dic)
  File &quot;/Users/jasonrute/Development/lean/test_massot_lean_client/venv/lib/python3.8/site-packages/lean_client/commands.py&quot;, line 199, in from_dict
    dic[&#39;record&#39;] = InfoRecord.from_dict(dic.pop(&#39;record&#39;))
  File &quot;/Users/jasonrute/Development/lean/test_massot_lean_client/venv/lib/python3.8/site-packages/lean_client/commands.py&quot;, line 189, in from_dict
    dic[&#39;source&#39;] = InfoSource(**dic.pop(&#39;source&#39;))
TypeError: __init__() missing 1 required positional argument: &#39;file&#39;
</pre></div>

<a name="194926621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194926621" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194926621">Jason Rute (Apr 22 2020 at 13:05)</a>:</h4>
<p>I'd love to have a way for the lean server to tell me when it is ready so I don't have to deal with arbitrarily long sleep statements and such.  I've tried a number of tricks including:</p>
<ul>
<li>putting an eval statement at the end of the file to check when it has gotten that far</li>
<li>waiting for the server to say that it is done processing</li>
<li>probably others<br>
However, none of them seem perfect, especially with a file like <code>ring_theory/polynomial.lean</code>.</li>
</ul>

<a name="194927055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194927055" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194927055">Gabriel Ebner (Apr 22 2020 at 13:08)</a>:</h4>
<p>Have you tried <code>server.full_sync</code> instead of sleeping?  The logic Patrick implemented seems correct to me.</p>

<a name="194927463"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194927463" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194927463">Jason Rute (Apr 22 2020 at 13:10)</a>:</h4>
<p>Here is the exact code I was running: <a href="https://gist.github.com/jasonrute/cfa1500e49f2c34724024056b53d8cba" title="https://gist.github.com/jasonrute/cfa1500e49f2c34724024056b53d8cba">https://gist.github.com/jasonrute/cfa1500e49f2c34724024056b53d8cba</a>  It is only a slightly modified version of Patrick's code: <a href="https://github.com/PatrickMassot/lean-client-python/blob/master/examples/trio_example.py" title="https://github.com/PatrickMassot/lean-client-python/blob/master/examples/trio_example.py">https://github.com/PatrickMassot/lean-client-python/blob/master/examples/trio_example.py</a></p>

<a name="194927513"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194927513" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194927513">Jason Rute (Apr 22 2020 at 13:11)</a>:</h4>
<p>It uses <code>server.full_sync</code> but maybe not correctly.</p>

<a name="194939202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194939202" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194939202">Jason Rute (Apr 22 2020 at 14:28)</a>:</h4>
<p>If I remove the sleep line, no states are found.</p>

<a name="194993384"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194993384" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194993384">Patrick Massot (Apr 22 2020 at 21:25)</a>:</h4>
<p>I'm sorry I had no time at all this afternoon and this evening. I just tried and I can reproduce the problem with polynomial.lean. We haven't understood all the mysteries of the Lean server protocol yet. I'll investigate.</p>

<a name="194994587"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/194994587" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#194994587">Patrick Massot (Apr 22 2020 at 21:38)</a>:</h4>
<p>Hopefully fixed in <a href="https://github.com/PatrickMassot/lean-client-python/commit/746eb30b98f340296a723da115bd1e5f49d421fd" title="https://github.com/PatrickMassot/lean-client-python/commit/746eb30b98f340296a723da115bd1e5f49d421fd">https://github.com/PatrickMassot/lean-client-python/commit/746eb30b98f340296a723da115bd1e5f49d421fd</a> (see commit message for the explanation).</p>

<a name="195014382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/195014382" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#195014382">Jason Rute (Apr 23 2020 at 03:00)</a>:</h4>
<p><span class="user-mention" data-user-id="110031">@Patrick Massot</span> I spent some time today learning about <code>async</code> and <code>await</code> in Python, so I'm much more familiar with how your code works.  (For example, my concern about <code>before</code> and <code>after</code> calling the "info" command in parallel is clearly wrong.  The <code>after</code> value won't start be computed until <code>before</code> is done being computed.)  (For another example, I also found that same error in your code--but you fixed it before I had a chance to tell you.)  I tried your new code and it works really well.  It seems to be much more robust than my code which is great!  I haven't found any cases so far where the server doesn't return results when it should, but I'd like to test it out more.  Thanks for making this!</p>

<a name="195034730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/195034730" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#195034730">Patrick Massot (Apr 23 2020 at 09:09)</a>:</h4>
<p>Great! This async thing clearly requires some adaptation. I didn't know any of this one week ago, and I spent quite a few hours reading documentation and blog posts about all this. But our problem is really typical of what this async/await stuff is meant to solve. All the examples are always talking about talking to a server over internet, but conceptually there are no difference (although the practical detail differences took me a while to figure out).</p>

<a name="195125716"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/195125716" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#195125716">Jason Rute (Apr 23 2020 at 22:11)</a>:</h4>
<p><span class="user-mention" data-user-id="110031">@Patrick Massot</span>  I found another error (more subtle this time).  Should I make a PR (and if so how?), or should I just tell you the fix?  It is short.</p>

<a name="195127275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/195127275" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#195127275">Florian Dupeyron (Apr 23 2020 at 22:27)</a>:</h4>
<p>Hi everyone,<br>
<span class="user-mention" data-user-id="110031">@Patrick Massot</span> why using a third-party instead of just using the asyncio library ? I think it should be possible to have a lighter code using the <a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.subprocess_exec" title="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.subprocess_exec"><code>loop.subprocess_shell</code></a> function for this little application, and implementing a <a href="https://docs.python.org/3/library/asyncio-protocol.html#asyncio.SubprocessProtocol" title="https://docs.python.org/3/library/asyncio-protocol.html#asyncio.SubprocessProtocol"><code>asyncio.SubprocessProtocol</code></a> to handle incoming data. I am also learning the async paradigm so I maybe missed some point. I will give it a try on my own and maybe send a PR if I get something interesting ?</p>

<a name="195142193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/lean-client-python/near/195142193" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/52892leanclientpython.html#195142193">Jason Rute (Apr 24 2020 at 02:59)</a>:</h4>
<p>Here is a tricky case, try running the trio example on <code>category/core.lean</code>.  On line 24, one gets a back an info response with no line or position.  (It is some weird effect of the obviously tactic.)  Anyway, it causes the current code to crash.</p>


{% endraw %}

{% include archive_update.html %}