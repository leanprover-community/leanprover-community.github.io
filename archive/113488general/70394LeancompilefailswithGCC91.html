---
layout: archive
title: Lean Prover Zulip Chat Archive
permalink: archive/113488general/70394LeancompilefailswithGCC91.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html">Lean compile fails with GCC 9.1</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">

{% raw %}
<a name="170801039"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170801039" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170801039">Yury G. Kudryashov (Jul 13 2019 at 18:51)</a>:</h4>
<p>Hi,<br>
I failed to build lean 3 from source on Fedora 30. It seems that the reason is GCC 9.1.<br>
More precisely, the code compiles with many warnings, then crashes every time.</p>

<a name="170801557"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170801557" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170801557">Wojciech Nawrocki (Jul 13 2019 at 19:05)</a>:</h4>
<p>That's strange, it works for me with GCC 9.1.0 on Arch Linux. Is it the community version (<a href="https://github.com/leanprover-community/lean" target="_blank" title="https://github.com/leanprover-community/lean">https://github.com/leanprover-community/lean</a>)?</p>

<a name="170802356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170802356" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170802356">Yury G. Kudryashov (Jul 13 2019 at 19:28)</a>:</h4>
<p>I tried both 3.4.2 and community version. I'll try <code>git clean</code>, then recompile.</p>

<a name="170802449"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170802449" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170802449">Yury G. Kudryashov (Jul 13 2019 at 19:31)</a>:</h4>
<p><span class="user-mention" data-user-id="128280">@Wojciech Nawrocki</span> Do you get a lot of warnings?</p>

<a name="170802514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170802514" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170802514">Wojciech Nawrocki (Jul 13 2019 at 19:33)</a>:</h4>
<p>I get a lot of <code>-Wdeprecated-copy</code>, but the built binary works fine. Possibly Fedora has a different set of libraries that break something.</p>

<a name="170802564"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170802564" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170802564">Yury G. Kudryashov (Jul 13 2019 at 19:35)</a>:</h4>
<p>I also get -Wpessimizing-move</p>

<a name="170802569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170802569" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170802569">Yury G. Kudryashov (Jul 13 2019 at 19:35)</a>:</h4>
<p>(still compiles)</p>

<a name="170802609"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170802609" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170802609">Wojciech Nawrocki (Jul 13 2019 at 19:36)</a>:</h4>
<p>Yeah, I also get a few of <code>-Wpessimizing-move</code>.</p>

<a name="170803431"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170803431" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170803431">Yury G. Kudryashov (Jul 13 2019 at 20:03)</a>:</h4>
<p>Here is the error:</p>
<div class="codehilite"><pre><span></span>/home/urkud/projects/lean3/library/init/meta/tactic.lean: parsing at line 1399terminate called after throwing an instance of &#39;lean::exception&#39;
  what():  vm check failed: is_composite(o) (possibly due to incorrect axioms, or sorry)
</pre></div>

<a name="170803478"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170803478" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170803478">Wojciech Nawrocki (Jul 13 2019 at 20:05)</a>:</h4>
<p>I've seen that one before. I'm not sure exactly why it happens. For me removing the Lean folder, downloading from git again and rebuilding fixed it. Sorry I don't have a cleaner possible solution!</p>

<a name="170803539"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170803539" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170803539">Wojciech Nawrocki (Jul 13 2019 at 20:07)</a>:</h4>
<p>(It seemed to have something to do with the built .olean files under lean/library/ being corrupted, but don't quote me on it).</p>

<a name="170803989"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170803989" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170803989">Yury G. Kudryashov (Jul 13 2019 at 20:22)</a>:</h4>
<p><code>git clean -fdx</code> removed all <code>.olean</code> files</p>

<a name="170804042"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170804042" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170804042">Yury G. Kudryashov (Jul 13 2019 at 20:24)</a>:</h4>
<p>Actually, I fixed this somehow a few months ago (or just got lucky after one more recompile), and use this lean binary since then. Probably I'll try to fix (most of) the warning and see if it fixes compilation.</p>

<a name="170804055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170804055" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170804055">Yury G. Kudryashov (Jul 13 2019 at 20:25)</a>:</h4>
<p>BTW, writing outside of the build directory is supposed to be a bad idea, and lean cmake script does it (instead of, e.g., copying <code>lean/library</code> to the build directory).</p>

<a name="170804104"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/170804104" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#170804104">Yury G. Kudryashov (Jul 13 2019 at 20:26)</a>:</h4>
<p>This is a bad idea because different build directories are no longer independent. E.g., I can't try different compilers/flags in different build directories and be sure that they do not interfere with each other.</p>

<a name="174351336"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174351336" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174351336">Wojciech Nawrocki (Aug 28 2019 at 10:58)</a>:</h4>
<p>I've made an issue for this in <a href="https://github.com/leanprover-community/lean/issues/62" target="_blank" title="https://github.com/leanprover-community/lean/issues/62">https://github.com/leanprover-community/lean/issues/62</a> .</p>

<a name="174354617"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174354617" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174354617">Simon Hudon (Aug 28 2019 at 11:58)</a>:</h4>
<p>Can you guys setup a travis build that will reproduce the problem? Is it specific to Linux or will it crash also on Mac and Windows?</p>

<a name="174362662"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174362662" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174362662">Wojciech Nawrocki (Aug 28 2019 at 13:36)</a>:</h4>
<p><span class="user-mention" data-user-id="110026">@Simon Hudon</span> It already fails in the AppVeyor MinGW build, for example <a href="https://ci.appveyor.com/project/cipher1024/lean-e5aoi/builds/27002887/job/pkp6cl1q3t4wf5xk" target="_blank" title="https://ci.appveyor.com/project/cipher1024/lean-e5aoi/builds/27002887/job/pkp6cl1q3t4wf5xk">https://ci.appveyor.com/project/cipher1024/lean-e5aoi/builds/27002887/job/pkp6cl1q3t4wf5xk</a></p>

<a name="174363031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174363031" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174363031">Simon Hudon (Aug 28 2019 at 13:40)</a>:</h4>
<p>Ok but there are changes in that branch. Without the changes, I think it's still working</p>

<a name="174363438"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174363438" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174363438">Wojciech Nawrocki (Aug 28 2019 at 13:45)</a>:</h4>
<p>There are changes, but your own PR from 24 days ago <a href="https://ci.appveyor.com/project/cipher1024/lean-e5aoi/builds/26836597/job/a0p7ulnskt0e1arb" target="_blank" title="https://ci.appveyor.com/project/cipher1024/lean-e5aoi/builds/26836597/job/a0p7ulnskt0e1arb">fails with the same error</a> despite changing completely different things. In the bug report I also mention that I get this error on a fresh <code>master</code>.  This makes me semi-confident that new GCC (which MinGW also uses) started doing something Lean doesn't like. Either it's UB in Lean, or an incorrect optimization in GCC. I will also try clang++ on my laptop and see if it works</p>

<a name="174363645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174363645" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174363645">Simon Hudon (Aug 28 2019 at 13:47)</a>:</h4>
<p>what's UB?</p>

<a name="174363774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174363774" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174363774">Bryan Gin-ge Chen (Aug 28 2019 at 13:48)</a>:</h4>
<p>undefined behavior</p>

<a name="174363955"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174363955" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174363955">Simon Hudon (Aug 28 2019 at 13:50)</a>:</h4>
<p>Ok, I'll see what happens when I revert my changes and then we can start looking at removing the warnings</p>

<a name="174364087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174364087" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174364087">Wojciech Nawrocki (Aug 28 2019 at 13:51)</a>:</h4>
<p>Note this is probably a bug in Lean proper, and not the community fork, because I also reliably see it when building <a href="http://github.com/leanprover/lean" target="_blank" title="http://github.com/leanprover/lean">github.com/leanprover/lean</a> . (See <a href="https://ci.appveyor.com/project/leodemoura/lean/build/job/jmxe5g5ywklbaofr" target="_blank" title="https://ci.appveyor.com/project/leodemoura/lean/build/job/jmxe5g5ywklbaofr">https://ci.appveyor.com/project/leodemoura/lean/build/job/jmxe5g5ywklbaofr</a> )</p>

<a name="174364942"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174364942" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174364942">Wojciech Nawrocki (Aug 28 2019 at 14:00)</a>:</h4>
<p><code>lean --make</code> just segfaults for me on <code>library/</code> when built by Clang 8.0.1. I'll stick to GCC for now</p>

<a name="174365305"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174365305" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174365305">Bryan Gin-ge Chen (Aug 28 2019 at 14:04)</a>:</h4>
<p><a href="https://ci.appveyor.com/project/leodemoura/lean/history" target="_blank" title="https://ci.appveyor.com/project/leodemoura/lean/history">The appveyor build history</a> (for <code>leanprover/lean</code>) shows that the nightly builds started failing Aug 1. It looks like that's when GCC was changed <a href="https://ci.appveyor.com/project/leodemoura/lean/builds/26389340/job/hdj3e9hge6tg3y05?fullLog=true#L44" target="_blank" title="https://ci.appveyor.com/project/leodemoura/lean/builds/26389340/job/hdj3e9hge6tg3y05?fullLog=true#L44">from 8.2.0</a> to <a href="https://ci.appveyor.com/project/leodemoura/lean/builds/26417837/job/5r3twj6en27xru3d?fullLog=true#L44" target="_blank" title="https://ci.appveyor.com/project/leodemoura/lean/builds/26417837/job/5r3twj6en27xru3d?fullLog=true#L44">9.1.0</a> . And that's presumably due to the update to MSYS2 <a href="https://www.appveyor.com/updates/2019/08/01/" target="_blank" title="https://www.appveyor.com/updates/2019/08/01/">here</a>.</p>

<a name="174381777"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174381777" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174381777">Mario Carneiro (Aug 28 2019 at 17:01)</a>:</h4>
<p>If there is UB in lean, I wonder if we can tame the nasal demons to prove false in paranoid mode</p>

<a name="174382100"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174382100" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174382100">Sebastian Ullrich (Aug 28 2019 at 17:04)</a>:</h4>
<p>I don't know about GCC, but LLVM 8 is known to miscompile Lean due to <a href="https://bugs.llvm.org/show_bug.cgi?id=40044" target="_blank" title="https://bugs.llvm.org/show_bug.cgi?id=40044">https://bugs.llvm.org/show_bug.cgi?id=40044</a></p>

<a name="174388922"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174388922" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174388922">Wojciech Nawrocki (Aug 28 2019 at 18:29)</a>:</h4>
<p>This was a little ridiculous to debug since minute changes like adding print statements make the code compile correctly, but the bug is this:<br>
The <code>vm_obj_cell::dealloc</code> code has a <a href="https://github.com/leanprover-community/lean/blob/master/src/library/vm/vm.cpp#L301" target="_blank" title="https://github.com/leanprover-community/lean/blob/master/src/library/vm/vm.cpp#L301">switch statement</a> which calls the right function to <code>dealloc</code> a <code>vm_obj_cell</code> depending on its kind. Two of these kinds are together called "composites":  <code>inline bool is_composite(vm_obj_cell const * o) { return is_constructor(o) || is_closure(o); }</code> and are both deallocated with <code>to_composite(it)-&gt;dealloc(todo)</code>. The code looks correct to me, but it gets compiled to:</p>
<div class="codehilite"><pre><span></span>      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="c1">// vm_obj_kind::Constructor</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">o</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">)</span>
          <span class="n">lean</span><span class="o">::</span><span class="n">vm_check_failed</span><span class="p">(</span><span class="s">&quot;to_composite: is_composite(o)&quot;</span><span class="p">);</span>
        <span class="n">lean</span><span class="o">::</span><span class="n">vm_composite</span><span class="o">::</span><span class="n">dealloc</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">(</span><span class="n">lean</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="n">lean</span><span class="o">::</span><span class="n">vm_obj_cell</span><span class="o">*</span><span class="p">,</span><span class="mi">16</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">todo</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="c1">// vm_obj_kind::Closure</span>
        <span class="n">lean</span><span class="o">::</span><span class="n">vm_check_failed</span><span class="p">(</span><span class="s">&quot;to_composite: is_composite(o)&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</pre></div>


<p>where the <code>Closure</code> branch incorrectly goes straight to failure without checking the <a href="https://github.com/leanprover-community/lean/blob/master/src/library/vm/vm.h#L51" target="_blank" title="https://github.com/leanprover-community/lean/blob/master/src/library/vm/vm.h#L51"><code>LEAN_VM_IS_PTR</code></a> tag on the <code>vm_obj_cell* o</code> pointer. I tried adding <code>alignas(2)</code> to <code>class vm_obj_cell</code> but no dice. At this point I'm not sure if Lean is abusing the pointer-int conversions (which are sometimes UB) or if some optimization in GCC incorrectly figures that  <code>o</code> is always odd.</p>

<a name="174389540"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174389540" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174389540">Simon Hudon (Aug 28 2019 at 18:37)</a>:</h4>
<p>Although it crashes there, the problem might appear earlier. I suggest you try addressing the warnings first and see if anything gets fixed. Because of the new features of C++11 and so on, I wouldn't be surprised if misusing them in subtle ways would result in code whose behavior varies between compilers</p>

<a name="174389725"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174389725" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174389725">Wojciech Nawrocki (Aug 28 2019 at 18:39)</a>:</h4>
<p>Yeah, I agree. I've started looking through the warnings.</p>

<a name="174399481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174399481" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174399481">Wojciech Nawrocki (Aug 28 2019 at 20:43)</a>:</h4>
<p>Sadly nothing useful comes out of <code>-Wall -Wextra -Wpedantic</code>, I'll try making an MWE.</p>

<a name="174399577"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174399577" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174399577">Simon Hudon (Aug 28 2019 at 20:44)</a>:</h4>
<p>It would be nice to know which test or which file in <code>library/</code> makes Lean fail and which ones do not</p>

<a name="174400004"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174400004" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174400004">Wojciech Nawrocki (Aug 28 2019 at 20:50)</a>:</h4>
<p>It fails on <a href="https://github.com/leanprover-community/lean/blob/master/library/init/meta/hole_command.lean" target="_blank" title="https://github.com/leanprover-community/lean/blob/master/library/init/meta/hole_command.lean">init/meta/hole_command.lean</a>, but I think that's probably just the first place in the library that exercises deallocation on closures.</p>

<a name="174400348"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174400348" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174400348">Simon Hudon (Aug 28 2019 at 20:54)</a>:</h4>
<p>You might want to create a custom <code>.lean</code> file and add one ingredient at a time from <code>hole_command.lean</code> to see what does it</p>

<a name="174407303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174407303" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174407303">Mario Carneiro (Aug 28 2019 at 22:36)</a>:</h4>
<p>I don't think the issue is with that line of code exactly, and AFAICT it's not UB, but the general type-punning scheme implemented with <code>LEAN_VM_IS_PTR</code> is implementation-defined. According to <a href="https://timsong-cpp.github.io/cppwp/n4659/expr.reinterpret.cast#5" target="_blank" title="https://timsong-cpp.github.io/cppwp/n4659/expr.reinterpret.cast#5">the standard</a>, casting <code>uintptr_t -&gt; T* -&gt; uintptr_t</code> is not guaranteed to be the identity, and in particular GCC is allowed to assume that every element of the type <code>T*</code> is aligned, which may have something to do with this optimization</p>

<a name="174408531"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174408531" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174408531">Wojciech Nawrocki (Aug 28 2019 at 22:58)</a>:</h4>
<p>I just posted an update on the GitHub issue, but the gist of is that the following code, derived directly from bits of <code>vm.cpp</code> doesn't do what it should when compiled by GCC 9.1.0 with at least <code>-O2</code>:</p>
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;cstddef&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstdint&gt;</span><span class="cp"></span>

<span class="k">enum</span> <span class="k">class</span> <span class="nc">foo_kind</span> <span class="p">{</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="p">};</span>

<span class="k">struct</span> <span class="nf">alignas</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="n">foo</span> <span class="p">{</span>
    <span class="n">foo_kind</span> <span class="n">m_kind</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">foo_kind</span> <span class="nf">kind_</span><span class="p">(</span><span class="n">foo</span> <span class="o">*</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">m_kind</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">foo_kind</span><span class="o">::</span><span class="n">A</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="nf">is_bc</span><span class="p">(</span><span class="n">foo</span> <span class="o">*</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">kind_</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="n">foo_kind</span><span class="o">::</span><span class="n">B</span> <span class="o">||</span> <span class="n">kind_</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="n">foo_kind</span><span class="o">::</span><span class="n">C</span><span class="p">;</span> <span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">(</span><span class="n">foo</span> <span class="o">*</span> <span class="n">o</span><span class="p">);</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">always_inline</span><span class="p">))</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">loop_if_bc</span><span class="p">(</span><span class="n">foo</span> <span class="o">*</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="o">!</span><span class="n">is_bc</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">throw</span> <span class="s">&quot;what&quot;</span><span class="p">;</span> <span class="c1">// Should never be thrown if loop_if_bc is called only with B/C kind foos.</span>
                      <span class="c1">// But with GCC, it&#39;s *always* thrown.</span>
    <span class="n">loop</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">loop</span><span class="p">(</span><span class="n">foo</span> <span class="o">*</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">m_kind</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">foo_kind</span><span class="o">::</span><span class="nl">A</span><span class="p">:</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">foo_kind</span><span class="o">::</span><span class="nl">B</span><span class="p">:</span> <span class="n">loop_if_bc</span><span class="p">(</span><span class="n">o</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">foo_kind</span><span class="o">::</span><span class="nl">C</span><span class="p">:</span> <span class="n">loop_if_bc</span><span class="p">(</span><span class="n">o</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">foo</span> <span class="n">obj</span> <span class="p">{</span> <span class="n">foo_kind</span><span class="o">::</span><span class="n">C</span> <span class="p">};</span>
    <span class="n">loop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<a name="174408786"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174408786" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174408786">Wojciech Nawrocki (Aug 28 2019 at 23:02)</a>:</h4>
<p>Note that for the LSB check to fail, GCC would have to assume that all <code>foo</code>s are <em>not</em> aligned, and have odd addresses.</p>

<a name="174410838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174410838" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174410838">Mario Carneiro (Aug 28 2019 at 23:39)</a>:</h4>
<p>According to the compiler explorer, this bug exists in 9.1 and 9.2 and is fixed in GCC trunk</p>

<a name="174523668"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174523668" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174523668">Keeley Hoek (Aug 30 2019 at 08:03)</a>:</h4>
<p>Wow, lean found a gcc bug. It's growing up so fast. :P</p>

<a name="174523875"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174523875" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174523875">Patrick Massot (Aug 30 2019 at 08:06)</a>:</h4>
<p>Wait until Lean 6 autogenerate a certified GCC</p>

<a name="174523918"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174523918" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174523918">Patrick Massot (Aug 30 2019 at 08:07)</a>:</h4>
<p>I guess we can't really say it found a bug if it's already fixed in trunk</p>

<a name="174524369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174524369" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174524369">Sebastian Ullrich (Aug 30 2019 at 08:15)</a>:</h4>
<p><span class="user-mention" data-user-id="110111">@Keeley Hoek</span> <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=85764" target="_blank" title="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=85764">https://gcc.gnu.org/bugzilla/show_bug.cgi?id=85764</a></p>

<a name="174525939"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174525939" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174525939">Keeley Hoek (Aug 30 2019 at 08:39)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I wish I had a gcc issue which had status <code>RESOLVED FIXED</code> :)<br>
Isn't that the pinnacle of CS achievement?</p>

<a name="174526018"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174526018" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174526018">Patrick Massot (Aug 30 2019 at 08:40)</a>:</h4>
<p>It may be so only until it turns out Lean 4 is faster than gcc.</p>

<a name="174526174"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174526174" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174526174">Sebastian Ullrich (Aug 30 2019 at 08:42)</a>:</h4>
<p>Well, we're using clang by default, which <em>is</em> faster than GCC in quite a few benchmarks...</p>

<a name="174526214"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174526214" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174526214">Sebastian Ullrich (Aug 30 2019 at 08:43)</a>:</h4>
<p>(I hope you're not talking about the compile times because let's not talk about those...)</p>

<a name="174526239"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174526239" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174526239">Patrick Massot (Aug 30 2019 at 08:43)</a>:</h4>
<p>You mean Lean code gets compiled to C++ code which is then compiled by clang which is faster than GCC?</p>

<a name="174526285"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174526285" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174526285">Patrick Massot (Aug 30 2019 at 08:44)</a>:</h4>
<p>Who cares about compile time?</p>

<a name="174526292"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174526292" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174526292">Keeley Hoek (Aug 30 2019 at 08:44)</a>:</h4>
<p>I think to C, actually</p>

<a name="174526303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174526303" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174526303">Keeley Hoek (Aug 30 2019 at 08:44)</a>:</h4>
<p>Incidentally, why the switch Sebastian?</p>

<a name="174526307"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174526307" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174526307">Patrick Massot (Aug 30 2019 at 08:44)</a>:</h4>
<p>Users don't care (unless you include interactive proof checking speed in compile time)</p>

<a name="174527052"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174527052" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174527052">Sebastian Ullrich (Aug 30 2019 at 08:55)</a>:</h4>
<blockquote>
<p>Incidentally, why the switch Sebastian?</p>
</blockquote>
<p>Because it's faster</p>

<a name="174527196"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174527196" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174527196">Keeley Hoek (Aug 30 2019 at 08:58)</a>:</h4>
<p>To compile or run?</p>

<a name="174527242"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174527242" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174527242">Keeley Hoek (Aug 30 2019 at 08:58)</a>:</h4>
<p>Which C++ features were you using</p>

<a name="174527680"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174527680" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174527680">Sebastian Ullrich (Aug 30 2019 at 09:05)</a>:</h4>
<p>Oh, you mean the switch from C++ to C. It's faster to compile, yes. We were only using C++ because the runtime header was written in it, but it's now all C.</p>

<a name="174527838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Lean%20compile%20fails%20with%20GCC%209.1/near/174527838" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/70394LeancompilefailswithGCC91.html#174527838">Keeley Hoek (Aug 30 2019 at 09:08)</a>:</h4>
<p>Cool</p>


{% endraw %}

{% include archive_update.html %}