---
layout: archive
title: Lean Prover Zulip Chat Archive 
permalink: archive/113488general/87130T50000challenge.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html">-T50000 challenge</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">
{% raw %}
<a name="165857644"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165857644" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165857644">Kevin Buzzard (May 16 2019 at 23:17)</a>:</h4>
<p>I just tried compiling mathlib with the timeout flag set to T50000 and it doesn't compile -- there are some deterministic timeouts.</p>
<p>Why do this? Well, when making the perfectoid project there were times when we were really battling against timeouts; for example check out </p>
<p><a href="https://github.com/leanprover-community/lean-perfectoid-spaces/blob/c1fec0fe89a6bac395935c759b8387316df0e3a6/src/valuation/field.lean#L653" target="_blank" title="https://github.com/leanprover-community/lean-perfectoid-spaces/blob/c1fec0fe89a6bac395935c759b8387316df0e3a6/src/valuation/field.lean#L653">https://github.com/leanprover-community/lean-perfectoid-spaces/blob/c1fec0fe89a6bac395935c759b8387316df0e3a6/src/valuation/field.lean#L653</a></p>
<p>which should be a one line term mode proof but Lean would time out at -T100000 (the default time-out value) so we had to tread really carefully to make the proof compile. At the time I thought that we were pushing Lean to the edge -- but since Mario responded in the timeout thread and showed us some more tricks I realise now that actually we were simply not getting Lean to unify efficiently. <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> I don't know whether a judicious <code>: _</code> fixes that proof, but definitely a judicious bunch of <code>let</code>s makes the proof compile instantly -- I've made this happen myself.</p>
<p>Compiling mathlib with <code>-T50000</code> might show up some more instances where people have written code which takes several seconds to compile instead of several tenths of a second because of similar issues. The first issue I ran into is</p>
<div class="codehilite"><pre><span></span>mathlib-community-master/src/category_theory/equivalence.lean:124:33: error: (deterministic) timeout
mathlib-community-master/src/category_theory/equivalence.lean:124:30: error: (deterministic) timeout
mathlib-community-master/src/category_theory/equivalence.lean:124:30: error: (deterministic) timeout
mathlib-community-master/src/category_theory/equivalence.lean:123:2: error: (deterministic) timeout
mathlib-community-master/src/category_theory/equivalence.lean:122:23: error: (deterministic) timeout
</pre></div>


<p>with code</p>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">adjointify_Œ∑</span> <span class="o">:</span> <span class="mi">ùü≠</span> <span class="n">C</span> <span class="err">‚âÖ</span> <span class="n">F</span> <span class="err">‚ãô</span> <span class="n">G</span> <span class="o">:=</span>
<span class="n">Œ∑</span> <span class="err">‚â™‚â´</span> <span class="n">iso_whisker_left</span> <span class="n">F</span> <span class="o">((</span><span class="n">left_unitor</span> <span class="n">G</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span> <span class="err">‚â™‚â´</span>
  <span class="n">iso_whisker_right</span> <span class="n">Œµ</span><span class="bp">.</span><span class="n">symm</span> <span class="n">G</span><span class="o">)</span> <span class="err">‚â™‚â´</span> <span class="n">iso_whisker_right</span> <span class="n">Œ∑</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">F</span> <span class="err">‚ãô</span> <span class="n">G</span><span class="o">)</span>
</pre></div>


<p>Is there some way of making Lean unify this more quickly? </p>
<p>NB the easiest way to play along at home is to open mathlib in VS Code, File -&gt; Preferences -&gt; Settings, search for Lean and find the timeout value and change it from 100000 to 50000, and then add and remove a character from equivalence.lean to make it recompile.</p>

<a name="165858601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165858601" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165858601">Floris van Doorn (May 16 2019 at 23:32)</a>:</h4>
<p>Yeah, I can imagine that that definition is a stress test on Lean. So for functors the associator <code>(F ‚ãô G) ‚ãô H ‚âÖ F ‚ãô (G ‚ãô H</code> is true by reflexivity and the unitors <code>1 ‚ãô F ‚âÖ F</code> are true by reflexivity as long as <code>F</code> is of the form <code>‚ü®_, _, _, _‚ü©</code> (usually this is the case if <code>F</code> is anything other than a variable). In the category theory library we can use/abuse this, by not explicitly writing down these associators and unitors, but at the cost of making Lean do (a lot of) extra work. We maybe should decide that we want to avoid doing these rules silently. However, this would change the definitions of natural isomorphisms we are defining, which might make future proofs more finicky. See also the discussion below this comment:<br>
<a href="https://github.com/leanprover-community/mathlib/pull/1018#discussion_r283978240" target="_blank" title="https://github.com/leanprover-community/mathlib/pull/1018#discussion_r283978240">https://github.com/leanprover-community/mathlib/pull/1018#discussion_r283978240</a></p>
<p>In this particular case I think there are two silent associators and one silent left unitor (and 1 non-silent one). We should probably include them explicitly. <span class="user-mention" data-user-id="110087">@Scott Morrison</span></p>

<a name="165858733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165858733" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165858733">Scott Morrison (May 16 2019 at 23:34)</a>:</h4>
<p>I agree this is a problem, and perhaps it indicates we should go back to your original construction for <code>adjointify</code>, which explicitly provided the components, at the expense of needing to check naturality.</p>

<a name="165858738"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165858738" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165858738">Scott Morrison (May 16 2019 at 23:34)</a>:</h4>
<p>Actually, what we really should do is both.</p>

<a name="165858761"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165858761" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165858761">Scott Morrison (May 16 2019 at 23:35)</a>:</h4>
<p>Define <code>adjointify</code> so that it is obviously natural, but inserting unitors and associators so elaboration fast</p>

<a name="165858770"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165858770" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165858770">Scott Morrison (May 16 2019 at 23:35)</a>:</h4>
<p>and then give a simp lemma that says the components are what you want them to be.</p>

<a name="165858864"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165858864" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165858864">Kevin Buzzard (May 16 2019 at 23:36)</a>:</h4>
<p>Out of interest, when we compiled the perfectoid project at -T50000 there were problems in four places. Two were fixed with Mario's <code>: _</code> trick, one was a <code>use</code> which we changed to <code>existsi</code>, and one was <code>embedding f</code> which had a potential overload and was fixed by changing it to <code>_root_.embedding f</code>. In all four cases elaboration time dropped dramatically from "takes several seconds to compile" to "compiles instantly".</p>

<a name="165858894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165858894" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165858894">Kevin Buzzard (May 16 2019 at 23:37)</a>:</h4>
<p>But is this associator thing yet another kind of problem?</p>

<a name="165858943"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165858943" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165858943">Floris van Doorn (May 16 2019 at 23:37)</a>:</h4>
<blockquote>
<p>Actually, what we really should do is both.</p>
</blockquote>
<p>I wanted to also suggest that. That is basically what I did in the Lean 2 HoTT library:<br>
<a href="https://github.com/leanprover/lean2/blob/master/hott/algebra/category/functor/equivalence.hlean#L82-L102" target="_blank" title="https://github.com/leanprover/lean2/blob/master/hott/algebra/category/functor/equivalence.hlean#L82-L102">https://github.com/leanprover/lean2/blob/master/hott/algebra/category/functor/equivalence.hlean#L82-L102</a><br>
I defined the new <code>Œ∑</code> first on components, and to show naturality I showed that it was equal to the map of a natural transformation, defined fully explicit.</p>

<a name="165859067"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165859067" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165859067">Kevin Buzzard (May 16 2019 at 23:39)</a>:</h4>
<p>What I feel I learnt from this experiment was that long elaboration times are not always inevitable -- sometimes persuading Lean to elaborate the same thing slightly differently can have a massively beneficial effect and perhaps even teach us something.</p>

<a name="165859297"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165859297" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165859297">Floris van Doorn (May 16 2019 at 23:43)</a>:</h4>
<blockquote>
<p>But is this associator thing yet another kind of problem?</p>
</blockquote>
<p>Yes, but we're basically abusing the Lean type checker. We have an expression <code>(F ‚ãô ((G ‚ãô F) ‚ãô G)</code> which we need to match with <code>(F ‚ãô G) ‚ãô (F ‚ãô G)</code>. We should really rewrite one expression to the other (using natural isomorphisms), but we proof it "by reflexivity". This is true, but only if Lean unfolds all occurrences of <code>‚ãô</code> (and likely gets a huge term in the process).<br>
It's roughly similar to proving <code>1000 + 1000 = 2000</code> by <code>refl</code> instead of <code>norm_num</code>.</p>

<a name="165877926"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165877926" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165877926">Kevin Buzzard (May 17 2019 at 07:04)</a>:</h4>
<p>Oh that's a very clear explanation Floris, thanks!</p>

<a name="165877990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165877990" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165877990">Kevin Buzzard (May 17 2019 at 07:05)</a>:</h4>
<p>The next one is this, from <code>src/data/complex/exponential.lean:456:0</code>:</p>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">cos_add</span> <span class="o">:</span> <span class="n">cos</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">cos</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">cos</span> <span class="n">y</span> <span class="bp">-</span> <span class="n">sin</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">sin</span> <span class="n">y</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="o">[</span><span class="err">‚Üê</span> <span class="n">domain</span><span class="bp">.</span><span class="n">mul_left_inj</span> <span class="o">(</span><span class="bp">@</span><span class="n">two_ne_zero&#39;</span> <span class="n">‚ÑÇ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">),</span>
      <span class="err">‚Üê</span> <span class="n">domain</span><span class="bp">.</span><span class="n">mul_left_inj</span> <span class="o">(</span><span class="bp">@</span><span class="n">two_ne_zero&#39;</span> <span class="n">‚ÑÇ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)],</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">mul_add</span><span class="o">,</span> <span class="n">add_mul</span><span class="o">,</span> <span class="n">mul_sub</span><span class="o">,</span> <span class="n">sub_mul</span><span class="o">,</span> <span class="n">exp_add</span><span class="o">,</span> <span class="n">div_mul_div</span><span class="o">,</span>
    <span class="n">div_add_div_same</span><span class="o">,</span> <span class="n">mul_assoc</span><span class="o">,</span> <span class="o">(</span><span class="n">div_div_eq_div_mul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
    <span class="n">mul_div_cancel&#39;</span> <span class="bp">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">two_ne_zero&#39;</span> <span class="n">‚ÑÇ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">),</span> <span class="n">sin</span><span class="o">,</span> <span class="n">cos</span><span class="o">],</span>
  <span class="n">apply</span> <span class="n">complex</span><span class="bp">.</span><span class="n">ext</span><span class="bp">;</span> <span class="n">simp</span> <span class="o">[</span><span class="n">mul_add</span><span class="o">,</span> <span class="n">add_mul</span><span class="o">,</span> <span class="n">exp_add</span><span class="o">]</span><span class="bp">;</span> <span class="n">ring</span>
<span class="kn">end</span>
</pre></div>


<p>Times out at -T50000.</p>

<a name="165881328"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165881328" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165881328">Mario Carneiro (May 17 2019 at 08:17)</a>:</h4>
<p>This one is a bit perplexing. Consider the following proof of <code>sin_add</code>:</p>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">two_sin</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">sin</span> <span class="n">x</span> <span class="bp">=</span> <span class="o">(</span><span class="n">exp</span> <span class="o">(</span><span class="bp">-</span><span class="n">x</span> <span class="bp">*</span> <span class="n">I</span><span class="o">)</span> <span class="bp">-</span> <span class="n">exp</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">I</span><span class="o">))</span> <span class="bp">*</span> <span class="n">I</span> <span class="o">:=</span>
<span class="n">mul_div_cancel&#39;</span> <span class="bp">_</span> <span class="n">two_ne_zero&#39;</span>

<span class="kn">lemma</span> <span class="n">two_cos</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">cos</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">exp</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">I</span><span class="o">)</span> <span class="bp">+</span> <span class="n">exp</span> <span class="o">(</span><span class="bp">-</span><span class="n">x</span> <span class="bp">*</span> <span class="n">I</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">mul_div_cancel&#39;</span> <span class="bp">_</span> <span class="n">two_ne_zero&#39;</span>

<span class="kn">lemma</span> <span class="n">sin_add</span> <span class="o">:</span> <span class="n">sin</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">sin</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">cos</span> <span class="n">y</span> <span class="bp">+</span> <span class="n">cos</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">sin</span> <span class="n">y</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="o">[</span><span class="err">‚Üê</span> <span class="n">domain</span><span class="bp">.</span><span class="n">mul_left_inj</span> <span class="o">(</span><span class="bp">@</span><span class="n">two_ne_zero&#39;</span> <span class="n">‚ÑÇ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">),</span> <span class="n">two_sin</span><span class="o">,</span>
      <span class="n">neg_add</span><span class="o">,</span> <span class="n">add_mul</span><span class="o">,</span> <span class="n">exp_add</span><span class="o">,</span> <span class="n">add_mul</span><span class="o">,</span> <span class="n">exp_add</span><span class="o">,</span> <span class="n">eq_comm</span><span class="o">,</span>
      <span class="n">mul_add</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">mul_assoc</span><span class="o">,</span> <span class="n">two_sin</span><span class="o">,</span> <span class="n">mul_left_comm</span><span class="o">,</span> <span class="n">two_sin</span><span class="o">,</span>
      <span class="err">‚Üê</span> <span class="n">domain</span><span class="bp">.</span><span class="n">mul_left_inj</span> <span class="o">(</span><span class="bp">@</span><span class="n">two_ne_zero&#39;</span> <span class="n">‚ÑÇ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">),</span> <span class="n">mul_add</span><span class="o">,</span>
      <span class="n">mul_left_comm</span><span class="o">,</span> <span class="n">two_cos</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">mul_assoc</span><span class="o">,</span> <span class="n">two_cos</span><span class="o">],</span> <span class="n">ring</span>
<span class="kn">end</span>
</pre></div>


<p>The <code>rw</code> part of the proof is instantaneous (less than 150ms if you replace <code>ring</code> by <code>sorry</code>). The <code>ring</code> tactic is also fast (a fraction of a second). The kernel is also quickly able to check the proof. Yet the <em>elaborator</em> spends a whopping 30s on... something... coming from the <code>ring</code>  tactic, despite the fact that <code>ring</code> produces fully elaborated proof terms.</p>

<a name="165881647"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165881647" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165881647">Mario Carneiro (May 17 2019 at 08:23)</a>:</h4>
<p>Bizarrely, this takes a long time...</p>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">sin_add</span> <span class="o">:</span> <span class="n">sin</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">sin</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">cos</span> <span class="n">y</span> <span class="bp">+</span> <span class="n">cos</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">sin</span> <span class="n">y</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="o">[</span><span class="err">‚Üê</span> <span class="n">domain</span><span class="bp">.</span><span class="n">mul_left_inj</span> <span class="o">(</span><span class="bp">@</span><span class="n">two_ne_zero&#39;</span> <span class="n">‚ÑÇ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">),</span> <span class="n">two_sin</span><span class="o">,</span>
      <span class="n">neg_add</span><span class="o">,</span> <span class="n">add_mul</span><span class="o">,</span> <span class="n">exp_add</span><span class="o">,</span> <span class="n">add_mul</span><span class="o">,</span> <span class="n">exp_add</span><span class="o">,</span> <span class="n">eq_comm</span><span class="o">,</span>
      <span class="n">mul_add</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">mul_assoc</span><span class="o">,</span> <span class="n">two_sin</span><span class="o">,</span> <span class="n">mul_left_comm</span><span class="o">,</span> <span class="n">two_sin</span><span class="o">,</span>
      <span class="err">‚Üê</span> <span class="n">domain</span><span class="bp">.</span><span class="n">mul_left_inj</span> <span class="o">(</span><span class="bp">@</span><span class="n">two_ne_zero&#39;</span> <span class="n">‚ÑÇ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">),</span> <span class="n">mul_add</span><span class="o">,</span>
      <span class="n">mul_left_comm</span><span class="o">,</span> <span class="n">two_cos</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">mul_assoc</span><span class="o">,</span> <span class="n">two_cos</span><span class="o">],</span>
  <span class="n">generalize</span><span class="o">:</span> <span class="n">exp</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">I</span><span class="o">)</span> <span class="bp">=</span> <span class="n">a</span><span class="o">,</span> <span class="n">generalize</span><span class="o">:</span> <span class="n">exp</span> <span class="o">(</span><span class="bp">-</span><span class="n">x</span> <span class="bp">*</span> <span class="n">I</span><span class="o">)</span> <span class="bp">=</span> <span class="n">b</span><span class="o">,</span>
  <span class="n">generalize</span><span class="o">:</span> <span class="n">exp</span> <span class="o">(</span><span class="n">y</span> <span class="bp">*</span> <span class="n">I</span><span class="o">)</span> <span class="bp">=</span> <span class="n">c</span><span class="o">,</span> <span class="n">generalize</span><span class="o">:</span> <span class="n">exp</span> <span class="o">(</span><span class="bp">-</span><span class="n">y</span> <span class="bp">*</span> <span class="n">I</span><span class="o">)</span> <span class="bp">=</span> <span class="n">d</span><span class="o">,</span>
  <span class="n">ring</span>
<span class="kn">end</span>
</pre></div>


<p>because <code>generalize</code> takes 6s</p>

<a name="165882367"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165882367" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165882367">Kevin Buzzard (May 17 2019 at 08:35)</a>:</h4>
<p>I'm glad that this slightly frivolous challenge is throwing up interesting questions!</p>

<a name="165891888"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165891888" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165891888">Rob Lewis (May 17 2019 at 11:32)</a>:</h4>
<blockquote>
<p>The <code>rw</code> part of the proof is instantaneous (less than 150ms if you replace <code>ring</code> by <code>sorry</code>). The <code>ring</code> tactic is also fast (a fraction of a second). The kernel is also quickly able to check the proof. Yet the <em>elaborator</em> spends a whopping 30s on... something... coming from the <code>ring</code>  tactic, despite the fact that <code>ring</code> produces fully elaborated proof terms.</p>
</blockquote>
<p>This is really strange. There's something going on in the <code>is_def_eq</code> call in <code>add_atom</code>. The profiler says <code>ring</code> is spending 6 seconds there. But each call is a fraction of a millisecond and there are only a couple dozen calls.</p>

<a name="165891918"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165891918" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165891918">Rob Lewis (May 17 2019 at 11:33)</a>:</h4>
<p>I used this to profile:</p>
<div class="codehilite"><pre><span></span><span class="n">meta</span> <span class="n">def</span> <span class="n">time_defeq</span> <span class="o">(</span><span class="n">e</span> <span class="n">e&#39;</span> <span class="o">:</span> <span class="n">expr</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">pe</span> <span class="err">‚Üê</span> <span class="n">pp</span> <span class="n">e</span><span class="o">,</span>
   <span class="n">pe&#39;</span> <span class="err">‚Üê</span> <span class="n">pp</span> <span class="n">e&#39;</span><span class="o">,</span>
   <span class="n">timeit</span> <span class="o">(</span><span class="s2">&quot;defeq</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="bp">++</span> <span class="n">to_string</span> <span class="n">pe</span> <span class="bp">++</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="bp">++</span> <span class="n">to_string</span> <span class="n">pe&#39;</span><span class="bp">++</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="o">(</span><span class="n">sleep</span> <span class="mi">1</span> <span class="bp">&gt;&gt;</span> <span class="n">is_def_eq</span> <span class="n">e</span> <span class="n">e&#39;</span><span class="o">)</span>
</pre></div>


<p><code>ring</code> spends 6500 ms in <code>time_defeq</code>, 18 in <code>pp</code>, and 1 in <code>timeit</code>.</p>

<a name="165892003"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892003" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892003">Rob Lewis (May 17 2019 at 11:35)</a>:</h4>
<p>Hmm, but this profiling is wrong, increasing the sleep time doesn't change the profile time of <code>timeit</code>?</p>

<a name="165892285"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892285" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892285">Keeley Hoek (May 17 2019 at 11:40)</a>:</h4>
<p>ah, <code>timeit</code> doesn't time tactics</p>

<a name="165892289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892289" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892289">Keeley Hoek (May 17 2019 at 11:40)</a>:</h4>
<p>I think you're timing how long it takes to build the monad or something</p>

<a name="165892293"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892293" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892293">Keeley Hoek (May 17 2019 at 11:40)</a>:</h4>
<p>(I think)</p>

<a name="165892303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892303" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892303">Keeley Hoek (May 17 2019 at 11:41)</a>:</h4>
<p>Isn't there a tactic version</p>

<a name="165892318"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892318" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892318">Rob Lewis (May 17 2019 at 11:41)</a>:</h4>
<p>You're right, it's <code>timetac</code>, not <code>timeit</code>. Getting my timers mixed up.</p>

<a name="165892467"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892467" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892467">Rob Lewis (May 17 2019 at 11:44)</a>:</h4>
<p>Would it be safe to set <code>complex.exp</code> to be irreducible at the end of <code>complex/exponential.lean</code>?</p>

<a name="165892478"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892478" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892478">Rob Lewis (May 17 2019 at 11:44)</a>:</h4>
<p>This is the culprit. <code>is_def_eq</code> is unfolding that and getting lost.</p>

<a name="165892483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892483" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892483">Mario Carneiro (May 17 2019 at 11:44)</a>:</h4>
<p>yeah, that makes sense</p>

<a name="165892502"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892502" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892502">Mario Carneiro (May 17 2019 at 11:45)</a>:</h4>
<p>We should probably back off on <code>is_def_eq</code> as well though</p>

<a name="165892518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892518" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892518">Mario Carneiro (May 17 2019 at 11:45)</a>:</h4>
<p>use some reducibility setting</p>

<a name="165892721"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165892721" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165892721">Rob Lewis (May 17 2019 at 11:48)</a>:</h4>
<p>I'm not sure if syntactic eq is enough there, it might be. But I guess a weaker <code>is_def_eq</code> probably is.</p>

<a name="165893518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165893518" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165893518">Mario Carneiro (May 17 2019 at 11:57)</a>:</h4>
<p>it is enough for this goal, but of course not for some goals</p>

<a name="165893527"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165893527" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165893527">Rob Lewis (May 17 2019 at 11:57)</a>:</h4>
<p>Hmm, no, this goes back to the discussion we had a few months ago about <code>ring</code> and <code>linarith</code> handling defeq atoms. Weakening that check means <code>linarith</code> fails to prove <code>id x ‚â• x</code>.</p>

<a name="165893618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165893618" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165893618">Mario Carneiro (May 17 2019 at 11:58)</a>:</h4>
<p>but I definitely want to avoid a cost for unfolding defeq when it's not even necessary. <code>assumption</code> has the same problem</p>

<a name="165893703"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165893703" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165893703">Mario Carneiro (May 17 2019 at 11:59)</a>:</h4>
<p>it's triggering because it wants to find out if <code>exp x =?= exp (-x)</code> and other variations</p>

<a name="165893838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165893838" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165893838">Rob Lewis (May 17 2019 at 12:00)</a>:</h4>
<p>Instead of using <code>is_def_eq</code> less, maybe we should be marking more things <code>irreducible</code>.</p>

<a name="165893863"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165893863" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165893863">Mario Carneiro (May 17 2019 at 12:00)</a>:</h4>
<p>This is what reducibility settings are for</p>

<a name="165893881"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165893881" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165893881">Mario Carneiro (May 17 2019 at 12:00)</a>:</h4>
<p>like how <code>rw</code> tries <code>refl</code> but not really hard in case it's not true</p>

<a name="165894094"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165894094" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165894094">Mario Carneiro (May 17 2019 at 12:02)</a>:</h4>
<p>I guess that's not enough to get <code>id x &gt;= x</code> though</p>

<a name="165894116"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165894116" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165894116">Mario Carneiro (May 17 2019 at 12:03)</a>:</h4>
<p>because <code>id</code> is semireducible</p>

<a name="165894254"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165894254" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165894254">Mario Carneiro (May 17 2019 at 12:04)</a>:</h4>
<p>how about giving <code>linarith</code> and <code>ring</code> a reducibility config option? I think the default should be unfold reducible</p>

<a name="165894366"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165894366" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165894366">Rob Lewis (May 17 2019 at 12:05)</a>:</h4>
<p>Exactly. Same thing in the example here: <a href="#narrow/stream/144837-PR-reviews/topic/.23878.20.20remove.20dependencies" title="#narrow/stream/144837-PR-reviews/topic/.23878.20.20remove.20dependencies">https://leanprover.zulipchat.com/#narrow/stream/144837-PR-reviews/topic/.23878.20.20remove.20dependencies</a> . Matching up to defeq lets <code>ring</code> and <code>linarith</code> unify two different coercions, which is sensible to do. But I'm pretty sure those coercions are semireducible.</p>

<a name="165894376"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165894376" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165894376">Rob Lewis (May 17 2019 at 12:05)</a>:</h4>
<p>That would work.</p>

<a name="165894432"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165894432" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165894432">Rob Lewis (May 17 2019 at 12:06)</a>:</h4>
<p>Linarith already has a bunch of config options. I worry this one would be pretty obscure.</p>

<a name="165894462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165894462" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165894462">Rob Lewis (May 17 2019 at 12:07)</a>:</h4>
<p>On the other hand, they were both using syntactic eq for a while with no issues. It wouldn't be a big loss to go half a step back and add a config option.</p>

<a name="165894625"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165894625" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165894625">Rob Lewis (May 17 2019 at 12:08)</a>:</h4>
<p>Regardless, I think we should also be a bit more aggressive about marking things irreducible.</p>

<a name="165911267"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165911267" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165911267">Kevin Buzzard (May 17 2019 at 15:46)</a>:</h4>
<p>So this one has actually now been fixed by the latest PR! Nice!</p>
<p>The next one is I think one of <span class="user-mention" data-user-id="110032">@Reid Barton</span> 's:</p>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">stone_cech</span><span class="bp">.</span><span class="n">t2_space</span> <span class="o">:</span> <span class="n">t2_space</span> <span class="o">(</span><span class="n">stone_cech</span> <span class="n">Œ±</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="n">t2_iff_ultrafilter</span><span class="o">,</span>
  <span class="n">rintros</span> <span class="n">g</span> <span class="bp">‚ü®</span><span class="n">x</span><span class="bp">‚ü©</span> <span class="bp">‚ü®</span><span class="n">y</span><span class="bp">‚ü©</span> <span class="n">u</span> <span class="n">gx</span> <span class="n">gy</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">quotient</span><span class="bp">.</span><span class="n">sound</span><span class="o">,</span>
  <span class="n">intros</span> <span class="n">Œ≥</span> <span class="n">tŒ≥</span> <span class="n">h‚ÇÅ</span> <span class="n">h‚ÇÇ</span> <span class="n">f</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">resetI</span><span class="o">,</span>
  <span class="n">change</span> <span class="n">stone_cech_extend</span> <span class="n">hf</span> <span class="err">‚ü¶</span><span class="n">x</span><span class="err">‚üß</span> <span class="bp">=</span> <span class="n">stone_cech_extend</span> <span class="n">hf</span> <span class="err">‚ü¶</span><span class="n">y</span><span class="err">‚üß</span><span class="o">,</span>
  <span class="n">refine</span> <span class="n">tendsto_nhds_unique</span> <span class="n">u</span><span class="bp">.</span><span class="mi">1</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">exact</span> <span class="n">stone_cech_extend</span> <span class="n">hf</span> <span class="o">},</span>
  <span class="n">all_goals</span>
  <span class="o">{</span> <span class="n">refine</span> <span class="n">le_trans</span> <span class="o">(</span><span class="n">map_mono</span> <span class="bp">_</span><span class="o">)</span> <span class="o">((</span><span class="n">continuous_stone_cech_extend</span> <span class="n">hf</span><span class="o">)</span><span class="bp">.</span><span class="n">tendsto</span> <span class="bp">_</span><span class="o">),</span>
    <span class="n">assumption</span> <span class="o">}</span>
<span class="kn">end</span>
</pre></div>


<p>Times out at -T50000. It's in <code>src/topology/stone_cech.lean</code>, <a href="https://github.com/leanprover-community/mathlib/blob/f633c948ff523b9a47b3b41bc1dc0b1b4b2be5c4/src/topology/stone_cech.lean#L253" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/f633c948ff523b9a47b3b41bc1dc0b1b4b2be5c4/src/topology/stone_cech.lean#L253">line 253</a>.</p>

<a name="165911320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165911320" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165911320">Reid Barton (May 17 2019 at 15:47)</a>:</h4>
<p>I think Patrick sent me a faster version of this proof at some point, let me check whether it got merged...</p>

<a name="165911620"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165911620" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165911620">Reid Barton (May 17 2019 at 15:50)</a>:</h4>
<p>Indeed this is still the old version</p>

<a name="165911914"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165911914" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165911914">Kevin Buzzard (May 17 2019 at 15:53)</a>:</h4>
<p>Did Patrick figure out why it was slow?</p>

<a name="165912091"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165912091" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165912091">Kevin Buzzard (May 17 2019 at 15:55)</a>:</h4>
<p>I think it's kind of important that we understand the various reasons that code ends up running slowly, because if we're not careful then slow code can turn into code which doesn't compile.</p>

<a name="165912131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165912131" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165912131">Reid Barton (May 17 2019 at 15:55)</a>:</h4>
<p>I don't know.</p>

<a name="165912285"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165912285" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165912285">Rob Lewis (May 17 2019 at 15:57)</a>:</h4>
<p>The problem is solving the very last goal <code>g ‚â§ nhds ‚ü¶y‚üß</code>, the second branch of the <code>all_goals</code>. It succeeds with the assumption <code>gy : g ‚â§ nhds (quot.mk setoid.r y)</code> but first it tries <code>gx : g ‚â§ nhds (quot.mk setoid.r x)</code> and takes ages to fail.</p>

<a name="165912459"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165912459" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165912459">Rob Lewis (May 17 2019 at 15:59)</a>:</h4>
<p>Did we not have a variant of <code>assumption</code> that takes a reducibility setting?</p>

<a name="165912854"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165912854" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165912854">Rob Lewis (May 17 2019 at 16:04)</a>:</h4>
<p>Oh, this is a little more subtle, the goal and <code>gy</code> don't unify with only reducible.</p>

<a name="165912926"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165912926" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165912926">Kevin Buzzard (May 17 2019 at 16:05)</a>:</h4>
<p>The other issue is when when I'm writing code, if something turned out super-slow then it makes it very painful to continue writing after that point. One thing I've learnt from this exercise is that sometimes if you understand what's going on then you can actually fix things up and the code compiles quickly and the pain goes away.</p>

<a name="165913036"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165913036" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165913036">Rob Lewis (May 17 2019 at 16:06)</a>:</h4>
<p>The easy patch is</p>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">stone_cech</span><span class="bp">.</span><span class="n">t2_space</span> <span class="o">:</span> <span class="n">t2_space</span> <span class="o">(</span><span class="n">stone_cech</span> <span class="n">Œ±</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="n">t2_iff_ultrafilter</span><span class="o">,</span>
  <span class="n">rintros</span> <span class="n">g</span> <span class="bp">‚ü®</span><span class="n">x</span><span class="bp">‚ü©</span> <span class="bp">‚ü®</span><span class="n">y</span><span class="bp">‚ü©</span> <span class="n">u</span> <span class="n">gx</span> <span class="n">gy</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">quotient</span><span class="bp">.</span><span class="n">sound</span><span class="o">,</span>
  <span class="n">intros</span> <span class="n">Œ≥</span> <span class="n">tŒ≥</span> <span class="n">h‚ÇÅ</span> <span class="n">h‚ÇÇ</span> <span class="n">f</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">resetI</span><span class="o">,</span>
  <span class="n">change</span> <span class="n">stone_cech_extend</span> <span class="n">hf</span> <span class="err">‚ü¶</span><span class="n">x</span><span class="err">‚üß</span> <span class="bp">=</span> <span class="n">stone_cech_extend</span> <span class="n">hf</span> <span class="err">‚ü¶</span><span class="n">y</span><span class="err">‚üß</span><span class="o">,</span>
  <span class="n">refine</span> <span class="n">tendsto_nhds_unique</span> <span class="n">u</span><span class="bp">.</span><span class="mi">1</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">exact</span> <span class="n">stone_cech_extend</span> <span class="n">hf</span> <span class="o">},</span>
  <span class="n">all_goals</span>
  <span class="o">{</span> <span class="n">refine</span> <span class="n">le_trans</span> <span class="o">(</span><span class="n">map_mono</span> <span class="bp">_</span><span class="o">)</span> <span class="o">((</span><span class="n">continuous_stone_cech_extend</span> <span class="n">hf</span><span class="o">)</span><span class="bp">.</span><span class="n">tendsto</span> <span class="bp">_</span><span class="o">)</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">exact</span> <span class="n">gx</span> <span class="o">},</span> <span class="o">{</span> <span class="n">exact</span> <span class="n">gy</span> <span class="o">}</span>
<span class="kn">end</span>
</pre></div>

<a name="165913064"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165913064" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165913064">Rob Lewis (May 17 2019 at 16:06)</a>:</h4>
<p>I'm not sure what can be made irreducible to speed up the failure to unify <code>gx</code>.</p>

<a name="165913184"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165913184" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165913184">Rob Lewis (May 17 2019 at 16:08)</a>:</h4>
<p><code>attribute [irreducible] nhds</code> works but I suspect that will break things.</p>

<a name="165914221"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165914221" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165914221">Reid Barton (May 17 2019 at 16:22)</a>:</h4>
<p>I made a PR with Patrick's proof: <a href="https://github.com/leanprover-community/mathlib/pull/1042" target="_blank" title="https://github.com/leanprover-community/mathlib/pull/1042">https://github.com/leanprover-community/mathlib/pull/1042</a></p>

<a name="165914996"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165914996" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165914996">Rob Lewis (May 17 2019 at 16:33)</a>:</h4>
<p>It looks like making <code>nhds</code> irreducible at the end of <code>topology/order.lean</code> is safe, and this salvages the original proof.</p>

<a name="165915012"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165915012" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165915012">Rob Lewis (May 17 2019 at 16:33)</a>:</h4>
<p>Meaning, the original proof is basically instant.</p>

<a name="165915081"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165915081" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165915081">Rob Lewis (May 17 2019 at 16:34)</a>:</h4>
<p>This is probably a good abstraction barrier too. I assumed it was broken more, but it seems like not.</p>

<a name="165915111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165915111" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165915111">Rob Lewis (May 17 2019 at 16:34)</a>:</h4>
<p>Is Patrick's change preferable to the old one if the old one is equally fast?</p>

<a name="165919009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165919009" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165919009">Kevin Buzzard (May 17 2019 at 17:22)</a>:</h4>
<p>The next one is in <code>data/polynomial.lean</code> and it's <code>card_nth_roots</code>.</p>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">card_nth_roots</span> <span class="o">{</span><span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">integral_domain</span> <span class="n">Œ±</span><span class="o">]</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">Œ±</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">nth_roots</span> <span class="n">n</span> <span class="n">a</span><span class="o">)</span><span class="bp">.</span><span class="n">card</span> <span class="bp">‚â§</span> <span class="n">n</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">letI</span> <span class="o">:=</span> <span class="n">classical</span><span class="bp">.</span><span class="n">prop_decidable</span><span class="bp">;</span> <span class="n">exact</span>
<span class="k">if</span> <span class="n">hn</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">=</span> <span class="mi">0</span>
<span class="k">then</span> <span class="k">if</span> <span class="n">h</span> <span class="o">:</span> <span class="o">(</span><span class="n">X</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">Œ±</span><span class="o">)</span> <span class="err">^</span> <span class="n">n</span> <span class="bp">-</span> <span class="n">C</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="k">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">nat</span><span class="bp">.</span><span class="n">zero_le</span><span class="o">,</span> <span class="n">nth_roots</span><span class="o">,</span> <span class="n">roots</span><span class="o">,</span> <span class="n">h</span><span class="o">,</span> <span class="n">dif_pos</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">card_empty</span><span class="o">]</span>
  <span class="k">else</span> <span class="n">with_bot</span><span class="bp">.</span><span class="n">coe_le_coe</span><span class="bp">.</span><span class="mi">1</span> <span class="o">(</span><span class="n">le_trans</span> <span class="o">(</span><span class="n">card_roots</span> <span class="n">h</span><span class="o">)</span>
    <span class="o">(</span><span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">hn</span><span class="o">,</span> <span class="n">pow_zero</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="bp">@</span><span class="n">C_1</span> <span class="n">Œ±</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">is_ring_hom</span><span class="bp">.</span><span class="n">map_sub</span> <span class="o">(</span><span class="bp">@</span><span class="n">C</span> <span class="n">Œ±</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)]</span><span class="bp">;</span>
      <span class="n">exact</span> <span class="n">degree_C_le</span><span class="o">))</span>
<span class="k">else</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="err">‚Üê</span> <span class="n">with_bot</span><span class="bp">.</span><span class="n">coe_le_coe</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">degree_X_pow_sub_C</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">pos_of_ne_zero</span> <span class="n">hn</span><span class="o">)</span> <span class="n">a</span><span class="o">]</span><span class="bp">;</span>
  <span class="n">exact</span> <span class="n">card_roots</span> <span class="o">(</span><span class="n">X_pow_sub_C_ne_zero</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">pos_of_ne_zero</span> <span class="n">hn</span><span class="o">)</span> <span class="n">a</span><span class="o">)</span>
</pre></div>


<p>It's a whopping <a href="https://github.com/leanprover-community/mathlib/blob/0b350228544244f2861ec8afc84dad0c27113a73/src/data/polynomial.lean#L1770" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/0b350228544244f2861ec8afc84dad0c27113a73/src/data/polynomial.lean#L1770">1770 lines in</a>, and given the amount that Kenny complained about timings for polynomials it's a miracle that Chris managed to make it so long without going insane ;-) Is there an official or unofficial max length for mathlib files? For some reason I thought we were unkeen on going over 1000 lines.</p>

<a name="165919229"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165919229" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165919229">Kevin Buzzard (May 17 2019 at 17:25)</a>:</h4>
<p>ha ha this lemma is true because the zero polynomial is defined to have no roots :D</p>

<a name="165919436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165919436" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165919436">Kevin Buzzard (May 17 2019 at 17:27)</a>:</h4>
<p>How do people actually debug these things? I throw them out and then Rob or Mario says something like "eew this specific thing is happening". I have no idea how to check what is going on at all, other than just setting -T50000 on VS Code and then randomly inserting lines of the form <code>sorry end #exit</code> until I find the problematic line, and even that tells me much less than the things the CS people come up with within minutes.</p>

<a name="165919924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165919924" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165919924">Rob Lewis (May 17 2019 at 17:33)</a>:</h4>
<p>I mean, that's basically it. Sometimes certain lines look suspicious and you start looking there. <code>assumption</code> and <code>convert</code> are likely candidates for this particular kind of problem.</p>

<a name="165919948"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165919948" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165919948">Rob Lewis (May 17 2019 at 17:33)</a>:</h4>
<p><code>set_option profiler true</code> can show if a particular tactic is misbehaving.</p>

<a name="165920078"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165920078" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165920078">Kevin Buzzard (May 17 2019 at 17:34)</a>:</h4>
<p>Aah I'd forgotten about the profiler.</p>
<p>I am very familiar with some <code>set_option</code> things -- the ones I use relatively regularly like <code>pp.all true</code> or implict or proofs or the one that turns on simp lemmas, but the ones I've only used a couple of times I forget about; there should be a list of options ordered by usefulness rather than alphabetically ;-)</p>

<a name="165920559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165920559" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165920559">Kevin Buzzard (May 17 2019 at 17:41)</a>:</h4>
<p>Well, the #exit strategy seems to indicate that it's the <code>    rw [hn, pow_zero, ‚Üê @C_1 Œ± _ _, ‚Üê is_ring_hom.map_sub (@C Œ± _ _)]</code> line</p>

<a name="165920627"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165920627" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165920627">Rob Lewis (May 17 2019 at 17:42)</a>:</h4>
<p>Yep, and in particular, the <code>map_sub</code>.</p>

<a name="165921035"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921035" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921035">Kevin Buzzard (May 17 2019 at 17:47)</a>:</h4>
<p>And the profiler informs us</p>
<div class="codehilite"><pre><span></span>polynomial.lean:1771:6: information
parsing took 27.7ms
polynomial.lean:1771:6: information
type checking of card_nth_roots took 0.0746ms
polynomial.lean:1771:6: information
decl post-processing of card_nth_roots took 0.00477ms
</pre></div>


<p>and then there's a very long pause and it adds</p>
<div class="codehilite"><pre><span></span>polynomial.lean:1771:6: information
elaboration of card_nth_roots took 12.8s
</pre></div>

<a name="165921055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921055" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921055">Kevin Buzzard (May 17 2019 at 17:47)</a>:</h4>
<p>(and that's with <code>sorry end)) else sorry #exit</code> just after the rewrite)</p>

<a name="165921079"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921079" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921079">Chris Hughes (May 17 2019 at 17:47)</a>:</h4>
<p>I think this is another reason in favour of bundled homs.</p>

<a name="165921114"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921114" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921114">Sebastien Gouezel (May 17 2019 at 17:48)</a>:</h4>
<p>In the same direction, I would be happy to make <code>continuous</code> irreducible (as it is a Pi type, it is complicated to unify).</p>

<a name="165921147"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921147" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921147">Mario Carneiro (May 17 2019 at 17:48)</a>:</h4>
<p>I keep convincing myself this has already happened</p>

<a name="165921185"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921185" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921185">Kevin Buzzard (May 17 2019 at 17:48)</a>:</h4>
<div class="codehilite"><pre><span></span>11363ms   100.0%   _private.3200700535.rw_goal._lambda_4
11354ms    99.9%   tactic.to_expr
11354ms    99.9%   tactic.interactive.to_expr&#39;
    9ms     0.1%   tactic.rewrite_target
    8ms     0.1%   tactic.rewrite_core
    8ms     0.1%   tactic.rewrite
    1ms     0.0%   tactic.assert
</pre></div>


<p>if this helps</p>

<a name="165921208"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921208" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921208">Mario Carneiro (May 17 2019 at 17:49)</a>:</h4>
<p><span class="user-mention" data-user-id="110050">@Sebastien Gouezel</span> Due to a bug in lean, marking <code>continuous</code> as irreducible won't fix the issue with <code>apply</code></p>

<a name="165921391"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921391" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921391">Sebastien Gouezel (May 17 2019 at 17:51)</a>:</h4>
<p>Even in Lean 3.5c? :)</p>

<a name="165921424"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921424" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921424">Mario Carneiro (May 17 2019 at 17:51)</a>:</h4>
<p>I haven't looked into it in detail, but I think it should not be hard to fix</p>

<a name="165921562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921562" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921562">Kevin Buzzard (May 17 2019 at 17:53)</a>:</h4>
<div class="codehilite"><pre><span></span>is_ring_hom.map_sub : ‚àÄ {Œ± Œ≤ : Type u_1} [_inst_1 : ring Œ±] [_inst_2 : ring Œ≤] (f : Œ± ‚Üí Œ≤) [_inst_3 : is_ring_hom f] {x y : Œ±}, f (x - y) = f x - f y
</pre></div>


<p>Chris is saying that <code>is_ring_hom</code> should be bundled?</p>

<a name="165921687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921687" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921687">Kevin Buzzard (May 17 2019 at 17:54)</a>:</h4>
<p>Is that one of those PR's where you break 20 files and then fix them all and then PR it and pray that it gets accepted quickly?</p>

<a name="165921706"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165921706" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165921706">Kevin Buzzard (May 17 2019 at 17:54)</a>:</h4>
<p>It should do some nice damage to the perfectoid project too ;-)</p>

<a name="165924231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165924231" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165924231">Kevin Buzzard (May 17 2019 at 18:24)</a>:</h4>
<div class="codehilite"><pre><span></span>class is_linear_map (Œ± : Type u) {Œ≤ : Type v} {Œ≥ : Type w}
  [ring Œ±] [add_comm_group Œ≤] [add_comm_group Œ≥] [module Œ± Œ≤] [module Œ± Œ≥]
  (f : Œ≤ ‚Üí Œ≥) : Prop :=
(add  : ‚àÄx y, f (x + y) = f x + f y)
(smul : ‚àÄ(c : Œ±) x, f (c ‚Ä¢ x) = c ‚Ä¢ f x)
</pre></div>


<p>That doesn't look bundled to me. What is a bundled example of a property of maps?</p>

<a name="165924318"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165924318" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165924318">Johan Commelin (May 17 2019 at 18:25)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> There is also <code>linear_map</code></p>

<a name="165924346"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165924346" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165924346">Johan Commelin (May 17 2019 at 18:25)</a>:</h4>
<p><code>is_linear_map</code> is kind of deprecated</p>

<a name="165924387"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165924387" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165924387">Kevin Buzzard (May 17 2019 at 18:25)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">linear_map</span> <span class="o">(</span><span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">(</span><span class="n">Œ≤</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">)</span> <span class="o">(</span><span class="n">Œ≥</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">)</span>
  <span class="o">[</span><span class="n">ring</span> <span class="n">Œ±</span><span class="o">]</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">Œ≤</span><span class="o">]</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">Œ≥</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="n">Œ±</span> <span class="n">Œ≤</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="n">Œ±</span> <span class="n">Œ≥</span><span class="o">]</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">to_fun</span> <span class="o">:</span> <span class="n">Œ≤</span> <span class="bp">‚Üí</span> <span class="n">Œ≥</span><span class="o">)</span>
<span class="o">(</span><span class="n">add</span>  <span class="o">:</span> <span class="bp">‚àÄ</span><span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">to_fun</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">to_fun</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">to_fun</span> <span class="n">y</span><span class="o">)</span>
<span class="o">(</span><span class="n">smul</span> <span class="o">:</span> <span class="bp">‚àÄ</span><span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">Œ±</span><span class="o">)</span> <span class="n">x</span><span class="o">,</span> <span class="n">to_fun</span> <span class="o">(</span><span class="n">c</span> <span class="err">‚Ä¢</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">c</span> <span class="err">‚Ä¢</span> <span class="n">to_fun</span> <span class="n">x</span><span class="o">)</span>
</pre></div>


<p>Aah yes -- immediately afterwards, in fact! So we have both? Will one be removed one day? Or are they both useful?</p>

<a name="165924446"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165924446" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165924446">Kevin Buzzard (May 17 2019 at 18:26)</a>:</h4>
<blockquote>
<p><code>is_linear_map</code> is kind of deprecated</p>
</blockquote>
<p>I see.</p>

<a name="165924679"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165924679" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165924679">Kevin Buzzard (May 17 2019 at 18:28)</a>:</h4>
<p>Well there are 499 instances of <code>is_ring_hom</code> in mathlib...</p>

<a name="165924742"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165924742" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165924742">Kevin Buzzard (May 17 2019 at 18:29)</a>:</h4>
<p>Do you think we can fix this with a regular expression?</p>

<a name="165924866"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165924866" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165924866">Johan Commelin (May 17 2019 at 18:30)</a>:</h4>
<p>There were more issues. I think Chris spent some time looking into this</p>

<a name="165924873"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165924873" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165924873">Kevin Buzzard (May 17 2019 at 18:30)</a>:</h4>
<p>More seriously, is it the sort of thing that can be done half-heartedly? Someone makes <code>ring_hom</code>, and then every now and then when someone is bored they change a few problematic <code>is_ring_hom</code>s to <code>ring_hom</code>s? Or doesn't life work like that?</p>

<a name="165925891"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165925891" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165925891">Kevin Buzzard (May 17 2019 at 18:43)</a>:</h4>
<p>I guess more generally, is it now believed by the community that <code>is_ring_hom</code> should be deprecated and replaced by a bundled <code>ring_hom</code>, and the only reason it hasn't been done is that it is a non-trivial thing to do which will involve changing 47 files? If so, is there a roadmap for getting it done? Can one start by just adding the definition and trying to change one file? Or does this then involve changing the 5 files it depends on, and then this breaks all the remaining 40-odd files?</p>

<a name="165926033"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165926033" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165926033">Kevin Buzzard (May 17 2019 at 18:44)</a>:</h4>
<p>Does it have to be done quickly? If there is a <code>ring_hom</code> branch then is it the case that if it's left for a week then it inevitably has merge conflicts?</p>

<a name="165926047"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165926047" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165926047">Kevin Buzzard (May 17 2019 at 18:45)</a>:</h4>
<p>Or actually is the jury still out on whether it should be done at all?</p>

<a name="165926097"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165926097" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165926097">Kevin Buzzard (May 17 2019 at 18:45)</a>:</h4>
<p>Sorry to ask such basic questions; I have 0 experience maintaining large projects.</p>

<a name="165926180"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165926180" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165926180">Johan Commelin (May 17 2019 at 18:46)</a>:</h4>
<p>See also <a href="https://github.com/leanprover-community/mathlib/issues/717" target="_blank" title="https://github.com/leanprover-community/mathlib/issues/717">#717</a></p>

<a name="165926374"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165926374" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165926374">Kevin Buzzard (May 17 2019 at 18:49)</a>:</h4>
<p>Oh so field and and ring and group homs all go hand in hand. I'm sorry, I never look at the PRs for mathlib, I only ever scan the ones that get merged.</p>

<a name="165926382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165926382" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165926382">Kevin Buzzard (May 17 2019 at 18:49)</a>:</h4>
<p>Thanks for the link!</p>

<a name="165926492"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165926492" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165926492">Kevin Buzzard (May 17 2019 at 18:50)</a>:</h4>
<p>I can now see Kenny's logic -- do field homs first, because that will be the smallest number of changes.</p>

<a name="165926532"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165926532" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165926532">Johan Commelin (May 17 2019 at 18:51)</a>:</h4>
<p>and monoid homs and add_monoid homs and add_group homs and mul_homs and add_homs and .....</p>

<a name="165926631"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165926631" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165926631">Johan Commelin (May 17 2019 at 18:52)</a>:</h4>
<p>We need <a href="https://www.xkcd.com/208/" target="_blank" title="https://www.xkcd.com/208/">https://www.xkcd.com/208/</a></p>

<a name="165929272"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165929272" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165929272">Kevin Buzzard (May 17 2019 at 19:24)</a>:</h4>
<p>OK I opened an issue for this one: <a href="https://github.com/leanprover-community/mathlib/issues/1044" target="_blank" title="https://github.com/leanprover-community/mathlib/issues/1044">#1044</a> . That way hopefully I can understand better what is going on here.</p>

<a name="165930262"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930262" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930262">Kevin Buzzard (May 17 2019 at 19:38)</a>:</h4>
<p>OK, next one is one of the jewels in the crown of mathlib -- <code>prod_filter_range_p_mul_q_div_two_eq_prod_product</code>.</p>

<a name="165930293"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930293" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930293">Kevin Buzzard (May 17 2019 at 19:39)</a>:</h4>
<p>It's pretty long: </p>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">prod_filter_range_p_mul_q_div_two_eq_prod_product</span> <span class="o">:</span>
  <span class="o">((</span><span class="n">range</span> <span class="o">((</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span><span class="bp">.</span><span class="n">filter</span> <span class="o">(</span><span class="n">coprime</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)))</span><span class="bp">.</span><span class="n">prod</span>
    <span class="o">(</span><span class="bp">Œª</span> <span class="n">x</span><span class="o">,</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span> <span class="bp">‚â§</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span> <span class="k">then</span> <span class="o">((</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">),</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">))</span>
      <span class="k">else</span> <span class="bp">-</span><span class="o">((</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">),</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)))</span> <span class="bp">=</span>
  <span class="o">(((</span><span class="n">range</span> <span class="n">p</span><span class="o">)</span><span class="bp">.</span><span class="n">erase</span> <span class="mi">0</span><span class="o">)</span><span class="bp">.</span><span class="n">product</span> <span class="o">((</span><span class="n">range</span> <span class="o">(</span><span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span><span class="bp">.</span><span class="n">erase</span> <span class="mi">0</span><span class="o">))</span><span class="bp">.</span><span class="n">prod</span>
    <span class="o">(</span><span class="bp">Œª</span> <span class="n">x</span><span class="o">,</span> <span class="o">((</span><span class="n">x</span><span class="bp">.</span><span class="mi">1</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">),</span> <span class="o">(</span><span class="n">x</span><span class="bp">.</span><span class="mi">2</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)))</span> <span class="o">:=</span>
<span class="k">have</span> <span class="n">hpqpnat</span> <span class="o">:</span> <span class="o">(((</span><span class="bp">‚ü®</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">,</span> <span class="n">mul_pos</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span> <span class="n">hq</span><span class="bp">.</span><span class="n">pos</span><span class="bp">‚ü©</span> <span class="o">:</span> <span class="bp">‚Ñï+</span><span class="o">)</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">)</span> <span class="o">:</span> <span class="bp">‚Ñ§</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="o">:</span> <span class="bp">‚Ñ§</span><span class="o">),</span> <span class="k">by</span> <span class="n">simp</span><span class="o">,</span>
<span class="k">have</span> <span class="n">hpqpnat&#39;</span> <span class="o">:</span> <span class="o">((</span><span class="bp">‚ü®</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">,</span> <span class="n">mul_pos</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span> <span class="n">hq</span><span class="bp">.</span><span class="n">pos</span><span class="bp">‚ü©</span> <span class="o">:</span> <span class="bp">‚Ñï+</span><span class="o">)</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">)</span> <span class="bp">=</span> <span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">,</span> <span class="k">by</span> <span class="n">simp</span><span class="o">,</span>
<span class="k">have</span> <span class="n">hpq1</span> <span class="o">:</span> <span class="o">((</span><span class="bp">‚ü®</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">,</span> <span class="n">mul_pos</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span> <span class="n">hq</span><span class="bp">.</span><span class="n">pos</span><span class="bp">‚ü©</span> <span class="o">:</span> <span class="bp">‚Ñï+</span><span class="o">)</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">)</span> <span class="err">%</span> <span class="mi">2</span> <span class="bp">=</span> <span class="mi">1</span><span class="o">,</span>
  <span class="k">from</span> <span class="n">nat</span><span class="bp">.</span><span class="n">odd_mul_odd</span> <span class="n">hp1</span> <span class="n">hq1</span><span class="o">,</span>
<span class="k">have</span> <span class="n">hpq1&#39;</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">&gt;</span> <span class="mi">1</span><span class="o">,</span> <span class="k">from</span> <span class="n">one_lt_mul</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span> <span class="n">hq</span><span class="bp">.</span><span class="n">gt_one</span><span class="o">,</span>
<span class="k">have</span> <span class="n">hhq0</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">a</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">,</span> <span class="n">coprime</span> <span class="n">q</span> <span class="n">a</span> <span class="bp">‚Üí</span> <span class="n">a</span> <span class="bp">‚â†</span> <span class="mi">0</span><span class="o">,</span>
  <span class="k">from</span> <span class="bp">Œª</span> <span class="n">a</span><span class="o">,</span> <span class="n">imp_not_comm</span><span class="bp">.</span><span class="mi">1</span> <span class="err">$</span> <span class="k">by</span> <span class="n">simp</span> <span class="o">[</span><span class="n">hq</span><span class="bp">.</span><span class="n">coprime_iff_not_dvd</span><span class="o">]</span> <span class="o">{</span><span class="n">contextual</span> <span class="o">:=</span> <span class="n">tt</span><span class="o">},</span>
<span class="k">have</span> <span class="n">hpq0</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">,</span> <span class="k">from</span> <span class="n">nat</span><span class="bp">.</span><span class="n">div_pos</span> <span class="o">(</span><span class="n">succ_le_of_lt</span> <span class="err">$</span> <span class="n">one_lt_mul</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span> <span class="n">hq</span><span class="bp">.</span><span class="n">gt_one</span><span class="o">)</span> <span class="n">dec_trivial</span><span class="o">,</span>
<span class="k">have</span> <span class="n">hinj</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">a‚ÇÅ</span> <span class="n">a‚ÇÇ</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">,</span>
    <span class="n">a‚ÇÅ</span> <span class="err">‚àà</span> <span class="o">(</span><span class="n">range</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span><span class="bp">.</span><span class="n">filter</span> <span class="o">(</span><span class="n">coprime</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">))</span> <span class="bp">‚Üí</span>
    <span class="n">a‚ÇÇ</span> <span class="err">‚àà</span> <span class="o">(</span><span class="n">range</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span><span class="bp">.</span><span class="n">filter</span> <span class="o">(</span><span class="n">coprime</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">))</span> <span class="bp">‚Üí</span>
    <span class="o">(</span><span class="k">if</span> <span class="o">(</span><span class="n">a‚ÇÅ</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span> <span class="bp">‚â§</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span> <span class="k">then</span> <span class="o">((</span><span class="n">a‚ÇÅ</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="o">(</span><span class="n">a‚ÇÅ</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">)</span>
      <span class="k">else</span> <span class="o">((</span><span class="bp">-</span><span class="n">a‚ÇÅ</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="o">(</span><span class="bp">-</span><span class="n">a‚ÇÅ</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">))</span> <span class="bp">=</span>
    <span class="o">(</span><span class="k">if</span> <span class="o">(</span><span class="n">a‚ÇÇ</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span> <span class="bp">‚â§</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span> <span class="k">then</span> <span class="o">((</span><span class="n">a‚ÇÇ</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="o">(</span><span class="n">a‚ÇÇ</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">)</span>
      <span class="k">else</span> <span class="o">((</span><span class="bp">-</span><span class="n">a‚ÇÇ</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="o">(</span><span class="bp">-</span><span class="n">a‚ÇÇ</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">))</span> <span class="bp">‚Üí</span> <span class="n">a‚ÇÅ</span> <span class="bp">=</span> <span class="n">a‚ÇÇ</span><span class="o">,</span>
  <span class="k">from</span> <span class="bp">Œª</span> <span class="n">a</span> <span class="n">b</span> <span class="n">ha</span> <span class="n">hb</span> <span class="n">h</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">ha&#39;</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">‚â§</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">‚àß</span> <span class="n">coprime</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)</span> <span class="n">a</span><span class="o">,</span>
      <span class="k">by</span> <span class="n">simpa</span> <span class="o">[</span><span class="n">lt_succ_iff</span><span class="o">]</span> <span class="kn">using</span> <span class="n">ha</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">hapq&#39;</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">&lt;</span> <span class="o">((</span><span class="bp">‚ü®</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">,</span> <span class="n">mul_pos</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span> <span class="n">hq</span><span class="bp">.</span><span class="n">pos</span><span class="bp">‚ü©</span> <span class="o">:</span> <span class="bp">‚Ñï+</span><span class="o">)</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">)</span> <span class="o">:=</span>
      <span class="n">lt_of_le_of_lt</span> <span class="n">ha&#39;</span><span class="bp">.</span><span class="mi">1</span> <span class="o">(</span><span class="n">div_lt_self</span> <span class="o">(</span><span class="n">mul_pos</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span> <span class="n">hq</span><span class="bp">.</span><span class="n">pos</span><span class="o">)</span> <span class="n">dec_trivial</span><span class="o">),</span>
    <span class="k">have</span> <span class="n">hb&#39;</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">‚â§</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">‚àß</span> <span class="n">coprime</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)</span> <span class="n">b</span><span class="o">,</span>
      <span class="k">by</span> <span class="n">simpa</span> <span class="o">[</span><span class="n">lt_succ_iff</span><span class="o">,</span> <span class="n">coprime_mul_iff_left</span><span class="o">]</span> <span class="kn">using</span> <span class="n">hb</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">hbpq&#39;</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">&lt;</span> <span class="o">((</span><span class="bp">‚ü®</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">,</span> <span class="n">mul_pos</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span> <span class="n">hq</span><span class="bp">.</span><span class="n">pos</span><span class="bp">‚ü©</span> <span class="o">:</span> <span class="bp">‚Ñï+</span><span class="o">)</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">)</span> <span class="o">:=</span>
      <span class="n">lt_of_le_of_lt</span> <span class="n">hb&#39;</span><span class="bp">.</span><span class="mi">1</span> <span class="o">(</span><span class="n">div_lt_self</span> <span class="o">(</span><span class="n">mul_pos</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span> <span class="n">hq</span><span class="bp">.</span><span class="n">pos</span><span class="o">)</span> <span class="n">dec_trivial</span><span class="o">),</span>
    <span class="k">have</span> <span class="n">val_inj</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">}</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">),</span> <span class="n">x</span><span class="bp">.</span><span class="n">val</span> <span class="bp">=</span> <span class="n">y</span><span class="bp">.</span><span class="n">val</span> <span class="bp">‚Üî</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">y</span><span class="o">,</span>
      <span class="k">from</span> <span class="bp">Œª</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">‚ü®</span><span class="n">fin</span><span class="bp">.</span><span class="n">eq_of_veq</span><span class="o">,</span> <span class="n">fin</span><span class="bp">.</span><span class="n">veq_of_eq</span><span class="bp">‚ü©</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">hbpq0</span> <span class="o">:</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">zmod</span> <span class="o">(</span><span class="bp">‚ü®</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">,</span> <span class="n">mul_pos</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span> <span class="n">hq</span><span class="bp">.</span><span class="n">pos</span><span class="bp">‚ü©</span><span class="o">))</span> <span class="bp">‚â†</span> <span class="mi">0</span><span class="o">,</span>
      <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">ne</span><span class="bp">.</span><span class="n">def</span><span class="o">,</span> <span class="n">zmod</span><span class="bp">.</span><span class="n">eq_zero_iff_dvd_nat</span><span class="o">]</span><span class="bp">;</span>
        <span class="n">exact</span> <span class="bp">Œª</span> <span class="n">h</span><span class="o">,</span> <span class="n">not_coprime_of_dvd_of_dvd</span> <span class="n">hpq1&#39;</span> <span class="o">(</span><span class="n">dvd_refl</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">))</span> <span class="n">h</span> <span class="n">hb&#39;</span><span class="bp">.</span><span class="mi">2</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">habneg</span> <span class="o">:</span> <span class="bp">¬¨</span><span class="o">((</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">-</span><span class="n">b</span> <span class="bp">‚àß</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">-</span><span class="n">b</span><span class="o">),</span>
      <span class="k">begin</span>
        <span class="n">rw</span> <span class="o">[</span><span class="err">‚Üê</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_coe_nat</span> <span class="n">a</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_coe_nat</span> <span class="n">b</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_coe_nat</span> <span class="n">a</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_coe_nat</span> <span class="n">b</span><span class="o">,</span>
          <span class="err">‚Üê</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_neg</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_neg</span><span class="o">,</span> <span class="n">zmodp</span><span class="bp">.</span><span class="n">eq_iff_modeq_int</span><span class="o">,</span> <span class="n">zmodp</span><span class="bp">.</span><span class="n">eq_iff_modeq_int</span><span class="o">,</span>
          <span class="bp">@</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">modeq_and_modeq_iff_modeq_mul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">p</span> <span class="n">q</span> <span class="o">((</span><span class="n">coprime_primes</span> <span class="n">hp</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span> <span class="n">hpq</span><span class="o">),</span> <span class="err">‚Üê</span> <span class="n">hpqpnat</span><span class="o">,</span>
          <span class="err">‚Üê</span> <span class="n">zmod</span><span class="bp">.</span><span class="n">eq_iff_modeq_int</span><span class="o">,</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_coe_nat</span><span class="o">,</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_neg</span><span class="o">,</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_coe_nat</span><span class="o">],</span>
        <span class="k">assume</span> <span class="n">h</span><span class="o">,</span>
        <span class="n">rw</span> <span class="o">[</span><span class="err">‚Üê</span> <span class="n">hpqpnat&#39;</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">zmod</span><span class="bp">.</span><span class="n">val_cast_of_lt</span> <span class="n">hbpq&#39;</span><span class="o">,</span> <span class="n">zmod</span><span class="bp">.</span><span class="n">le_div_two_iff_lt_neg</span> <span class="n">hpq1</span> <span class="n">hbpq0</span><span class="o">,</span>
          <span class="err">‚Üê</span> <span class="n">h</span><span class="o">,</span> <span class="n">zmod</span><span class="bp">.</span><span class="n">val_cast_of_lt</span> <span class="n">hapq&#39;</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">not_le</span><span class="o">]</span> <span class="n">at</span> <span class="n">hb&#39;</span><span class="o">,</span>
        <span class="n">exact</span> <span class="n">hb&#39;</span><span class="bp">.</span><span class="mi">1</span> <span class="n">ha&#39;</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span>
      <span class="kn">end</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">habneg&#39;</span> <span class="o">:</span> <span class="bp">¬¨</span><span class="o">((</span><span class="bp">-</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">‚àß</span> <span class="o">(</span><span class="bp">-</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span> <span class="bp">=</span> <span class="n">b</span><span class="o">),</span>
      <span class="k">by</span> <span class="n">rwa</span> <span class="o">[</span><span class="err">‚Üê</span> <span class="n">neg_inj&#39;</span><span class="o">,</span> <span class="n">neg_neg</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="bp">@</span><span class="n">neg_inj&#39;</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="bp">-</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">),</span> <span class="n">neg_neg</span><span class="o">],</span>
    <span class="n">suffices</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">‚àß</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span> <span class="bp">=</span> <span class="n">b</span><span class="o">,</span>
      <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="err">‚Üê</span> <span class="n">mod_eq_of_lt</span> <span class="n">hapq&#39;</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">mod_eq_of_lt</span> <span class="n">hbpq&#39;</span><span class="o">]</span><span class="bp">;</span>
        <span class="n">rwa</span> <span class="o">[</span><span class="n">zmodp</span><span class="bp">.</span><span class="n">eq_iff_modeq_nat</span><span class="o">,</span> <span class="n">zmodp</span><span class="bp">.</span><span class="n">eq_iff_modeq_nat</span><span class="o">,</span>
          <span class="n">nat</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">modeq_and_modeq_iff_modeq_mul</span> <span class="o">((</span><span class="n">coprime_primes</span> <span class="n">hp</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span> <span class="n">hpq</span><span class="o">)]</span> <span class="n">at</span> <span class="n">this</span><span class="o">,</span>
    <span class="k">by</span> <span class="n">split_ifs</span> <span class="n">at</span> <span class="n">h</span><span class="bp">;</span> <span class="n">simp</span> <span class="bp">*</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
<span class="k">have</span> <span class="n">hmem</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">a</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">,</span>
    <span class="n">a</span> <span class="err">‚àà</span> <span class="o">(</span><span class="n">range</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span><span class="bp">.</span><span class="n">filter</span> <span class="o">(</span><span class="n">coprime</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">))</span> <span class="bp">‚Üí</span>
    <span class="o">(</span><span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span> <span class="bp">‚â§</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span> <span class="k">then</span> <span class="o">((</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">)</span>
      <span class="k">else</span> <span class="o">((</span><span class="bp">-</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="o">(</span><span class="bp">-</span><span class="n">a</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">))</span> <span class="err">‚àà</span>
      <span class="o">((</span><span class="n">range</span> <span class="n">p</span><span class="o">)</span><span class="bp">.</span><span class="n">erase</span> <span class="mi">0</span><span class="o">)</span><span class="bp">.</span><span class="n">product</span> <span class="o">((</span><span class="n">range</span> <span class="o">(</span><span class="n">succ</span> <span class="o">(</span><span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)))</span><span class="bp">.</span><span class="n">erase</span> <span class="mi">0</span><span class="o">),</span>
  <span class="k">from</span> <span class="bp">Œª</span> <span class="n">x</span><span class="o">,</span> <span class="k">have</span> <span class="n">hxp</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">}</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">),</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="n">val</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">‚Üî</span> <span class="n">p</span> <span class="err">‚à£</span> <span class="n">x</span><span class="o">,</span>
    <span class="k">from</span> <span class="bp">Œª</span> <span class="n">p</span> <span class="n">hp</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">zmodp</span><span class="bp">.</span><span class="n">val_cast_nat</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">dvd_iff_mod_eq_zero</span><span class="o">],</span>
  <span class="k">have</span> <span class="n">hxpneg</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="bp">‚Ñï</span><span class="o">}</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">),</span> <span class="o">(</span><span class="bp">-</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="n">val</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">‚Üî</span> <span class="n">p</span> <span class="err">‚à£</span> <span class="n">x</span><span class="o">,</span>
    <span class="k">from</span> <span class="bp">Œª</span> <span class="n">p</span> <span class="n">hp</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="err">‚Üê</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_coe_nat</span> <span class="n">x</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast_neg</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">int</span><span class="bp">.</span><span class="n">coe_nat_inj&#39;</span><span class="o">,</span>
      <span class="n">zmodp</span><span class="bp">.</span><span class="n">coe_val_cast_int</span><span class="o">,</span> <span class="n">int</span><span class="bp">.</span><span class="n">coe_nat_zero</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">int</span><span class="bp">.</span><span class="n">dvd_iff_mod_eq_zero</span><span class="o">,</span> <span class="n">dvd_neg</span><span class="o">,</span> <span class="n">int</span><span class="bp">.</span><span class="n">coe_nat_dvd</span><span class="o">],</span>
  <span class="k">have</span> <span class="n">hxplt</span> <span class="o">:</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="n">val</span> <span class="bp">&lt;</span> <span class="n">p</span> <span class="o">:=</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">hxpltneg</span> <span class="o">:</span> <span class="o">(</span><span class="bp">-</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="n">val</span> <span class="bp">&lt;</span> <span class="n">p</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">-</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">hneglt</span> <span class="o">:</span> <span class="bp">¬¨</span><span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="n">val</span> <span class="bp">‚â§</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">‚Üí</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span> <span class="bp">‚â†</span> <span class="mi">0</span> <span class="bp">‚Üí</span> <span class="o">(</span><span class="bp">-</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="n">val</span> <span class="bp">‚â§</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">,</span>
    <span class="k">from</span> <span class="bp">Œª</span> <span class="n">hx‚ÇÅ</span> <span class="n">hx0</span><span class="o">,</span> <span class="k">by</span> <span class="n">rwa</span> <span class="o">[</span><span class="n">zmodp</span><span class="bp">.</span><span class="n">le_div_two_iff_lt_neg</span> <span class="n">hq</span> <span class="n">hq1</span> <span class="n">hx0</span><span class="o">,</span> <span class="n">not_lt</span><span class="o">]</span> <span class="n">at</span> <span class="n">hx‚ÇÅ</span><span class="o">,</span>
  <span class="k">by</span> <span class="n">split_ifs</span><span class="bp">;</span>
    <span class="n">simp</span> <span class="o">[</span><span class="n">zmodp</span><span class="bp">.</span><span class="n">eq_zero_iff_dvd_nat</span> <span class="n">hq</span><span class="o">,</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span><span class="o">,</span> <span class="n">coprime_mul_iff_left</span><span class="o">,</span>
      <span class="n">lt_succ_iff</span><span class="o">,</span> <span class="n">h</span><span class="o">,</span> <span class="bp">*</span><span class="o">,</span> <span class="n">hp</span><span class="bp">.</span><span class="n">coprime_iff_not_dvd</span><span class="o">,</span>
      <span class="n">hq</span><span class="bp">.</span><span class="n">coprime_iff_not_dvd</span><span class="o">,</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span><span class="o">,</span> <span class="o">(</span><span class="bp">-</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span><span class="o">]</span> <span class="o">{</span><span class="n">contextual</span> <span class="o">:=</span> <span class="n">tt</span><span class="o">},</span>
<span class="n">prod_bij</span> <span class="o">(</span><span class="bp">Œª</span> <span class="n">x</span> <span class="bp">_</span><span class="o">,</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span> <span class="bp">‚â§</span> <span class="o">(</span><span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span> <span class="k">then</span> <span class="o">((</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="n">val</span><span class="o">,</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="n">val</span><span class="o">)</span>
      <span class="k">else</span> <span class="o">((</span><span class="bp">-</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">p</span> <span class="n">hp</span><span class="o">)</span><span class="bp">.</span><span class="n">val</span><span class="o">,</span> <span class="o">(</span><span class="bp">-</span><span class="n">x</span> <span class="o">:</span> <span class="n">zmodp</span> <span class="n">q</span> <span class="n">hq</span><span class="o">)</span><span class="bp">.</span><span class="n">val</span><span class="o">))</span>
  <span class="n">hmem</span>
  <span class="o">(</span><span class="bp">Œª</span> <span class="n">a</span> <span class="n">ha</span><span class="o">,</span> <span class="k">by</span> <span class="n">split_ifs</span><span class="bp">;</span> <span class="n">simp</span> <span class="o">[</span><span class="bp">*</span><span class="o">,</span> <span class="n">prod</span><span class="bp">.</span><span class="n">ext_iff</span><span class="o">]</span> <span class="n">at</span> <span class="bp">*</span><span class="o">)</span>
  <span class="n">hinj</span>
  <span class="o">(</span><span class="n">surj_on_of_inj_on_of_card_le</span> <span class="bp">_</span> <span class="n">hmem</span> <span class="n">hinj</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">nat</span><span class="bp">.</span><span class="n">le_of_add_le_add_right</span> <span class="o">(</span><span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">+</span> <span class="o">(</span><span class="n">p</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span>
      <span class="o">(</span><span class="k">calc</span> <span class="n">card</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">product</span> <span class="o">(</span><span class="n">erase</span> <span class="o">(</span><span class="n">range</span> <span class="n">p</span><span class="o">)</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">erase</span> <span class="o">(</span><span class="n">range</span> <span class="o">(</span><span class="n">succ</span> <span class="o">(</span><span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)))</span> <span class="mi">0</span><span class="o">))</span> <span class="bp">+</span> <span class="o">(</span><span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">+</span> <span class="o">(</span><span class="n">p</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span>
            <span class="bp">=</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">+</span> <span class="mi">1</span> <span class="o">:</span>
          <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">card_product</span><span class="o">,</span> <span class="n">card_erase_of_mem</span> <span class="o">(</span><span class="n">mem_range</span><span class="bp">.</span><span class="mi">2</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span><span class="o">),</span> <span class="n">card_erase_of_mem</span> <span class="o">(</span><span class="n">mem_range</span><span class="bp">.</span><span class="mi">2</span> <span class="o">(</span><span class="n">succ_pos</span> <span class="bp">_</span><span class="o">)),</span>
            <span class="n">card_range</span><span class="o">,</span> <span class="n">card_range</span><span class="o">,</span> <span class="n">pred_succ</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">add_assoc</span><span class="o">,</span> <span class="err">‚Üê</span> <span class="n">succ_mul</span><span class="o">,</span> <span class="n">succ_pred_eq_of_pos</span> <span class="n">hp</span><span class="bp">.</span><span class="n">pos</span><span class="o">,</span>
            <span class="n">odd_mul_odd_div_two</span> <span class="n">hp1</span> <span class="n">hq1</span><span class="o">,</span> <span class="n">add_succ</span><span class="o">]</span>
        <span class="bp">...</span> <span class="bp">=</span> <span class="n">card</span> <span class="o">(</span><span class="n">range</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span> <span class="o">:</span> <span class="k">by</span> <span class="n">rw</span> <span class="n">card_range</span>
        <span class="bp">...</span> <span class="bp">=</span> <span class="n">card</span> <span class="o">((</span><span class="n">range</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span><span class="bp">.</span><span class="n">filter</span> <span class="o">(</span><span class="n">coprime</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">))</span> <span class="err">‚à™</span>
                    <span class="o">((</span><span class="n">range</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span><span class="bp">.</span><span class="n">filter</span> <span class="o">(</span><span class="bp">Œª</span> <span class="n">x</span><span class="o">,</span> <span class="bp">¬¨</span><span class="n">coprime</span> <span class="n">p</span> <span class="n">x</span><span class="o">))</span><span class="bp">.</span><span class="n">erase</span> <span class="mi">0</span> <span class="err">‚à™</span>
                    <span class="o">(</span><span class="n">range</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span><span class="bp">.</span><span class="n">filter</span> <span class="o">(</span><span class="bp">Œª</span> <span class="n">x</span><span class="o">,</span> <span class="bp">¬¨</span><span class="n">coprime</span> <span class="n">q</span> <span class="n">x</span><span class="o">))</span> <span class="o">:</span>
          <span class="n">congr_arg</span> <span class="n">card</span> <span class="o">(</span><span class="k">by</span> <span class="n">simp</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">ext</span><span class="o">,</span> <span class="n">coprime_mul_iff_left</span><span class="o">]</span><span class="bp">;</span> <span class="n">tauto</span><span class="o">)</span>
        <span class="bp">...</span> <span class="bp">‚â§</span> <span class="n">card</span> <span class="o">((</span><span class="n">range</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span><span class="bp">.</span><span class="n">filter</span> <span class="o">(</span><span class="n">coprime</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)))</span> <span class="bp">+</span>
              <span class="n">card</span> <span class="o">(((</span><span class="n">range</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span><span class="bp">.</span><span class="n">filter</span> <span class="o">(</span><span class="bp">Œª</span> <span class="n">x</span><span class="o">,</span> <span class="bp">¬¨</span><span class="n">coprime</span> <span class="n">p</span> <span class="n">x</span><span class="o">))</span><span class="bp">.</span><span class="n">erase</span> <span class="mi">0</span><span class="o">)</span> <span class="bp">+</span>
              <span class="n">card</span> <span class="o">((</span><span class="n">range</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span><span class="bp">.</span><span class="n">filter</span> <span class="o">(</span><span class="bp">Œª</span> <span class="n">x</span><span class="o">,</span> <span class="bp">¬¨</span><span class="n">coprime</span> <span class="n">q</span> <span class="n">x</span><span class="o">))</span> <span class="o">:</span>
          <span class="n">le_trans</span> <span class="o">(</span><span class="n">card_union_le</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span> <span class="o">(</span><span class="n">add_le_add_right</span> <span class="o">(</span><span class="n">card_union_le</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span> <span class="bp">_</span><span class="o">)</span>
        <span class="bp">...</span> <span class="bp">=</span> <span class="bp">_</span> <span class="o">:</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">card_erase_of_mem</span><span class="o">,</span> <span class="n">card_range_p_mul_q_filter_not_coprime</span> <span class="n">hp</span> <span class="n">hq</span> <span class="n">hp1</span> <span class="n">hq1</span> <span class="n">hpq</span><span class="o">,</span>
              <span class="n">mul_comm</span> <span class="n">p</span> <span class="n">q</span><span class="o">,</span> <span class="n">card_range_p_mul_q_filter_not_coprime</span> <span class="n">hq</span> <span class="n">hp</span> <span class="n">hq1</span> <span class="n">hp1</span> <span class="n">hpq</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span> <span class="n">pred_succ</span><span class="o">,</span>
              <span class="n">add_assoc</span><span class="o">]</span><span class="bp">;</span>
            <span class="n">simp</span> <span class="o">[</span><span class="n">range_succ</span><span class="o">,</span> <span class="n">hp</span><span class="bp">.</span><span class="n">coprime_iff_not_dvd</span><span class="o">,</span> <span class="n">hpq0</span><span class="o">])))</span>
</pre></div>

<a name="165930311"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930311" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930311">Floris van Doorn (May 17 2019 at 19:39)</a>:</h4>
<p>I opened a PR to fix the first T50000-challenge issue: <a href="https://github.com/leanprover-community/mathlib/pull/1045" target="_blank" title="https://github.com/leanprover-community/mathlib/pull/1045">https://github.com/leanprover-community/mathlib/pull/1045</a></p>

<a name="165930425"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930425" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930425">Kevin Buzzard (May 17 2019 at 19:40)</a>:</h4>
<p>It's in <a href="https://github.com/leanprover-community/mathlib/blob/45afa86e6e45ea4f2afa5dd5881cb5af7210a139/src/data/zmod/quadratic_reciprocity.lean#L291" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/45afa86e6e45ea4f2afa5dd5881cb5af7210a139/src/data/zmod/quadratic_reciprocity.lean#L291"><code>data/zmod/quadratic_reciprocity.lean</code></a>, line 291.</p>

<a name="165930455"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930455" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930455">Kevin Buzzard (May 17 2019 at 19:41)</a>:</h4>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> I wasn't sure whether you thought it was worth fixing. I can see the appeal of proving something by <code>rfl</code>.</p>

<a name="165930481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930481" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930481">Kevin Buzzard (May 17 2019 at 19:41)</a>:</h4>
<p>This number theory one is a key lemma in the proof of quadratic reciprocity.</p>

<a name="165930541"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930541" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930541">Mario Carneiro (May 17 2019 at 19:42)</a>:</h4>
<p>Of course some proofs take a long time because they are actually big proofs</p>

<a name="165930546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930546" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930546">Kevin Buzzard (May 17 2019 at 19:42)</a>:</h4>
<p>Right!</p>

<a name="165930553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930553" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930553">Kevin Buzzard (May 17 2019 at 19:42)</a>:</h4>
<p>That of course could be what's going on here.</p>

<a name="165930579"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930579" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930579">Kevin Buzzard (May 17 2019 at 19:42)</a>:</h4>
<p>Hmm, it's really high time I left the office. I'll maybe look at this one on the subway.</p>

<a name="165930580"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930580" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930580">Mario Carneiro (May 17 2019 at 19:42)</a>:</h4>
<p>One option is to break it up into subparts</p>

<a name="165930595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930595" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930595">Kevin Buzzard (May 17 2019 at 19:43)</a>:</h4>
<p><span class="user-mention" data-user-id="110044">@Chris Hughes</span> would that be feasible?</p>

<a name="165930745"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930745" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930745">Kevin Buzzard (May 17 2019 at 19:45)</a>:</h4>
<p>I guess another issue is that for several of the other timeouts, it has been manifestly clear that changing mathlib to fix the timeout was a good idea. Here that's not so clear to me, if it's simply one long proof that nobody is interested in the subparts of.</p>

<a name="165930784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930784" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930784">Kevin Buzzard (May 17 2019 at 19:45)</a>:</h4>
<p>The proof of quadratic reciprocity that we have is the standard counting proof, basically looking at the lattices points in Z^2 with 0&lt;=x&lt;p/2 and 0&lt;=y&lt;q/2 and then counting them in a slightly funny way</p>

<a name="165930850"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930850" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930850">Kevin Buzzard (May 17 2019 at 19:46)</a>:</h4>
<p>It might really be the case that these lemmas are of no use anywhere else.</p>

<a name="165930869"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165930869" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165930869">Kevin Buzzard (May 17 2019 at 19:47)</a>:</h4>
<p>I saw these lemmas when I was still at high school and I don't think I've ever seen them in any other context, and I'm a professional number theorist.</p>

<a name="165931647"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165931647" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165931647">Johan Commelin (May 17 2019 at 19:59)</a>:</h4>
<p>Well... speed-ups are always nice (-;</p>

<a name="165931672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165931672" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165931672">Johan Commelin (May 17 2019 at 19:59)</a>:</h4>
<p>This file is probably compiled quite often... everytime something in the root of the hierarchy changes</p>

<a name="165933797"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165933797" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165933797">Mario Carneiro (May 17 2019 at 20:27)</a>:</h4>
<p>If you break a theorem into two parts it doesn't make it go faster</p>

<a name="165933856"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165933856" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165933856">Mario Carneiro (May 17 2019 at 20:28)</a>:</h4>
<p>although you will be able to avoid the timeout</p>

<a name="165933890"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165933890" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165933890">Mario Carneiro (May 17 2019 at 20:28)</a>:</h4>
<p>However, another reason to break up long proofs is if you want to step through it or modify it... it's the same issue with long files</p>

<a name="165933904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165933904" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165933904">Johan Commelin (May 17 2019 at 20:29)</a>:</h4>
<p>... and the same issue with long papers...</p>

<a name="165933922"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165933922" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165933922">Kevin Buzzard (May 17 2019 at 20:29)</a>:</h4>
<p><code>elaboration of prod_filter_range_p_mul_q_div_two_eq_prod_product took 22.6s</code></p>

<a name="165933942"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165933942" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165933942">Johan Commelin (May 17 2019 at 20:30)</a>:</h4>
<p>That's still faster than I was when I first read that proof (-;</p>

<a name="165934051"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165934051" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165934051">Kevin Buzzard (May 17 2019 at 20:31)</a>:</h4>
<p>There's only a few to go.</p>

<a name="165934066"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165934066" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165934066">Kevin Buzzard (May 17 2019 at 20:31)</a>:</h4>
<p>[PS Chris' proof is basically all in term mode, so one would have to think about how to break it up]</p>

<a name="165934196"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165934196" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165934196">Kevin Buzzard (May 17 2019 at 20:33)</a>:</h4>
<p>The next one is the open mapping theorem. Again this might just be because it's a long proof.</p>

<a name="165934306"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165934306" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165934306">Kevin Buzzard (May 17 2019 at 20:34)</a>:</h4>
<p>It's nearly 150 lines -- <code>exists_preimage_norm_le</code> in <code>analysis/normed_space/banach.lean</code>, <a href="https://github.com/leanprover-community/mathlib/blob/5e5298b9273b44aa06e3b30aa064cf866cd8152a/src/analysis/normed_space/banach.lean#L29" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/5e5298b9273b44aa06e3b30aa064cf866cd8152a/src/analysis/normed_space/banach.lean#L29">line 29</a></p>

<a name="165934489"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165934489" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165934489">Kevin Buzzard (May 17 2019 at 20:36)</a>:</h4>
<p>I guess it's one variant of the open mapping theorem. Sebastien says that the proof falls naturally into two halves but it's still formalised as one big proof.</p>

<a name="165934652"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165934652" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165934652">Kevin Buzzard (May 17 2019 at 20:38)</a>:</h4>
<p>At least this one is in tactic mode but again it's difficult for me to tell whether there's something bad in the proof or whether it's just long, and it's also difficult for me to tell whether it's worth breaking up the proof into smaller chunks. <span class="user-mention" data-user-id="110050">@Sebastien Gouezel</span> do you have an opinion on this? Your proof takes a long time to elaborate, apparently. Is this just because it's long?</p>

<a name="165934733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165934733" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165934733">Kevin Buzzard (May 17 2019 at 20:39)</a>:</h4>
<p>I'm amazed you could write any code after it :D</p>

<a name="165934803"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165934803" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165934803">Kevin Buzzard (May 17 2019 at 20:40)</a>:</h4>
<p><code>elaboration of exists_preimage_norm_le took 18.9s</code>. That's a long time to wait after each keypress ;-)</p>

<a name="165935008"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165935008" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165935008">Kevin Buzzard (May 17 2019 at 20:43)</a>:</h4>
<p>Sebastien is also responsible for <code>GH_dist_le_of_approx_subsets</code> in <code>topology/metric_space/gromov_hausdorff.lean</code>, which is the next timeout.</p>

<a name="165935040"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165935040" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165935040">Kevin Buzzard (May 17 2019 at 20:43)</a>:</h4>
<p>That one is only about 67 lines long -- so there might be something funny going on in that one.</p>

<a name="165935269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165935269" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165935269">Sebastien Gouezel (May 17 2019 at 20:46)</a>:</h4>
<p>You can write such a proof interactively by sorrying big chunks of it, and then putting back everything together once every bit compiles. And you can also buy a faster computer :)</p>

<a name="165935536"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165935536" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165935536">Sebastien Gouezel (May 17 2019 at 20:49)</a>:</h4>
<p>I am sure this can be made faster, but I don't know where the bottlenecks are. A tutorial on optimization, based on this one example of <code>exists_preimage_norm_le</code>, would be much appreciated. In particular, I can't tell if typeclass inference takes a lot of time, or unification, or it's just that everything is nontrivial.</p>

<a name="165936232"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165936232" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165936232">Sebastien Gouezel (May 17 2019 at 20:58)</a>:</h4>
<p>For instance, in the middle of the proof, there is a calc block</p>
<div class="codehilite"><pre><span></span><span class="err">‚à•</span><span class="n">f</span> <span class="o">(</span><span class="n">d</span><span class="bp">‚Åª¬π</span> <span class="err">‚Ä¢</span> <span class="n">x</span><span class="o">)</span> <span class="bp">-</span> <span class="n">y</span><span class="err">‚à•</span> <span class="bp">=</span> <span class="err">‚à•</span><span class="n">d</span><span class="bp">‚Åª¬π</span> <span class="err">‚Ä¢</span> <span class="n">f</span> <span class="n">x</span> <span class="bp">-</span> <span class="o">(</span><span class="n">d</span><span class="bp">‚Åª¬π</span> <span class="bp">*</span> <span class="n">d</span><span class="o">)</span> <span class="err">‚Ä¢</span> <span class="n">y</span><span class="err">‚à•</span> <span class="o">:</span> <span class="k">by</span> <span class="n">rwa</span> <span class="o">[</span><span class="n">lin</span><span class="bp">.</span><span class="n">smul</span><span class="o">,</span> <span class="n">inv_mul_cancel</span><span class="o">,</span> <span class="n">one_smul</span><span class="o">]</span>
<span class="bp">...</span> <span class="bp">=</span> <span class="err">‚à•</span><span class="n">d</span><span class="bp">‚Åª¬π</span> <span class="err">‚Ä¢</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span> <span class="bp">-</span> <span class="n">d</span> <span class="err">‚Ä¢</span> <span class="n">y</span><span class="o">)</span><span class="err">‚à•</span> <span class="o">:</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">mul_smul</span><span class="o">,</span> <span class="n">smul_sub</span><span class="o">]</span>
<span class="bp">...</span> <span class="bp">=</span> <span class="err">‚à•</span><span class="n">d</span><span class="err">‚à•</span><span class="bp">‚Åª¬π</span> <span class="bp">*</span> <span class="err">‚à•</span><span class="n">f</span> <span class="n">x</span> <span class="bp">-</span> <span class="n">d</span> <span class="err">‚Ä¢</span> <span class="n">y</span><span class="err">‚à•</span> <span class="o">:</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">norm_smul</span><span class="o">,</span> <span class="n">norm_inv</span><span class="o">]</span>
</pre></div>


<p>The first line takes 235ms, the second one 167ms and the third one 3ms. I don't understand why there would be a factor 100 between the first and the third line!</p>

<a name="165942011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165942011" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165942011">Kevin Buzzard (May 17 2019 at 22:31)</a>:</h4>
<p>And we finish where we started, with some category theory. Explicitly, <a href="https://github.com/leanprover-community/mathlib/blob/5e5298b9273b44aa06e3b30aa064cf866cd8152a/src/category_theory/instances/CommRing/adjunctions.lean#L42" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/5e5298b9273b44aa06e3b30aa064cf866cd8152a/src/category_theory/instances/CommRing/adjunctions.lean#L42">polynomial ring being adjoint to the forgetful functor</a> on line 42 of <code>category_theory/instances/CommRing/adjunctions.lean</code>.</p>
<div class="codehilite"><pre><span></span><span class="n">noncomputable</span> <span class="n">def</span> <span class="n">adj</span> <span class="o">:</span> <span class="n">polynomial_ring</span> <span class="err">‚ä£</span> <span class="o">(</span><span class="n">forget</span> <span class="o">:</span> <span class="n">CommRing</span> <span class="err">‚•§</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">adjunction</span><span class="bp">.</span><span class="n">mk_of_hom_equiv</span>
<span class="o">{</span> <span class="n">hom_equiv</span> <span class="o">:=</span> <span class="bp">Œª</span> <span class="n">Œ±</span> <span class="n">R</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="bp">Œª</span> <span class="n">f</span><span class="o">,</span> <span class="n">f</span> <span class="err">‚àò</span> <span class="n">X</span><span class="o">,</span>
    <span class="n">inv_fun</span> <span class="o">:=</span> <span class="bp">Œª</span> <span class="n">f</span><span class="o">,</span> <span class="bp">‚ü®</span><span class="n">eval‚ÇÇ</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast</span> <span class="n">f</span><span class="o">,</span> <span class="k">by</span> <span class="n">apply_instance</span><span class="bp">‚ü©</span><span class="o">,</span>
    <span class="n">left_inv</span> <span class="o">:=</span> <span class="bp">Œª</span> <span class="n">f</span><span class="o">,</span> <span class="n">subtype</span><span class="bp">.</span><span class="n">ext</span><span class="bp">.</span><span class="n">mpr</span> <span class="err">$</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">Œª</span> <span class="n">p</span><span class="o">,</span>
    <span class="k">begin</span>
      <span class="k">have</span> <span class="n">H0</span> <span class="o">:=</span> <span class="bp">Œª</span> <span class="n">n</span><span class="o">,</span> <span class="o">(</span><span class="n">congr</span> <span class="o">(</span><span class="n">int</span><span class="bp">.</span><span class="n">eq_cast&#39;</span> <span class="o">(</span><span class="n">f</span><span class="bp">.</span><span class="n">val</span> <span class="err">‚àò</span> <span class="n">C</span><span class="o">))</span> <span class="o">(</span><span class="n">rfl</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">=</span> <span class="n">n</span><span class="o">))</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
      <span class="k">have</span> <span class="n">H1</span> <span class="o">:=</span> <span class="bp">Œª</span> <span class="n">p‚ÇÅ</span> <span class="n">p‚ÇÇ</span><span class="o">,</span> <span class="o">(</span><span class="bp">@</span><span class="n">is_ring_hom</span><span class="bp">.</span><span class="n">map_add</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">f</span><span class="bp">.</span><span class="n">val</span> <span class="n">f</span><span class="bp">.</span><span class="mi">2</span> <span class="n">p‚ÇÅ</span> <span class="n">p‚ÇÇ</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
      <span class="k">have</span> <span class="n">H2</span> <span class="o">:=</span> <span class="bp">Œª</span> <span class="n">p‚ÇÅ</span> <span class="n">p‚ÇÇ</span><span class="o">,</span> <span class="o">(</span><span class="bp">@</span><span class="n">is_ring_hom</span><span class="bp">.</span><span class="n">map_mul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">f</span><span class="bp">.</span><span class="n">val</span> <span class="n">f</span><span class="bp">.</span><span class="mi">2</span> <span class="n">p‚ÇÅ</span> <span class="n">p‚ÇÇ</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
      <span class="n">apply</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span><span class="bp">;</span> <span class="n">intros</span><span class="bp">;</span>
      <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="bp">*</span><span class="o">,</span> <span class="n">eval‚ÇÇ_add</span><span class="o">,</span> <span class="n">eval‚ÇÇ_mul</span><span class="o">,</span> <span class="n">eval‚ÇÇ_C</span><span class="o">,</span> <span class="n">eval‚ÇÇ_X</span><span class="o">,</span>
        <span class="n">eq_self_iff_true</span><span class="o">,</span> <span class="n">function</span><span class="bp">.</span><span class="n">comp_app</span><span class="o">,</span> <span class="n">hom_coe_app&#39;</span><span class="o">]</span> <span class="n">at</span> <span class="bp">*</span>
    <span class="kn">end</span><span class="o">,</span>
    <span class="n">right_inv</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">tidy</span> <span class="o">},</span>
  <span class="n">hom_equiv_naturality_left_symm&#39;</span> <span class="o">:=</span> <span class="bp">Œª</span> <span class="n">X&#39;</span> <span class="n">X</span> <span class="n">Y</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">subtype</span><span class="bp">.</span><span class="n">ext</span><span class="bp">.</span><span class="n">mpr</span> <span class="err">$</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">Œª</span> <span class="n">p</span><span class="o">,</span>
  <span class="k">begin</span>
    <span class="n">apply</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span><span class="bp">;</span> <span class="n">intros</span><span class="bp">;</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="bp">*</span><span class="o">,</span> <span class="n">eval‚ÇÇ_mul</span><span class="o">,</span> <span class="n">eval‚ÇÇ_add</span><span class="o">,</span> <span class="n">eval‚ÇÇ_C</span><span class="o">,</span> <span class="n">eval‚ÇÇ_X</span><span class="o">,</span>
      <span class="n">comp_val</span><span class="o">,</span> <span class="n">equiv</span><span class="bp">.</span><span class="n">coe_fn_symm_mk</span><span class="o">,</span> <span class="n">hom_coe_app</span><span class="o">,</span> <span class="n">polynomial_ring_map_val</span><span class="o">,</span>
      <span class="n">eq_self_iff_true</span><span class="o">,</span> <span class="n">function</span><span class="bp">.</span><span class="n">comp_app</span><span class="o">,</span> <span class="n">add_right_inj</span><span class="o">,</span> <span class="n">types_comp</span><span class="o">]</span> <span class="n">at</span> <span class="bp">*</span>
  <span class="kn">end</span> <span class="o">}</span>
</pre></div>

<a name="165942407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165942407" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165942407">Kevin Buzzard (May 17 2019 at 22:39)</a>:</h4>
<p>I wonder if it's the two simp lines which are making this one hurt.</p>

<a name="165942606"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165942606" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165942606">Kevin Buzzard (May 17 2019 at 22:42)</a>:</h4>
<p>That <code>intros;</code> before the first <code>simp only</code> -- after that there are three goals. Has the simp statement been carefully crafted to close all of them? [that's what it does]</p>

<a name="165942910"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165942910" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165942910">Kevin Buzzard (May 17 2019 at 22:48)</a>:</h4>
<p>Maybe this is the point of <code>simp</code> anyway? Maybe it's supposed to take a lot of time but we only have to compile once so who cares?</p>

<a name="165943049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165943049" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165943049">Kevin Buzzard (May 17 2019 at 22:51)</a>:</h4>
<p>That is a pretty compact proof really. Automation is doing a bunch of diagram-chasing here.</p>

<a name="165950438"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165950438" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165950438">Scott Morrison (May 18 2019 at 01:30)</a>:</h4>
<p>I think it would clearer if we ran three separate <code>simp only</code>s here, to discharge the three goals. Combining them all into one longer list seems unnecessarily golf-y.</p>

<a name="165997059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165997059" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165997059">Scott Morrison (May 19 2019 at 00:05)</a>:</h4>
<p>Okay, <a href="https://github.com/leanprover-community/mathlib/issues/1049" target="_blank" title="https://github.com/leanprover-community/mathlib/issues/1049">#1049</a> fulfills the -T50000 challenge for <code>category_theory/instances/CommRing/adjunctions.lean</code>.</p>

<a name="165997061"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165997061" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165997061">Scott Morrison (May 19 2019 at 00:05)</a>:</h4>
<p>Feel like running it all again with a lower threshold? :-)</p>

<a name="165997106"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165997106" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165997106">Scott Morrison (May 19 2019 at 00:06)</a>:</h4>
<p>Given that pretty much every instance that went over 50000 came from at least somewhat smelly code, perhaps we should review this regularly.</p>

<a name="165997107"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/165997107" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#165997107">Scott Morrison (May 19 2019 at 00:07)</a>:</h4>
<p>Re <a href="https://github.com/leanprover-community/mathlib/issues/1049" target="_blank" title="https://github.com/leanprover-community/mathlib/issues/1049">#1049</a>, <span class="user-mention" data-user-id="112680">@Johan Commelin</span>, could you have a look at this and see if you're happy? I think you wrote the original file.</p>

<a name="166011365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166011365" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166011365">matt rice (May 19 2019 at 07:38)</a>:</h4>
<p>Hmm, there is this function <a href="https://github.com/leanprover-community/lean/blob/master/src/util/memory.cpp#L127-L140" target="_blank" title="https://github.com/leanprover-community/lean/blob/master/src/util/memory.cpp#L127-L140">https://github.com/leanprover-community/lean/blob/master/src/util/memory.cpp#L127-L140</a><br>
I wonder if it might be possible to build a top-5 old_peak-get_peak_rss() delta, list of components from there or something.</p>

<a name="166011443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166011443" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166011443">Kevin Buzzard (May 19 2019 at 07:41)</a>:</h4>
<blockquote>
<p>Feel like running it all again with a lower threshold? :-)</p>
</blockquote>
<p>Heh, I tried compiling the version of mathlib from just before I started this thread, and a version from yesterday, and the newer version seemed to take slightly longer to compile! So I'm not sure I've done any good with this project anyway :-/</p>

<a name="166014257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166014257" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166014257">Scott Morrison (May 19 2019 at 09:02)</a>:</h4>
<p>Progress...?</p>

<a name="166014326"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166014326" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166014326">Mario Carneiro (May 19 2019 at 09:04)</a>:</h4>
<p>it could just be new material. We're always fighting the tide of general library growth</p>

<a name="166016920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166016920" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166016920">Sebastien Gouezel (May 19 2019 at 10:23)</a>:</h4>
<p>I could decrase the compilation of <code>GH_dist_le_of_approx_subsets</code> from 50s to 5s on my computer by replacing two <code>linarith</code> calls by explicit computations. See <a href="https://github.com/leanprover-community/mathlib/issues/1052" target="_blank" title="https://github.com/leanprover-community/mathlib/issues/1052">#1052</a>.</p>

<a name="166016971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166016971" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166016971">Sebastien Gouezel (May 19 2019 at 10:24)</a>:</h4>
<p>I tried first to avoid problems by telling <code>linarith</code> which equations it should look at, but I don't understand the syntax. Consider for instance</p>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">‚Ñù</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">‚Ñù</span><span class="o">)</span> <span class="o">(</span><span class="n">ha</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">hb</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">‚â§</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">‚â§</span> <span class="n">a</span><span class="bp">/</span><span class="mi">2</span> <span class="bp">+</span> <span class="n">b</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">linarith</span>
<span class="kn">end</span>
</pre></div>


<p>works, but if I use instead <code>linarith ha hb</code> it fails. While the docstring says <code>linarith h1 h2 h3 will only use hypotheses h1, h2, h3.</code></p>

<a name="166017305"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166017305" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166017305">Mario Carneiro (May 19 2019 at 10:34)</a>:</h4>
<p>From my experience <code>ring</code> and <code>linarith</code> aren't usually bottlenecks; it's usually the <code>simp</code>ing they do in the preprocessing stage</p>

<a name="166017394"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166017394" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166017394">Keeley Hoek (May 19 2019 at 10:36)</a>:</h4>
<p>I think Sebastien said that it got bad after the <code>is_def_eq</code> changes</p>

<a name="166017395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166017395" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166017395">Keeley Hoek (May 19 2019 at 10:36)</a>:</h4>
<p>What about <code>ring</code> and <code>ring!</code></p>

<a name="166017404"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166017404" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166017404">Mario Carneiro (May 19 2019 at 10:36)</a>:</h4>
<p>I like that</p>

<a name="166017422"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166017422" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166017422">Keeley Hoek (May 19 2019 at 10:37)</a>:</h4>
<p>That way you when you're angry that <code>linarith</code> can't solve <code>id x = x</code> you can take it out on lean when you press <code>!</code></p>

<a name="166017433"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166017433" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166017433">Keeley Hoek (May 19 2019 at 10:38)</a>:</h4>
<p>:D</p>

<a name="166017782"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166017782" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166017782">Rob Lewis (May 19 2019 at 10:47)</a>:</h4>
<p>The <code>!</code> notation is better than another config option. In both <code>ring</code> and <code>linarith</code>, it will take a little bit of work to propagate that flag from the tactic call to the place where it's actually used. But it's a refactor that's worth doing.</p>

<a name="166017832"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166017832" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166017832">Rob Lewis (May 19 2019 at 10:48)</a>:</h4>
<p>More generally, though. If this change to <code>linarith</code> causes this kind of slowdown, there's probably something missing an <code>irreducible</code> attribute.</p>

<a name="166018128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166018128" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166018128">Rob Lewis (May 19 2019 at 10:56)</a>:</h4>
<p>As for restricting <code>linarith</code> to only certain hypotheses: iirc, it won't use the goal if you do this. It will just try to find a contradiction with <code>ha, hb</code>. <code>apply le_of_not_gt, intro hc, linarith ha hb hc</code> would work. I remember noticing this a while back and thought I changed it but maybe I never got around to it.</p>

<a name="166018280"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166018280" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166018280">Mario Carneiro (May 19 2019 at 11:00)</a>:</h4>
<p>What about using <code>linarith h1 h2 \|-</code> for this?</p>

<a name="166018371"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166018371" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166018371">Rob Lewis (May 19 2019 at 11:03)</a>:</h4>
<p>That would be ideal. It takes slightly more work to parse because it's no longer a list of names.</p>

<a name="166018604"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166018604" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166018604">Rob Lewis (May 19 2019 at 11:10)</a>:</h4>
<p>By the way, any idea what's up with Travis here? <a href="https://github.com/leanprover-community/mathlib/pull/1043" target="_blank" title="https://github.com/leanprover-community/mathlib/pull/1043">https://github.com/leanprover-community/mathlib/pull/1043</a> I'm certain the original PR compiled, and I don't see why Mario's changes should change that.</p>

<a name="166018695"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166018695" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166018695">Mario Carneiro (May 19 2019 at 11:12)</a>:</h4>
<p>you could just use the <code>loc</code> parser</p>

<a name="166018708"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166018708" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166018708">Mario Carneiro (May 19 2019 at 11:13)</a>:</h4>
<p>It timed out. I restarted the build</p>

<a name="166018924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166018924" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166018924">Rob Lewis (May 19 2019 at 11:18)</a>:</h4>
<blockquote>
<p>you could just use the <code>loc</code> parser</p>
</blockquote>
<p>That takes an <code>at</code>, right? <code>linarith at h1 h2 |-</code> sounds strange. But yes, that can be adapted.</p>

<a name="166019613"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166019613" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166019613">Rob Lewis (May 19 2019 at 11:39)</a>:</h4>
<p>There's something entirely different going on in the <code>GH_dist_le_of_approx_subsets</code> proof. Even if you clear everything irrelevant from the context, <code>linarith</code> (with no arguments) still fails. With the same goal and context in a separate proof right above, it succeeds.</p>

<a name="166019977"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166019977" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166019977">Sebastien Gouezel (May 19 2019 at 11:49)</a>:</h4>
<p><code>attribute [irreducible] Hausdorff_dist</code> makes it instantaneous. I will add this and keep the <code>linarith</code> calls, instead of the current version of <a href="https://github.com/leanprover-community/mathlib/issues/1052" target="_blank" title="https://github.com/leanprover-community/mathlib/issues/1052">#1052</a>.</p>

<a name="166020536"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166020536" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166020536">Sebastien Gouezel (May 19 2019 at 12:05)</a>:</h4>
<p>Done. This is more satisfactory, as the proofs with <code>linarith</code> are clearly better, and moreover this was just a symptom of a problem that would have shown up again later on.</p>

<a name="166020671"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166020671" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166020671">Rob Lewis (May 19 2019 at 12:08)</a>:</h4>
<p>As for the other issue here: the type of <code>Œ¥0</code> is actually a metavariable. The <code>refine</code> call at the very first line never instantiates it. We'll have to add calls to <code>instantiate_mvars</code> in <code>linarith</code>. I think we saw something similar in <code>ring</code> a while back.</p>

<a name="166020812"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166020812" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166020812">Sebastien Gouezel (May 19 2019 at 12:12)</a>:</h4>
<p>Where it the other issue? The original proof (with several calls to <code>linarith</code>) works fine just by making <code>Hausdorff_dist</code> irreducible and no other change.</p>

<a name="166020829"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166020829" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166020829">Sebastien Gouezel (May 19 2019 at 12:13)</a>:</h4>
<p>In particular, <code>linarith</code> is able to use <code>Œ¥0</code> just fine.</p>

<a name="166020900"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166020900" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166020900">Rob Lewis (May 19 2019 at 12:15)</a>:</h4>
<p>I started looking at your changes to see what needed to be irreducible. The first thing I tried was clearing all the irrelevant stuff:</p>
<div class="codehilite"><pre><span></span><span class="k">have</span> <span class="n">I5</span> <span class="o">:</span> <span class="n">Hausdorff_dist</span> <span class="o">(</span><span class="n">Fl</span> <span class="err">&#39;&#39;</span> <span class="n">s</span><span class="o">)</span> <span class="o">(</span><span class="n">Fr</span> <span class="err">&#39;&#39;</span> <span class="o">(</span><span class="n">range</span> <span class="err">Œ¶</span><span class="o">))</span> <span class="bp">‚â§</span> <span class="n">Œµ2</span><span class="bp">/</span><span class="mi">2</span> <span class="bp">+</span> <span class="n">Œ¥</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">refine</span> <span class="n">Hausdorff_dist_le_of_mem_dist</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">clear</span> <span class="n">I4</span> <span class="n">I3</span> <span class="n">I2</span> <span class="n">I1</span> <span class="n">Il</span> <span class="n">Ir</span> <span class="n">Fr</span> <span class="n">Fl</span> <span class="bp">_</span><span class="n">inst_7</span> <span class="n">this</span> <span class="n">sne</span> <span class="n">hs</span> <span class="n">hs&#39;</span> <span class="n">H</span> <span class="n">h</span> <span class="n">Dxs</span>  <span class="bp">_</span><span class="n">inst</span> <span class="n">hxs</span> <span class="n">xŒ±</span> <span class="n">xs</span> <span class="err">Œ¶</span> <span class="n">s</span> <span class="n">Œµ1</span> <span class="n">Œµ3</span> <span class="bp">_</span><span class="n">inst_6</span> <span class="bp">_</span><span class="n">inst_5</span> <span class="bp">_</span><span class="n">inst_4</span> <span class="bp">_</span><span class="n">inst_3</span> <span class="bp">_</span><span class="n">inst_2</span> <span class="bp">_</span><span class="n">inst_1</span> <span class="n">Œ≤</span> <span class="n">Œ±</span><span class="o">,</span>
      <span class="n">linarith</span> <span class="o">}</span>
</pre></div>


<p>This fails, even though it works elsewhere with the exact same context and goal.</p>

<a name="166020956"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166020956" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166020956">Rob Lewis (May 19 2019 at 12:16)</a>:</h4>
<p>It works if you <code>revert Œµ2 Œ¥, intros,</code> before <code>linarith</code>, and printing the raw format of the type of <code>Œ¥0</code> shows it's a metavar.</p>

<a name="166020975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166020975" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166020975">Rob Lewis (May 19 2019 at 12:17)</a>:</h4>
<p>But that's curious that <code>linarith</code> manages to use it in the improved proof. It must get instantiated somewhere.</p>

<a name="166021401"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/-T50000%20challenge/near/166021401" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/87130T50000challenge.html#166021401">Rob Lewis (May 19 2019 at 12:29)</a>:</h4>
<p>Yep. At the <code>linarith</code> call in the line <code> refine Hausdorff_dist_le_of_mem_dist  (by linarith) _ _</code>, the type of <code>Œ¥0</code> has been instantiated. If you change this to <code>refine Hausdorff_dist_le_of_mem_dist _ _ _</code>, <code>linarith</code> fails on the first goal, because type of <code>Œ¥0</code> is still an mvar.</p>


{% endraw %}
