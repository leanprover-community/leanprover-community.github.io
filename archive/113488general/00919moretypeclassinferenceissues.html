---
layout: page
title: Lean Prover Zulip Chat Archive 
permalink: archive/113488general/00919moretypeclassinferenceissues.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html">more type class inference issues</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">
{% raw %}
<a name="125320059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320059" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320059">Kevin Buzzard (Apr 19 2018 at 18:59)</a>:</h4>
<p>It seems to me that for classes like <code>ring</code>defined in core lean or mathlib, you are kind of supposed to use type class inference to make them work.</p>

<a name="125320070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320070" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320070">Kevin Buzzard (Apr 19 2018 at 18:59)</a>:</h4>
<p>For example, <code>class is_ring_hom {α : Type u} {β : Type v} [ring α] [ring β] (f : α → β) : Prop := ...</code> is now in mathlib</p>

<a name="125320128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320128" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320128">Kevin Buzzard (Apr 19 2018 at 19:00)</a>:</h4>
<p>now I don't actually know how to make type class inference work in all cases, so I spend some of my time working around it.</p>

<a name="125320162"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320162" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320162">Kevin Buzzard (Apr 19 2018 at 19:01)</a>:</h4>
<p>Here's an example. I have the following structure in my code:</p>

<a name="125320181"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320181" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320181">Kevin Buzzard (Apr 19 2018 at 19:01)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">presheaf_of_rings</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">T</span> <span class="o">:</span> <span class="n">topological_space</span> <span class="n">α</span><span class="o">]</span> <span class="kn">extends</span> <span class="n">presheaf_of_types</span> <span class="n">α</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">Fring</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">U</span><span class="o">}</span> <span class="o">(</span><span class="n">OU</span> <span class="o">:</span> <span class="n">T</span><span class="bp">.</span><span class="n">is_open</span> <span class="n">U</span><span class="o">),</span> <span class="n">comm_ring</span> <span class="o">(</span><span class="n">F</span> <span class="n">OU</span><span class="o">))</span>
<span class="o">(</span><span class="n">res_is_ring_morphism</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">U</span> <span class="n">V</span> <span class="o">:</span> <span class="n">set</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">OU</span> <span class="o">:</span> <span class="n">T</span><span class="bp">.</span><span class="n">is_open</span> <span class="n">U</span><span class="o">)</span> <span class="o">(</span><span class="n">OV</span> <span class="o">:</span> <span class="n">T</span><span class="bp">.</span><span class="n">is_open</span> <span class="n">V</span><span class="o">)</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">V</span> <span class="err">⊆</span> <span class="n">U</span><span class="o">),</span>
  <span class="n">is_ring_hom</span> <span class="o">(</span><span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">OU</span> <span class="n">OV</span> <span class="n">H</span><span class="o">))</span>
</pre></div>

<a name="125320267"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320267" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320267">Kevin Buzzard (Apr 19 2018 at 19:03)</a>:</h4>
<p>Yesterday, <code>is_ring_hom</code> was about <code>comm_ring</code>, and I used it in my code via <code>@is_ring_hom _ _ (FPR.Fring HU) (GPR.Fring HU) ...</code>, explicitly giving the proof that something was a comm_ring.</p>

<a name="125320275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320275" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320275">Kevin Buzzard (Apr 19 2018 at 19:03)</a>:</h4>
<p>But now it's changed to ring and so either I figure out a way of explicitly turning a comm_ring into a ring</p>

<a name="125320318"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320318" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320318">Kevin Buzzard (Apr 19 2018 at 19:04)</a>:</h4>
<p>or I ask here about how I should be doing this properly.</p>

<a name="125320334"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320334" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320334">Kevin Buzzard (Apr 19 2018 at 19:04)</a>:</h4>
<p>In short, Lean / mathlib seems to want me, by default, to prove that things are rings by type class inference.</p>

<a name="125320369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320369" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320369">Kevin Buzzard (Apr 19 2018 at 19:05)</a>:</h4>
<p>How do I ensure that every time I access a <code>presheaf_of_rings</code> as defined above, <code>presheaf_of_rings.Fring</code> is added to the type class inference system?</p>

<a name="125320463"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320463" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320463">Kevin Buzzard (Apr 19 2018 at 19:07)</a>:</h4>
<p>Is there some clever trick involving an <code>instance</code> statement directly after the definition of <code>presheaf_of_rings</code>?</p>

<a name="125320625"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320625" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320625">Kevin Buzzard (Apr 19 2018 at 19:11)</a>:</h4>
<p>Oh yeah :-)</p>

<a name="125320629"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320629" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320629">Kevin Buzzard (Apr 19 2018 at 19:11)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">presheaf_of_rings_Fring</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">T</span> <span class="o">:</span> <span class="n">topological_space</span> <span class="n">α</span><span class="o">]</span> <span class="o">{</span><span class="n">U</span> <span class="o">:</span> <span class="n">set</span> <span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">FPR</span> <span class="o">:</span> <span class="n">presheaf_of_rings</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">OU</span> <span class="o">:</span> <span class="n">T</span><span class="bp">.</span><span class="n">is_open</span> <span class="n">U</span><span class="o">)</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="o">(</span><span class="n">FPR</span><span class="bp">.</span><span class="n">F</span> <span class="n">OU</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">FPR</span><span class="bp">.</span><span class="n">Fring</span> <span class="n">OU</span>
</pre></div>

<a name="125320631"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125320631" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125320631">Kevin Buzzard (Apr 19 2018 at 19:11)</a>:</h4>
<p>As you were :-)</p>

<a name="125322233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125322233" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125322233">Kevin Buzzard (Apr 19 2018 at 19:50)</a>:</h4>
<p>What does this mean?</p>

<a name="125322237"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125322237" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125322237">Kevin Buzzard (Apr 19 2018 at 19:50)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">presheaf_of_rings</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">T</span> <span class="o">:</span> <span class="n">topological_space</span> <span class="n">α</span><span class="o">]</span> <span class="kn">extends</span> <span class="n">presheaf_of_types</span> <span class="n">α</span> <span class="o">:=</span>
<span class="o">[</span><span class="n">Fring</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">U</span><span class="o">}</span> <span class="o">(</span><span class="n">OU</span> <span class="o">:</span> <span class="n">T</span><span class="bp">.</span><span class="n">is_open</span> <span class="n">U</span><span class="o">),</span> <span class="n">comm_ring</span> <span class="o">(</span><span class="n">F</span> <span class="n">OU</span><span class="o">)]</span>
<span class="o">(</span><span class="n">res_is_ring_morphism</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">U</span> <span class="n">V</span> <span class="o">:</span> <span class="n">set</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">OU</span> <span class="o">:</span> <span class="n">T</span><span class="bp">.</span><span class="n">is_open</span> <span class="n">U</span><span class="o">)</span> <span class="o">(</span><span class="n">OV</span> <span class="o">:</span> <span class="n">T</span><span class="bp">.</span><span class="n">is_open</span> <span class="n">V</span><span class="o">)</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">V</span> <span class="err">⊆</span> <span class="n">U</span><span class="o">),</span>
  <span class="n">is_ring_hom</span> <span class="o">(</span><span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">OU</span> <span class="n">OV</span> <span class="n">H</span><span class="o">))</span>
</pre></div>

<a name="125322241"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125322241" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125322241">Kevin Buzzard (Apr 19 2018 at 19:50)</a>:</h4>
<p>Is that a thing? It doesn't seem to be a thing.</p>

<a name="125322275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125322275" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125322275">Chris Hughes (Apr 19 2018 at 19:51)</a>:</h4>
<p><code>comm_ring.to_ring</code> might help</p>

<a name="125322379"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125322379" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125322379">Chris Hughes (Apr 19 2018 at 19:53)</a>:</h4>
<p><code>attribute [instance] presheaf_of_rings.Fring</code> might also help</p>

<a name="125322454"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125322454" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125322454">Chris Hughes (Apr 19 2018 at 19:55)</a>:</h4>
<p>Just add that ^ line after the definition of <code>presheaf_of_rings</code></p>

<a name="125323095"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125323095" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125323095">Kevin Buzzard (Apr 19 2018 at 20:09)</a>:</h4>
<p>Oh that's a better way :-) Thanks Chris, I'm glad I asked now.</p>

<a name="125323244"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125323244" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125323244">Kevin Buzzard (Apr 19 2018 at 20:12)</a>:</h4>
<p>I specifically wanted to avoid <code>comm_ring.to_ring</code> as I am pretty sure that the whole point of type class inference is that the end user shouldn't have to use such functions.</p>

<a name="125324599"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125324599" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125324599">Kevin Buzzard (Apr 19 2018 at 20:43)</a>:</h4>
<p>Actually, is the following a potential problem with the type class system:</p>

<a name="125324670"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125324670" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125324670">Kevin Buzzard (Apr 19 2018 at 20:44)</a>:</h4>
<p>My understanding (incomplete) of something Johannes was saying a few days ago to Patrick, was that the reason <code>topological_space</code> is defined as a <code>structure</code> with the <code>class</code> attribute added later, rather than a <code>class</code> directly, was that there were occasions when you might want to consider more than one topological space structure on a given type.</p>

<a name="125324680"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125324680" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125324680">Kevin Buzzard (Apr 19 2018 at 20:45)</a>:</h4>
<p>but ring is defined as a class in core lean</p>

<a name="125324721"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125324721" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125324721">Kevin Buzzard (Apr 19 2018 at 20:46)</a>:</h4>
<p>so what about the person who wants to prove theorems about putting different ring structures on a type?</p>

<a name="125324728"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125324728" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125324728">Kevin Buzzard (Apr 19 2018 at 20:46)</a>:</h4>
<p>Are they forced to abandon the type class system, and then they really would have to learn the names of all the theorems mapping a ring to an additive group etc?</p>

<a name="125324903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125324903" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125324903">Kevin Buzzard (Apr 19 2018 at 20:50)</a>:</h4>
<p>And here's another question: what if the ring instance is in the same structure?</p>

<a name="125324906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125324906" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125324906">Kevin Buzzard (Apr 19 2018 at 20:50)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">presheaf_of_rings_on_basis</span> <span class="o">{</span><span class="n">X</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">TX</span> <span class="o">:</span> <span class="n">topological_space</span> <span class="n">X</span><span class="o">]</span>
  <span class="o">{</span><span class="n">B</span> <span class="o">:</span> <span class="n">set</span> <span class="o">(</span><span class="n">set</span> <span class="n">X</span><span class="o">)}</span> <span class="o">(</span><span class="n">HB</span> <span class="o">:</span> <span class="n">topological_space</span><span class="bp">.</span><span class="n">is_topological_basis</span> <span class="n">B</span><span class="o">)</span> <span class="kn">extends</span> <span class="n">presheaf_of_types_on_basis</span> <span class="n">HB</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">Fring</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">U</span><span class="o">}</span> <span class="n">BU</span><span class="o">,</span> <span class="n">comm_ring</span> <span class="o">(</span><span class="n">F</span> <span class="n">BU</span><span class="o">))</span>
<span class="o">(</span><span class="n">res_is_ring_morphism</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">U</span> <span class="n">V</span><span class="o">}</span> <span class="o">(</span><span class="n">BU</span> <span class="o">:</span> <span class="n">U</span> <span class="err">∈</span> <span class="n">B</span><span class="o">)</span> <span class="o">(</span><span class="n">BV</span> <span class="o">:</span> <span class="n">V</span> <span class="err">∈</span> <span class="n">B</span><span class="o">)</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">V</span> <span class="err">⊆</span> <span class="n">U</span><span class="o">),</span>
  <span class="bp">@</span><span class="n">is_ring_hom</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">Fring</span> <span class="n">U</span> <span class="n">BU</span><span class="o">)</span> <span class="o">(</span><span class="n">Fring</span> <span class="n">BV</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">BU</span> <span class="n">BV</span> <span class="n">H</span><span class="o">))</span>
</pre></div>

<a name="125324987"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125324987" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125324987">Kevin Buzzard (Apr 19 2018 at 20:52)</a>:</h4>
<p>Here a <code>presheaf_of_rings_on_basis</code> has <code>Fring</code> saying something is a commutative ring, and then <code>res_is_ring_morphism</code> which immediately wants to use type class inference to deduce that <code>Fring U BU</code> is a ring. Now do I really have to use <code>comm_ring.to_ring</code>?</p>

<a name="125325099"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325099" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325099">Kevin Buzzard (Apr 19 2018 at 20:55)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">presheaf_of_rings_on_basis</span> <span class="o">{</span><span class="n">X</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">TX</span> <span class="o">:</span> <span class="n">topological_space</span> <span class="n">X</span><span class="o">]</span>
  <span class="o">{</span><span class="n">B</span> <span class="o">:</span> <span class="n">set</span> <span class="o">(</span><span class="n">set</span> <span class="n">X</span><span class="o">)}</span> <span class="o">(</span><span class="n">HB</span> <span class="o">:</span> <span class="n">topological_space</span><span class="bp">.</span><span class="n">is_topological_basis</span> <span class="n">B</span><span class="o">)</span> <span class="kn">extends</span> <span class="n">presheaf_of_types_on_basis</span> <span class="n">HB</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">Fring</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">U</span><span class="o">}</span> <span class="o">(</span><span class="n">BU</span> <span class="o">:</span> <span class="n">U</span> <span class="err">∈</span> <span class="n">B</span><span class="o">),</span> <span class="n">comm_ring</span> <span class="o">(</span><span class="n">F</span> <span class="n">BU</span><span class="o">))</span>
<span class="o">(</span><span class="n">res_is_ring_morphism</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">U</span> <span class="n">V</span><span class="o">}</span> <span class="o">(</span><span class="n">BU</span> <span class="o">:</span> <span class="n">U</span> <span class="err">∈</span> <span class="n">B</span><span class="o">)</span> <span class="o">(</span><span class="n">BV</span> <span class="o">:</span> <span class="n">V</span> <span class="err">∈</span> <span class="n">B</span><span class="o">)</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">V</span> <span class="err">⊆</span> <span class="n">U</span><span class="o">),</span>
  <span class="bp">@</span><span class="n">is_ring_hom</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_ring</span> <span class="bp">_</span> <span class="o">(</span><span class="n">Fring</span> <span class="n">BU</span><span class="o">))</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_ring</span> <span class="bp">_</span> <span class="o">(</span><span class="n">Fring</span> <span class="n">BV</span><span class="o">))</span> <span class="o">(</span><span class="bp">@</span><span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">BU</span> <span class="n">BV</span> <span class="n">H</span><span class="o">))</span>
</pre></div>

<a name="125325160"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325160" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325160">Kevin Buzzard (Apr 19 2018 at 20:56)</a>:</h4>
<p>Type class inference is failing me badly here. Sorry for no MWE, hopefully people can see the problem; Lean wants me to use type class inference to prove that commutative rings are rings but I don't know how to make this happen in this situation.</p>

<a name="125325164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325164" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325164">Mario Carneiro (Apr 19 2018 at 20:57)</a>:</h4>
<p>that's what the brackets inside the structure are for</p>

<a name="125325231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325231" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325231">Kevin Buzzard (Apr 19 2018 at 20:58)</a>:</h4>
<p>?</p>

<a name="125325233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325233" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325233">Kevin Buzzard (Apr 19 2018 at 20:58)</a>:</h4>
<p>Oh!</p>

<a name="125325247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325247" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325247">Kevin Buzzard (Apr 19 2018 at 20:59)</a>:</h4>
<p>:-)</p>

<a name="125325251"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325251" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325251">Kevin Buzzard (Apr 19 2018 at 20:59)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">presheaf_of_rings_on_basis</span> <span class="o">{</span><span class="n">X</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">TX</span> <span class="o">:</span> <span class="n">topological_space</span> <span class="n">X</span><span class="o">]</span>
  <span class="o">{</span><span class="n">B</span> <span class="o">:</span> <span class="n">set</span> <span class="o">(</span><span class="n">set</span> <span class="n">X</span><span class="o">)}</span> <span class="o">(</span><span class="n">HB</span> <span class="o">:</span> <span class="n">topological_space</span><span class="bp">.</span><span class="n">is_topological_basis</span> <span class="n">B</span><span class="o">)</span> <span class="kn">extends</span> <span class="n">presheaf_of_types_on_basis</span> <span class="n">HB</span> <span class="o">:=</span>
<span class="o">[</span><span class="n">Fring</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">U</span><span class="o">}</span> <span class="o">(</span><span class="n">BU</span> <span class="o">:</span> <span class="n">U</span> <span class="err">∈</span> <span class="n">B</span><span class="o">),</span> <span class="n">comm_ring</span> <span class="o">(</span><span class="n">F</span> <span class="n">BU</span><span class="o">)]</span>
<span class="o">(</span><span class="n">res_is_ring_morphism</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">U</span> <span class="n">V</span><span class="o">}</span> <span class="o">(</span><span class="n">BU</span> <span class="o">:</span> <span class="n">U</span> <span class="err">∈</span> <span class="n">B</span><span class="o">)</span> <span class="o">(</span><span class="n">BV</span> <span class="o">:</span> <span class="n">V</span> <span class="err">∈</span> <span class="n">B</span><span class="o">)</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">V</span> <span class="err">⊆</span> <span class="n">U</span><span class="o">),</span>
  <span class="n">is_ring_hom</span> <span class="o">(</span><span class="bp">@</span><span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">BU</span> <span class="n">BV</span> <span class="n">H</span><span class="o">))</span>
</pre></div>

<a name="125325270"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325270" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325270">Kevin Buzzard (Apr 19 2018 at 21:00)</a>:</h4>
<p>So just to be clear -- the square brackets inside the structure trigger type class inference only within the structure definitions?</p>

<a name="125325325"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325325" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325325">Mario Carneiro (Apr 19 2018 at 21:01)</a>:</h4>
<p>I think they also mark it as an instance, but you should <code>#print</code> to be sure</p>

<a name="125325334"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325334" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325334">Kevin Buzzard (Apr 19 2018 at 21:01)</a>:</h4>
<p>I don't think they do</p>

<a name="125325344"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325344" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325344">Kevin Buzzard (Apr 19 2018 at 21:01)</a>:</h4>
<p>because that was what prompted the question about why the square brackets within the structure definition was even a thing</p>

<a name="125325345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325345" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325345">Kevin Buzzard (Apr 19 2018 at 21:01)</a>:</h4>
<p>earlier</p>

<a name="125325421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325421" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325421">Mario Carneiro (Apr 19 2018 at 21:03)</a>:</h4>
<p>you shouldn't need <code>@res</code> either</p>

<a name="125325481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325481" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325481">Kevin Buzzard (Apr 19 2018 at 21:04)</a>:</h4>
<p>yes, that's gone now</p>

<a name="125325517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325517" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325517">Kevin Buzzard (Apr 19 2018 at 21:05)</a>:</h4>
<p>But your change of is_ring_hom from [comm_ring] to [ring] has thrown up one final type class inference issue which I can't solve</p>

<a name="125325520"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325520" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325520">Kevin Buzzard (Apr 19 2018 at 21:05)</a>:</h4>
<p>possibly because it's not solvable</p>

<a name="125325528"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325528" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325528">Kevin Buzzard (Apr 19 2018 at 21:05)</a>:</h4>
<p>I think I do need an MWE for this one</p>

<a name="125325814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325814" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325814">Kevin Buzzard (Apr 19 2018 at 21:11)</a>:</h4>
<p>Oh no it's Ok, indeed I am now pretty convinced that the square brackets in the structure definition do not insert anything into the type class inference system globally</p>

<a name="125325890"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325890" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325890">Kevin Buzzard (Apr 19 2018 at 21:12)</a>:</h4>
<p>because my final problem was solved by Chris' instance trick.</p>

<a name="125325902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325902" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325902">Kevin Buzzard (Apr 19 2018 at 21:12)</a>:</h4>
<p>Oh this is great. I got stuck on these problems before and blamed it on the type class inference system not being smart enough.</p>

<a name="125325907"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325907" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325907">Kevin Buzzard (Apr 19 2018 at 21:12)</a>:</h4>
<p>I should have asked for help earlier.</p>

<a name="125325924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325924" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325924">Kevin Buzzard (Apr 19 2018 at 21:13)</a>:</h4>
<p>Patrick said the same thing -- I told him to give up on coercions because they weren't smart enough</p>

<a name="125325932"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125325932" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125325932">Kevin Buzzard (Apr 19 2018 at 21:13)</a>:</h4>
<p>and he pointed out that whenever he'd got stuck before, you (Mario) had had a trick which got him through.</p>

<a name="125326155"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125326155" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125326155">Kevin Buzzard (Apr 19 2018 at 21:18)</a>:</h4>
<p>Here's a weird question. It feels to me like <code>comm_ring.to_ring</code> should not be the kind of function which end users have to worry about, because when the devs made <code>ring</code> a typeclass they are somehow declaring that Lean will automatically take care of inferences of this nature.</p>

<a name="125326166"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125326166" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125326166">Kevin Buzzard (Apr 19 2018 at 21:18)</a>:</h4>
<p>Am I right in thinking that an end user should only have to invoke <code>comm_ring.to_ring</code> in exceptional circumstances?</p>

<a name="125326183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125326183" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125326183">Kevin Buzzard (Apr 19 2018 at 21:19)</a>:</h4>
<p>(says the person who just managed to avoid all uses of it when his code broke in lots of places)</p>

<a name="125326192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125326192" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125326192">Kevin Buzzard (Apr 19 2018 at 21:19)</a>:</h4>
<p>(when a comm_ring changed to a ring)</p>

<a name="125326297"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125326297" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125326297">Kevin Buzzard (Apr 19 2018 at 21:21)</a>:</h4>
<p>Aah, more generally should an end user never have to explicitly invoke any theorem tagged with the <code>instance</code> attribute?</p>

<a name="125326358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125326358" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125326358">Kevin Buzzard (Apr 19 2018 at 21:22)</a>:</h4>
<p>(unless they are putting more than one structure of a typeclass onto one type, say)</p>

<a name="125328614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125328614" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125328614">Chris Hughes (Apr 19 2018 at 22:16)</a>:</h4>
<p>Sorry to hijack your thread, but I have a typeclass issue of my own</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span>

<span class="kn">instance</span> <span class="n">Zmod_setoid</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">}</span> <span class="o">:</span> <span class="n">setoid</span> <span class="bp">ℤ</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">int</span><span class="bp">.</span><span class="n">modeq</span> <span class="n">n</span><span class="o">,</span>
  <span class="n">iseqv</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">refl</span><span class="o">,</span> <span class="bp">@</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">symm</span> <span class="n">n</span><span class="o">,</span> <span class="bp">@</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">trans</span> <span class="n">n</span><span class="bp">⟩</span> <span class="o">}</span>

<span class="n">def</span> <span class="n">Zmod</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span> <span class="n">quotient</span> <span class="o">(</span><span class="bp">@</span><span class="n">Zmod_setoid</span> <span class="n">n</span><span class="o">)</span>

<span class="kn">private</span> <span class="n">def</span> <span class="n">add_aux</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Zmod</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">Zmod</span> <span class="n">n</span> <span class="o">:=</span>
<span class="n">quotient</span><span class="bp">.</span><span class="n">lift_on₂</span> <span class="n">a</span> <span class="n">b</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="err">⟦</span><span class="n">a</span> <span class="bp">+</span> <span class="n">b</span><span class="err">⟧</span><span class="o">)</span> <span class="n">sorry</span>
</pre></div>


<p>It cannot infer the <code>setoid</code> instance, probably because it requires an argument. Not sure of a good solution to this.</p>

<a name="125328872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125328872" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125328872">Mario Carneiro (Apr 19 2018 at 22:22)</a>:</h4>
<p>This is a common problem; I think the <code>lift_on</code> recursor does not correctly deliver the expected type to the lambda. The usual solution is to add an ascription at the lambda:</p>
<div class="codehilite"><pre><span></span>private def add_aux {n : ℤ} (a b : Zmod n) : Zmod n :=
quotient.lift_on₂ a b (λ a b, (⟦a + b⟧ : Zmod n)) sorry
</pre></div>

<a name="125328985"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125328985" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125328985">Chris Hughes (Apr 19 2018 at 22:25)</a>:</h4>
<p>Still not working I'm getting this message</p>
<div class="codehilite"><pre><span></span>synthesized type class instance is not definitionally equal to expression inferred by typing rules, synthesized
  ⁇
inferred
  Zmod_setoid n
</pre></div>

<a name="125331043"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331043" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331043">Kevin Buzzard (Apr 19 2018 at 23:24)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span>

<span class="kn">instance</span> <span class="n">Zmod_setoid</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">}</span> <span class="o">:</span> <span class="n">setoid</span> <span class="bp">ℤ</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">int</span><span class="bp">.</span><span class="n">modeq</span> <span class="n">n</span><span class="o">,</span>
  <span class="n">iseqv</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">refl</span><span class="o">,</span> <span class="bp">@</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">symm</span> <span class="n">n</span><span class="o">,</span> <span class="bp">@</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">trans</span> <span class="n">n</span><span class="bp">⟩</span> <span class="o">}</span>

<span class="kn">example</span> <span class="o">:</span> <span class="n">setoid</span> <span class="bp">ℤ</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span> <span class="c1">-- fails</span>
</pre></div>

<a name="125331049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331049" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331049">Kevin Buzzard (Apr 19 2018 at 23:24)</a>:</h4>
<p>I'm not sure that I understand how parametrized instances work.</p>

<a name="125331179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331179" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331179">Kevin Buzzard (Apr 19 2018 at 23:29)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span>

<span class="kn">instance</span> <span class="n">Zmod_setoid</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">}</span> <span class="o">:</span> <span class="n">setoid</span> <span class="bp">ℤ</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">int</span><span class="bp">.</span><span class="n">modeq</span> <span class="n">n</span><span class="o">,</span>
  <span class="n">iseqv</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">refl</span><span class="o">,</span> <span class="bp">@</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">symm</span> <span class="n">n</span><span class="o">,</span> <span class="bp">@</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">trans</span> <span class="n">n</span><span class="bp">⟩</span> <span class="o">}</span>

<span class="n">def</span> <span class="n">Zmod</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span> <span class="n">quotient</span> <span class="o">(</span><span class="bp">@</span><span class="n">Zmod_setoid</span> <span class="n">n</span><span class="o">)</span>

<span class="bp">#</span><span class="kn">check</span> <span class="o">(</span><span class="err">⟦</span><span class="mi">3</span><span class="err">⟧</span> <span class="o">:</span> <span class="n">Zmod</span> <span class="mi">5</span><span class="o">)</span> <span class="c1">-- failed to synthesize type class instance for setoid ℤ</span>
</pre></div>

<a name="125331180"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331180" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331180">Kevin Buzzard (Apr 19 2018 at 23:29)</a>:</h4>
<p>I'm even less sure now</p>

<a name="125331268"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331268" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331268">Kevin Buzzard (Apr 19 2018 at 23:32)</a>:</h4>
<p><code>#check (⟦(3 : ℤ)⟧ : Zmod 5</code> gives</p>

<a name="125331299"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331299" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331299">Kevin Buzzard (Apr 19 2018 at 23:32)</a>:</h4>
<p><code>⁇ : Zmod 5</code> for information check result (in green)</p>

<a name="125331303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331303" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331303">Kevin Buzzard (Apr 19 2018 at 23:33)</a>:</h4>
<p>and fails to synthesize the instance</p>

<a name="125331410"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331410" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331410">Simon Hudon (Apr 19 2018 at 23:36)</a>:</h4>
<p>Try:</p>
<div class="codehilite"><pre><span></span>import data.int.modeq

@[reducible]
def Zmod (n : ℤ) : Type := ℤ

instance Zmod_setoid {n : ℤ} : setoid (Zmod n) :=
{ r := int.modeq n,
  iseqv := ⟨int.modeq.refl, @int.modeq.symm n, @int.modeq.trans n⟩ }

example {n : ℤ} : setoid (Zmod n) := by apply_instance

#check ⟦ (3 : Zmod 5) ⟧
</pre></div>

<a name="125331465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331465" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331465">Simon Hudon (Apr 19 2018 at 23:38)</a>:</h4>
<p>The problem is that instance inference is only working with <code>ℤ</code> (in your example) to find a setoid instance. It's not enough information to infer the <code>n</code> parameter. Now, I added a synonym for <code>ℤ</code> which provides that information.</p>

<a name="125331928"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331928" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331928">Kevin Buzzard (Apr 19 2018 at 23:52)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">reducible</span><span class="o">]</span>
<span class="n">def</span> <span class="n">Z_aux</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span> <span class="bp">ℤ</span>

<span class="kn">instance</span> <span class="n">Zmod_setoid</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">}</span> <span class="o">:</span> <span class="n">setoid</span> <span class="o">(</span><span class="n">Z_aux</span> <span class="n">n</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">int</span><span class="bp">.</span><span class="n">modeq</span> <span class="n">n</span><span class="o">,</span>
  <span class="n">iseqv</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">refl</span><span class="o">,</span> <span class="bp">@</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">symm</span> <span class="n">n</span><span class="o">,</span> <span class="bp">@</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">trans</span> <span class="n">n</span><span class="bp">⟩</span> <span class="o">}</span>

<span class="kn">example</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">}</span> <span class="o">:</span> <span class="n">setoid</span> <span class="o">(</span><span class="n">Z_aux</span> <span class="n">n</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>

<span class="n">def</span> <span class="n">Zmod</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span> <span class="n">quotient</span> <span class="o">(</span><span class="bp">@</span><span class="n">Zmod_setoid</span> <span class="n">n</span><span class="o">)</span>

<span class="bp">#</span><span class="kn">check</span> <span class="o">(</span><span class="err">⟦</span> <span class="mi">3</span> <span class="err">⟧</span> <span class="o">:</span> <span class="n">Zmod</span> <span class="mi">5</span><span class="o">)</span> <span class="c1">-- 3 is interpreted as being in Z_aux 5 and this works</span>

<span class="kn">private</span> <span class="n">def</span> <span class="n">add_aux</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Zmod</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">Zmod</span> <span class="n">n</span> <span class="o">:=</span>
<span class="n">quotient</span><span class="bp">.</span><span class="n">lift_on₂</span> <span class="n">a</span> <span class="n">b</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="o">(</span><span class="err">⟦</span><span class="n">a</span> <span class="bp">+</span> <span class="n">b</span><span class="err">⟧</span> <span class="o">:</span> <span class="n">Zmod</span> <span class="n">n</span><span class="o">))</span> <span class="n">sorry</span> <span class="c1">-- no error yet</span>
</pre></div>

<a name="125331934"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331934" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331934">Kevin Buzzard (Apr 19 2018 at 23:53)</a>:</h4>
<p>As a mathematician I'm a bit uneasy about having a thing which is Z but which is called Zmod n</p>

<a name="125331935"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331935" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331935">Kevin Buzzard (Apr 19 2018 at 23:53)</a>:</h4>
<p>so I renamed it Z_aux, but your trick is excellent all the same :-)</p>

<a name="125331939"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125331939" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125331939">Kevin Buzzard (Apr 19 2018 at 23:53)</a>:</h4>
<p>I was worried the check would fail because Lean wouldn't push 3 into Z_aux 5</p>

<a name="125332001"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332001" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332001">Kevin Buzzard (Apr 19 2018 at 23:55)</a>:</h4>
<p><code>setoid</code> is a class and this is in core lean.</p>

<a name="125332004"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332004" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332004">Kevin Buzzard (Apr 19 2018 at 23:55)</a>:</h4>
<p>I think this means that it's quite hard to have more than one instance of a setoid structure on a given type</p>

<a name="125332006"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332006" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332006">Kevin Buzzard (Apr 19 2018 at 23:55)</a>:</h4>
<p>Simon's trick shows how to get around this, by making lots of types, one for each structure</p>

<a name="125332009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332009" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332009">Kevin Buzzard (Apr 19 2018 at 23:56)</a>:</h4>
<p>it's evil :-)</p>

<a name="125332056"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332056" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332056">Simon Hudon (Apr 19 2018 at 23:56)</a>:</h4>
<p>In general, if you need more than one instance of a class for a given type, it should make you suspicious</p>

<a name="125332058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332058" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332058">Mario Carneiro (Apr 19 2018 at 23:56)</a>:</h4>
<p>it's also a good way to handle the multiple rings problem</p>

<a name="125332059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332059" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332059">Kevin Buzzard (Apr 19 2018 at 23:56)</a>:</h4>
<p>yes</p>

<a name="125332060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332060" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332060">Kevin Buzzard (Apr 19 2018 at 23:56)</a>:</h4>
<p>I don't think I'd seen it before</p>

<a name="125332061"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332061" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332061">Simon Hudon (Apr 19 2018 at 23:56)</a>:</h4>
<p>But you can also name the quotient instead of <code>Z</code>:</p>

<a name="125332069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332069" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332069">Simon Hudon (Apr 19 2018 at 23:57)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">Zmod_setoid</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="n">setoid</span> <span class="o">(</span><span class="n">Zmod</span> <span class="n">n</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">int</span><span class="bp">.</span><span class="n">modeq</span> <span class="n">n</span><span class="o">,</span>
  <span class="n">iseqv</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">refl</span><span class="o">,</span> <span class="bp">@</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">symm</span> <span class="n">n</span><span class="o">,</span> <span class="bp">@</span><span class="n">int</span><span class="bp">.</span><span class="n">modeq</span><span class="bp">.</span><span class="n">trans</span> <span class="n">n</span><span class="bp">⟩</span> <span class="o">}</span>

<span class="n">def</span> <span class="n">Zmod&#39;</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span> <span class="n">quotient</span> <span class="o">(</span><span class="n">Zmod_setoid</span> <span class="n">n</span><span class="o">)</span>

<span class="bp">#</span><span class="kn">check</span> <span class="o">(</span><span class="err">⟦</span> <span class="mi">3</span> <span class="err">⟧</span> <span class="o">:</span> <span class="n">Zmod&#39;</span> <span class="mi">5</span><span class="o">)</span>
</pre></div>

<a name="125332072"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332072" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332072">Simon Hudon (Apr 19 2018 at 23:57)</a>:</h4>
<p>And if you equip <code>Zmod' 5</code> with <code>has_one</code>, <code>has_zero</code> and <code>has_add</code>, <code>#check (3 : Zmod' 5)</code> should work</p>

<a name="125332189"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332189" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332189">Kevin Buzzard (Apr 20 2018 at 00:01)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">variables</span> <span class="o">(</span><span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">has_add</span> <span class="n">Y</span><span class="o">]</span> <span class="o">[</span><span class="n">has_one</span> <span class="n">Y</span><span class="o">]</span>
<span class="bp">#</span><span class="kn">check</span> <span class="o">(</span><span class="mi">3</span> <span class="o">:</span> <span class="n">Y</span><span class="o">)</span>
</pre></div>

<a name="125332191"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332191" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332191">Kevin Buzzard (Apr 20 2018 at 00:01)</a>:</h4>
<p>no need for zero ;-)</p>

<a name="125332193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332193" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332193">Simon Hudon (Apr 20 2018 at 00:01)</a>:</h4>
<p>Even better!</p>

<a name="125332195"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332195" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332195">Kevin Buzzard (Apr 20 2018 at 00:01)</a>:</h4>
<p>sort of...</p>

<a name="125332198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332198" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332198">Kevin Buzzard (Apr 20 2018 at 00:02)</a>:</h4>
<p>:-)</p>

<a name="125332241"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332241" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332241">Simon Hudon (Apr 20 2018 at 00:02)</a>:</h4>
<blockquote>
<p>Simon's trick shows how to get around this, by making lots of types, one for each structure</p>
<p>it's evil :-)</p>
</blockquote>
<p>I disagree. If you want the structure to be inferred implicitly, the information must be somewhere. The alternative is to have a different <code>+</code> / <code>*</code> operator for each one of those structures: <code>+_mod_5</code> / <code>*_mod_5</code>. That would be ugly and evil!</p>

<a name="125332255"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332255" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332255">Kevin Buzzard (Apr 20 2018 at 00:03)</a>:</h4>
<p>If setoid were a structure rather than a class, do you think Chris' code would be OK?</p>

<a name="125332260"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332260" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332260">Kevin Buzzard (Apr 20 2018 at 00:03)</a>:</h4>
<p>The quotient knows the equivalence relation, and the information distinguishing the quotient types is in the equivalence relation</p>

<a name="125332359"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332359" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332359">Kevin Buzzard (Apr 20 2018 at 00:06)</a>:</h4>
<p><code>variables (Y : Type) [has_add Y] [has_one Y]</code></p>

<a name="125332360"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332360" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332360">Kevin Buzzard (Apr 20 2018 at 00:06)</a>:</h4>
<p>I think I just defined the positive integers :-)</p>

<a name="125332361"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332361" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332361">Simon Hudon (Apr 20 2018 at 00:06)</a>:</h4>
<p>Yeah I think that would be good. Maybe rather than making <code>setoid</code> a structure, just make <code>Zmod_setoid</code> into a definition because it is not unique</p>

<a name="125332379"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332379" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332379">Kevin Buzzard (Apr 20 2018 at 00:07)</a>:</h4>
<p>then you'll lose access to the \[[ notation</p>

<a name="125332381"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332381" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332381">Kevin Buzzard (Apr 20 2018 at 00:07)</a>:</h4>
<p>this goes back to the thing I was talking about earlier</p>

<a name="125332382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332382" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332382">Kevin Buzzard (Apr 20 2018 at 00:07)</a>:</h4>
<p>once setoid is deemed to be a class</p>

<a name="125332385"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332385" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332385">Kevin Buzzard (Apr 20 2018 at 00:08)</a>:</h4>
<p>then pretty much whenever it's mentioned in a definition or theorem, it's in a square bracket</p>

<a name="125332386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332386" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332386">Simon Hudon (Apr 20 2018 at 00:08)</a>:</h4>
<blockquote>
<p>I think I just defined the positive integers :-)</p>
</blockquote>
<p>That looks like the Church numerals</p>

<a name="125332428"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332428" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332428">Simon Hudon (Apr 20 2018 at 00:08)</a>:</h4>
<p>Sorry, I kind of jumped in the middle your conversation</p>

<a name="125332434"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332434" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332434">Kevin Buzzard (Apr 20 2018 at 00:09)</a>:</h4>
<p>so it's a pain to work with if you decide not to use the type class inference system</p>

<a name="125332443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332443" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332443">Simon Hudon (Apr 20 2018 at 00:09)</a>:</h4>
<p>Yes, I see now</p>

<a name="125332444"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332444" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332444">Kevin Buzzard (Apr 20 2018 at 00:09)</a>:</h4>
<p>As Mario points out, it's the same sort of thing as the (hypothetical but not completely impossible) possibility of having more than one ring structure on a type</p>

<a name="125332445"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332445" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332445">Simon Hudon (Apr 20 2018 at 00:09)</a>:</h4>
<p>Is it ever necessary to have it inferred?</p>

<a name="125332492"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332492" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332492">Kevin Buzzard (Apr 20 2018 at 00:10)</a>:</h4>
<p>it's just inconvenient not to have it inferred, if Lean wants it to be inferred.</p>

<a name="125332499"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332499" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332499">Kevin Buzzard (Apr 20 2018 at 00:10)</a>:</h4>
<p>That was what I discovered when I had a commutative ring earlier -- if you use the type class inference system then you also automatically have a ring, an additive group, and a whole bunch of other things</p>

<a name="125332504"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332504" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332504">Kevin Buzzard (Apr 20 2018 at 00:11)</a>:</h4>
<p>and if you don't then you're stuck making all of these yourself</p>

<a name="125332521"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332521" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332521">Simon Hudon (Apr 20 2018 at 00:11)</a>:</h4>
<p>What if you skip <code>\[[</code> and instead rely on <code>coe</code> to convert integers to <code>Zmod</code> and <code>has_one</code> / <code>has_add</code> to use numerals?</p>

<a name="125332584"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332584" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332584">Kevin Buzzard (Apr 20 2018 at 00:13)</a>:</h4>
<p>I guess the proof of the pudding would be in the eating</p>

<a name="125332628"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332628" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332628">Kevin Buzzard (Apr 20 2018 at 00:14)</a>:</h4>
<p>I was fine explictly writing my proofs that various types were commutative rings up to a point</p>

<a name="125332632"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332632" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332632">Kevin Buzzard (Apr 20 2018 at 00:14)</a>:</h4>
<p>and then it got inconvenient and then I figured out how to use type class inference.</p>

<a name="125332637"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332637" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332637">Kevin Buzzard (Apr 20 2018 at 00:14)</a>:</h4>
<p>Those things aren't quite church numerals</p>

<a name="125332638"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332638" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332638">Kevin Buzzard (Apr 20 2018 at 00:14)</a>:</h4>
<p>as far as I can see at least</p>

<a name="125332647"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332647" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332647">Kevin Buzzard (Apr 20 2018 at 00:15)</a>:</h4>
<p>but they do have a similar flavour</p>

<a name="125332757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332757" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332757">Kevin Buzzard (Apr 20 2018 at 00:19)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">hudon_numeral</span> <span class="o">:=</span> <span class="bp">Π</span> <span class="o">(</span><span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">),</span> <span class="o">(</span><span class="n">Y</span> <span class="bp">→</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">Y</span><span class="o">)</span> <span class="bp">→</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">Y</span>
<span class="n">def</span> <span class="n">one</span> <span class="o">:</span> <span class="n">hudon_numeral</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">Y</span> <span class="n">h_add</span> <span class="n">h_one</span><span class="o">,</span> <span class="n">h_one</span>
<span class="n">def</span> <span class="n">two</span> <span class="o">:</span> <span class="n">hudon_numeral</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">Y</span> <span class="n">h_add</span> <span class="n">h_one</span><span class="o">,</span> <span class="n">h_add</span> <span class="n">h_one</span> <span class="n">h_one</span>
</pre></div>

<a name="125332760"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332760" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332760">Kevin Buzzard (Apr 20 2018 at 00:19)</a>:</h4>
<p>etc</p>

<a name="125332812"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125332812" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125332812">Simon Hudon (Apr 20 2018 at 00:20)</a>:</h4>
<p>Ah yes I see! 0 is missing and Church encodes <code>succ</code> rather than <code>add</code></p>

<a name="125443745"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125443745" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125443745">Chris Hughes (Apr 20 2018 at 11:05)</a>:</h4>
<p>Any advice about how to deal with this issue? </p>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">Zmod_fintype</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">}</span> <span class="o">(</span><span class="n">hn</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="n">fintype</span> <span class="o">(</span><span class="n">Zmod</span> <span class="n">n</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">fintype</span><span class="bp">.</span><span class="n">of_equiv</span> <span class="bp">_</span> <span class="o">(</span><span class="n">equiv_fin</span> <span class="n">hn</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span>
</pre></div>


<p>I can't make this an instance, because it's only true if <code>n ≠ 0</code></p>

<a name="125444830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125444830" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125444830">Kevin Buzzard (Apr 20 2018 at 11:14)</a>:</h4>
<p>Why not let n be in pnat (positive integers) instead of Z?</p>

<a name="125444960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125444960" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125444960">Chris Hughes (Apr 20 2018 at 11:18)</a>:</h4>
<p>Probably the best thing. Alternative is to define the equivalence relation differently in the case <code>n = 0</code>, so <code>Zmod 0</code> is a fintype.</p>

<a name="125445223"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125445223" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125445223">Chris Hughes (Apr 20 2018 at 11:26)</a>:</h4>
<p>Then there's also the issue of proving it's a field in the case <code>prime p</code></p>

<a name="125445230"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125445230" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125445230">Kenny Lau (Apr 20 2018 at 11:27)</a>:</h4>
<p><code>fintype (Zmod $ nat.succ m)</code></p>

<a name="125445289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125445289" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125445289">Chris Hughes (Apr 20 2018 at 11:29)</a>:</h4>
<p><code>n</code> is an int currently</p>

<a name="125458960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125458960" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125458960">Kevin Buzzard (Apr 20 2018 at 17:34)</a>:</h4>
<p>I have another type class inference issue and this one is rather frustrating.</p>

<a name="125458969"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125458969" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125458969">Kevin Buzzard (Apr 20 2018 at 17:34)</a>:</h4>
<p>I am making a definition, so I really want to stay in term mode.</p>

<a name="125458971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125458971" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125458971">Kevin Buzzard (Apr 20 2018 at 17:34)</a>:</h4>
<p>I wrote down something which should work</p>

<a name="125458983"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125458983" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125458983">Kevin Buzzard (Apr 20 2018 at 17:35)</a>:</h4>
<p>and Lean complained that it could not prove that a certain composition of two maps was a ring homomorphism.</p>

<a name="125458987"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125458987" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125458987">Kevin Buzzard (Apr 20 2018 at 17:35)</a>:</h4>
<p>So I tried again in tactic mode</p>

<a name="125459006"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459006" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459006">Kevin Buzzard (Apr 20 2018 at 17:35)</a>:</h4>
<p>(each map is a ring hom, with an instance, and the composite of two ring homs is a ring hom, and this is an instance too, so it should work)</p>

<a name="125459058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459058" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459058">Kevin Buzzard (Apr 20 2018 at 17:36)</a>:</h4>
<p>and in tactic mode I have managed to get Lean into a state where the goal is to show that the map is a ring hom (I did this using <code>refine</code>)</p>

<a name="125459059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459059" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459059">Kevin Buzzard (Apr 20 2018 at 17:36)</a>:</h4>
<p>and <code>apply_instance</code> fails</p>

<a name="125459063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459063" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459063">Kevin Buzzard (Apr 20 2018 at 17:36)</a>:</h4>
<p>but <code>show ([cut and paste the goal])</code></p>

<a name="125459066"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459066" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459066">Kevin Buzzard (Apr 20 2018 at 17:36)</a>:</h4>
<p>followed by <code>apply_instance</code> succeeds.</p>

<a name="125459079"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459079" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459079">Kevin Buzzard (Apr 20 2018 at 17:37)</a>:</h4>
<p>In term mode, the proof should look like this:</p>

<a name="125459080"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459080" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459080">Kevin Buzzard (Apr 20 2018 at 17:37)</a>:</h4>
<p><code>to_fun := away.extend_map_of_im_unit ((of_comm_ring (away f) _) ∘ (of_comm_ring R (powers f))) H,</code></p>

<a name="125459087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459087" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459087">Kevin Buzzard (Apr 20 2018 at 17:37)</a>:</h4>
<p>(it's some part of a structure I'm defining)</p>

<a name="125459144"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459144" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459144">Kevin Buzzard (Apr 20 2018 at 17:38)</a>:</h4>
<p>but <code>away.extend_map_of_im_unit</code> requires that the map (a composite of two ring homs) is a ring hom</p>

<a name="125459165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459165" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459165">Kevin Buzzard (Apr 20 2018 at 17:39)</a>:</h4>
<p>So here it feels to me like Lean is not working as well as it could be.</p>

<a name="125459169"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459169" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459169">Kevin Buzzard (Apr 20 2018 at 17:39)</a>:</h4>
<p>But I don't have any feeling as to why not</p>

<a name="125459242"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459242" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459242">Kevin Buzzard (Apr 20 2018 at 17:41)</a>:</h4>
<p>If I set <code>pp.all true</code> I can see that the <code>show</code> command is doing something</p>

<a name="125459251"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459251" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459251">Kevin Buzzard (Apr 20 2018 at 17:41)</a>:</h4>
<p>but unfortunately these are complex maps defined between complex rings</p>

<a name="125459257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459257" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459257">Kevin Buzzard (Apr 20 2018 at 17:41)</a>:</h4>
<p>and so I am having trouble figuring out what I have done wrong</p>

<a name="125459260"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459260" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459260">Kevin Buzzard (Apr 20 2018 at 17:41)</a>:</h4>
<p>and whether it's Lean's fault or mine</p>

<a name="125459438"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459438" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459438">Kevin Buzzard (Apr 20 2018 at 17:45)</a>:</h4>
<p>Here are the two (rather lengthy) goals.</p>

<a name="125459440"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459440" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459440">Kevin Buzzard (Apr 20 2018 at 17:45)</a>:</h4>
<p><a href="https://gist.github.com/kbuzzard/a09dc87e290c0497db65c4c702b37c2f" target="_blank" title="https://gist.github.com/kbuzzard/a09dc87e290c0497db65c4c702b37c2f">https://gist.github.com/kbuzzard/a09dc87e290c0497db65c4c702b37c2f</a></p>

<a name="125459524"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459524" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459524">Kevin Buzzard (Apr 20 2018 at 17:47)</a>:</h4>
<p>Just to be clear: my problem is that I need to prove something in term mode because it's part of a definition. Type class inference fails me and I don't know why. In tactic mode I can make type class inference succeed.</p>

<a name="125459544"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459544" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459544">Kevin Buzzard (Apr 20 2018 at 17:47)</a>:</h4>
<p>I could go down the awful route of adding <code>@</code>s and explicitly chasing up the proof, but I would rather let type class inference do its job properly and just add hints.</p>

<a name="125459604"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459604" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459604">Simon Hudon (Apr 20 2018 at 17:48)</a>:</h4>
<p>if it's a proof (i.e. it's type is a <code>Prop</code>) I think you can use a tactic:</p>
<div class="codehilite"><pre><span></span>to_fun :=
have local_proof : something, by ...,
definition_using_local_proof,
</pre></div>

<a name="125459924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125459924" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125459924">Simon Hudon (Apr 20 2018 at 17:55)</a>:</h4>
<p>To my memory, <code>local_proof</code> gets compiled to an auxiliary definition / lemma and you'll have <code>to_fun := definition_using_local_proof</code> with a reference to that auxiliary definition (which will not be displayed because of proof erasure).</p>

<a name="125460308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460308" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460308">Kevin Buzzard (Apr 20 2018 at 18:03)</a>:</h4>
<p>Unfortunately this fails, because my local proof is not a proof of the correct thing.</p>

<a name="125460313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460313" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460313">Kevin Buzzard (Apr 20 2018 at 18:03)</a>:</h4>
<p>My local proof is a proof of the second monstrous expression in the gist, which can be proved by type class inference.</p>

<a name="125460320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460320" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460320">Kevin Buzzard (Apr 20 2018 at 18:03)</a>:</h4>
<p>I have two maps phi and psi</p>

<a name="125460361"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460361" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460361">Kevin Buzzard (Apr 20 2018 at 18:04)</a>:</h4>
<p>and I can prove <code>is_ring_hom (phi comp psi)</code> with <code>apply_instance</code></p>

<a name="125460370"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460370" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460370">Kevin Buzzard (Apr 20 2018 at 18:04)</a>:</h4>
<p>but when I write <code>foo (phi comp psi)</code></p>

<a name="125460372"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460372" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460372">Kevin Buzzard (Apr 20 2018 at 18:04)</a>:</h4>
<p>for some function foo which needs (phi comp psi) to be a ring hom</p>

<a name="125460374"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460374" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460374">Kevin Buzzard (Apr 20 2018 at 18:04)</a>:</h4>
<p>then type class inference fails</p>

<a name="125460384"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460384" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460384">Kevin Buzzard (Apr 20 2018 at 18:05)</a>:</h4>
<p>well, this is my understanding of the situation.</p>

<a name="125460405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460405" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460405">Kevin Buzzard (Apr 20 2018 at 18:05)</a>:</h4>
<p>I tried to create a MWE but I could not reproduce the problem in a controlled environment</p>

<a name="125460490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460490" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460490">Simon Hudon (Apr 20 2018 at 18:06)</a>:</h4>
<p>What do you know about <code>phi comp psi</code> that makes it a <code>is_ring_hom</code>? Could you create:</p>
<div class="codehilite"><pre><span></span>instance [... some context about (phi comp psi) ...] : is_ring_hom (phi comp psi) := ...
</pre></div>


<p>right before the structure you're trying to define?</p>

<a name="125460538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460538" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460538">Johan Commelin (Apr 20 2018 at 18:07)</a>:</h4>
<p><code>phi</code> and <code>psi</code> are both ring homs themselves, if I understand Kevin correctly</p>

<a name="125460635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460635" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460635">Kevin Buzzard (Apr 20 2018 at 18:09)</a>:</h4>
<p>Type class inference will make it a ring hom</p>

<a name="125460684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460684" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460684">Kevin Buzzard (Apr 20 2018 at 18:10)</a>:</h4>
<p>Here is a very clear explanation of the situation I find myself in:</p>

<a name="125460694"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460694" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460694">Kevin Buzzard (Apr 20 2018 at 18:10)</a>:</h4>
<div class="codehilite"><pre><span></span>  <span class="n">to_fun</span> <span class="o">:=</span> <span class="k">have</span> <span class="n">XXX</span> <span class="o">:</span> <span class="n">is_ring_hom</span>
    <span class="o">(</span><span class="n">of_comm_ring</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="n">g</span><span class="o">))</span> <span class="err">∘</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">))</span> <span class="o">)</span>
    <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span><span class="o">,</span>
  <span class="n">away</span><span class="bp">.</span><span class="n">extend_map_of_im_unit</span>
              <span class="o">(</span><span class="n">of_comm_ring</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="n">g</span><span class="o">))</span> <span class="err">∘</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)))</span>
              <span class="n">sorry</span><span class="o">,</span>
</pre></div>

<a name="125460701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460701" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460701">Kevin Buzzard (Apr 20 2018 at 18:10)</a>:</h4>
<p>(the sorry at the end is just to save you from having to look at another term)</p>

<a name="125460708"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460708" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460708">Kevin Buzzard (Apr 20 2018 at 18:10)</a>:</h4>
<p>So this definition fails</p>

<a name="125460711"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460711" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460711">Kevin Buzzard (Apr 20 2018 at 18:10)</a>:</h4>
<p>there's a red squiggle under <code>away</code></p>

<a name="125460715"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460715" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460715">Kevin Buzzard (Apr 20 2018 at 18:11)</a>:</h4>
<p>and the error is</p>

<a name="125460727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460727" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460727">Kevin Buzzard (Apr 20 2018 at 18:11)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">failed</span> <span class="n">to</span> <span class="n">synthesize</span> <span class="n">type</span> <span class="n">class</span> <span class="kn">instance</span> <span class="n">for</span>
<span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_1</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">R</span><span class="o">,</span>
<span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">R</span><span class="o">,</span>
<span class="n">H</span> <span class="o">:</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span> <span class="err">⊆</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">f</span><span class="o">,</span>
<span class="n">XXX</span> <span class="o">:</span> <span class="n">is_ring_hom</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="n">g</span><span class="o">))</span> <span class="err">∘</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">))</span>
<span class="err">⊢</span> <span class="n">is_ring_hom</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="n">g</span><span class="o">))</span> <span class="err">∘</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">))</span>
</pre></div>

<a name="125460736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460736" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460736">Kevin Buzzard (Apr 20 2018 at 18:11)</a>:</h4>
<p>Note that the goal looks exactly like <code>XXX</code></p>

<a name="125460745"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460745" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460745">Kevin Buzzard (Apr 20 2018 at 18:11)</a>:</h4>
<p>and what is even more frustrating is that the goal and <code>XXX</code> were both created in the same way</p>

<a name="125460790"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460790" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460790">Kevin Buzzard (Apr 20 2018 at 18:12)</a>:</h4>
<p>by typing the same string twice</p>

<a name="125460794"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460794" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460794">Kevin Buzzard (Apr 20 2018 at 18:12)</a>:</h4>
<p>namely the string which appears in the goal</p>

<a name="125460800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460800" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460800">Kevin Buzzard (Apr 20 2018 at 18:12)</a>:</h4>
<p>however if I set pp.all true</p>

<a name="125460808"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460808" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460808">Kevin Buzzard (Apr 20 2018 at 18:12)</a>:</h4>
<p>then XXX and the goal expand into the two distinct, but defeq, monsters</p>

<a name="125460830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460830" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460830">Kevin Buzzard (Apr 20 2018 at 18:13)</a>:</h4>
<p>and note that XXX was proved by type class inference</p>

<a name="125460885"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460885" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460885">Kevin Buzzard (Apr 20 2018 at 18:14)</a>:</h4>
<p>What I need to understand to proceed, I think, is that I'd like to understand how Lean can unfold the same string in two different ways in these two situations.</p>

<a name="125460896"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460896" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460896">Kevin Buzzard (Apr 20 2018 at 18:14)</a>:</h4>
<p>I am scared to use a let to define the function, because I am scared it will cause me problems further down the line</p>

<a name="125460917"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460917" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460917">Kevin Buzzard (Apr 20 2018 at 18:15)</a>:</h4>
<p>I am trying to prove that a map is a bijection and if I do something screwy when defining the map then I'm worried I won't be able to use it later</p>

<a name="125460977"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460977" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460977">Simon Hudon (Apr 20 2018 at 18:16)</a>:</h4>
<p>The problem might be in the two terms that are defeq but not identical. Cosmetic differences in the syntax can take the instance inference process in a different direction. Do you think you can make them exactly identical?</p>

<a name="125460979"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460979" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460979">Kevin Buzzard (Apr 20 2018 at 18:16)</a>:</h4>
<p>this is exactly what I cannot do</p>

<a name="125460982"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460982" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460982">Kevin Buzzard (Apr 20 2018 at 18:17)</a>:</h4>
<p>because as you can see from my term</p>

<a name="125460989"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460989" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460989">Kevin Buzzard (Apr 20 2018 at 18:17)</a>:</h4>
<p>I created <code>XXX</code> and the input to <code>away.extend_map_of_im_unit </code> by typing exactly the same string of characters.</p>

<a name="125460992"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125460992" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125460992">Simon Hudon (Apr 20 2018 at 18:18)</a>:</h4>
<p>including the <code>@</code>?</p>

<a name="125461035"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125461035" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125461035">Kevin Buzzard (Apr 20 2018 at 18:18)</a>:</h4>
<p>aah I see</p>

<a name="125461038"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125461038" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125461038">Kevin Buzzard (Apr 20 2018 at 18:18)</a>:</h4>
<p>I can try to be more persuasive</p>

<a name="125461051"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125461051" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125461051">Simon Hudon (Apr 20 2018 at 18:19)</a>:</h4>
<p>It will probably not be concise but we can work on that once we know it works</p>

<a name="125461063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125461063" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125461063">Kevin Buzzard (Apr 20 2018 at 18:19)</a>:</h4>
<p>by the way, am I right in thinking that I should not be using <code>let</code> in a defintion of a map?</p>

<a name="125461117"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125461117" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125461117">Kevin Buzzard (Apr 20 2018 at 18:20)</a>:</h4>
<p>Many thanks Simon</p>

<a name="125461123"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125461123" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125461123">Kevin Buzzard (Apr 20 2018 at 18:20)</a>:</h4>
<p>Explicitly telling Lean what the type of the composition was has solved the problem</p>

<a name="125461141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125461141" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125461141">Kevin Buzzard (Apr 20 2018 at 18:21)</a>:</h4>
<p>Thanks a <em>lot</em> for persevering with this very awkward problem which was completely blocking me.</p>

<a name="125461152"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125461152" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125461152">Kevin Buzzard (Apr 20 2018 at 18:21)</a>:</h4>
<p>Many thanks indeed.</p>

<a name="125461200"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125461200" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125461200">Simon Hudon (Apr 20 2018 at 18:22)</a>:</h4>
<p>You're very welcome :)</p>

<a name="125461268"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125461268" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125461268">Simon Hudon (Apr 20 2018 at 18:24)</a>:</h4>
<blockquote>
<p>by the way, am I right in thinking that I should not be using <code>let</code> in a defintion of a map?</p>
</blockquote>
<p>I would avoid it especially if you're going to prove stuff about it. Maybe you're asking about the ùmathlibù style though. I haven't seen that mentioned anywhere but facilitating proofs using your definitions is likely to make you popular with the <code>mathlib</code> team.</p>

<a name="125472229"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125472229" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125472229">Mario Carneiro (Apr 20 2018 at 23:12)</a>:</h4>
<p>Have you tried using <code>by exact</code> in your definition? There is nothing wrong with using tactics in the definition of a term, although you may need to be more conscientious about junk added to your term by lean (or use <code>by clean</code>)</p>

<a name="125472249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125472249" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125472249">Mario Carneiro (Apr 20 2018 at 23:13)</a>:</h4>
<p>there is not a problem with using <code>let</code> or other techniques in defining a complicated function, although you will probably want to write simp lemmas providing your interface so you don't need to rely on definitional expansion</p>

<a name="125504684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504684" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504684">Kevin Buzzard (Apr 21 2018 at 20:34)</a>:</h4>
<p>Gaargh I have another one. Here's a MWE.</p>

<a name="125504686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504686" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504686">Kevin Buzzard (Apr 21 2018 at 20:34)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">ring</span>
<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="n">uu</span>

<span class="kn">structure</span> <span class="n">is_unique_R_alg_hom</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">β</span><span class="o">]</span>
<span class="o">(</span><span class="n">sα</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">sβ</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">sα</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">sβ</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">f</span><span class="o">]</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">R_alg_hom</span> <span class="o">:</span> <span class="n">sβ</span> <span class="bp">=</span> <span class="n">f</span> <span class="err">∘</span> <span class="n">sα</span><span class="o">)</span>
<span class="o">(</span><span class="n">is_unique</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">,</span> <span class="n">is_ring_hom</span> <span class="n">g</span> <span class="bp">→</span> <span class="n">sβ</span> <span class="bp">=</span> <span class="n">g</span> <span class="err">∘</span> <span class="n">sα</span> <span class="bp">→</span> <span class="n">g</span> <span class="bp">=</span> <span class="n">f</span><span class="o">)</span>

<span class="kn">lemma</span> <span class="n">comp_unique</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">}</span> <span class="o">{</span><span class="n">γ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">uu</span><span class="o">}</span>
  <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">γ</span><span class="o">]</span>
  <span class="o">(</span><span class="n">sα</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">sβ</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">sγ</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span>
  <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">sα</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">sβ</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">sγ</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">f</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">g</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">h</span><span class="o">]</span> <span class="o">:</span>
  <span class="n">is_unique_R_alg_hom</span> <span class="n">sα</span> <span class="n">sβ</span> <span class="n">f</span> <span class="bp">→</span> <span class="n">is_unique_R_alg_hom</span> <span class="n">sβ</span> <span class="n">sγ</span> <span class="n">g</span> <span class="bp">→</span> <span class="n">is_unique_R_alg_hom</span> <span class="n">sα</span> <span class="n">sγ</span> <span class="n">h</span> <span class="bp">→</span> <span class="n">g</span> <span class="err">∘</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">h</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">Uf</span> <span class="n">Ug</span> <span class="n">Uh</span><span class="o">,</span> <span class="n">Uh</span><span class="bp">.</span><span class="n">is_unique</span> <span class="o">(</span><span class="n">g</span> <span class="err">∘</span> <span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="k">by</span> <span class="n">apply_instance</span><span class="o">)</span> <span class="o">(</span><span class="k">by</span> <span class="n">simp</span> <span class="o">[</span><span class="n">Uf</span><span class="bp">.</span><span class="n">R_alg_hom</span><span class="o">,</span><span class="n">Ug</span><span class="bp">.</span><span class="n">R_alg_hom</span><span class="o">])</span>
</pre></div>

<a name="125504689"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504689" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504689">Kevin Buzzard (Apr 21 2018 at 20:34)</a>:</h4>
<p>Note the <code>by apply_instance</code> on the last line!</p>

<a name="125504698"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504698" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504698">Kevin Buzzard (Apr 21 2018 at 20:35)</a>:</h4>
<p>If I replace that with <code>_</code> then I get</p>

<a name="125504699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504699" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504699">Kevin Buzzard (Apr 21 2018 at 20:35)</a>:</h4>
<div class="codehilite"><pre><span></span>don&#39;t know how to synthesize placeholder
context:
R : Type u,
α : Type v,
β : Type w,
γ : Type uu,
_inst_1 : comm_ring R,
_inst_2 : comm_ring α,
_inst_3 : comm_ring β,
_inst_4 : comm_ring γ,
sα : R → α,
sβ : R → β,
sγ : R → γ,
f : α → β,
g : β → γ,
h : α → γ,
_inst_5 : is_ring_hom sα,
_inst_6 : is_ring_hom sβ,
_inst_7 : is_ring_hom sγ,
_inst_8 : is_ring_hom f,
_inst_9 : is_ring_hom g,
_inst_10 : is_ring_hom h,
Uf : is_unique_R_alg_hom sα sβ f,
Ug : is_unique_R_alg_hom sβ sγ g,
Uh : is_unique_R_alg_hom sα sγ h
⊢ is_ring_hom (g ∘ f)
</pre></div>

<a name="125504701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504701" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504701">Kevin Buzzard (Apr 21 2018 at 20:35)</a>:</h4>
<p>How does type class inference work? Is <code>_</code> something other than <code>by apply_instance</code>?</p>

<a name="125504758"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504758" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504758">Mario Carneiro (Apr 21 2018 at 20:37)</a>:</h4>
<p>yes</p>

<a name="125504796"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504796" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504796">Kevin Buzzard (Apr 21 2018 at 20:38)</a>:</h4>
<p>I guess I just proved that :-)</p>

<a name="125504799"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504799" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504799">Mario Carneiro (Apr 21 2018 at 20:38)</a>:</h4>
<p><code>_</code> only does unification</p>

<a name="125504804"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504804" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504804">Mario Carneiro (Apr 21 2018 at 20:38)</a>:</h4>
<p>when it is omitted and the binder type is <code>[tc A]</code> it uses typeclass inference</p>

<a name="125504805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504805" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504805">Patrick Massot (Apr 21 2018 at 20:38)</a>:</h4>
<p>You need <code>is_unique_R_alg_hom.is_unique</code> to take a square bracket argument</p>

<a name="125504807"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504807" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504807">Mario Carneiro (Apr 21 2018 at 20:38)</a>:</h4>
<p><code>by apply_instance</code> does the same thing but manually</p>

<a name="125504815"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504815" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504815">Kevin Buzzard (Apr 21 2018 at 20:39)</a>:</h4>
<p>So "don't know how to synthesize placeholder" -- what did it try??</p>

<a name="125504817"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504817" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504817">Mario Carneiro (Apr 21 2018 at 20:39)</a>:</h4>
<p>unification</p>

<a name="125504820"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504820" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504820">Mario Carneiro (Apr 21 2018 at 20:39)</a>:</h4>
<p>and nothing else</p>

<a name="125504822"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504822" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504822">Kevin Buzzard (Apr 21 2018 at 20:39)</a>:</h4>
<p>I don't know what unification means</p>

<a name="125504860"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504860" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504860">Kevin Buzzard (Apr 21 2018 at 20:40)</a>:</h4>
<p>isn't that something to do with finding something of the right type?</p>

<a name="125504865"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504865" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504865">Kevin Buzzard (Apr 21 2018 at 20:40)</a>:</h4>
<p>Oh</p>

<a name="125504866"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504866" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504866">Kevin Buzzard (Apr 21 2018 at 20:40)</a>:</h4>
<p>I remember</p>

<a name="125504869"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504869" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504869">Kevin Buzzard (Apr 21 2018 at 20:40)</a>:</h4>
<p>it means "I will call this ?m_6"</p>

<a name="125504871"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504871" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504871">Kevin Buzzard (Apr 21 2018 at 20:40)</a>:</h4>
<p>"and sort it out later"</p>

<a name="125504884"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504884" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504884">Kevin Buzzard (Apr 21 2018 at 20:41)</a>:</h4>
<p>Thanks Patrick:</p>

<a name="125504885"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504885" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504885">Kevin Buzzard (Apr 21 2018 at 20:41)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">is_unique_R_alg_hom</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">β</span><span class="o">]</span>
<span class="o">(</span><span class="n">sα</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">sβ</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">sα</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">sβ</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">f</span><span class="o">]</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">R_alg_hom</span> <span class="o">:</span> <span class="n">sβ</span> <span class="bp">=</span> <span class="n">f</span> <span class="err">∘</span> <span class="n">sα</span><span class="o">)</span>
<span class="o">(</span><span class="n">is_unique</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">g</span><span class="o">],</span> <span class="n">sβ</span> <span class="bp">=</span> <span class="n">g</span> <span class="err">∘</span> <span class="n">sα</span> <span class="bp">→</span> <span class="n">g</span> <span class="bp">=</span> <span class="n">f</span><span class="o">)</span>

<span class="kn">lemma</span> <span class="n">comp_unique</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">}</span> <span class="o">{</span><span class="n">γ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">uu</span><span class="o">}</span>
  <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">γ</span><span class="o">]</span>
  <span class="o">(</span><span class="n">sα</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">sβ</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">sγ</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span>
  <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">sα</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">sβ</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">sγ</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">f</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">g</span><span class="o">]</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">h</span><span class="o">]</span> <span class="o">:</span>
  <span class="n">is_unique_R_alg_hom</span> <span class="n">sα</span> <span class="n">sβ</span> <span class="n">f</span> <span class="bp">→</span> <span class="n">is_unique_R_alg_hom</span> <span class="n">sβ</span> <span class="n">sγ</span> <span class="n">g</span> <span class="bp">→</span> <span class="n">is_unique_R_alg_hom</span> <span class="n">sα</span> <span class="n">sγ</span> <span class="n">h</span> <span class="bp">→</span> <span class="n">g</span> <span class="err">∘</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">h</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">Uf</span> <span class="n">Ug</span> <span class="n">Uh</span><span class="o">,</span> <span class="n">Uh</span><span class="bp">.</span><span class="n">is_unique</span> <span class="o">(</span><span class="n">g</span> <span class="err">∘</span> <span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="k">by</span> <span class="n">simp</span> <span class="o">[</span><span class="n">Uf</span><span class="bp">.</span><span class="n">R_alg_hom</span><span class="o">,</span><span class="n">Ug</span><span class="bp">.</span><span class="n">R_alg_hom</span><span class="o">])</span>
</pre></div>

<a name="125504929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504929" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504929">Patrick Massot (Apr 21 2018 at 20:42)</a>:</h4>
<p>You're welcome</p>

<a name="125504934"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504934" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504934">Kevin Buzzard (Apr 21 2018 at 20:43)</a>:</h4>
<p>I have abstracted a standard trick :-)</p>

<a name="125504986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504986" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504986">Kevin Buzzard (Apr 21 2018 at 20:44)</a>:</h4>
<p>I see, I was not even asking type class inference to do its job here. So this one is my bad.</p>

<a name="125504987"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125504987" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125504987">Patrick Massot (Apr 21 2018 at 20:44)</a>:</h4>
<p>Indeed</p>

<a name="125508966"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125508966" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125508966">Kevin Buzzard (Apr 21 2018 at 23:15)</a>:</h4>
<p>How do I do this one:</p>

<a name="125508967"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125508967" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125508967">Kevin Buzzard (Apr 21 2018 at 23:15)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">foo</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">bar</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">group</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span> <span class="kt">Prop</span><span class="o">)</span>

<span class="kn">definition</span> <span class="n">X</span> <span class="o">:</span> <span class="n">foo</span> <span class="o">:=</span>
<span class="o">{</span><span class="n">bar</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">Hα</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">,</span> <span class="o">(</span><span class="n">mul_assoc</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">)}</span>
</pre></div>

<a name="125509119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509119" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509119">Kevin Buzzard (Apr 21 2018 at 23:20)</a>:</h4>
<p>Can I use type class inference here?</p>

<a name="125509132"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509132" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509132">Kenny Lau (Apr 21 2018 at 23:21)</a>:</h4>
<p>you need a prop</p>

<a name="125509133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509133" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509133">Kenny Lau (Apr 21 2018 at 23:21)</a>:</h4>
<p>that isn't a prop</p>

<a name="125509135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509135" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509135">Kenny Lau (Apr 21 2018 at 23:22)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">foo</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">bar</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">group</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span> <span class="kt">Prop</span><span class="o">)</span>

<span class="kn">definition</span> <span class="n">X</span> <span class="o">:</span> <span class="n">foo</span> <span class="o">:=</span>
<span class="o">{</span><span class="n">bar</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">g</span> <span class="n">Hg</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">,</span> <span class="k">by</span> <span class="n">letI</span> <span class="o">:=</span> <span class="n">Hg</span><span class="bp">;</span> <span class="k">from</span> <span class="n">mul_assoc</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">}</span>
</pre></div>

<a name="125509173"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509173" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509173">Kenny Lau (Apr 21 2018 at 23:22)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">invalid</span> <span class="n">type</span> <span class="n">ascription</span><span class="o">,</span> <span class="n">term</span> <span class="n">has</span> <span class="n">type</span>
  <span class="n">a</span> <span class="bp">*</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">*</span> <span class="o">(</span><span class="n">b</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="kt">Prop</span> <span class="o">:</span> <span class="kt">Type</span>
<span class="n">state</span><span class="o">:</span>
<span class="n">g</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">,</span>
<span class="n">Hg</span> <span class="o">:</span> <span class="n">group</span> <span class="n">g</span><span class="o">,</span>
<span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">g</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst</span> <span class="o">:</span> <span class="n">group</span> <span class="n">g</span> <span class="o">:=</span> <span class="n">Hg</span>
<span class="err">⊢</span> <span class="kt">Prop</span>
</pre></div>

<a name="125509187"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509187" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509187">Kevin Buzzard (Apr 21 2018 at 23:23)</a>:</h4>
<p>I have some type mismatch error, I think I have more than one problem here</p>

<a name="125509237"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509237" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509237">Kenny Lau (Apr 21 2018 at 23:25)</a>:</h4>
<p>which is?</p>

<a name="125509242"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509242" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509242">Kenny Lau (Apr 21 2018 at 23:25)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">foo</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">bar</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">group</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span> <span class="kt">Prop</span><span class="o">)</span>

<span class="kn">definition</span> <span class="n">X</span> <span class="o">:</span> <span class="n">foo</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">bar</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">g</span> <span class="n">Hg</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">,</span> <span class="bp">@</span><span class="n">mul_assoc</span> <span class="bp">_</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">monoid</span><span class="bp">.</span><span class="n">to_semigroup</span> <span class="n">g</span> <span class="err">$</span> <span class="bp">@</span><span class="n">group</span><span class="bp">.</span><span class="n">to_monoid</span> <span class="n">g</span> <span class="n">Hg</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">}</span>
</pre></div>

<a name="125509394"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509394" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509394">Kevin Buzzard (Apr 21 2018 at 23:30)</a>:</h4>
<p><code>mul_assoc a b c</code> isn't a prop, it's a proof.</p>

<a name="125509395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509395" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509395">Kevin Buzzard (Apr 21 2018 at 23:30)</a>:</h4>
<p>I know I can do it using @, I want to do it using type class inference</p>

<a name="125509397"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509397" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509397">Kevin Buzzard (Apr 21 2018 at 23:30)</a>:</h4>
<p>I want to understand how to make type class inference work, not to understand how to work around it (which I already know)</p>

<a name="125509405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509405" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509405">Kevin Buzzard (Apr 21 2018 at 23:31)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">structure</span> <span class="n">foo</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">bar</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">group</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span> <span class="mi">1</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a</span><span class="o">)</span>

<span class="kn">definition</span> <span class="n">X</span> <span class="o">:</span> <span class="n">foo</span> <span class="o">:=</span>
<span class="o">{</span><span class="n">bar</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">Hα</span> <span class="n">a</span><span class="o">,</span> <span class="n">group</span><span class="bp">.</span><span class="n">one_mul</span> <span class="n">a</span><span class="o">}</span>
</pre></div>

<a name="125509406"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509406" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509406">Kevin Buzzard (Apr 21 2018 at 23:31)</a>:</h4>
<div class="codehilite"><pre><span></span>failed to synthesize type class instance for
α : Type,
Hα : group α,
a : α
⊢ group α
</pre></div>

<a name="125509408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509408" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509408">Kenny Lau (Apr 21 2018 at 23:31)</a>:</h4>
<p>then just letI</p>

<a name="125509445"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509445" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509445">Kevin Buzzard (Apr 21 2018 at 23:32)</a>:</h4>
<p>Where do I put the letI?</p>

<a name="125509448"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509448" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509448">Kevin Buzzard (Apr 21 2018 at 23:32)</a>:</h4>
<p>I am in the middle of a structure</p>

<a name="125509449"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509449" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509449">Kenny Lau (Apr 21 2018 at 23:32)</a>:</h4>
<p><code>by letI := H\a; from group.one_mul a</code></p>

<a name="125509450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509450" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509450">Kevin Buzzard (Apr 21 2018 at 23:32)</a>:</h4>
<p>What if I don't want to go into tactic mode because I am actually defining something?</p>

<a name="125509455"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509455" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509455">Kevin Buzzard (Apr 21 2018 at 23:33)</a>:</h4>
<p>What exactly are yuo suggesting?</p>

<a name="125509461"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509461" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509461">Kevin Buzzard (Apr 21 2018 at 23:34)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">definition</span> <span class="n">X</span> <span class="o">:</span> <span class="n">foo</span> <span class="o">:=</span>
<span class="o">{</span><span class="n">bar</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">Hα</span> <span class="n">a</span><span class="o">,</span> <span class="k">by</span> <span class="n">letI</span> <span class="o">:=</span> <span class="n">Hα</span><span class="bp">;</span> <span class="k">from</span> <span class="n">group</span><span class="bp">.</span><span class="n">one_mul</span> <span class="n">a</span><span class="o">}</span>
</pre></div>

<a name="125509493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509493" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509493">Kevin Buzzard (Apr 21 2018 at 23:34)</a>:</h4>
<p>?</p>

<a name="125509494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509494" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509494">Kenny Lau (Apr 21 2018 at 23:34)</a>:</h4>
<p>yes</p>

<a name="125509499"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509499" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509499">Kevin Buzzard (Apr 21 2018 at 23:34)</a>:</h4>
<p>7 errors</p>

<a name="125509502"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509502" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509502">Kevin Buzzard (Apr 21 2018 at 23:34)</a>:</h4>
<p>including "unknown identifier <code>letI</code>"</p>

<a name="125509506"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509506" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509506">Kevin Buzzard (Apr 21 2018 at 23:35)</a>:</h4>
<p>But even if we can get this to work</p>

<a name="125509509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509509" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509509">Kenny Lau (Apr 21 2018 at 23:35)</a>:</h4>
<p>import anything from mathlib</p>

<a name="125509512"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509512" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509512">Kevin Buzzard (Apr 21 2018 at 23:35)</a>:</h4>
<p>I would rather just make type class inference work.</p>

<a name="125509514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509514" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509514">Kenny Lau (Apr 21 2018 at 23:35)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">group</span>

<span class="kn">structure</span> <span class="n">foo</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">bar</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">group</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span> <span class="mi">1</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a</span><span class="o">)</span>

<span class="kn">definition</span> <span class="n">X</span> <span class="o">:</span> <span class="n">foo</span> <span class="o">:=</span>
<span class="o">{</span><span class="n">bar</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">Hα</span> <span class="n">a</span><span class="o">,</span> <span class="k">by</span> <span class="n">letI</span> <span class="o">:=</span> <span class="n">Hα</span><span class="bp">;</span> <span class="k">from</span> <span class="n">group</span><span class="bp">.</span><span class="n">one_mul</span> <span class="n">a</span><span class="o">}</span>

<span class="bp">#</span><span class="kn">print</span> <span class="n">X</span><span class="bp">._</span><span class="n">proof_1</span>

<span class="c">/-</span><span class="cm"></span>
<span class="cm">theorem X._proof_1 : ∀ (α : Type) (Hα : group α) (a : α), 1 * a = a :=</span>
<span class="cm">λ (α : Type) (Hα : group α) (a : α), let _inst : group α := Hα in group.one_mul a</span>
<span class="cm">-/</span>
</pre></div>

<a name="125509518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509518" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509518">Kevin Buzzard (Apr 21 2018 at 23:35)</a>:</h4>
<p>?!</p>

<a name="125509520"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509520" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509520">Kenny Lau (Apr 21 2018 at 23:36)</a>:</h4>
<p>!?</p>

<a name="125509561"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509561" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509561">Kevin Buzzard (Apr 21 2018 at 23:36)</a>:</h4>
<p>which version of Lean are you using?</p>

<a name="125509562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509562" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509562">Kevin Buzzard (Apr 21 2018 at 23:36)</a>:</h4>
<p>aah</p>

<a name="125509563"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509563" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509563">Kevin Buzzard (Apr 21 2018 at 23:36)</a>:</h4>
<p>I have no import</p>

<a name="125509568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509568" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509568">Kevin Buzzard (Apr 21 2018 at 23:37)</a>:</h4>
<p><code>letI</code> is some mathlib magic I guess</p>

<a name="125509569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509569" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509569">Kenny Lau (Apr 21 2018 at 23:37)</a>:</h4>
<p>it is.</p>

<a name="125509571"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509571" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509571">Kenny Lau (Apr 21 2018 at 23:37)</a>:</h4>
<p>it is Mario's workaround of Leo's changes.</p>

<a name="125509572"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509572" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509572">Kenny Lau (Apr 21 2018 at 23:37)</a>:</h4>
<p>So it's in mathlib.</p>

<a name="125509573"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509573" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509573">Kevin Buzzard (Apr 21 2018 at 23:37)</a>:</h4>
<p>Well thank you for your answer, which kind of stinks</p>

<a name="125509612"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509612" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509612">Kevin Buzzard (Apr 21 2018 at 23:38)</a>:</h4>
<p>Your answer seems to indicate that <code>[group \a]</code> is useless in my structure</p>

<a name="125509614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509614" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509614">Kevin Buzzard (Apr 21 2018 at 23:38)</a>:</h4>
<p>i.e. it didn't insert H\a into the type class inference system anyway</p>

<a name="125509622"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509622" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509622">Kevin Buzzard (Apr 21 2018 at 23:39)</a>:</h4>
<p>but wait a minute, isn't this what Patrick told me to do earlier?</p>

<a name="125509623"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509623" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509623">Kenny Lau (Apr 21 2018 at 23:39)</a>:</h4>
<p>only typeclasses before the colon are inserted</p>

<a name="125509624"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509624" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509624">Kenny Lau (Apr 21 2018 at 23:39)</a>:</h4>
<p>that is Leo's changes</p>

<a name="125509626"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509626" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509626">Kevin Buzzard (Apr 21 2018 at 23:39)</a>:</h4>
<p>I am writing another localization interface by the way</p>

<a name="125509627"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509627" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509627">Kevin Buzzard (Apr 21 2018 at 23:39)</a>:</h4>
<p>rewriting your universal properties</p>

<a name="125509628"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509628" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509628">Kenny Lau (Apr 21 2018 at 23:39)</a>:</h4>
<p>heh</p>

<a name="125509979"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125509979" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125509979">Mario Carneiro (Apr 21 2018 at 23:52)</a>:</h4>
<p>you don't need to use <code>letI</code>, <code>by exactI</code> is the right solution for this application</p>

<a name="125510034"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125510034" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125510034">Kenny Lau (Apr 21 2018 at 23:54)</a>:</h4>
<p>aha</p>

<a name="125510848"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125510848" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125510848">Kevin Buzzard (Apr 22 2018 at 00:25)</a>:</h4>
<p><a href="https://github.com/kbuzzard/lean-stacks-project/blob/master/src/localization_UMP.lean" target="_blank" title="https://github.com/kbuzzard/lean-stacks-project/blob/master/src/localization_UMP.lean">https://github.com/kbuzzard/lean-stacks-project/blob/master/src/localization_UMP.lean</a></p>

<a name="125510887"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125510887" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125510887">Kevin Buzzard (Apr 22 2018 at 00:26)</a>:</h4>
<p>I have finally battled through all my typeclass inference issues.</p>

<a name="125510888"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125510888" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125510888">Kevin Buzzard (Apr 22 2018 at 00:26)</a>:</h4>
<p>Kenny, I wrote an even better interface for localization</p>

<a name="125510889"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125510889" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125510889">Kevin Buzzard (Apr 22 2018 at 00:26)</a>:</h4>
<p>I put all the stuff which makes up the universal properties into one structure</p>

<a name="125510892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125510892" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125510892">Kevin Buzzard (Apr 22 2018 at 00:27)</a>:</h4>
<p><code>is_unique_R_alg_hom</code></p>

<a name="125510895"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125510895" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125510895">Kevin Buzzard (Apr 22 2018 at 00:27)</a>:</h4>
<p>Mario, it's not quite mathlib-ready, but one day this should probably be in mathlib in some form if localization is in</p>

<a name="125510897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125510897" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125510897">Kevin Buzzard (Apr 22 2018 at 00:27)</a>:</h4>
<p>because this file makes the localization stuff usable without ever having to touch the quotient type itself</p>

<a name="125510936"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125510936" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125510936">Kevin Buzzard (Apr 22 2018 at 00:28)</a>:</h4>
<p>I know because I'm using localization all the time in my schemes work and this work is what led me to the formalisation and the instances in the file I just linked to</p>

<a name="125510937"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125510937" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125510937">Kevin Buzzard (Apr 22 2018 at 00:28)</a>:</h4>
<p>There's one more instance of the structure which is commonly used which we still have to fill in</p>

<a name="125511151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125511151" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125511151">Mario Carneiro (Apr 22 2018 at 00:37)</a>:</h4>
<p>Shouldn't <code>comp_unique</code> read something like <code>is_unique_R_alg_hom sα sβ f → is_unique_R_alg_hom sβ sγ g → is_unique_R_alg_hom sα sγ (g ∘ f)</code>?</p>

<a name="125511244"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125511244" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125511244">Mario Carneiro (Apr 22 2018 at 00:40)</a>:</h4>
<blockquote>
<p><code>by rw ←HR.symm</code></p>
</blockquote>
<p>what?</p>

<a name="125523403"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125523403" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125523403">Patrick Massot (Apr 22 2018 at 09:10)</a>:</h4>
<p>Nice one!</p>

<a name="125523409"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125523409" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125523409">Patrick Massot (Apr 22 2018 at 09:11)</a>:</h4>
<p>Kevin, is there is reason why your file doesn't have <code>open classical</code> towards the top? You write <code>classical.</code> quite a lot</p>

<a name="125523921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125523921" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125523921">Kevin Buzzard (Apr 22 2018 at 09:32)</a>:</h4>
<blockquote>
<p>Shouldn't <code>comp_unique</code> read something like <code>is_unique_R_alg_hom sα sβ f → is_unique_R_alg_hom sβ sγ g → is_unique_R_alg_hom sα sγ (g ∘ f)</code>?</p>
</blockquote>
<p>No. That's not even true in general. The standard use of the universal property to prove that certain maps are isomorphisms is via the following argument: "We are given maps X-&gt; Y and Y -&gt; X. The given map from X to Y is the only map X -&gt; Y with a certain property (e.g. being an R-algebra map). The map given Y -&gt; X is the only map Y -&gt; X with a certain property. Composition of two maps with the property has the property. The identity map X -&gt; X is the only map X -&gt; X with the property. Hence X -&gt; Y -&gt; X is the identity map by comp_unique. Furthermore the identity map Y -&gt; Y is the only map Y -&gt; Y with the property. Hence Y -&gt; X -&gt; Y is also the identity. So X isomorphic to Y".</p>

<a name="125523973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125523973" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125523973">Kevin Buzzard (Apr 22 2018 at 09:35)</a>:</h4>
<p>The reason your suggestion is not true is that there could be plenty of maps from A to C which don't factor through B.</p>

<a name="125524012"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125524012" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125524012">Kevin Buzzard (Apr 22 2018 at 09:36)</a>:</h4>
<p>I don't open classical because I typically don't open anything. I am very bad at namespaces in general. A whole bunch of my code is incorrectly sitting in the root namespace. The whole thing needs a clear-up.</p>

<a name="125524203"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125524203" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125524203">Kevin Buzzard (Apr 22 2018 at 09:44)</a>:</h4>
<blockquote>
<blockquote>
<p><code>by rw ←HR.symm</code></p>
</blockquote>
<p>what?</p>
</blockquote>
<p>ha ha. I think it was getting late at that point. This was kind of stupid. I had that composition of f and g was h, but needed to show <code>forall x, f (g x) = h x</code>and I felt that this should just be an application of a standard lemma but I couldn't find it. So I just wrote "lambda x, by rw (proof that f circ g = h)" a few times, but then something was the other way round so I switched it and then something else was the other way around so I had to switch it back</p>

<a name="125628730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125628730" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125628730">Kevin Buzzard (Apr 24 2018 at 16:50)</a>:</h4>
<blockquote>
<p>Shouldn't <code>comp_unique</code> read something like <code>is_unique_R_alg_hom sα sβ f → is_unique_R_alg_hom sβ sγ g → is_unique_R_alg_hom sα sγ (g ∘ f)</code>?</p>
</blockquote>
<p>Maybe you'll like this one:</p>

<a name="125628734"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125628734" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125628734">Kevin Buzzard (Apr 24 2018 at 16:51)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">unique_R_of_unique_R_of_unique_Rloc</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">}</span> <span class="o">{</span><span class="n">γ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">uu</span><span class="o">}</span>
<span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">γ</span><span class="o">]</span>
<span class="o">(</span><span class="n">sα</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">sα</span><span class="o">]</span> <span class="o">(</span><span class="n">fαβ</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">fαβ</span><span class="o">]</span> <span class="o">(</span><span class="n">fβγ</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="n">is_ring_hom</span> <span class="n">fβγ</span><span class="o">]</span> <span class="o">:</span>
<span class="n">is_unique_R_alg_hom</span> <span class="n">sα</span> <span class="o">(</span><span class="n">fβγ</span> <span class="err">∘</span> <span class="n">fαβ</span> <span class="err">∘</span> <span class="n">sα</span><span class="o">)</span> <span class="o">(</span><span class="n">fβγ</span> <span class="err">∘</span> <span class="n">fαβ</span><span class="o">)</span>
<span class="bp">→</span> <span class="n">is_unique_R_alg_hom</span> <span class="n">fαβ</span> <span class="o">(</span><span class="n">fβγ</span> <span class="err">∘</span> <span class="n">fαβ</span><span class="o">)</span> <span class="n">fβγ</span>
<span class="bp">→</span> <span class="n">is_unique_R_alg_hom</span> <span class="o">(</span><span class="n">fαβ</span> <span class="err">∘</span> <span class="n">sα</span><span class="o">)</span> <span class="o">(</span><span class="n">fβγ</span>  <span class="err">∘</span> <span class="n">fαβ</span> <span class="err">∘</span> <span class="n">sα</span><span class="o">)</span> <span class="o">(</span><span class="n">fβγ</span><span class="o">)</span> <span class="o">:=</span>
</pre></div>

<a name="125628799"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125628799" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125628799">Kevin Buzzard (Apr 24 2018 at 16:52)</a>:</h4>
<p>If there's a unique R-alg hom from alpha to gamma and a unique alpha-alg hom from beta to gamma then there's a unique R-alg hom from beta to gamma (and it's the same map)</p>

<a name="125628813"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125628813" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125628813">Kevin Buzzard (Apr 24 2018 at 16:52)</a>:</h4>
<p>(oh, the R-alg hom from alpha to gamma must be the composite of a given map alpha -&gt; beta and our given alpha-alg map from beta to gamma)</p>

<a name="125629917"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125629917" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125629917">Johan Commelin (Apr 24 2018 at 17:18)</a>:</h4>
<p>This feels like you want to hit it with Yoneda and reduce it to some basic set-theoretic fact... But that is only instinct</p>

<a name="125629948"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125629948" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125629948">Johan Commelin (Apr 24 2018 at 17:19)</a>:</h4>
<p>You're looking at both R-alg-homs and alpha-alg-homs... so maybe it is not that straightforward actually</p>

<a name="125629956"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125629956" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125629956">Kenny Lau (Apr 24 2018 at 17:19)</a>:</h4>
<p>don't get him started on alpha</p>

<a name="125629960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125629960" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125629960">Johan Commelin (Apr 24 2018 at 17:19)</a>:</h4>
<p>What do you mean?</p>

<a name="125629968"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125629968" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125629968">Johan Commelin (Apr 24 2018 at 17:19)</a>:</h4>
<p>There is alpha's everywhere in his code</p>

<a name="125630009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630009" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630009">Johan Commelin (Apr 24 2018 at 17:20)</a>:</h4>
<p>I was actually surprised when I saw that</p>

<a name="125630023"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630023" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630023">Kenny Lau (Apr 24 2018 at 17:20)</a>:</h4>
<p>don't say "alpha" and any mathematical object in the same sentence in front of kevin buzzard</p>

<a name="125630032"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630032" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630032">Johan Commelin (Apr 24 2018 at 17:20)</a>:</h4>
<p>But he just did that himself!</p>

<a name="125630039"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630039" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630039">Kenny Lau (Apr 24 2018 at 17:20)</a>:</h4>
<p>it doesn't matter</p>

<a name="125630634"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630634" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630634">Kevin Buzzard (Apr 24 2018 at 17:33)</a>:</h4>
<p>Did you notice that when we were doing groups earlier I used alpha to be a group homomorphism just to wind up the CS folk?</p>

<a name="125630639"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630639" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630639">Kevin Buzzard (Apr 24 2018 at 17:34)</a>:</h4>
<p>alpha : G to H</p>

<a name="125630684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630684" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630684">Kevin Buzzard (Apr 24 2018 at 17:34)</a>:</h4>
<p>The reason I am using alpha for a ring</p>

<a name="125630687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630687" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630687">Kevin Buzzard (Apr 24 2018 at 17:34)</a>:</h4>
<p>is that the most important ring is called R</p>

<a name="125630689"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630689" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630689">Kevin Buzzard (Apr 24 2018 at 17:34)</a>:</h4>
<p>and then I needed three more</p>

<a name="125630693"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630693" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630693">Kevin Buzzard (Apr 24 2018 at 17:34)</a>:</h4>
<p>but I couldn't face S T U</p>

<a name="125630696"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630696" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630696">Kevin Buzzard (Apr 24 2018 at 17:34)</a>:</h4>
<p>so I thought alpha beta gamma was OK</p>

<a name="125630729"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630729" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630729">Kevin Buzzard (Apr 24 2018 at 17:35)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">begin</span>
  <span class="n">intros</span> <span class="n">Hαβ</span> <span class="n">Hβγ</span><span class="o">,</span>
  <span class="n">constructor</span><span class="o">,</span><span class="n">refl</span><span class="o">,</span>
  <span class="n">intros</span> <span class="n">gβγ</span> <span class="n">Hgβγ</span> <span class="n">H1</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">Hαγ</span> <span class="o">:</span> <span class="n">fβγ</span> <span class="err">∘</span> <span class="n">fαβ</span> <span class="bp">=</span> <span class="n">gβγ</span> <span class="err">∘</span> <span class="n">fαβ</span><span class="o">,</span>
    <span class="n">exactI</span> <span class="o">(</span><span class="n">Hαβ</span><span class="bp">.</span><span class="n">is_unique</span> <span class="o">(</span><span class="n">gβγ</span> <span class="err">∘</span> <span class="n">fαβ</span><span class="o">)</span> <span class="n">H1</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
  <span class="n">exactI</span> <span class="n">Hβγ</span><span class="bp">.</span><span class="n">is_unique</span> <span class="n">gβγ</span> <span class="n">Hαγ</span><span class="o">,</span>
<span class="kn">end</span>
</pre></div>

<a name="125630733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125630733" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125630733">Kevin Buzzard (Apr 24 2018 at 17:35)</a>:</h4>
<p>That was the proof</p>

<a name="125631047"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125631047" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125631047">Reid Barton (Apr 24 2018 at 17:40)</a>:</h4>
<p>Haha, I seriously thought up to now that an "alpha-alg-hom" was a map of rings equipped with some fancy extra additional structure, like <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">λ</span></span></span></span>-rings or divided power rings or something.</p>

<a name="125631446"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125631446" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125631446">Kevin Buzzard (Apr 24 2018 at 17:48)</a>:</h4>
<p>no, it's an alpha-algebra hom :-)</p>

<a name="125631453"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125631453" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125631453">Kevin Buzzard (Apr 24 2018 at 17:49)</a>:</h4>
<p>YOU SEE YOU CS PEOPLE</p>

<a name="125631456"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125631456" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125631456">Kevin Buzzard (Apr 24 2018 at 17:49)</a>:</h4>
<p>THE MOMENT YOU CALL RINGS ALPHA</p>

<a name="125631461"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125631461" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125631461">Kevin Buzzard (Apr 24 2018 at 17:49)</a>:</h4>
<p>WE GET THINGS LIKE THIS HAPPENING</p>

<a name="125631555"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125631555" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125631555">Johan Commelin (Apr 24 2018 at 17:50)</a>:</h4>
<p>wow, that was pretty <code>α</code>-male</p>

<a name="125747509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747509" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747509">Kevin Buzzard (Apr 26 2018 at 22:54)</a>:</h4>
<p>Here's today's type class inference issue:</p>

<a name="125747511"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747511" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747511">Kevin Buzzard (Apr 26 2018 at 22:54)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">canonical_iso_is_canonical_hom</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">{</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">R</span><span class="o">}</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span> <span class="err">⊆</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">f</span><span class="o">)</span> <span class="o">:</span>
<span class="k">let</span> <span class="n">gbar</span> <span class="o">:=</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="n">g</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sα</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">loc</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">of_comm_ring</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="err">∘</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sγ</span> <span class="o">:=</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">non_zero_on_U</span> <span class="o">(</span><span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span><span class="o">)))</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">H2</span> <span class="o">:=</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">is_ring_hom</span> <span class="k">in</span>
<span class="n">is_unique_R_alg_hom</span> <span class="n">sγ</span> <span class="n">sα</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">to_fun</span> <span class="o">:=</span> <span class="n">sorry</span>
</pre></div>

<a name="125747515"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747515" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747515">Kevin Buzzard (Apr 26 2018 at 22:55)</a>:</h4>
<p>that won't run</p>

<a name="125747523"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747523" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747523">Kevin Buzzard (Apr 26 2018 at 22:55)</a>:</h4>
<p>but hopefully I can explain the issue</p>

<a name="125747533"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747533" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747533">Kevin Buzzard (Apr 26 2018 at 22:55)</a>:</h4>
<p>I am trying to prove <code>is_unique_R_alg_hom sγ sα (canonical_iso H).to_fun</code></p>

<a name="125747592"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747592" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747592">Kevin Buzzard (Apr 26 2018 at 22:56)</a>:</h4>
<p>but the definition of <code>is_unique_R_alg_hom</code> expects H2 to be deduced from type class inference</p>

<a name="125747595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747595" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747595">Kevin Buzzard (Apr 26 2018 at 22:56)</a>:</h4>
<p>and I've only managed to prove it the line before</p>

<a name="125747597"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747597" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747597">Kevin Buzzard (Apr 26 2018 at 22:56)</a>:</h4>
<p>so I can solve this with @</p>

<a name="125747612"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747612" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747612">Kevin Buzzard (Apr 26 2018 at 22:56)</a>:</h4>
<p>but given that it would then look like</p>

<a name="125747672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747672" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747672">Kevin Buzzard (Apr 26 2018 at 22:58)</a>:</h4>
<p>...erm</p>

<a name="125747674"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747674" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747674">Kevin Buzzard (Apr 26 2018 at 22:58)</a>:</h4>
<p>even that didn't work</p>

<a name="125747690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747690" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747690">Kevin Buzzard (Apr 26 2018 at 22:58)</a>:</h4>
<p><code>@is_unique_R_alg_hom _ _ _ _ _ _ sγ sα (canonical_iso H).to_fun _ _ H2 </code></p>

<a name="125747691"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747691" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747691">Kevin Buzzard (Apr 26 2018 at 22:58)</a>:</h4>
<p>actually it did work, I now have an unrelated problem</p>

<a name="125747701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125747701" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125747701">Kevin Buzzard (Apr 26 2018 at 22:59)</a>:</h4>
<p>So can I insert H2 into the type class inference system before I have even started my proof, because I need it to make my term typecheck?</p>

<a name="125748084"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748084" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748084">Kevin Buzzard (Apr 26 2018 at 23:09)</a>:</h4>
<p>I have got it working with <code>@</code></p>

<a name="125748085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748085" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748085">Kevin Buzzard (Apr 26 2018 at 23:09)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">canonical_iso_is_canonical_hom</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">{</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">R</span><span class="o">}</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span> <span class="err">⊆</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">f</span><span class="o">)</span> <span class="o">:</span>
<span class="k">let</span> <span class="n">gbar</span> <span class="o">:=</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="n">g</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sα</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">loc</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">of_comm_ring</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="err">∘</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sγ</span> <span class="o">:=</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">non_zero_on_U</span> <span class="o">(</span><span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span><span class="o">)))</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">H2</span> <span class="o">:=</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">is_ring_hom</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">H3</span> <span class="o">:</span> <span class="n">is_ring_hom</span> <span class="n">sα</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">H4</span> <span class="o">:</span> <span class="n">is_ring_hom</span> <span class="n">sγ</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span> <span class="k">in</span>
<span class="bp">@</span><span class="n">is_unique_R_alg_hom</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">sγ</span> <span class="n">sα</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">to_fun</span> <span class="n">H4</span> <span class="n">H3</span> <span class="n">H2</span> <span class="o">:=</span> <span class="n">sorry</span>
</pre></div>

<a name="125748090"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748090" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748090">Kevin Buzzard (Apr 26 2018 at 23:09)</a>:</h4>
<p>The first three lets are simply there to make the statement look clearer</p>

<a name="125748098"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748098" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748098">Kevin Buzzard (Apr 26 2018 at 23:10)</a>:</h4>
<p>the last three are there because type class inference asked for them all</p>

<a name="125748163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748163" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748163">Reid Barton (Apr 26 2018 at 23:11)</a>:</h4>
<p>Change those last three <code>let</code>s to <code>letI</code> I think</p>

<a name="125748209"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748209" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748209">Kevin Buzzard (Apr 26 2018 at 23:12)</a>:</h4>
<p><code>letI</code> doesn't work there</p>

<a name="125748210"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748210" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748210">Kevin Buzzard (Apr 26 2018 at 23:12)</a>:</h4>
<p>well, it doesn't work for me</p>

<a name="125748212"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748212" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748212">Kevin Buzzard (Apr 26 2018 at 23:12)</a>:</h4>
<p>It works in a proof</p>

<a name="125748213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748213" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748213">Reid Barton (Apr 26 2018 at 23:12)</a>:</h4>
<p>Sorry, I just noticed this was in term mode</p>

<a name="125748214"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748214" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748214">Kevin Buzzard (Apr 26 2018 at 23:12)</a>:</h4>
<p>but this is before the proof</p>

<a name="125748215"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748215" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748215">Kevin Buzzard (Apr 26 2018 at 23:12)</a>:</h4>
<p>the issue is that we're before the colon</p>

<a name="125748216"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748216" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748216">Kevin Buzzard (Apr 26 2018 at 23:12)</a>:</h4>
<p>I think</p>

<a name="125748217"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748217" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748217">Reid Barton (Apr 26 2018 at 23:12)</a>:</h4>
<p>But I think <code>by letI ...; exact</code> is fine</p>

<a name="125748219"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748219" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748219">Kevin Buzzard (Apr 26 2018 at 23:12)</a>:</h4>
<p>I have only seen letI after the colon</p>

<a name="125748230"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748230" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748230">Reid Barton (Apr 26 2018 at 23:13)</a>:</h4>
<p>Though, it does make me vaguely uneasy to put it in the theorem statement.</p>

<a name="125748310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125748310" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125748310">Reid Barton (Apr 26 2018 at 23:15)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">canonical_iso_is_canonical_hom</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">{</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">R</span><span class="o">}</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span> <span class="err">⊆</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">f</span><span class="o">)</span> <span class="o">:</span>
<span class="k">let</span> <span class="n">gbar</span> <span class="o">:=</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="n">g</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sα</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">loc</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">of_comm_ring</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="err">∘</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sγ</span> <span class="o">:=</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">non_zero_on_U</span> <span class="o">(</span><span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span><span class="o">)))</span> <span class="k">in</span>
<span class="k">by</span> <span class="n">letI</span> <span class="n">H2</span> <span class="o">:=</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">is_ring_hom</span><span class="bp">;</span> <span class="n">exact</span>
<span class="n">is_unique_R_alg_hom</span> <span class="n">sγ</span> <span class="n">sα</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">to_fun</span> <span class="o">:=</span> <span class="n">sorry</span>
</pre></div>


<p>(untested, hopefully I deleted the right amount of stuff)</p>

<a name="125751156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125751156" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125751156">Mario Carneiro (Apr 27 2018 at 00:39)</a>:</h4>
<p>Using <code>letI</code> in theorem types is fine, and <code>by letI ...; exact</code> or <code>by exactI</code> is the recommended way to introduce a typeclass thing from the context in term mode</p>

<a name="125761174"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761174" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761174">Chris Hughes (Apr 27 2018 at 06:43)</a>:</h4>
<p>Don't use let in the statement of a theorem.</p>

<a name="125761407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761407" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761407">Kevin Buzzard (Apr 27 2018 at 06:51)</a>:</h4>
<blockquote>
<p>Don't use let in the statement of a theorem.</p>
</blockquote>
<p>This is easy to fix -- the let is in some sense for my own sanity.</p>

<a name="125761455"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761455" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761455">Mario Carneiro (Apr 27 2018 at 06:53)</a>:</h4>
<p>Note that <code>haveI</code> when used in a tactic doesn't actually produce a <code>have</code> term, the result is just like you would get if it were actually inferred by regular tc inference</p>

<a name="125761462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761462" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761462">Mario Carneiro (Apr 27 2018 at 06:53)</a>:</h4>
<p>If in doubt, just <code>#print</code> the statement to make sure it doesn't look weird</p>

<a name="125761464"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761464" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761464">Kevin Buzzard (Apr 27 2018 at 06:53)</a>:</h4>
<p>I can't get the syntax right for this</p>

<a name="125761465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761465" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761465">Kevin Buzzard (Apr 27 2018 at 06:53)</a>:</h4>
<p>having tried for 10 seconds</p>

<a name="125761507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761507" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761507">Kevin Buzzard (Apr 27 2018 at 06:54)</a>:</h4>
<p>I need to insert three hypotheses into the type class inference box</p>

<a name="125761511"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761511" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761511">Kevin Buzzard (Apr 27 2018 at 06:54)</a>:</h4>
<p>and I don't understand the syntax of this by thing</p>

<a name="125761521"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761521" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761521">Kevin Buzzard (Apr 27 2018 at 06:55)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">canonical_iso_is_canonical_hom</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">{</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">R</span><span class="o">}</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span> <span class="err">⊆</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">f</span><span class="o">)</span> <span class="o">:</span>
<span class="k">let</span> <span class="n">gbar</span> <span class="o">:=</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="n">g</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sα</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">loc</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">of_comm_ring</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="err">∘</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sγ</span> <span class="o">:=</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">non_zero_on_U</span> <span class="o">(</span><span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span><span class="o">)))</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">H2</span> <span class="o">:=</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">is_ring_hom</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">H3</span> <span class="o">:</span> <span class="n">is_ring_hom</span> <span class="n">sα</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">H4</span> <span class="o">:</span> <span class="n">is_ring_hom</span> <span class="n">sγ</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span> <span class="k">in</span>
<span class="bp">@</span><span class="n">is_unique_R_alg_hom</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">sγ</span> <span class="n">sα</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">to_fun</span> <span class="n">H4</span> <span class="n">H3</span> <span class="n">H2</span> <span class="o">:=</span>
</pre></div>

<a name="125761522"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761522" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761522">Kevin Buzzard (Apr 27 2018 at 06:55)</a>:</h4>
<p>This works</p>

<a name="125761524"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761524" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761524">Kenny Lau (Apr 27 2018 at 06:55)</a>:</h4>
<p>good luck proving that</p>

<a name="125761562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761562" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761562">Kevin Buzzard (Apr 27 2018 at 06:56)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">begin</span>
<span class="n">letI</span> <span class="o">:=</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">is_ring_hom</span><span class="o">,</span>
<span class="k">have</span> <span class="n">H5</span> <span class="o">:=</span> <span class="n">unique_R_alg_from_loc</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">to_fun</span><span class="o">,</span>
<span class="k">have</span> <span class="n">H6</span> <span class="o">:=</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">R_alg_hom</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
<span class="n">simp</span> <span class="o">[</span><span class="n">H6</span><span class="o">]</span> <span class="n">at</span> <span class="n">H5</span><span class="o">,</span>
<span class="n">exact</span> <span class="n">H5</span><span class="o">,</span>
<span class="kn">end</span>
</pre></div>

<a name="125761565"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761565" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761565">Kevin Buzzard (Apr 27 2018 at 06:56)</a>:</h4>
<p>done</p>

<a name="125761566"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761566" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761566">Kenny Lau (Apr 27 2018 at 06:56)</a>:</h4>
<p>ok you win</p>

<a name="125761569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761569" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761569">Kevin Buzzard (Apr 27 2018 at 06:56)</a>:</h4>
<p>Now I have good interface</p>

<a name="125761570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761570" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761570">Kevin Buzzard (Apr 27 2018 at 06:56)</a>:</h4>
<p>so all the proofs are "this canonical thing is canonical"</p>

<a name="125761571"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761571" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761571">Kevin Buzzard (Apr 27 2018 at 06:56)</a>:</h4>
<p>or "this canonical thing is unique"</p>

<a name="125761573"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761573" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761573">Kevin Buzzard (Apr 27 2018 at 06:57)</a>:</h4>
<p>or "this unique thing is canonical"</p>

<a name="125761635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761635" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761635">Kevin Buzzard (Apr 27 2018 at 06:59)</a>:</h4>
<p>I was trying to put all three hypotheses into one "by"</p>

<a name="125761638"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761638" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761638">Kevin Buzzard (Apr 27 2018 at 06:59)</a>:</h4>
<p>but I don't understand the syntax</p>

<a name="125761644"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761644" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761644">Kevin Buzzard (Apr 27 2018 at 06:59)</a>:</h4>
<p>but I've got it working</p>

<a name="125761645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761645" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761645">Kevin Buzzard (Apr 27 2018 at 06:59)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">canonical_iso_is_canonical_hom</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">{</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">R</span><span class="o">}</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span> <span class="err">⊆</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">f</span><span class="o">)</span> <span class="o">:</span>
<span class="k">let</span> <span class="n">gbar</span> <span class="o">:=</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="n">g</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sα</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">loc</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">of_comm_ring</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="err">∘</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sγ</span> <span class="o">:=</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">non_zero_on_U</span> <span class="o">(</span><span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span><span class="o">)))</span> <span class="k">in</span>
<span class="k">by</span> <span class="n">letI</span> <span class="n">H2</span> <span class="o">:=</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">is_ring_hom</span><span class="bp">;</span> <span class="n">exact</span>
<span class="k">by</span> <span class="n">letI</span> <span class="n">H3</span> <span class="o">:</span> <span class="n">is_ring_hom</span> <span class="n">sα</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span><span class="bp">;</span> <span class="n">exact</span>
<span class="k">by</span> <span class="n">letI</span> <span class="n">H4</span> <span class="o">:</span> <span class="n">is_ring_hom</span> <span class="n">sγ</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span><span class="bp">;</span> <span class="n">exact</span>
<span class="bp">@</span><span class="n">is_unique_R_alg_hom</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">sγ</span> <span class="n">sα</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">to_fun</span> <span class="n">H4</span> <span class="n">H3</span> <span class="n">H2</span> <span class="o">:=</span>
</pre></div>

<a name="125761646"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761646" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761646">Kevin Buzzard (Apr 27 2018 at 06:59)</a>:</h4>
<p>I can't even parse that</p>

<a name="125761649"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761649" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761649">Kevin Buzzard (Apr 27 2018 at 07:00)</a>:</h4>
<p>and now the moment of truth...</p>

<a name="125761698"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761698" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761698">Kevin Buzzard (Apr 27 2018 at 07:00)</a>:</h4>
<p>wooah</p>

<a name="125761699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761699" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761699">Kevin Buzzard (Apr 27 2018 at 07:00)</a>:</h4>
<p>stop everything</p>

<a name="125761701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761701" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761701">Kevin Buzzard (Apr 27 2018 at 07:00)</a>:</h4>
<p>lean has silently crashed</p>

<a name="125761761"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761761" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761761">Kevin Buzzard (Apr 27 2018 at 07:02)</a>:</h4>
<p>OK great, when I restart Lean it just quietly exits</p>

<a name="125761771"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761771" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761771">Kevin Buzzard (Apr 27 2018 at 07:03)</a>:</h4>
<p>Restarting VS Code and I am back up and running</p>

<a name="125761814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761814" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761814">Kevin Buzzard (Apr 27 2018 at 07:04)</a>:</h4>
<p>and it doesn't work after all</p>

<a name="125761869"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761869" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761869">Kevin Buzzard (Apr 27 2018 at 07:06)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">canonical_iso_is_canonical_hom</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">{</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">R</span><span class="o">}</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span> <span class="err">⊆</span> <span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">f</span><span class="o">)</span> <span class="o">:</span>
<span class="k">let</span> <span class="n">gbar</span> <span class="o">:=</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="n">g</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sα</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">loc</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">of_comm_ring</span> <span class="o">(</span><span class="n">away</span> <span class="n">f</span><span class="o">)</span> <span class="o">(</span><span class="n">powers</span> <span class="n">gbar</span><span class="o">)</span> <span class="err">∘</span> <span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">powers</span> <span class="n">f</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">sγ</span> <span class="o">:=</span> <span class="o">(</span><span class="n">of_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="n">non_zero_on_U</span> <span class="o">(</span><span class="n">Spec</span><span class="bp">.</span><span class="n">D&#39;</span> <span class="n">g</span><span class="o">)))</span> <span class="k">in</span>
<span class="k">by</span> <span class="n">letI</span> <span class="n">H2</span> <span class="o">:=</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">is_ring_hom</span><span class="bp">;</span>
<span class="n">letI</span> <span class="n">H3</span> <span class="o">:</span> <span class="n">is_ring_hom</span> <span class="n">sα</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span><span class="bp">;</span>
<span class="n">letI</span> <span class="n">H4</span> <span class="o">:</span> <span class="n">is_ring_hom</span> <span class="n">sγ</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span><span class="bp">;</span> <span class="n">exact</span>
<span class="bp">@</span><span class="n">is_unique_R_alg_hom</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">sγ</span> <span class="n">sα</span> <span class="o">(</span><span class="n">canonical_iso</span> <span class="n">H</span><span class="o">)</span><span class="bp">.</span><span class="n">to_fun</span> <span class="n">H4</span> <span class="n">H3</span> <span class="n">H2</span> <span class="o">:=</span>
</pre></div>


<p>doesn't work</p>

<a name="125761871"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761871" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761871">Kevin Buzzard (Apr 27 2018 at 07:06)</a>:</h4>
<p>It's not a problem because my multi-let <code>@</code> solution works</p>

<a name="125761872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125761872" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125761872">Kevin Buzzard (Apr 27 2018 at 07:06)</a>:</h4>
<p>I'll construct a MWE. I think this is just a syntax thing</p>

<a name="125762346"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125762346" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125762346">Kevin Buzzard (Apr 27 2018 at 07:22)</a>:</h4>
<p>gaargh it's not a syntax thing, my MWE is too minimal and strings of <code>by letI ...; exact</code> work fine</p>

<a name="125762486"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125762486" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125762486">Kevin Buzzard (Apr 27 2018 at 07:27)</a>:</h4>
<p>My <code>by apply_instance</code> proofs seem to be failing when wrapped up in the outer <code>by</code></p>

<a name="125762657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125762657" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125762657">Kevin Buzzard (Apr 27 2018 at 07:33)</a>:</h4>
<p>I am torn between giving up and constructing a MWE</p>

<a name="125762659"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125762659" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125762659">Kenny Lau (Apr 27 2018 at 07:33)</a>:</h4>
<p>lemme help you</p>

<a name="125762660"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125762660" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125762660">Kenny Lau (Apr 27 2018 at 07:33)</a>:</h4>
<p>give up.</p>

<a name="125762661"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125762661" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125762661">Kevin Buzzard (Apr 27 2018 at 07:33)</a>:</h4>
<p>OK</p>

<a name="125762662"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125762662" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125762662">Kevin Buzzard (Apr 27 2018 at 07:33)</a>:</h4>
<p>thanks</p>

<a name="125762663"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125762663" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125762663">Kenny Lau (Apr 27 2018 at 07:33)</a>:</h4>
<p>no probs</p>

<a name="125763632"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125763632" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125763632">Mario Carneiro (Apr 27 2018 at 08:06)</a>:</h4>
<p>Your <code>letI : ... := by apply_instance</code> lines are redundant. If the typeclass system can already find it, there's no reason to add it to the typeclass system. Unless you are trying to limit search depth?</p>

<a name="125763651"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125763651" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125763651">Mario Carneiro (Apr 27 2018 at 08:07)</a>:</h4>
<p>Also I recommend <code>haveI</code> over <code>letI</code> when possible. The only time you need <code>letI</code> is if you are unfolding the exact definition of the inferred ring or whatever later on in the same proof</p>

<a name="125764739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125764739" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125764739">Patrick Massot (Apr 27 2018 at 08:47)</a>:</h4>
<p>About type classes, let me quickly share <a href="https://gist.github.com/PatrickMassot/0d28b74be6f7bc9c0814a87393c91663" target="_blank" title="https://gist.github.com/PatrickMassot/0d28b74be6f7bc9c0814a87393c91663">https://gist.github.com/PatrickMassot/0d28b74be6f7bc9c0814a87393c91663</a> It's a draft of documentation of something that took me an embarrassingly long time to understand (I don't say it's directly related to your issues, it's only general knowledge about type class magic)</p>

<a name="125764855"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125764855" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125764855">Mario Carneiro (Apr 27 2018 at 08:50)</a>:</h4>
<p>I think the <code>..prod.has_op</code> on the last instance is unnecessary</p>

<a name="125764861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125764861" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125764861">Mario Carneiro (Apr 27 2018 at 08:51)</a>:</h4>
<p>it is inferred if you don't specify</p>

<a name="125764904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125764904" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125764904">Patrick Massot (Apr 27 2018 at 08:52)</a>:</h4>
<p>oooh</p>

<a name="125764906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125764906" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125764906">Patrick Massot (Apr 27 2018 at 08:52)</a>:</h4>
<p>that's even better</p>

<a name="125764909"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125764909" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125764909">Patrick Massot (Apr 27 2018 at 08:52)</a>:</h4>
<p>How does this new magic trick work?</p>

<a name="125764911"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125764911" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125764911">Patrick Massot (Apr 27 2018 at 08:52)</a>:</h4>
<p>This file is all about understanding more magic</p>

<a name="125764989"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125764989" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125764989">Mario Carneiro (Apr 27 2018 at 08:55)</a>:</h4>
<p>The <code>comm_magma.mk</code> structure constructor has the <code>to_has_op</code> parent field as instance implicit, and in structure notation that translates to an optional field</p>

<a name="125765037"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125765037" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125765037">Mario Carneiro (Apr 27 2018 at 08:56)</a>:</h4>
<p>same with anonymous constructor notation, you could write it as just <code>⟨proof of commutativity⟩</code> instead of <code>{op_comm := proof of commutativity}</code></p>

<a name="125801928"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125801928" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125801928">Kevin Buzzard (Apr 28 2018 at 01:22)</a>:</h4>
<p>Today's typeclass tale of woe:</p>

<a name="125801930"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125801930" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125801930">Kevin Buzzard (Apr 28 2018 at 01:22)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">equiv</span>
<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="n">u&#39;</span> <span class="n">v&#39;</span> <span class="n">w&#39;</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">{</span><span class="n">γ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">}</span> <span class="o">{</span><span class="n">α&#39;</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u&#39;</span><span class="o">}</span> <span class="o">{</span><span class="n">β&#39;</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v&#39;</span><span class="o">}</span> <span class="o">{</span><span class="n">γ&#39;</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w&#39;</span><span class="o">}</span>

<span class="kn">structure</span> <span class="n">canonically_isomorphic_add_group_homs</span> <span class="o">(</span><span class="n">Cα</span> <span class="o">:</span> <span class="n">equiv</span> <span class="n">α</span> <span class="n">α&#39;</span><span class="o">)</span> <span class="o">(</span><span class="n">Cβ</span> <span class="o">:</span> <span class="n">equiv</span> <span class="n">β</span> <span class="n">β&#39;</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">f&#39;</span> <span class="o">:</span> <span class="n">α&#39;</span> <span class="bp">→</span> <span class="n">β&#39;</span><span class="o">)</span>
<span class="o">[</span><span class="n">add_group</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">add_group</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">add_group</span> <span class="n">α&#39;</span><span class="o">]</span> <span class="o">[</span><span class="n">add_group</span> <span class="n">β&#39;</span><span class="o">]</span>
<span class="o">[</span><span class="n">is_group_hom</span> <span class="n">f</span><span class="o">]</span> <span class="o">[</span><span class="n">is_group_hom</span> <span class="n">f&#39;</span><span class="o">]</span>
<span class="o">:=</span> <span class="n">sorry</span>
</pre></div>

<a name="125801936"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125801936" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125801936">Kevin Buzzard (Apr 28 2018 at 01:23)</a>:</h4>
<div class="codehilite"><pre><span></span>failed to synthesize type class instance for
α : Type u,
β : Type v,
α&#39; : Type u&#39;,
β&#39; : Type v&#39;,
Cα : α ≃ α&#39;,
Cβ : β ≃ β&#39;,
f : α → β,
f&#39; : α&#39; → β&#39;,
_inst_1 : add_group α,
_inst_2 : add_group β,
_inst_3 : add_group α&#39;,
_inst_4 : add_group β&#39;,
_inst_5 : is_group_hom f
⊢ group β&#39;
</pre></div>

<a name="125802086"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802086" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802086">Kevin Buzzard (Apr 28 2018 at 01:29)</a>:</h4>
<p>dammit</p>

<a name="125802087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802087" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802087">Kevin Buzzard (Apr 28 2018 at 01:29)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">equiv</span>
<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="n">u&#39;</span> <span class="n">v&#39;</span> <span class="n">w&#39;</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">{</span><span class="n">γ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">}</span> <span class="o">{</span><span class="n">α&#39;</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u&#39;</span><span class="o">}</span> <span class="o">{</span><span class="n">β&#39;</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v&#39;</span><span class="o">}</span> <span class="o">{</span><span class="n">γ&#39;</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w&#39;</span><span class="o">}</span>

<span class="kn">structure</span> <span class="n">canonically_isomorphic_add_group_homs</span> <span class="o">(</span><span class="n">Cα</span> <span class="o">:</span> <span class="n">equiv</span> <span class="n">α</span> <span class="n">α&#39;</span><span class="o">)</span> <span class="o">(</span><span class="n">Cβ</span> <span class="o">:</span> <span class="n">equiv</span> <span class="n">β</span> <span class="n">β&#39;</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">f&#39;</span> <span class="o">:</span> <span class="n">α&#39;</span> <span class="bp">→</span> <span class="n">β&#39;</span><span class="o">)</span>
<span class="o">[</span><span class="n">Hα</span> <span class="o">:</span> <span class="n">add_group</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">Hβ</span> <span class="o">:</span> <span class="n">add_group</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">add_group</span> <span class="n">α&#39;</span><span class="o">]</span> <span class="o">[</span><span class="n">Hβ&#39;</span> <span class="o">:</span> <span class="n">add_group</span> <span class="n">β&#39;</span><span class="o">]</span>
<span class="o">[</span><span class="bp">@</span><span class="n">is_group_hom</span> <span class="n">α</span> <span class="n">β</span> <span class="n">Hα</span> <span class="o">(</span><span class="k">by</span> <span class="n">apply_instance</span><span class="o">)</span> <span class="n">f</span><span class="o">]</span> <span class="o">[</span><span class="bp">@</span><span class="n">is_group_hom</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">Hβ&#39;</span> <span class="n">f&#39;</span><span class="o">]</span>
<span class="o">:=</span> <span class="n">sorry</span>
</pre></div>

<a name="125802128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802128" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802128">Kevin Buzzard (Apr 28 2018 at 01:30)</a>:</h4>
<div class="codehilite"><pre><span></span>type mismatch at application
  is_group_hom
term
  Hα
has type
  add_group α
but is expected to have type
  group α
</pre></div>

<a name="125802133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802133" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802133">Kevin Buzzard (Apr 28 2018 at 01:30)</a>:</h4>
<p>Damn you Lean</p>

<a name="125802135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802135" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802135">Kevin Buzzard (Apr 28 2018 at 01:30)</a>:</h4>
<p>finding out how to turn an <code>add_group</code> to a <code>group</code> is <em>exactly</em> the kind of question which you should be good at.</p>

<a name="125802141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802141" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802141">Kevin Buzzard (Apr 28 2018 at 01:31)</a>:</h4>
<p>thus saving me from having to remember the details about names of instances.</p>

<a name="125802181"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802181" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802181">Kevin Buzzard (Apr 28 2018 at 01:32)</a>:</h4>
<p>Why am I constantly running into type class inference issues <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> ? Is this sort of thing going to change in Lean 4, do you think?</p>

<a name="125802182"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802182" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802182">Kevin Buzzard (Apr 28 2018 at 01:32)</a>:</h4>
<p>I find the whole <code>letI</code> stuff both essential and extremely confusing</p>

<a name="125802185"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802185" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802185">Kevin Buzzard (Apr 28 2018 at 01:32)</a>:</h4>
<p>I probably need to write some <code>letI</code> docs</p>

<a name="125802192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802192" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802192">Kevin Buzzard (Apr 28 2018 at 01:33)</a>:</h4>
<p>but am I right in thinking that <code>letI</code> is just a hack which we will be doing away with in Lean 4 as the amazing new type class inference system / syntax comes in?</p>

<a name="125802231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802231" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802231">Kevin Buzzard (Apr 28 2018 at 01:34)</a>:</h4>
<p>I know that Mario has work hard to keep up with Leo's changes in the type class inference system</p>

<a name="125802232"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802232" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802232">Kevin Buzzard (Apr 28 2018 at 01:34)</a>:</h4>
<p>but that means that it's currently really confusing for end users</p>

<a name="125802234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802234" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802234">Kevin Buzzard (Apr 28 2018 at 01:35)</a>:</h4>
<p>I believe in Lean so much</p>

<a name="125802239"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802239" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802239">Kevin Buzzard (Apr 28 2018 at 01:35)</a>:</h4>
<p>and I am really hoping for a beautiful solution.</p>

<a name="125802279"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802279" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802279">Kevin Buzzard (Apr 28 2018 at 01:36)</a>:</h4>
<p>Type class inference issues are stopping me from working right now.</p>

<a name="125802460"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802460" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802460">Kevin Buzzard (Apr 28 2018 at 01:42)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">variable</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span>
<span class="kn">lemma</span> <span class="n">to_group</span> <span class="o">[</span><span class="n">H</span> <span class="o">:</span> <span class="n">add_group</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">group</span> <span class="n">α</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
</pre></div>

<a name="125802462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125802462" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125802462">Kevin Buzzard (Apr 28 2018 at 01:43)</a>:</h4>
<div class="codehilite"><pre><span></span>tactic.mk_instance failed to generate instance for
  group α
state:
α : Type,
H : add_group α
⊢ group α
</pre></div>

<a name="125814582"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125814582" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125814582">Sebastian Ullrich (Apr 28 2018 at 09:38)</a>:</h4>
<p>There are no plans to change class inference for Lean 4. On the other hand, lifting the distinction between <code>group</code> and <code>add_group</code> is the primary motivation behind refactoring the algebraic hierarchy.</p>

<a name="125814583"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125814583" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125814583">Kenny Lau (Apr 28 2018 at 09:38)</a>:</h4>
<p>but the algebraic hierarchy also has its own problems, right</p>

<a name="125814601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125814601" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125814601">Kenny Lau (Apr 28 2018 at 09:39)</a>:</h4>
<blockquote>
<p>Today's typeclass tale of woe:</p>
</blockquote>
<p>look, I already wrote you an <code>is_add_group_hom</code></p>

<a name="125820595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125820595" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125820595">Kevin Buzzard (Apr 28 2018 at 13:48)</a>:</h4>
<p>Oh, I see, I am an idiot. Lean regards the <code>add_group</code> hierarchy as completely different to, the <code>group</code> hierarchy. I have mixed my hierarchies without noticing</p>

<a name="125820600"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125820600" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125820600">Kevin Buzzard (Apr 28 2018 at 13:48)</a>:</h4>
<p>The reason I have made this mistake</p>

<a name="125820603"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125820603" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125820603">Kevin Buzzard (Apr 28 2018 at 13:48)</a>:</h4>
<p>is that the two heirarchies are canonically isomorphic</p>

<a name="125820604"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125820604" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125820604">Kevin Buzzard (Apr 28 2018 at 13:48)</a>:</h4>
<p>and indeed there is a unique canonical isomorphism in each direction</p>

<a name="125820609"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125820609" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125820609">Kevin Buzzard (Apr 28 2018 at 13:49)</a>:</h4>
<p>however the type class inference procedure might not use these canonical isomorphisms</p>

<a name="125820610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125820610" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125820610">Kevin Buzzard (Apr 28 2018 at 13:49)</a>:</h4>
<p>because neither of the hierarchies is "better" than the other one</p>

<a name="125820611"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125820611" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125820611">Kevin Buzzard (Apr 28 2018 at 13:49)</a>:</h4>
<p>so it would be asymmetric to let type class inference move from one to the other</p>

<a name="125820653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125820653" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125820653">Kevin Buzzard (Apr 28 2018 at 13:50)</a>:</h4>
<p>and there is a risk of diamonds if we let it move between them freely</p>

<a name="125820654"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125820654" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125820654">Kevin Buzzard (Apr 28 2018 at 13:50)</a>:</h4>
<p>On the other hand, to a mathematician, they are the same object</p>

<a name="125820655"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125820655" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125820655">Kevin Buzzard (Apr 28 2018 at 13:50)</a>:</h4>
<p>canonical isomorphism is different to type class resolution</p>

<a name="125820656"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/125820656" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#125820656">Kevin Buzzard (Apr 28 2018 at 13:50)</a>:</h4>
<p>and I was applying canonical isomorphism</p>

<a name="128108229"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128108229" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128108229">Johan Commelin (Jun 15 2018 at 07:54)</a>:</h4>
<p>Does this mean I introduced a diamond:</p>
<blockquote>
<p>synthesized type class instance is not definitionally equal to expression inferred by typing rules, synthesized<br>
  subset.submodule 𝔥<br>
inferred<br>
  lie_algebra.to_module ↥𝔥</p>
</blockquote>

<a name="128112522"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128112522" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128112522">Johan Commelin (Jun 15 2018 at 10:01)</a>:</h4>
<p>So the context is as follows:</p>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">subset</span><span class="bp">.</span><span class="n">lie_algebra</span> <span class="o">{</span><span class="err">𝔥</span> <span class="o">:</span> <span class="n">set</span> <span class="err">𝔤</span><span class="o">}</span> <span class="o">[</span><span class="n">H</span> <span class="o">:</span> <span class="bp">@</span><span class="n">is_lie_subalgebra</span> <span class="n">R</span> <span class="n">ri</span> <span class="err">𝔤</span> <span class="n">la</span> <span class="err">𝔥</span><span class="o">]</span> <span class="o">:</span>
<span class="n">lie_algebra</span> <span class="n">R</span> <span class="err">𝔥</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">bracket</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="bp">⟨</span><span class="o">[</span><span class="n">x</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span><span class="n">y</span><span class="bp">.</span><span class="mi">1</span><span class="o">],</span> <span class="n">is_lie_subalgebra</span><span class="bp">.</span><span class="n">closed</span> <span class="bp">_</span> <span class="n">x</span><span class="bp">.</span><span class="mi">2</span> <span class="n">y</span><span class="bp">.</span><span class="mi">2</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="n">left_linear</span> <span class="o">:=</span> <span class="k">begin</span>
    <span class="n">intro</span> <span class="n">y</span><span class="o">,</span>
    <span class="n">constructor</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">x₁</span> <span class="n">x₂</span><span class="o">,</span>
      <span class="n">apply</span> <span class="n">subtype</span><span class="bp">.</span><span class="n">eq</span><span class="o">,</span>
      <span class="n">simp</span><span class="o">,</span>
      <span class="n">apply</span> <span class="o">(</span><span class="n">lie_algebra</span><span class="bp">.</span><span class="n">left_linear</span> <span class="n">y</span><span class="o">)</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="c1">-- FAILS</span>
      <span class="n">sorry</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">r</span> <span class="n">x</span><span class="o">,</span>
      <span class="n">apply</span> <span class="n">subtype</span><span class="bp">.</span><span class="n">eq</span><span class="o">,</span>
      <span class="c1">-- apply (lie_algebra.left_linear y).smul, FAILS</span>
      <span class="n">sorry</span> <span class="o">}</span>
  <span class="kn">end</span><span class="o">,</span>
  <span class="n">right_linear</span> <span class="o">:=</span> <span class="n">sorry</span><span class="o">,</span>
  <span class="n">alternating</span> <span class="o">:=</span> <span class="k">assume</span> <span class="bp">⟨</span><span class="n">x</span><span class="o">,</span><span class="bp">_⟩</span><span class="o">,</span> <span class="n">subtype</span><span class="bp">.</span><span class="n">eq</span> <span class="err">$</span> <span class="n">lie_algebra</span><span class="bp">.</span><span class="n">alternating</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">Jacobi_identity</span> <span class="o">:=</span> <span class="k">assume</span> <span class="bp">⟨</span><span class="n">x</span><span class="o">,</span><span class="bp">_⟩</span> <span class="bp">⟨</span><span class="n">y</span><span class="o">,</span><span class="bp">_⟩</span> <span class="bp">⟨</span><span class="n">z</span><span class="o">,</span><span class="bp">_⟩</span><span class="o">,</span> <span class="n">subtype</span><span class="bp">.</span><span class="n">eq</span> <span class="err">$</span> <span class="n">lie_algebra</span><span class="bp">.</span><span class="n">Jacobi_identity</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">anti_comm</span> <span class="o">:=</span> <span class="k">assume</span> <span class="bp">⟨</span><span class="n">x</span><span class="o">,</span><span class="bp">_⟩</span> <span class="bp">⟨</span><span class="n">y</span><span class="o">,</span><span class="bp">_⟩</span><span class="o">,</span> <span class="n">subtype</span><span class="bp">.</span><span class="n">eq</span> <span class="err">$</span> <span class="n">lie_algebra</span><span class="bp">.</span><span class="n">anti_comm</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
<span class="o">}</span>
</pre></div>

<a name="128112567"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128112567" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128112567">Johan Commelin (Jun 15 2018 at 10:02)</a>:</h4>
<p>How do I tell Lean that it should infer <code>subset.submodule 𝔥</code>, instead of <code>lie_algebra.to_module ↥𝔥</code>.</p>

<a name="128112594"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128112594" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128112594">Johan Commelin (Jun 15 2018 at 10:03)</a>:</h4>
<p>I really don't get why the type class system is tripping up in this case. After all, the first instance unifies completely. The second instance has one meta-variable in it (and rightly so, because it can't infer that <code>𝔥</code> is a <code>lie_algebra</code> since that is exactly what I'm trying to prove.</p>

<a name="128112638"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128112638" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128112638">Johan Commelin (Jun 15 2018 at 10:04)</a>:</h4>
<p>So it seems to me like the type class inference went down a wrong path, but still got convinced that it did a good job. (While the correct path is actually there in Lean.)</p>

<a name="128114320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128114320" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128114320">Johan Commelin (Jun 15 2018 at 10:58)</a>:</h4>
<p>Aaaahhrg.....</p>
<div class="codehilite"><pre><span></span><span class="o">[</span><span class="n">class_instances</span><span class="o">]</span>  <span class="n">class</span><span class="bp">-</span><span class="kn">instance</span> <span class="n">resolution</span> <span class="n">trace</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="err">?</span><span class="n">x_0</span> <span class="o">:</span> <span class="n">has_bracket</span> <span class="err">𝔤</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">commutator_bracket</span> <span class="err">?</span><span class="n">x_1</span> <span class="err">?</span><span class="n">x_2</span> <span class="err">?</span><span class="n">x_3</span> <span class="err">?</span><span class="n">x_4</span> <span class="err">?</span><span class="n">x_5</span> <span class="err">?</span><span class="n">x_6</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="err">?</span><span class="n">x_2</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="err">?</span><span class="n">x_1</span> <span class="o">:=</span> <span class="n">ri</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="err">?</span><span class="n">x_4</span> <span class="o">:</span> <span class="bp">@</span><span class="n">lie_algebra</span> <span class="n">R</span> <span class="err">?</span><span class="n">x_3</span> <span class="n">ri</span> <span class="o">:=</span> <span class="n">la</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="err">?</span><span class="n">x_6</span> <span class="o">:</span> <span class="n">ring</span> <span class="err">𝔤</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">nonneg_ring</span><span class="bp">.</span><span class="n">to_ring</span> <span class="err">?</span><span class="n">x_7</span> <span class="err">?</span><span class="n">x_8</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="err">?</span><span class="n">x_8</span> <span class="o">:</span> <span class="n">nonneg_ring</span> <span class="err">𝔤</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">linear_nonneg_ring</span><span class="bp">.</span><span class="n">to_nonneg_ring</span> <span class="err">?</span><span class="n">x_9</span> <span class="err">?</span><span class="n">x_10</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="err">?</span><span class="n">x_6</span> <span class="o">:</span> <span class="n">ring</span> <span class="err">𝔤</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">domain</span><span class="bp">.</span><span class="n">to_ring</span> <span class="err">?</span><span class="n">x_7</span> <span class="err">?</span><span class="n">x_8</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="err">?</span><span class="n">x_8</span> <span class="o">:</span> <span class="n">domain</span> <span class="err">𝔤</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">linear_nonneg_ring</span><span class="bp">.</span><span class="n">to_domain</span> <span class="err">?</span><span class="n">x_9</span> <span class="err">?</span><span class="n">x_10</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="err">?</span><span class="n">x_8</span> <span class="o">:</span> <span class="n">domain</span> <span class="err">𝔤</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">to_domain</span> <span class="err">?</span><span class="n">x_9</span> <span class="err">?</span><span class="n">x_10</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="err">?</span><span class="n">x_10</span> <span class="o">:</span> <span class="n">linear_ordered_ring</span> <span class="err">𝔤</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">linear_nonneg_ring</span><span class="bp">.</span><span class="n">to_linear_ordered_ring</span> <span class="err">?</span><span class="n">x_11</span> <span class="err">?</span><span class="n">x_12</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="err">?</span><span class="n">x_10</span> <span class="o">:</span> <span class="n">linear_ordered_ring</span> <span class="err">𝔤</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">linear_ordered_field</span><span class="bp">.</span><span class="n">to_linear_ordered_ring</span> <span class="err">?</span><span class="n">x_11</span> <span class="err">?</span><span class="n">x_12</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="err">?</span><span class="n">x_12</span> <span class="o">:</span> <span class="n">linear_ordered_field</span> <span class="err">𝔤</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">discrete_linear_ordered_field</span><span class="bp">.</span><span class="n">to_linear_ordered_field</span> <span class="err">?</span><span class="n">x_13</span> <span class="err">?</span><span class="n">x_14</span>
</pre></div>


<p>[the list goes on and on...]</p>

<a name="128114327"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128114327" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128114327">Johan Commelin (Jun 15 2018 at 10:59)</a>:</h4>
<p>No stupid! It's a Lie algebra!</p>

<a name="128114337"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128114337" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128114337">Johan Commelin (Jun 15 2018 at 10:59)</a>:</h4>
<p>Everywhere in this file it has realised immediately that <code>𝔤</code> is a Lie algebra, and therefore has a bracket.</p>

<a name="128114338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128114338" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128114338">Johan Commelin (Jun 15 2018 at 10:59)</a>:</h4>
<p>But somehow, here it messes up completely.</p>

<a name="128114684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128114684" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128114684">Andrew Ashworth (Jun 15 2018 at 11:10)</a>:</h4>
<p>I notice type class inference issues are quite common in this chat. Maybe in the future a visualization aide would be helpful for people trying to debug  the process</p>

<a name="128114691"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128114691" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128114691">Andrew Ashworth (Jun 15 2018 at 11:11)</a>:</h4>
<p>Actually for myself I don't know any better method to debug it than to write out the expression in full, and then in order work forwards as if I was doing the search by hand...</p>

<a name="128114731"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128114731" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128114731">Johan Commelin (Jun 15 2018 at 11:12)</a>:</h4>
<p>Right... which is not really what you would expect in this "computer-era"</p>

<a name="128115009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115009" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115009">Andrew Ashworth (Jun 15 2018 at 11:21)</a>:</h4>
<p>you'd be disappointed in how much paper I go through while using a computerized theorem prover... or programming in general</p>

<a name="128115071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115071" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115071">Mario Carneiro (Jun 15 2018 at 11:23)</a>:</h4>
<p>I have mentioned this in previous instance issues, but <code>comm_ring ?x_1</code> is a bad sign in an instance trace, that will usually run away</p>

<a name="128115074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115074" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115074">Mario Carneiro (Jun 15 2018 at 11:23)</a>:</h4>
<p>what is the type of <code>commutator_bracket</code>?</p>

<a name="128115592"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115592" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115592">Johan Commelin (Jun 15 2018 at 11:39)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">variables</span> <span class="o">{</span><span class="n">S</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">ring</span> <span class="n">S</span><span class="o">]</span>
<span class="kn">instance</span> <span class="n">commutator_bracket</span> <span class="o">:</span> <span class="n">has_bracket</span> <span class="n">S</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">x</span><span class="bp">*</span><span class="n">y</span> <span class="bp">-</span> <span class="n">y</span><span class="bp">*</span><span class="n">x</span><span class="bp">⟩</span>
</pre></div>

<a name="128115668"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115668" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115668">Mario Carneiro (Jun 15 2018 at 11:41)</a>:</h4>
<p>That can't be right, the printout has six variables not two</p>

<a name="128115709"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115709" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115709">Mario Carneiro (Jun 15 2018 at 11:42)</a>:</h4>
<p>what does <code>#print commutator_bracket</code> show?</p>

<a name="128115711"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115711" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115711">Johan Commelin (Jun 15 2018 at 11:42)</a>:</h4>
<p>Anyway, my point is that <code>𝔤</code> is a Lie algebra, and by definition that means it <code>extends has_bracket</code>. So I would hope that Lean could figure this one out.</p>

<a name="128115718"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115718" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115718">Johan Commelin (Jun 15 2018 at 11:42)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="bp">@</span><span class="o">[</span><span class="kn">instance</span><span class="o">]</span>
<span class="kn">protected</span> <span class="n">def</span> <span class="n">commutator_bracket</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_1</span><span class="o">}</span> <span class="o">[</span><span class="n">ri</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">{</span><span class="err">𝔤</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_2</span><span class="o">}</span> <span class="o">[</span><span class="n">la</span> <span class="o">:</span> <span class="n">lie_algebra</span> <span class="n">R</span> <span class="err">𝔤</span><span class="o">]</span> <span class="o">{</span><span class="n">S</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_3</span><span class="o">}</span> <span class="o">[</span><span class="bp">_</span><span class="n">inst_1</span> <span class="o">:</span> <span class="n">ring</span> <span class="n">S</span><span class="o">],</span>
  <span class="n">has_bracket</span> <span class="n">S</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_1</span><span class="o">}</span> <span class="o">[</span><span class="n">ri</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">{</span><span class="err">𝔤</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_2</span><span class="o">}</span> <span class="o">[</span><span class="n">la</span> <span class="o">:</span> <span class="n">lie_algebra</span> <span class="n">R</span> <span class="err">𝔤</span><span class="o">]</span> <span class="o">{</span><span class="n">S</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_3</span><span class="o">}</span> <span class="o">[</span><span class="bp">_</span><span class="n">inst_1</span> <span class="o">:</span> <span class="n">ring</span> <span class="n">S</span><span class="o">],</span>
  <span class="o">{</span><span class="n">bracket</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">S</span><span class="o">),</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">y</span> <span class="bp">-</span> <span class="n">y</span> <span class="bp">*</span> <span class="n">x</span><span class="o">}</span>
</pre></div>

<a name="128115721"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115721" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115721">Mario Carneiro (Jun 15 2018 at 11:42)</a>:</h4>
<p>there's your problem</p>

<a name="128115722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115722" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115722">Johan Commelin (Jun 15 2018 at 11:42)</a>:</h4>
<p>Which is crazy...</p>

<a name="128115728"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115728" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115728">Johan Commelin (Jun 15 2018 at 11:43)</a>:</h4>
<p>It pulls in way too much stuff.</p>

<a name="128115732"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115732" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115732">Mario Carneiro (Jun 15 2018 at 11:43)</a>:</h4>
<p>did you <code>include</code> stuff at the top maybe?</p>

<a name="128115807"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115807" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115807">Mario Carneiro (Jun 15 2018 at 11:44)</a>:</h4>
<p>try defining it outside the section, this instance has nothing to do with lie algebras</p>

<a name="128115819"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115819" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115819">Johan Commelin (Jun 15 2018 at 11:45)</a>:</h4>
<p>Yes... thanks for catching that!</p>

<a name="128115879"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115879" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115879">Johan Commelin (Jun 15 2018 at 11:46)</a>:</h4>
<p>Hmm, I need to run. In fact, I should try to get rid of those <code>include ri la</code>, but that seems to be non-trivial.</p>

<a name="128115887"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/128115887" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#128115887">Johan Commelin (Jun 15 2018 at 11:47)</a>:</h4>
<p>Anyway, I'll be back later. AFK</p>

<a name="167024345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024345" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024345">Kevin Buzzard (May 31 2019 at 19:04)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">punit_instances</span>

<span class="c1">-- works fine</span>
<span class="kn">example</span> <span class="o">:</span> <span class="n">add_comm_group</span> <span class="n">unit</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>

<span class="n">class</span> <span class="n">G_module</span> <span class="o">(</span><span class="n">G</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">group</span> <span class="n">G</span><span class="o">]</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span>
  <span class="kn">extends</span> <span class="n">add_comm_group</span> <span class="n">M</span><span class="o">,</span> <span class="n">has_scalar</span> <span class="n">G</span> <span class="n">M</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">id</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">m</span> <span class="o">:</span> <span class="n">M</span><span class="o">,</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="n">G</span><span class="o">)</span> <span class="err">•</span> <span class="n">m</span> <span class="bp">=</span> <span class="n">m</span><span class="o">)</span>
<span class="o">(</span><span class="n">mul</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">g</span> <span class="n">h</span> <span class="o">:</span> <span class="n">G</span><span class="o">,</span> <span class="bp">∀</span> <span class="n">m</span> <span class="o">:</span> <span class="n">M</span><span class="o">,</span> <span class="n">g</span> <span class="err">•</span> <span class="o">(</span><span class="n">h</span> <span class="err">•</span> <span class="n">m</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">g</span> <span class="bp">*</span> <span class="n">h</span><span class="o">)</span> <span class="err">•</span> <span class="n">m</span><span class="o">)</span>
<span class="o">(</span><span class="n">linear</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">g</span> <span class="o">:</span> <span class="n">G</span><span class="o">,</span> <span class="bp">∀</span> <span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="n">M</span><span class="o">,</span> <span class="n">g</span> <span class="err">•</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="n">n</span><span class="o">)</span> <span class="bp">=</span> <span class="n">g</span> <span class="err">•</span> <span class="n">m</span> <span class="bp">+</span> <span class="n">g</span> <span class="err">•</span> <span class="n">n</span><span class="o">)</span>

<span class="kn">example</span> <span class="o">:</span> <span class="n">add_comm_group</span> <span class="n">unit</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span> <span class="c1">-- fails</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">maximum class-instance resolution depth has been reached (the limit can be increased by setting option &#39;class.instance_max_depth&#39;) (the class-instance resolution trace can be visualized by setting option &#39;trace.class_instances&#39;)</span>
<span class="cm">state:</span>
<span class="cm">⊢ add_comm_group unit</span>
<span class="cm">-/</span>
</pre></div>


<p>What did I do to deserve that? Is the class bad in some way?</p>

<a name="167024427"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024427" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024427">Kevin Buzzard (May 31 2019 at 19:04)</a>:</h4>
<p><code>set_option class.instance_max_depth 1000</code> doesn't fix it</p>

<a name="167024506"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024506" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024506">Kevin Buzzard (May 31 2019 at 19:05)</a>:</h4>
<div class="codehilite"><pre><span></span>[class_instances]  class-instance resolution trace
[class_instances] (0) ?x_0 : add_comm_group unit := @G_module.to_add_comm_group ?x_1 ?x_2 ?x_3 ?x_4
[class_instances] (1) ?x_2 : group ?x_1 := @subtype.group ?x_5 ?x_6 ?x_7 ?x_8
[class_instances] (2) ?x_6 : group ?x_5 := @subtype.group ?x_9 ?x_10 ?x_11 ?x_12
[class_instances] (3) ?x_10 : group ?x_9 := @subtype.group ?x_13 ?x_14 ?x_15 ?x_16
[class_instances] (4) ?x_14 : group ?x_13 := @subtype.group ?x_17 ?x_18 ?x_19 ?x_20
[class_instances] (5) ?x_18 : group ?x_17 := @subtype.group ?x_21 ?x_22 ?x_23 ?x_24
[class_instances] (6) ?x_22 : group ?x_21 := @subtype.group ?x_25 ?x_26 ?x_27 ?x_28
[class_instances] (7) ?x_26 : group ?x_25 := @subtype.group ?x_29 ?x_30 ?x_31 ?x_32
[class_instances] (8) ?x_30 : group ?x_29 := @subtype.group ?x_33 ?x_34 ?x_35 ?x_36
[class_instances] (9) ?x_34 : group ?x_33 := @subtype.group ?x_37 ?x_38 ?x_39 ?x_40
[class_instances] (10) ?x_38 : group ?x_37 := @subtype.group ?x_41 ?x_42 ?x_43 ?x_44
[class_instances] (11) ?x_42 : group ?x_41 := @subtype.group ?x_45 ?x_46 ?x_47 ?x_48
[class_instances] (12) ?x_46 : group ?x_45 := @subtype.group ?x_49 ?x_50 ?x_51 ?x_52
[class_instances] (13) ?x_50 : group ?x_49 := @subtype.group ?x_53 ?x_54 ?x_55 ?x_56
[class_instances] (14) ?x_54 : group ?x_53 := @subtype.group ?x_57 ?x_58 ?x_59 ?x_60
[class_instances] (15) ?x_58 : group ?x_57 := @subtype.group ?x_61 ?x_62 ?x_63 ?x_64
[class_instances] (16) ?x_62 : group ?x_61 := @subtype.group ?x_65 ?x_66 ?x_67 ?x_68
[class_instances] (17) ?x_66 : group ?x_65 := @subtype.group ?x_69 ?x_70 ?x_71 ?x_72
[class_instances] (18) ?x_70 : group ?x_69 := @subtype.group ?x_73 ?x_74 ?x_75 ?x_76
[class_instances] (19) ?x_74 : group ?x_73 := @subtype.group ?x_77 ?x_78 ?x_79 ?x_80
[class_instances] (20) ?x_78 : group ?x_77 := @subtype.group ?x_81 ?x_82 ?x_83 ?x_84
[class_instances] (21) ?x_82 : group ?x_81 := @subtype.group ?x_85 ?x_86 ?x_87 ?x_88
[class_instances] (22) ?x_86 : group ?x_85 := @subtype.group ?x_89 ?x_90 ?x_91 ?x_92
[class_instances] (23) ?x_90 : group ?x_89 := @subtype.group ?x_93 ?x_94 ?x_95 ?x_96
[class_instances] (24) ?x_94 : group ?x_93 := @subtype.group ?x_97 ?x_98 ?x_99 ?x_100
[class_instances] (25) ?x_98 : group ?x_97 := @subtype.group ?x_101 ?x_102 ?x_103 ?x_104
[class_instances] (26) ?x_102 : group ?x_101 := @subtype.group ?x_105 ?x_106 ?x_107 ?x_108
[class_instances] (27) ?x_106 : group ?x_105 := @subtype.group ?x_109 ?x_110 ?x_111 ?x_112
[class_instances] (28) ?x_110 : group ?x_109 := @subtype.group ?x_113 ?x_114 ?x_115 ?x_116
[class_instances] (29) ?x_114 : group ?x_113 := @subtype.group ?x_117 ?x_118 ?x_119 ?x_120
[class_instances] (30) ?x_118 : group ?x_117 := @subtype.group ?x_121 ?x_122 ?x_123 ?x_124
[class_instances] (31) ?x_122 : group ?x_121 := @subtype.group ?x_125 ?x_126 ?x_127 ?x_128
[class_instances] (32) ?x_126 : group ?x_125 := @subtype.group ?x_129 ?x_130 ?x_131 ?x_132
</pre></div>

<a name="167024586"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024586" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024586">Kevin Buzzard (May 31 2019 at 19:06)</a>:</h4>
<p>Can I solve this with some priority hack? Why does this happen?</p>

<a name="167024656"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024656" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024656">Mario Carneiro (May 31 2019 at 19:07)</a>:</h4>
<p>the class is bad, as you suspect</p>

<a name="167024677"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024677" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024677">Floris van Doorn (May 31 2019 at 19:07)</a>:</h4>
<p>Make <code>add_comm_group M</code> an argument of the class.</p>

<a name="167024679"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024679" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024679">Mario Carneiro (May 31 2019 at 19:07)</a>:</h4>
<p>and the offending instance is right there in the trace - <code>G_module.to_add_comm_group</code></p>

<a name="167024793"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024793" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024793">Floris van Doorn (May 31 2019 at 19:09)</a>:</h4>
<p>something like </p>
<div class="codehilite"><pre><span></span>class G_module (G : Type*) (M : Type*) [group G] [add_comm_group M]
  extends has_scalar G M :=
</pre></div>

<a name="167024796"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024796" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024796">Kevin Buzzard (May 31 2019 at 19:09)</a>:</h4>
<p>That sounds like a really super instance though.</p>

<a name="167024876"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024876" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024876">Kevin Buzzard (May 31 2019 at 19:10)</a>:</h4>
<p>There is some subtlety here which I don't understand -- this is exactly one of those times where you're saying "don't do it this way, do it in some way which looks exactly the same to a mathematician". Is there some general principle I'm unaware of?</p>

<a name="167024899"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024899" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024899">Mario Carneiro (May 31 2019 at 19:10)</a>:</h4>
<p>Don't have a parent instance with fewer type arguments than the class</p>

<a name="167024929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024929" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024929">Kevin Buzzard (May 31 2019 at 19:11)</a>:</h4>
<p>wait, what is a parent instance?</p>

<a name="167024936"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024936" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024936">Mario Carneiro (May 31 2019 at 19:11)</a>:</h4>
<p><code>extends</code> produces an instance</p>

<a name="167024949"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024949" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024949">Kevin Buzzard (May 31 2019 at 19:11)</a>:</h4>
<p>And Floris' suggestion doesn't?</p>

<a name="167024977"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167024977" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167024977">Mario Carneiro (May 31 2019 at 19:11)</a>:</h4>
<p>In the original case it was <code>[G_module G M] : add_comm_group M</code></p>

<a name="167025031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025031" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025031">Mario Carneiro (May 31 2019 at 19:12)</a>:</h4>
<p>no, I am in complete agreement with floris</p>

<a name="167025055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025055" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025055">Mario Carneiro (May 31 2019 at 19:12)</a>:</h4>
<p>floris is proposing to remove this instance, which is bad because <code>G</code> is "dangling"</p>

<a name="167025056"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025056" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025056">Kevin Buzzard (May 31 2019 at 19:12)</a>:</h4>
<p>Yes I understand that. And this is not generated in the suggested fix?</p>

<a name="167025085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025085" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025085">Kevin Buzzard (May 31 2019 at 19:13)</a>:</h4>
<p>Sorry, I had a little internet time-out. My comment referred to "extends produces an instance"</p>

<a name="167025086"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025086" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025086">Johan Commelin (May 31 2019 at 19:13)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> You know about <a href="https://github.com/leanprover-community/mathlib/blob/66a86ffe010ffc32ee92e2e92cbdaf83487af168/src/group_theory/group_action.lean#L173" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/66a86ffe010ffc32ee92e2e92cbdaf83487af168/src/group_theory/group_action.lean#L173">https://github.com/leanprover-community/mathlib/blob/66a86ffe010ffc32ee92e2e92cbdaf83487af168/src/group_theory/group_action.lean#L173</a> ?</p>

<a name="167025090"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025090" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025090">Mario Carneiro (May 31 2019 at 19:13)</a>:</h4>
<p>reading it from right to left, <code>G</code> just appears and lean doesn't know how to pick a value</p>

<a name="167025096"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025096" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025096">Johan Commelin (May 31 2019 at 19:13)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="c">/-</span><span class="cm">- Typeclass for multiplicative actions on additive structures. This generalizes group modules. -/</span>
<span class="n">class</span> <span class="n">distrib_mul_action</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">(</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">)</span> <span class="o">[</span><span class="n">monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">add_monoid</span> <span class="n">β</span><span class="o">]</span> <span class="kn">extends</span> <span class="n">mul_action</span> <span class="n">α</span> <span class="n">β</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">smul_add</span> <span class="o">:</span> <span class="bp">∀</span><span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">r</span> <span class="err">•</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">r</span> <span class="err">•</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">r</span> <span class="err">•</span> <span class="n">y</span><span class="o">)</span>
<span class="o">(</span><span class="n">smul_zero</span> <span class="o">{}</span> <span class="o">:</span> <span class="bp">∀</span><span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span> <span class="n">r</span> <span class="err">•</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">β</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">)</span>
</pre></div>

<a name="167025238"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025238" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025238">Kevin Buzzard (May 31 2019 at 19:15)</a>:</h4>
<blockquote>
<p>reading it from right to left, <code>G</code> just appears and lean doesn't know how to pick a value</p>
</blockquote>
<p>I appreciate the problem; I am just saying that my understanding of why it occurs the way I did it and not the way Floris did it is hazy. <code>extends</code> produces an instance, this is the point. So Floris' method produces no instances?</p>

<a name="167025242"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025242" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025242">Kevin Buzzard (May 31 2019 at 19:15)</a>:</h4>
<p>Johan -- no, I didn't know about this.</p>

<a name="167025246"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025246" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025246">Floris van Doorn (May 31 2019 at 19:15)</a>:</h4>
<p>My solution doesn't generate the instance, because Lean will need to synthesize the instance <code>add_comm_group M</code> before it can even start searching for an instance of <code>G_module G M</code></p>

<a name="167025266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025266" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025266">Kevin Buzzard (May 31 2019 at 19:15)</a>:</h4>
<p>Right.</p>

<a name="167025299"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025299" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025299">Mario Carneiro (May 31 2019 at 19:15)</a>:</h4>
<p>there is still a parent instance coming from the other <code>extends</code> clause</p>

<a name="167025301"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025301" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025301">Kevin Buzzard (May 31 2019 at 19:16)</a>:</h4>
<p>In a parallel universe someone could tell me that this [Floris' suggestion] produces an instance anyway, and I would happily believe them.</p>

<a name="167025418"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025418" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025418">Mario Carneiro (May 31 2019 at 19:17)</a>:</h4>
<p>The easiest way to think of it is <code>extends</code> is notation for an extra field in the class + an instance to get to the parent from the child</p>

<a name="167025511"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025511" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025511">Mario Carneiro (May 31 2019 at 19:18)</a>:</h4>
<p>AFAIK it's the only way to get autogenerated instances</p>

<a name="167025524"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025524" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025524">Floris van Doorn (May 31 2019 at 19:18)</a>:</h4>
<p>Well, let's try do define this instance:</p>
<div class="codehilite"><pre><span></span>instance (G : Type*) (M : Type*) [group G] [add_comm_group M] [G_module G M] :
  add_comm_group M :=
_
</pre></div>


<p>What would you pick for the value of the underscore? It's the instance you already got as an argument. So this instance says "if you want <code>add_comm_group M</code> then you need to search for <code>add_comm_group M</code> (and a bunch more things). It's (worse than) useless.</p>

<a name="167025571"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025571" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025571">Kevin Buzzard (May 31 2019 at 19:19)</a>:</h4>
<p>My understanding of what is going on here is hazy at best. I even don't really understand, in some sense, why the instance is bad, because I don't really understand how type class inference works; I can of course see that it's bad because of what just happened, but the fact that I asked here instead of trying to fix it myself (which is nowadays my preferred solution with problems I run into) is just an indication of my poor understanding of this stuff. </p>
<p>I keep meaning to write some doc for <code>docs/extras/</code> about the nitty-gritty of how type class inference works but I've had a busy year. The next three months are looking much nicer though, maybe I should actually do this; writing the docs myself will show me what I don't understand.</p>

<a name="167025595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025595" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025595">Mario Carneiro (May 31 2019 at 19:19)</a>:</h4>
<p>It's a prolog-like search</p>

<a name="167025827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025827" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025827">Mario Carneiro (May 31 2019 at 19:22)</a>:</h4>
<p>Every instance says "to prove A it suffices to prove B, C, D" and lean just applies all instances greedily hoping to get somewhere</p>

<a name="167025859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025859" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025859">Kevin Buzzard (May 31 2019 at 19:22)</a>:</h4>
<p>[prolog] Yeah, somehow this is exactly the problem. I can believe that at some point in CS UG there's a chance to do some lectures / problem sets on how prolog works. In maths departments we don't do this. On a couple of occasions now I've sat down to fathom this out (even installing prolog on one occasion) but then never wrote down any of my thoughts and then I just forget them again. Writing things down is really helpful for me at my age -- only today did I look at my <code>simp</code> notes that I wrote so I could find out how to turn the trace on for <code>simp</code> -- I always forget, but I know where to look. The docs I write are "by me now, for me next week" :-)</p>

<a name="167025861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025861" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025861">Floris van Doorn (May 31 2019 at 19:22)</a>:</h4>
<p>Btw, I don't have some magical superpower that I know how to do these things. The general strategy for a lot of formalization is to see if someone has done something similar before. If so, copy their code and adapt it to your case. In this case, the definition of <code>module</code> is similar:<br>
<a href="https://github.com/leanprover-community/mathlib/blob/master/src/algebra/module.lean#L25" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/master/src/algebra/module.lean#L25">https://github.com/leanprover-community/mathlib/blob/master/src/algebra/module.lean#L25</a><br>
Often the design decisions will be the same for your case.</p>

<a name="167025910"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025910" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025910">Kevin Buzzard (May 31 2019 at 19:23)</a>:</h4>
<blockquote>
<p>Btw, I don't have some magical superpower</p>
</blockquote>
<p>Rotten luck! Mathematicians have a super-power.</p>

<a name="167025919"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025919" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025919">Floris van Doorn (May 31 2019 at 19:23)</a>:</h4>
<p>I do this all the time, even if I wrote the previous code. Past me was usually much more aware of all the pitfalls (because he fell into them, and then changed the code).</p>

<a name="167025931"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025931" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025931">Kevin Buzzard (May 31 2019 at 19:23)</a>:</h4>
<p>Unfortunately, Lean disables our super-power.</p>

<a name="167025973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167025973" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167025973">Mario Carneiro (May 31 2019 at 19:24)</a>:</h4>
<p>You should mostly assume that lean applies instances in the worst possible order, because anything else is luck. So if there is an instance like "to prove T A it suffices to prove T (A x A)" then it should be clear that lean will loop</p>

<a name="167026010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167026010" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167026010">Kevin Buzzard (May 31 2019 at 19:24)</a>:</h4>
<p>ha ha, that rule of thumb stinks! It's crying out for a fix.</p>

<a name="167026051"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167026051" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167026051">Kevin Buzzard (May 31 2019 at 19:25)</a>:</h4>
<p>The rule of thumb makes perfect sense,  but somehow says "we could be doing this better". I guess we had this conversation once before quite recently.</p>

<a name="167026067"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167026067" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167026067">Mario Carneiro (May 31 2019 at 19:25)</a>:</h4>
<p>It's not as bad as it sounds; you just have to make sure that the worst possible order isn't that bad</p>

<a name="167026081"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167026081" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167026081">Kevin Buzzard (May 31 2019 at 19:25)</a>:</h4>
<p>I know that making typeclass inference better is on Leo's mind.</p>

<a name="167026105"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167026105" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167026105">Floris van Doorn (May 31 2019 at 19:25)</a>:</h4>
<p>i really think we should use <code>priority n</code> more in mathlib so that we can decide which instances should be applied first and which ones should be applied last.</p>

<a name="167026110"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167026110" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167026110">Kevin Buzzard (May 31 2019 at 19:25)</a>:</h4>
<p>[we had a brief email exchange when perfectoids got done, and he mentioned it]</p>

<a name="167026191"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167026191" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167026191">Mario Carneiro (May 31 2019 at 19:26)</a>:</h4>
<p>I agree that more use of priority would be a good thing, but I currently don't have a good model for how to structure the priorities</p>

<a name="167029799"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167029799" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167029799">Floris van Doorn (May 31 2019 at 20:08)</a>:</h4>
<p>My gut feeling says priorities should be as follows:</p>
<ul>
<li>Structural instances: an instance which only works for certain types (like <code>group A -&gt; group B -&gt; group (prod A B)</code> or <code>ring int</code>). If such an instance applies, then it's almost always the instance you want to apply. So the order doesn't matter that much, but you can put the more common instances in front.</li>
<li>Forgetful instances, like <code>comm_group A -&gt; group A</code>. Here you want to order them by how likely they are to apply (taking into consideration how long it would take for this instance to fail). Ultimately this will depend on which area of maths you're doing. When doing ring theory, you'll want to apply <code>ring.to_add_comm_group</code>first, while in other cases you might want to do apply <code>ordered_comm_group.to_add_comm_group</code> first (this is not a great example, I think you almost always want to apply <code>ring.to_add_comm_group</code> first).</li>
</ul>
<p>Looking a bit over <code>#print instances</code>, it looks like mathlib does this mostly right. I think this is partially accidental, since forgetful instances tend to be declared before structural instances are, and so even if they have the same priority they will be considered later. Some things I noticed:</p>
<ul>
<li>Sometimes there are "shortcuts", like <code>decidable_linear_ordered_comm_group.to_add_comm_group</code> and <code>ordered_comm_group.to_add_comm_group</code> (or <code>linear_ordered_ring.to_linear_order</code> and <code>linear_ordered_semiring.to_linear_order</code>). If these instances do not apply, the search through the "order hierarchy" will happen twice, right? Probably these shortcuts should be removed?</li>
<li><code>nonneg_comm_group.to_add_comm_group</code> should have a lower priority.</li>
<li>Some declarations should probably not be instances: <code>decidable_eq_of_decidable_le</code> or <code>decidable_lt_of_decidable_le</code>. Unfortunately they are in core...</li>
</ul>

<a name="167030029"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167030029" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167030029">Mario Carneiro (May 31 2019 at 20:11)</a>:</h4>
<p>We need a real test to find out if shortcuts are taken twice</p>

<a name="167030675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167030675" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167030675">Floris van Doorn (May 31 2019 at 20:18)</a>:</h4>
<p>Is <code>set_option trace.class_instances true</code> a reliable test?</p>
<div class="codehilite"><pre><span></span>example : add_comm_group bool := by apply_instance
</pre></div>


<p>gives</p>
<div class="codehilite"><pre><span></span>[...]
[class_instances] (0) ?x_0 : add_comm_group bool := @decidable_linear_ordered_comm_group.to_add_comm_group ?x_1 ?x_2
[class_instances] (1) ?x_2 : decidable_linear_ordered_comm_group bool := int.decidable_linear_ordered_comm_group
failed is_def_eq
[class_instances] (1) ?x_2 : decidable_linear_ordered_comm_group bool := @decidable_linear_ordered_comm_ring.to_decidable_linear_ordered_comm_group ?x_3 ?x_4
[class_instances] (2) ?x_4 : decidable_linear_ordered_comm_ring bool := @linear_nonneg_ring.to_decidable_linear_ordered_comm_ring ?x_5 ?x_6 ?x_7 ?x_8
[class_instances] (2) ?x_4 : decidable_linear_ordered_comm_ring bool := int.decidable_linear_ordered_comm_ring
failed is_def_eq
[class_instances] (2) ?x_4 : decidable_linear_ordered_comm_ring bool := @discrete_linear_ordered_field.to_decidable_linear_ordered_comm_ring ?x_5 ?x_6
[class_instances] (0) ?x_0 : add_comm_group bool := @ordered_comm_group.to_add_comm_group ?x_1 ?x_2
[...]
[class_instances] (4) ?x_8 : linear_ordered_comm_ring bool := @decidable_linear_ordered_comm_ring.to_linear_ordered_comm_ring ?x_9 ?x_10
[class_instances] (5) ?x_10 : decidable_linear_ordered_comm_ring bool := @linear_nonneg_ring.to_decidable_linear_ordered_comm_ring ?x_11 ?x_12 ?x_13 ?x_14
[class_instances] (5) ?x_10 : decidable_linear_ordered_comm_ring bool := int.decidable_linear_ordered_comm_ring
failed is_def_eq
[class_instances] (5) ?x_10 : decidable_linear_ordered_comm_ring bool := @discrete_linear_ordered_field.to_decidable_linear_ordered_comm_ring ?x_11 ?x_12
[class_instances] (1) ?x_2 : ordered_comm_group bool := @decidable_linear_ordered_comm_group.to_ordered_comm_group ?x_3 ?x_4
[class_instances] (2) ?x_4 : decidable_linear_ordered_comm_group bool := int.decidable_linear_ordered_comm_group
failed is_def_eq
[class_instances] (2) ?x_4 : decidable_linear_ordered_comm_group bool := @decidable_linear_ordered_comm_ring.to_decidable_linear_ordered_comm_group ?x_5 ?x_6
[class_instances] (3) ?x_6 : decidable_linear_ordered_comm_ring bool := @linear_nonneg_ring.to_decidable_linear_ordered_comm_ring ?x_7 ?x_8 ?x_9 ?x_10
[class_instances] (3) ?x_6 : decidable_linear_ordered_comm_ring bool := int.decidable_linear_ordered_comm_ring
failed is_def_eq
[class_instances] (3) ?x_6 : decidable_linear_ordered_comm_ring bool := @discrete_linear_ordered_field.to_decidable_linear_ordered_comm_ring ?x_7 ?x_8
</pre></div>


<p>It seems like it considered <code>decidable_linear_ordered_comm_ring bool</code> three times.</p>

<a name="167030809"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167030809" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167030809">Floris van Doorn (May 31 2019 at 20:19)</a>:</h4>
<p>Now sometimes duplication is impossible to avoid, without changing the code to the search, when you have diamonds...</p>

<a name="167031132"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031132" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031132">Mario Carneiro (May 31 2019 at 20:23)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">class</span> <span class="n">A</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span>
<span class="n">class</span> <span class="n">B</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="kn">extends</span> <span class="n">A</span> <span class="n">α</span> <span class="n">n</span>
<span class="n">class</span> <span class="n">C</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="kn">extends</span> <span class="n">B</span> <span class="n">α</span> <span class="n">n</span>

<span class="kn">instance</span> <span class="n">C_nat</span> <span class="o">:</span> <span class="n">C</span> <span class="bp">ℕ</span> <span class="mi">0</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">C</span><span class="bp">.</span><span class="n">mk</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">B</span><span class="bp">.</span><span class="n">mk</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">)</span>

<span class="kn">instance</span> <span class="n">C_of_A&#39;</span> <span class="o">(</span><span class="n">α</span> <span class="n">n</span><span class="o">)</span> <span class="o">[</span><span class="n">A</span> <span class="n">α</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">C</span> <span class="n">α</span> <span class="n">n</span><span class="bp">.</span><span class="n">succ</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">C</span><span class="bp">.</span><span class="n">mk</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">B</span><span class="bp">.</span><span class="n">mk</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">)</span>
<span class="kn">instance</span> <span class="n">shortcut</span> <span class="o">(</span><span class="n">α</span> <span class="n">n</span><span class="o">)</span> <span class="o">[</span><span class="n">C</span> <span class="n">α</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">A</span> <span class="n">α</span> <span class="n">n</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>

<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">class_instances</span> <span class="n">true</span>
<span class="kn">set_option</span> <span class="n">class</span><span class="bp">.</span><span class="n">instance_max_depth</span> <span class="mi">1000</span>
<span class="bp">#</span><span class="kn">check</span> <span class="o">(</span><span class="k">by</span> <span class="n">apply_instance</span> <span class="o">:</span> <span class="n">C</span> <span class="bp">ℕ</span> <span class="mi">30</span><span class="o">)</span>
</pre></div>


<p>it's considering <code>shortcut</code> at each level but it's not exponential</p>

<a name="167031274"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031274" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031274">Floris van Doorn (May 31 2019 at 20:25)</a>:</h4>
<p>About the <code>decidable_eq_of_decidable_le</code>issue: maybe we should set their priorities in <code>mathlib</code> to <code>0</code>, and decide that <code>local attribute [instance, priority 10] classical.prop_decidable</code> should happen at priority 10, not 0. Now, it probably searches through big chunks of the order hierarchy twice, when you want that <code>prop_decidable</code> should decide an equality on any type:</p>
<ul>
<li>through <code>decidable_linear_order α</code></li>
<li>through <code>decidable_eq_of_decidable_le</code></li>
</ul>

<a name="167031300"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031300" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031300">Mario Carneiro (May 31 2019 at 20:25)</a>:</h4>
<p>oh wait, <code>C unit 7</code> is definitely exponential</p>

<a name="167031320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031320" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031320">Mario Carneiro (May 31 2019 at 20:25)</a>:</h4>
<p>that's disconcerting</p>

<a name="167031431"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031431" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031431">Mario Carneiro (May 31 2019 at 20:26)</a>:</h4>
<p>once again I am staggered that typeclass inference works at all</p>

<a name="167031475"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031475" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031475">Floris van Doorn (May 31 2019 at 20:27)</a>:</h4>
<p>numerals have special support on <code>nat</code>, maybe that makes a difference?</p>

<a name="167031497"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031497" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031497">Mario Carneiro (May 31 2019 at 20:27)</a>:</h4>
<p>no, that just makes it a bit easier to write a bunch of succs here</p>

<a name="167031570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031570" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031570">Mario Carneiro (May 31 2019 at 20:28)</a>:</h4>
<p>Compare the instance trace on <code>C unit 7</code> with and without <code>shortcut</code></p>

<a name="167031597"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031597" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031597">Floris van Doorn (May 31 2019 at 20:28)</a>:</h4>
<p>the problem is that your first instance <em>never</em> fails: all instances it tries succeed. Each branch is linear: backtracking is exponential.</p>

<a name="167031728"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031728" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031728">Mario Carneiro (May 31 2019 at 20:30)</a>:</h4>
<p>To some extent that's not unreasonable - I'm not sure how much we should care about failing searches</p>

<a name="167031789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031789" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031789">Floris van Doorn (May 31 2019 at 20:31)</a>:</h4>
<p>a lot</p>

<a name="167031811"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031811" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031811">Floris van Doorn (May 31 2019 at 20:31)</a>:</h4>
<p>whenever you do <code>local attribute [instance, priority 0] classical.prop_decidable</code> there are a whole lot of failing searches.</p>

<a name="167031837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031837" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031837">Floris van Doorn (May 31 2019 at 20:31)</a>:</h4>
<p>probably half of the "Forgetful instances" will fail. (even if applying another instance succeeds)</p>

<a name="167031936"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167031936" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167031936">Mario Carneiro (May 31 2019 at 20:32)</a>:</h4>
<p>here's a case where the instance succeeds but takes a long time:</p>
<div class="codehilite"><pre><span></span><span class="n">class</span> <span class="n">D</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span>
<span class="kn">instance</span> <span class="n">D_unit</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">D</span> <span class="n">unit</span> <span class="n">n</span> <span class="o">:=</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_⟩</span>
<span class="kn">instance</span> <span class="n">D_of_C</span> <span class="o">(</span><span class="n">α</span> <span class="n">n</span><span class="o">)</span> <span class="o">[</span><span class="n">C</span> <span class="n">α</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">D</span> <span class="n">α</span> <span class="n">n</span> <span class="o">:=</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_⟩</span>

<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">class_instances</span> <span class="n">true</span>
<span class="kn">set_option</span> <span class="n">class</span><span class="bp">.</span><span class="n">instance_max_depth</span> <span class="mi">1000</span>
<span class="bp">#</span><span class="kn">check</span> <span class="o">(</span><span class="k">by</span> <span class="n">apply_instance</span> <span class="o">:</span> <span class="n">D</span> <span class="n">unit</span> <span class="mi">7</span><span class="o">)</span>
</pre></div>

<a name="167032404"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167032404" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167032404">Floris van Doorn (May 31 2019 at 20:38)</a>:</h4>
<p>when doing some testing on my own</p>
<div class="codehilite"><pre><span></span>(message too long, truncated at 262144 characters)
</pre></div>


<p>lol,</p>
<p>But I think it's pretty clear we should remove these shortcuts of "forgetful" instances.</p>

<a name="167032576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167032576" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167032576">Mario Carneiro (May 31 2019 at 20:41)</a>:</h4>
<p>this is a real shame, these could be useful in principle but lean really doesn't like them</p>

<a name="167032635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167032635" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167032635">Kevin Buzzard (May 31 2019 at 20:41)</a>:</h4>
<blockquote>
<p>(message too long, truncated at 262144 characters)</p>
</blockquote>
<p>Gabriel put that check there precisely because I was fiddling around with this sort of thing once and managed to get a message that was so long that it broke stuff.</p>

<a name="167032642"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167032642" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167032642">Mario Carneiro (May 31 2019 at 20:41)</a>:</h4>
<p>but actually I don't know to what degree we can make our hierarchy "tree-like"</p>

<a name="167032712"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167032712" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167032712">Mario Carneiro (May 31 2019 at 20:42)</a>:</h4>
<p>algebraic hierarchies don't work like that</p>

<a name="167033408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167033408" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167033408">Floris van Doorn (May 31 2019 at 20:50)</a>:</h4>
<p>There should really be a different algorithm for these "forgetful instances". Make a graph of all instances that change the class but not the type (like <code>add_comm_group \a -&gt; add_group \a</code>) and when you have searched through all structural instances (or all instances with priority &gt;= default priority), then use a graph reachability algorithm to quickly search for a path to any instance in the local context.</p>

<a name="167036451"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167036451" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167036451">Kevin Buzzard (May 31 2019 at 21:36)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> how about you make type class search user-configurable? Everyone has different ideas :-)</p>

<a name="167054394"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167054394" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167054394">Johan Commelin (Jun 01 2019 at 04:31)</a>:</h4>
<p>I think that is one of the plans for Lean 4</p>

<a name="167081954"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167081954" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167081954">Sebastian Ullrich (Jun 01 2019 at 17:33)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> Making typeclass inference based on customizable tactics has been proposed before, but no one has figured out how to combine that with instance caching</p>

<a name="167081965"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167081965" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167081965">Kevin Buzzard (Jun 01 2019 at 17:33)</a>:</h4>
<p>My comment was really tongue-in-cheek I guess</p>

<a name="167082024"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082024" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082024">Kevin Buzzard (Jun 01 2019 at 17:34)</a>:</h4>
<p>The moment you let users do what they want is presumably the moment that things get really inefficient</p>

<a name="167082031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082031" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082031">Kevin Buzzard (Jun 01 2019 at 17:34)</a>:</h4>
<p>We have seen type class inference doing some silly things recently</p>

<a name="167082060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082060" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082060">Kevin Buzzard (Jun 01 2019 at 17:35)</a>:</h4>
<p>But it is not clear to me that there is some unified sensible algorithm which stops all of those silly things happening at once whilst remaining efficient</p>

<a name="167082072"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082072" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082072">Kevin Buzzard (Jun 01 2019 at 17:35)</a>:</h4>
<p>Why not just let prolog do it and make prolog a dependency?</p>

<a name="167082121"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082121" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082121">Kevin Buzzard (Jun 01 2019 at 17:36)</a>:</h4>
<p>Some people claimed that prolog was better than lean at prolog-like searches</p>

<a name="167082130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082130" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082130">Kevin Buzzard (Jun 01 2019 at 17:36)</a>:</h4>
<p>I of course am in no position to comment</p>

<a name="167082162"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082162" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082162">Johan Commelin (Jun 01 2019 at 17:37)</a>:</h4>
<p>The difference is maybe that Prolog does a Prolog search, instead of merely a prolog-like search <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>

<a name="167082220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082220" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082220">Sebastian Ullrich (Jun 01 2019 at 17:38)</a>:</h4>
<p>For starters, Lean's unification is much more complex than Prolog's. You wouldn't want to lose delta reduction in instance searches</p>

<a name="167082221"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082221" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082221">Kevin Buzzard (Jun 01 2019 at 17:38)</a>:</h4>
<p>I still reserve the right to snicker when Lean tries 20 random things in order to prove that rat has a one, before finally stumbling on <code>rat.has_one</code></p>

<a name="167082252"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082252" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082252">Johan Commelin (Jun 01 2019 at 17:39)</a>:</h4>
<blockquote>
<p>I still reserve the right to snicker when Lean tries 20 random things in order to prove that rat has a one, before finally stumbling on <code>rat.has_one</code></p>
</blockquote>
<p><span aria-label="up" class="emoji emoji-2b06" role="img" title="up">:up:</span> Completely agree. I think that guessing the correct name is one place where we could really win, and possibly win a lot.</p>

<a name="167082313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082313" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082313">Johan Commelin (Jun 01 2019 at 17:40)</a>:</h4>
<p>For this reason, I've been trying to always use the auto-generated name for instances, in the hope that this will pay of in the future.</p>

<a name="167082321"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082321" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082321">Sebastian Ullrich (Jun 01 2019 at 17:40)</a>:</h4>
<p>This is one example where some instance indexing approach in Lean 4 should make the search instantaneous. Well, assuming you really have the same "one" in goal and instance.</p>

<a name="167082328"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082328" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082328">Johan Commelin (Jun 01 2019 at 17:40)</a>:</h4>
<p>It might break some sort of psychological/abstraction barrier in the software though: names ought to be irrelevant to Lean, and only relevant for humans.</p>

<a name="167082487"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more%20type%20class%20inference%20issues/near/167082487" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/00919moretypeclassinferenceissues.html#167082487">Chris Hughes (Jun 01 2019 at 17:44)</a>:</h4>
<p>Use some hidden name that isn't the name we have to look at.</p>


{% endraw %}
