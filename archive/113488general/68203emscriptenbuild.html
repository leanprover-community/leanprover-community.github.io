---
layout: archive
title: Lean Prover Zulip Chat Archive 
permalink: archive/113488general/68203emscriptenbuild.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html">emscripten build</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">
{% raw %}
<a name="125887589"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125887589" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125887589">Sebastian Ullrich (Apr 30 2018 at 10:15)</a>:</h4>
<p>I see the emscripten situation is as stellar as ever :| .<br>
Using the official Arch Linux build:</p>
<div class="codehilite"><pre><span></span>$ pacaur -Qo $(which emconfigure)
/usr/lib/emscripten/emconfigure is owned by emscripten 1.37.36-1
 $ emconfigure cmake ../../src -DCMAKE_BUILD_TYPE=Emscripten
-- Lean library will be installed at /usr/local/lib/lean
-- Disabled multi-thread support, it will not be safe to run multiple threads in parallel
-- Using standard malloc.
-- Found PythonInterp: /usr/bin/python (found version &quot;3.6.4&quot;)
-- git commit sha1: 17fe3decaf8ae236f0d0ff51ac8fd7f6940acdee
-- Configuring done
-- Generating done
-- Build files have been written to: /home/sebastian/projects/lean/build/emscripten
$ make
...
checking how to switch to text section... configure: error: Cannot determine text section directive
ERROR:root:Configure step failed with non-zero return code 1! Command line: [&#39;./configure&#39;, &#39;CC_FOR_BUILD=gcc&#39;, &#39;CFLAGS=-m32 -DPIC -Oz -O3&#39;, &#39;--host=x86_64-pc-linux-gnu&#39;, &#39;--build=i686-pc-linux-gnu&#39;, &#39;--disable-assembly&#39;, &#39;--prefix=/home/sebastian/projects/lean/build/emscripten/gmp-root&#39;] at /home/sebastian/projects/lean/build/emscripten/gmp-prefix/src/gmp
make[2]: *** [CMakeFiles/gmp.dir/build.make:109: gmp-prefix/src/gmp-stamp/gmp-configure] Error 1
make[1]: *** [CMakeFiles/Makefile2:1180: CMakeFiles/gmp.dir/all] Error 2
make: *** [Makefile:163: all] Error 2
</pre></div>

<a name="125887631"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125887631" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125887631">Sebastian Ullrich (Apr 30 2018 at 10:16)</a>:</h4>
<p>/cc <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> <span class="user-mention" data-user-id="110524">@Scott Morrison</span> <span class="user-mention" data-user-id="110066">@loki der quaeler</span></p>

<a name="125887638"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125887638" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125887638">Kevin Buzzard (Apr 30 2018 at 10:17)</a>:</h4>
<p><a href="https://gitter.im/leanprover_public/lean_js" target="_blank" title="https://gitter.im/leanprover_public/lean_js">https://gitter.im/leanprover_public/lean_js</a></p>

<a name="125887639"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125887639" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125887639">Kevin Buzzard (Apr 30 2018 at 10:17)</a>:</h4>
<p>(for reference)</p>

<a name="125887687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125887687" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125887687">Johan Commelin (Apr 30 2018 at 10:18)</a>:</h4>
<p>Once we have multiplayer lean on cocalc we can forget about these headaches <span class="emoji emoji-1f3ae" title="video game">:video_game:</span></p>

<a name="125887852"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125887852" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125887852">Kevin Buzzard (Apr 30 2018 at 10:24)</a>:</h4>
<p>no because I want people who are idly reading my blog with no cocalc account to be able to see modern lean and mathlib doing stuff at the click of a button.</p>

<a name="125887854"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125887854" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125887854">Kevin Buzzard (Apr 30 2018 at 10:24)</a>:</h4>
<p>so we have one 3.4.1 headache</p>

<a name="125887855"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125887855" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125887855">Kevin Buzzard (Apr 30 2018 at 10:24)</a>:</h4>
<p>but then that's it</p>

<a name="125887857"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125887857" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125887857">Kevin Buzzard (Apr 30 2018 at 10:24)</a>:</h4>
<p>[assuming Mario can get mathlib working with 3.4.1]</p>

<a name="125887859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125887859" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125887859">Kevin Buzzard (Apr 30 2018 at 10:24)</a>:</h4>
<p>[or else the number of headaches goes up again]</p>

<a name="125887860"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125887860" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125887860">Johan Commelin (Apr 30 2018 at 10:24)</a>:</h4>
<p>Ok, fair enough</p>

<a name="125890720"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125890720" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125890720">Gabriel Ebner (Apr 30 2018 at 12:01)</a>:</h4>
<p>try this:</p>
<div class="codehilite"><pre><span></span><span class="gh">diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt</span>
<span class="gh">index 863f6a66d..6163d9b32 100644</span>
<span class="gd">--- a/src/CMakeLists.txt</span>
<span class="gi">+++ b/src/CMakeLists.txt</span>
<span class="gu">@@ -287,7 +287,7 @@ if (EMSCRIPTEN)</span>
             URL https://gmplib.org/download/gmp/gmp-6.1.1.tar.bz2
             URL_HASH SHA256=a8109865f2893f1373b0a8ed5ff7429de8db696fc451b1036bd7bdf95bbeffd6
             BUILD_IN_SOURCE 1
<span class="gd">-            CONFIGURE_COMMAND emconfigure ./configure &quot;CC_FOR_BUILD=gcc&quot; &quot;CFLAGS=-m32 -DPIC ${CFLAGS_EMSCRIPTEN}&quot; --host=x86_64-pc-linux-gnu --build=i686-pc-linux-gnu --disable-assembly --prefix=${gmp_install_prefix}</span>
<span class="gi">+           CONFIGURE_COMMAND emconfigure ./configure &quot;CC_FOR_BUILD=gcc&quot; &quot;CCAS=gcc -c&quot; &quot;CFLAGS=-m32 -DPIC ${CFLAGS_EMSCRIPTEN}&quot; --host=x86_64-pc-linux-gnu --build=i686-pc-linux-gnu --disable-assembly --prefix=${gmp_install_prefix}</span>
             BUILD_COMMAND emmake make -j4
             INSTALL_COMMAND make install
     )
</pre></div>

<a name="125891597"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/125891597" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#125891597">Sebastian Ullrich (Apr 30 2018 at 12:31)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> Seems to work, thanks!</p>

<a name="163916548"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/163916548" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#163916548">Bryan Gin-ge Chen (Apr 22 2019 at 16:37)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> I've been digging into the emscripten build for lean and am trying to figure out how to get a reasonable test setup working in the community fork (see <a href="https://github.com/leanprover-community/lean/pull/17" target="_blank" title="https://github.com/leanprover-community/lean/pull/17">this PR</a>). I'd appreciate any advice or suggestions if you've got time.</p>
<p>Here's where I'm at: I've managed to build the js and wasm files that are used by <code>lean-web-editor</code>, but I am having trouble with the other build outputs.  <code>ctest</code> seems to rely on a shell script <code>lean</code> which runs  <code>lean.js</code> and <code>lean.wasm</code> using <code>node</code>. This fails for me with the following error (and I get similar errors for <code>leanchecker</code>):</p>
<div class="codehilite"><pre><span></span>{ Error
    at new ErrnoError (.../lean/build/emscripten/shell/lean.js:1:72345)
    at Object.getMode (.../lean/build/emscripten/shell/lean.js:1:40486)
    at Object.mount (.../lean/build/emscripten/shell/lean.js:1:40042)
    at Object.mount (.../lean/build/emscripten/shell/lean.js:1:56062)
    at Array.ASM_CONSTS (.../lean/build/emscripten/shell/lean.js:1:15742)
    at _emscripten_asm_const_i (.../lean/build/emscripten/shell/lean.js:1:15892)
    at wasm-function[11542]:20
    at Object.Module._main (.../lean/build/emscripten/shell/lean.js:1:123255)
    at Object.callMain (.../lean/build/emscripten/shell/lean.js:1:128352)
    at doRun (.../lean/build/emscripten/shell/lean.js:1:129028)
  node: undefined,
  setErrno: [Function],
  errno: 2,
  message: &#39;FS error&#39; }
</pre></div>


<p>Any ideas on how to get it running again? I tried adding:</p>
<div class="codehilite"><pre><span></span>    set_target_properties(lean PROPERTIES LINK_FLAGS &quot;-s WASM=0 ${LEAN_JS_OPTS}&quot;)
</pre></div>


<p>in <code>src/shell/CMakeLists.txt</code> since <code>LEAN_JS_OPTS</code> contains <code>"-s 'EXTRA_EXPORTED_RUNTIME_METHODS=[\"FS\"]'"</code> but it didn't seem to do anything. (<code>-s WASM=1</code> didn't work either)</p>

<a name="163927294"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/emscripten%20build/near/163927294" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/68203emscriptenbuild.html#163927294">Bryan Gin-ge Chen (Apr 22 2019 at 18:51)</a>:</h4>
<p>OK, I've gotten past this error now. There were some hardcoded paths in <code>src/shell/lean.cpp</code> that I had to change.</p>


{% endraw %}
