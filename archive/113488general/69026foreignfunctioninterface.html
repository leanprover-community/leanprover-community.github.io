---
layout: archive
title: Lean Prover Zulip Chat Archive
permalink: archive/113488general/69026foreignfunctioninterface.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html">foreign function interface</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">

{% raw %}
<a name="164593325"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164593325" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164593325">James King (May 01 2019 at 02:01)</a>:</h4>
<p>Hey -- I'm working out how to add a foreign function interface to Lean's VM so that Lean code can call into libraries written in C/C++. Ideas and feedback on how to achieve this are welcome. I've started a branch at <a href="https://github.com/agentultra/lean/tree/feature/vm-dynload" target="_blank" title="https://github.com/agentultra/lean/tree/feature/vm-dynload">https://github.com/agentultra/lean/tree/feature/vm-dynload</a> for adding the low-level plumbing.</p>

<a name="164594296"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594296" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594296">Mario Carneiro (May 01 2019 at 02:25)</a>:</h4>
<p>You should coordinate with <span class="user-mention" data-user-id="110026">@Simon Hudon</span>, who has also been working on FFI in the leanprover-community fork</p>

<a name="164594365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594365" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594365">Mario Carneiro (May 01 2019 at 02:26)</a>:</h4>
<p>assuming you aren't already working on the same project as Simon's been discussing</p>

<a name="164594381"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594381" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594381">James King (May 01 2019 at 02:26)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> I am working with him on it... he has convinced me to get involved with Lean. :)</p>

<a name="164594469"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594469" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594469">Mario Carneiro (May 01 2019 at 02:28)</a>:</h4>
<p>First, I would want to see what's the minimum implementation that is fully expressive</p>

<a name="164594560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594560" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594560">Simon Hudon (May 01 2019 at 02:31)</a>:</h4>
<p>What I'm thinking is that you could load a <code>.so</code> file with</p>
<div class="codehilite"><pre><span></span><span class="n">run_cmd</span> <span class="n">load_external</span> <span class="s2">&quot;file.so&quot;</span> <span class="s2">&quot;init_function&quot;</span> <span class="s2">&quot;finalize_function&quot;</span>
</pre></div>


<p>and then add bindings with:</p>
<div class="codehilite"><pre><span></span><span class="bp">@</span><span class="o">[</span><span class="n">ffi</span> <span class="s2">&quot;file.so&quot;</span> <span class="s2">&quot;int c_add (int,int)&quot;</span><span class="o">]</span>
<span class="kn">constant</span> <span class="n">external_add_fn</span> <span class="o">:</span> <span class="n">c_int</span> <span class="bp">-&gt;</span> <span class="n">c_int</span> <span class="bp">-&gt;</span> <span class="n">c_int</span>
</pre></div>

<a name="164594570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594570" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594570">Simon Hudon (May 01 2019 at 02:31)</a>:</h4>
<p>And I'm thinking of accumulating <code>.so</code> objects in the `environment object</p>

<a name="164594653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594653" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594653">Mario Carneiro (May 01 2019 at 02:33)</a>:</h4>
<p>how can you call a function using a string description like that?</p>

<a name="164594655"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594655" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594655">Mario Carneiro (May 01 2019 at 02:33)</a>:</h4>
<p>in the c++</p>

<a name="164594750"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594750" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594750">James King (May 01 2019 at 02:35)</a>:</h4>
<p>We may need some way of telling the Lean code how to call the function. I was thinking we'd try using the <code>dlopen</code>/<code>dlsym</code> API</p>

<a name="164594796"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594796" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594796">Simon Hudon (May 01 2019 at 02:36)</a>:</h4>
<p>How does it work?</p>

<a name="164594799"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594799" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594799">Mario Carneiro (May 01 2019 at 02:36)</a>:</h4>
<p>I think you just get a void* function pointer</p>

<a name="164594801"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594801" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594801">James King (May 01 2019 at 02:37)</a>:</h4>
<p>Well... it's all <code>void *</code> pointers</p>

<a name="164594841"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594841" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594841">Mario Carneiro (May 01 2019 at 02:37)</a>:</h4>
<p>I don't know if it's possible to dynamically call a function with a runtime known type</p>

<a name="164594892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594892" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594892">Simon Hudon (May 01 2019 at 02:38)</a>:</h4>
<p>Right, as far as the <code>.so</code> file is concerned, only the function name matters. The rest of the string is to help us validate and marshal data</p>

<a name="164594918"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594918" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594918">Mario Carneiro (May 01 2019 at 02:39)</a>:</h4>
<p>but how can we adhere to C calling convention with a number of arguments only known at runtime</p>

<a name="164594920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594920" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594920">Simon Hudon (May 01 2019 at 02:39)</a>:</h4>
<p>You load the <code>so</code> file, you get a <code>void *</code>, you cast it in the right type to do the call (or, in our case, into a <code>type fn_name(...)</code> function I assume) and then you call</p>

<a name="164594980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594980" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594980">Simon Hudon (May 01 2019 at 02:40)</a>:</h4>
<p>We're going to need to manipulate the call stack to some extent</p>

<a name="164594985"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164594985" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164594985">James King (May 01 2019 at 02:40)</a>:</h4>
<p>I think so too.</p>

<a name="164595001"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164595001" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164595001">Mario Carneiro (May 01 2019 at 02:41)</a>:</h4>
<p><a href="https://sourceware.org/libffi/" target="_blank" title="https://sourceware.org/libffi/">https://sourceware.org/libffi/</a> ?</p>

<a name="164595061"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164595061" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164595061">James King (May 01 2019 at 02:42)</a>:</h4>
<p>That would make things nice and easy.</p>

<a name="164595074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164595074" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164595074">Simon Hudon (May 01 2019 at 02:43)</a>:</h4>
<p>Sounds like a nice tool</p>

<a name="164595133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164595133" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164595133">James King (May 01 2019 at 02:44)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="110049">@Mario Carneiro</span>!</p>

<a name="164595289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164595289" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164595289">Mario Carneiro (May 01 2019 at 02:48)</a>:</h4>
<p>See also the manual <a href="http://www.chiark.greenend.org.uk/doc/libffi-dev/html/" target="_blank" title="http://www.chiark.greenend.org.uk/doc/libffi-dev/html/">http://www.chiark.greenend.org.uk/doc/libffi-dev/html/</a>, which was surprisingly hard to find</p>

<a name="164621234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164621234" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164621234">Patrick Massot (May 01 2019 at 12:58)</a>:</h4>
<p>You guys are free to work on whatever sounds fun to you. But I cannot help wondering why you work on things that, as far as I can understand, will be completely wiped out by Lean 4. There are so many things that need expert work and will likely be portable to Lean 4. Why don't you work on transfer and parametricity for instance?</p>

<a name="164627136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164627136" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164627136">matt rice (May 01 2019 at 14:27)</a>:</h4>
<blockquote>
<p>I don't know if it's possible to dynamically call a function with a runtime known type</p>
</blockquote>
<p>I know there are some experiments in this regard, e.g. <a href="https://github.com/stephenrkell/liballocs" target="_blank" title="https://github.com/stephenrkell/liballocs">https://github.com/stephenrkell/liballocs</a> it essentially parses dwarf debug information and makes the necessary things available to the dynamic loader, but that entails custom compiler etc...</p>

<a name="164627616"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164627616" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164627616">Simon Hudon (May 01 2019 at 14:33)</a>:</h4>
<p>Have you had a look at  <a href="http://www.chiark.greenend.org.uk/doc/libffi-dev/html/" target="_blank" title="http://www.chiark.greenend.org.uk/doc/libffi-dev/html/">http://www.chiark.greenend.org.uk/doc/libffi-dev/html/</a>? This looks even better to me</p>

<a name="164628549"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164628549" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164628549">matt rice (May 01 2019 at 14:45)</a>:</h4>
<p>yeah, the thing liballocs gives on top of that is it gives one the ability to query the type of some memory allocation, and so the primitive types are safer i guess, where libffi is i guess an abstraction on top of void *, where the right ffi type corresponds to the c function (if you get it right), which is i believe Mario's complaint above.</p>

<a name="164628689"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164628689" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164628689">matt rice (May 01 2019 at 14:46)</a>:</h4>
<p>Anyhow, the thing i mentioned above is quite an endeavor to build, and rather experimental, but i wanted to point it out none the less.</p>

<a name="164628705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164628705" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164628705">Simon Hudon (May 01 2019 at 14:47)</a>:</h4>
<p>Thanks!</p>

<a name="164761769"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164761769" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164761769">James King (May 03 2019 at 02:07)</a>:</h4>
<p>Looks like we're making good progress. We're able to load the shared object into memory and keep a handle; next we'll start adding libffi support and initializing <code>ffi_cif</code> from the Lean annotations</p>

<a name="164761890"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164761890" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164761890">Mario Carneiro (May 03 2019 at 02:09)</a>:</h4>
<p>I think we might be able to avoid the type annotations that Simon showed</p>

<a name="164761900"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164761900" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164761900">Mario Carneiro (May 03 2019 at 02:09)</a>:</h4>
<p>You should be able to derive it from the lean type, i.e. <code>c_int -&gt; c_int -&gt; c_int</code></p>

<a name="164762117"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/164762117" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#164762117">James King (May 03 2019 at 02:14)</a>:</h4>
<p>I'll give that a try.</p>

<a name="165127351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165127351" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165127351">James King (May 08 2019 at 01:56)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Do you have an idea for a Lean declaration that would work?</p>
<div class="codehilite"><pre><span></span>@[ffi &quot;libfile.so&quot;]
constant my_fun : c_int -&gt; c_pointer -&gt; c_void
</pre></div>

<a name="165127373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165127373" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165127373">Mario Carneiro (May 08 2019 at 01:57)</a>:</h4>
<p>On the lean side, I think that would be <code>io c_void</code> but otherwise that seems fine</p>

<a name="165127381"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165127381" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165127381">Mario Carneiro (May 08 2019 at 01:57)</a>:</h4>
<p>Better yet, just use <code>unit</code> instead of defining <code>c_void</code> (and similarly for other types if they exist)</p>

<a name="165127450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165127450" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165127450">James King (May 08 2019 at 01:59)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Good idea, thanks.</p>

<a name="165127514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165127514" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165127514">Mario Carneiro (May 08 2019 at 02:00)</a>:</h4>
<p><span class="user-mention" data-user-id="110026">@Simon Hudon</span> Do you think <code>c_pointer</code> should be a constant or should it be defined to be u64 or whatever</p>

<a name="165127549"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165127549" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165127549">Mario Carneiro (May 08 2019 at 02:01)</a>:</h4>
<p>also I wonder whether we should allow people to define FFI functions that are not in <code>io</code></p>

<a name="165127617"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165127617" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165127617">Mario Carneiro (May 08 2019 at 02:03)</a>:</h4>
<p>It doesn't really make sense for a unit-returning function to not be <code>io</code> but a regular function might be pure</p>

<a name="165127686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165127686" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165127686">James King (May 08 2019 at 02:04)</a>:</h4>
<p>I thought <code>io</code> made sense myself but I think <span class="user-mention" data-user-id="110026">@Simon Hudon</span> had a few insights.</p>

<a name="165127726"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165127726" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165127726">Simon Hudon (May 08 2019 at 02:06)</a>:</h4>
<p>I would make <code>c_pointer</code> into a constant and I would allow non-<code>io</code>-returning functions</p>

<a name="165127772"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165127772" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165127772">Simon Hudon (May 08 2019 at 02:06)</a>:</h4>
<p>We can't check whether <code>io</code> should be required so we just have to trust the writer of the bindings</p>

<a name="165192944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165192944" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165192944">Simon Hudon (May 08 2019 at 19:25)</a>:</h4>
<p><span class="user-mention" data-user-id="220270">@James King</span> </p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> Do you have an idea for a Lean declaration that would work?</p>
<div class="codehilite"><pre><span></span>@[ffi &quot;libfile.so&quot;]
constant my_fun : c_int -&gt; c_pointer -&gt; c_void
</pre></div>


</blockquote>
<p>In passing, I was thinking that the <code>ffi</code> attribute could take a Lean name instead of a file name. That way, if there's any complexity around path resolution, it can be isolated into a single declaration</p>

<a name="165300676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165300676" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165300676">James King (May 10 2019 at 01:00)</a>:</h4>
<p>So...</p>
<div class="codehilite"><pre><span></span>@[ffi &#39;main]
constant my_fun : c_int -&gt; c_pointer -&gt; c_void
</pre></div>


<p>Would be ideal?</p>

<a name="165301037"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301037" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301037">Mario Carneiro (May 10 2019 at 01:10)</a>:</h4>
<p>what does 'main mean?</p>

<a name="165301050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301050" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301050">Mario Carneiro (May 10 2019 at 01:10)</a>:</h4>
<p>also that can probably be just <code>main</code> since we control the parser there</p>

<a name="165301065"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301065" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301065">James King (May 10 2019 at 01:11)</a>:</h4>
<p>We have added a function to the environment that loads the foreign object file and stores the handle in a map</p>

<a name="165301071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301071" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301071">James King (May 10 2019 at 01:11)</a>:</h4>
<p>I was trying to follow along with <span class="user-mention" data-user-id="110026">@Simon Hudon</span> 's suggestion.</p>

<a name="165301073"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301073" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301073">Mario Carneiro (May 10 2019 at 01:11)</a>:</h4>
<p>I see. What does that function look like?</p>

<a name="165301126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301126" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301126">Mario Carneiro (May 10 2019 at 01:12)</a>:</h4>
<p>are these names associated to some definitions or are they in their own namespace?</p>

<a name="165301225"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301225" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301225">James King (May 10 2019 at 01:15)</a>:</h4>
<p><a href="https://github.com/agentultra/lean/blob/feature/vm-dynload/src/library/vm/vm_dynload.h" target="_blank" title="https://github.com/agentultra/lean/blob/feature/vm-dynload/src/library/vm/vm_dynload.h">https://github.com/agentultra/lean/blob/feature/vm-dynload/src/library/vm/vm_dynload.h</a><br>
<a href="https://github.com/agentultra/lean/blob/feature/vm-dynload/src/library/vm/vm_dynload.cpp#L33" target="_blank" title="https://github.com/agentultra/lean/blob/feature/vm-dynload/src/library/vm/vm_dynload.cpp#L33">https://github.com/agentultra/lean/blob/feature/vm-dynload/src/library/vm/vm_dynload.cpp#L33</a><br>
<a href="https://github.com/agentultra/lean/blob/feature/vm-dynload/src/library/vm/vm_environment.cpp#L318" target="_blank" title="https://github.com/agentultra/lean/blob/feature/vm-dynload/src/library/vm/vm_environment.cpp#L318">https://github.com/agentultra/lean/blob/feature/vm-dynload/src/library/vm/vm_environment.cpp#L318</a></p>

<a name="165301279"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301279" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301279">James King (May 10 2019 at 01:16)</a>:</h4>
<p>The foreign symbol stuff will probably go, but we basically load those objects into a map so we can associate the handle with a "Lean name" as <span class="user-mention" data-user-id="110026">@Simon Hudon</span> says</p>

<a name="165301338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301338" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301338">James King (May 10 2019 at 01:18)</a>:</h4>
<p>I'm still pretty new to Lean so forgive my ignorance of the finer points of the language/syntax; it's pretty fun learning about it this way.</p>

<a name="165301633"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301633" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301633">Mario Carneiro (May 10 2019 at 01:26)</a>:</h4>
<p>What does the lean side of this look like?</p>

<a name="165301675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301675" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301675">Mario Carneiro (May 10 2019 at 01:27)</a>:</h4>
<p>I think you're doing a great job btw, I'm just thinking about what the lean user side is</p>

<a name="165301737"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301737" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301737">James King (May 10 2019 at 01:28)</a>:</h4>
<p>see <code>tests/lean/vm_dynload/ffi.lean</code></p>

<a name="165301765"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301765" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301765">James King (May 10 2019 at 01:29)</a>:</h4>
<p>I'm working on changing the bind function to take the argument specs to fill the <code>ffi_cif</code> struct</p>

<a name="165301814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301814" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301814">Mario Carneiro (May 10 2019 at 01:30)</a>:</h4>
<p>Why is <code>bind_foreign_symbol</code> separate from the <code>@[ffi]</code> attribute?</p>

<a name="165301821"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301821" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301821">Mario Carneiro (May 10 2019 at 01:30)</a>:</h4>
<p>is there a reason they wouldn't be 1-1?</p>

<a name="165301826"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301826" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301826">James King (May 10 2019 at 01:30)</a>:</h4>
<p>I think that's where I'm going to change it so that it uses this attribute part, I'm just not sure where to start to hook into that.</p>

<a name="165301980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301980" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301980">Mario Carneiro (May 10 2019 at 01:35)</a>:</h4>
<p>look for uses of <code>register_system_attribute</code> to add a new system attribute</p>

<a name="165301990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165301990" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165301990">James King (May 10 2019 at 01:35)</a>:</h4>
<p>Will do, thanks.</p>

<a name="165304006"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/foreign%20function%20interface/near/165304006" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/69026foreignfunctioninterface.html#165304006">Simon Hudon (May 10 2019 at 02:29)</a>:</h4>
<p>This branch (the last 3 commits) has a lot in common the ffi feature: <a href="https://github.com/leanprover-community/lean/tree/vm_override" target="_blank" title="https://github.com/leanprover-community/lean/tree/vm_override">https://github.com/leanprover-community/lean/tree/vm_override</a></p>
<p>feel free to borrow from it. <span class="user-mention" data-user-id="121918">@Edward Ayers</span> did most of it.</p>


{% endraw %}

{% include archive_update.html %}