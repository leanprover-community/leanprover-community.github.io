---
layout: page
title: Lean Prover Zulip Chat Archive 
permalink: archive/113488general/98841anothertimeout.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html">another timeout</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">
{% raw %}
<a name="165472346"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165472346" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165472346">Kevin Buzzard (May 12 2019 at 16:58)</a>:</h4>
<p>The perfectoid project currently compiles fine, according to Travis, but if I try it in VS Code I get deterministic timeouts! I have traced the issue back to VS Code feeding <code>-T100000</code> to Lean (maximum number of memory allocations per task), but Travis not doing this. </p>
<p>If I have code which is timing out with <code>-T100000</code> does this indicate that something is wrong with the code? Before, we had timeout issues which were fixed by making arbitrary universe changes. Maybe I'll try this now, but in general I am not sure what this means. I've seen my code give typeclass inference errors which could be fixed by changing the max depth, but this is the first time I've seen a timeout issue which could be fixed by changing the parameters.</p>

<a name="165486652"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165486652" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165486652">Scott Morrison (May 12 2019 at 23:32)</a>:</h4>
<p>Oh, I definitely get this when I let tactics go berserk. It's usually solved by splitting things into smaller lemmas.</p>

<a name="165514559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165514559" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165514559">Kevin Buzzard (May 13 2019 at 10:10)</a>:</h4>
<p>I have managed to tame the timeouts but I don't think it's a tactic issue.</p>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">presheaf_map</span> <span class="o">{</span><span class="n">U</span> <span class="n">V</span> <span class="o">:</span> <span class="n">opens</span> <span class="o">(</span><span class="n">spa</span> <span class="n">A</span><span class="o">)}</span> <span class="o">(</span><span class="n">hUV</span> <span class="o">:</span> <span class="n">U</span> <span class="bp">≤</span> <span class="n">V</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">presheaf_value</span> <span class="n">V</span> <span class="bp">→</span> <span class="n">presheaf_value</span> <span class="n">U</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">f</span><span class="o">,</span> <span class="bp">⟨λ</span> <span class="n">rd</span><span class="o">,</span>
<span class="k">let</span> <span class="n">TEMP</span> <span class="o">:=</span> <span class="n">f</span><span class="bp">.</span><span class="n">val</span> <span class="k">in</span> <span class="n">TEMP</span> <span class="bp">⟨</span><span class="n">rd</span><span class="bp">.</span><span class="n">val</span><span class="o">,</span> <span class="n">set</span><span class="bp">.</span><span class="n">subset</span><span class="bp">.</span><span class="n">trans</span> <span class="n">rd</span><span class="bp">.</span><span class="mi">2</span> <span class="n">hUV</span><span class="bp">⟩</span><span class="o">,</span>
<span class="c1">--  f.val ⟨rd.val, set.subset.trans rd.2 hUV⟩, -- this times out with lean -T100000</span>
<span class="bp">λ</span> <span class="n">rd1</span> <span class="n">rd2</span> <span class="n">h</span><span class="o">,</span>
<span class="c1">-- I do not particularly want to go into tactic mode right now</span>
<span class="k">begin</span>
  <span class="k">let</span> <span class="n">TEMP2</span> <span class="o">:=</span> <span class="n">f</span><span class="bp">.</span><span class="mi">2</span> <span class="o">(</span><span class="n">rational_open_data_subsets</span><span class="bp">.</span><span class="n">map</span> <span class="n">hUV</span> <span class="n">rd1</span><span class="o">)</span>
    <span class="o">(</span><span class="n">rational_open_data_subsets</span><span class="bp">.</span><span class="n">map</span> <span class="n">hUV</span> <span class="n">rd2</span><span class="o">)</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">TEMP2</span><span class="o">,</span>
  <span class="c1">-- exact f.2 (rational_open_data... times out</span>
  <span class="c1">-- convert f.2 (rational_open_data... works</span>
<span class="kn">end</span><span class="bp">⟩</span>
</pre></div>


<p>This should be a purely term mode proof. The first problem is that <code> f.val ⟨rd.val, set.subset.trans rd.2 hUV⟩</code> times out when applied directly; this <code>let</code> hack fixes the first timeout. The second timeout I solve in tactic mode (it's a prop) but it's the same story; a term should work, but <code>exact</code> fails and it's only <code>convert</code> or the <code>let</code> which save us. A <code>convert</code> can be used with the first timeout too, but this causes errors later in the file for some reason.</p>
<p>I would like to debug this further. I do not know what is going on at all. If this is happening because we have written bad code then I'd like to write better code but I don't know which code is bad. If this is happening because of some other reason I'd still  like to know what is going on. I feel a bit helpless at the minute; I have no understanding why the first <code>let</code> changes anything. <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> can either of you make some educated guesses about what is happening?</p>
<p>A completely compiled version of the perfectoid project, all the olean files, with current mathlib master, is available here:</p>
<p><a href="http://wwwf.imperial.ac.uk/~buzzard/xena/perfectoid_20190513.tar" target="_blank" title="http://wwwf.imperial.ac.uk/~buzzard/xena/perfectoid_20190513.tar">wwwf.imperial.ac.uk/~buzzard/xena/perfectoid_20190513.tar</a></p>
<p>If you download this, and run <code>lean --make</code> in <code>src</code> the command returns very quickly with no output. The project is all compiled and all fine. Now open it in VS Code and in <code>src/Spa.lean</code> on line 720 there is a timeout, which can be fixed by changing -T100000 to a higher value in VS Code settings. Lean is working far too hard to compile this lemma. Changing <code>f.val ⟨rd.val, set.subset.trans rd.2 hUV⟩, </code> to <code>let TEMP := f.val in TEMP ⟨rd.val, set.subset.trans rd.2 hUV⟩,</code> fixes everything.</p>

<a name="165514653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165514653" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165514653">Mario Carneiro (May 13 2019 at 10:12)</a>:</h4>
<p>what is the type of <code>TEMP</code>?</p>

<a name="165514669"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165514669" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165514669">Mario Carneiro (May 13 2019 at 10:12)</a>:</h4>
<p>and <code>f</code> and <code>⟨rd.val, set.subset.trans rd.2 hUV⟩</code></p>

<a name="165515200"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165515200" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165515200">Mario Carneiro (May 13 2019 at 10:21)</a>:</h4>
<p>Here's a working term mode proof:</p>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">presheaf_map</span> <span class="o">{</span><span class="n">U</span> <span class="n">V</span> <span class="o">:</span> <span class="n">opens</span> <span class="o">(</span><span class="n">spa</span> <span class="n">A</span><span class="o">)}</span> <span class="o">(</span><span class="n">hUV</span> <span class="o">:</span> <span class="n">U</span> <span class="bp">≤</span> <span class="n">V</span><span class="o">)</span>
  <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">presheaf_value</span> <span class="n">V</span><span class="o">)</span> <span class="o">:</span> <span class="n">presheaf_value</span> <span class="n">U</span> <span class="o">:=</span>
<span class="bp">⟨_</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">rd1</span> <span class="n">rd2</span> <span class="n">h</span><span class="o">,</span>
  <span class="o">(</span><span class="n">f</span><span class="bp">.</span><span class="mi">2</span> <span class="o">(</span><span class="n">rational_open_data_subsets</span><span class="bp">.</span><span class="n">map</span> <span class="n">hUV</span> <span class="n">rd1</span><span class="o">)</span>
    <span class="o">(</span><span class="n">rational_open_data_subsets</span><span class="bp">.</span><span class="n">map</span> <span class="n">hUV</span> <span class="n">rd2</span><span class="o">)</span> <span class="n">h</span> <span class="o">:</span> <span class="bp">_</span><span class="o">)</span><span class="bp">⟩</span>
</pre></div>

<a name="165515549"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165515549" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165515549">Kevin Buzzard (May 13 2019 at 10:27)</a>:</h4>
<p>But what's going on? How is (blah : _) any different to blah?</p>

<a name="165515674"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165515674" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165515674">Kevin Buzzard (May 13 2019 at 10:29)</a>:</h4>
<p>This is my actual question. Is the point that your code is somehow better than my code in some intrinsic way -- I should never have written my code the way I wrote it? Or is the problem that I have made some ghastly types and the fact that they're difficult to manipulate is my fault and something should be changed? Or is the problem that Lean is not very good at something and you know how to work around the deficiency? What is actually happening?</p>

<a name="165515681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165515681" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165515681">Mario Carneiro (May 13 2019 at 10:29)</a>:</h4>
<p><code>(blah : _)</code> says "ignore the expected type here, figure out the type of blah first and then unify with the goal"</p>

<a name="165515702"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165515702" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165515702">Kevin Buzzard (May 13 2019 at 10:29)</a>:</h4>
<p>But doesn't <code>(blah)</code> also say that?</p>

<a name="165515774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165515774" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165515774">Mario Carneiro (May 13 2019 at 10:30)</a>:</h4>
<p><code>blah</code> says "use the expected type to elaborate <code>blah</code>"</p>

<a name="165515798"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165515798" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165515798">Mario Carneiro (May 13 2019 at 10:30)</a>:</h4>
<p>usually this is a good thing, but occasionally it gives a bad result</p>

<a name="165515828"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165515828" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165515828">Kevin Buzzard (May 13 2019 at 10:31)</a>:</h4>
<p>Aah. So the elaboration process of a term usually takes the type of this term into account, and this is a workaround to stop it doing this?</p>

<a name="165515858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165515858" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165515858">Kevin Buzzard (May 13 2019 at 10:32)</a>:</h4>
<p>Running Lean with -T200000 succeeds, by the way -- so everything is consistent; this is just, for some reason, a way of making Lean succeed quicker.</p>

<a name="165515926"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165515926" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165515926">Mario Carneiro (May 13 2019 at 10:32)</a>:</h4>
<p>I think I figured out the problem (and I guess you could class it as "lean is not very good at something"). If I start with</p>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">presheaf_map</span> <span class="o">{</span><span class="n">U</span> <span class="n">V</span> <span class="o">:</span> <span class="n">opens</span> <span class="o">(</span><span class="n">spa</span> <span class="n">A</span><span class="o">)}</span> <span class="o">(</span><span class="n">hUV</span> <span class="o">:</span> <span class="n">U</span> <span class="bp">≤</span> <span class="n">V</span><span class="o">)</span>
  <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">presheaf_value</span> <span class="n">V</span><span class="o">)</span> <span class="o">:</span> <span class="n">presheaf_value</span> <span class="n">U</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="bp">⟨λ</span> <span class="n">rd</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span>
  <span class="k">have</span> <span class="o">:=</span> <span class="n">f</span><span class="bp">.</span><span class="n">val</span><span class="o">,</span>
<span class="kn">end</span>
</pre></div>


<p>I see that the goal has type <code>r_o_d_completion (rd.val)</code>, and the <code>have</code> has type <code>Π (rd : rational_open_data_subsets V), r_o_d_completion (rd.val)</code>. The obvious solution is to plug <code>rd</code> into <code>f.val</code> but this doesn't work because <code>rd : rational_open_data_subsets U</code> instead</p>

<a name="165515965"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165515965" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165515965">Kevin Buzzard (May 13 2019 at 10:33)</a>:</h4>
<p>I am deeply sorry about <code>r_o_d_completion</code> by the way. I got sick of typing <code>rational_open_data</code>. It's on my job list to change it to something more sensible.</p>

<a name="165516047"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516047" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516047">Mario Carneiro (May 13 2019 at 10:35)</a>:</h4>
<p>But the problem is that when you use <code>refine f.val _</code> here lean thinks "okay, let's make <code>r_o_d_completion (rd.val) =?= r_o_d_completion (?m.val)</code>. I know, let's try to make all the arguments to <code>r_o_d_completion</code> the same and <code>rd =?= ?m</code>. So I have to prove <code>rational_open_data_subsets U =?= rational_open_data_subsets V</code>." Lean then gets lost unfolding your tower of definitions, hoping that U doesn't actually appear in the definition so that <code>rational_open_data_subsets U</code> is defeq to <code>rational_open_data_subsets V</code></p>

<a name="165516049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516049" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516049">Kevin Buzzard (May 13 2019 at 10:35)</a>:</h4>
<blockquote>
<p>but this doesn't work because <code>rd : rational_open_data_subsets U</code> instead</p>
</blockquote>
<p>Right, that's what all the <code>set.subset.trans rd.2 hUV</code> is about.</p>

<a name="165516117"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516117" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516117">Kevin Buzzard (May 13 2019 at 10:36)</a>:</h4>
<p>Oh you have maybe completely debugged this. Many thanks as ever! Did you use some trace tools or was this just pure thought? I think it is worth my while thinking about what you're saying here. This is a trick I don't know yet.</p>

<a name="165516133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516133" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516133">Mario Carneiro (May 13 2019 at 10:36)</a>:</h4>
<p>This is often the place where the <code>:_</code> trick works</p>

<a name="165516170"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516170" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516170">Mario Carneiro (May 13 2019 at 10:37)</a>:</h4>
<p>I usually see this when you use <code>congr_arg</code>, which is another place where the heuristic <code>f x =?= g y =&gt; f =?= g /\ x =?= y</code> leads lean astray</p>

<a name="165516342"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516342" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516342">Kevin Buzzard (May 13 2019 at 10:40)</a>:</h4>
<p>I knew the maths I was formalising in the project (although as Patrick pointed out I didn't know all of the details in several places), but the timeouts were scary.  Before we finished the project I was sometimes thinking "you know, Lean actually can't do this can it". I've been forced to wrestle with several timeouts.</p>

<a name="165516355"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516355" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516355">Kevin Buzzard (May 13 2019 at 10:40)</a>:</h4>
<p>But Lean always came through in the end, although the solutions were a bit random.</p>

<a name="165516378"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516378" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516378">Kevin Buzzard (May 13 2019 at 10:41)</a>:</h4>
<p>On line 744 of <code>src/valuation/field.lean</code> if you change <code>Type u</code> to <code>Type*</code> then Lean times out. That was the worst one. I have no idea why.</p>

<a name="165516627"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516627" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516627">Mario Carneiro (May 13 2019 at 10:44)</a>:</h4>
<p>For that one, I tried</p>

<a name="165516646"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516646" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516646">Mario Carneiro (May 13 2019 at 10:45)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">begin</span>
  <span class="n">refine</span> <span class="n">valuation</span><span class="bp">.</span><span class="n">completion_extend</span> <span class="bp">_</span><span class="o">,</span>
  <span class="c1">-- try_for 10000 {</span>
  <span class="c1">--   exact valuation.completion_extend (valuation_field.canonical_valuation v)</span>
  <span class="c1">-- }</span>
<span class="kn">end</span>
</pre></div>


<p>and it says</p>
<div class="codehilite"><pre><span></span><span class="n">invalid</span> <span class="n">type</span> <span class="n">ascription</span><span class="o">,</span> <span class="n">term</span> <span class="n">has</span> <span class="n">type</span>
  <span class="n">valuation</span> <span class="o">(</span><span class="n">ring_completion</span> <span class="o">(</span><span class="n">valued_ring</span> <span class="err">?</span><span class="n">m_3</span> <span class="err">?</span><span class="n">m_5</span><span class="o">))</span> <span class="err">?</span><span class="n">m_1</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">(</span><span class="n">max</span> <span class="err">?</span> <span class="err">?</span><span class="o">)</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="n">valuation</span> <span class="o">(</span><span class="n">ring_completion</span> <span class="o">(</span><span class="n">valuation_field</span> <span class="n">v</span><span class="o">))</span> <span class="o">(</span><span class="n">value_group</span> <span class="n">v</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="err">?</span>
</pre></div>

<a name="165516681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516681" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516681">Mario Carneiro (May 13 2019 at 10:45)</a>:</h4>
<p>what is the relation between <code>valuation_field</code> and <code>valued_ring</code>?</p>

<a name="165516897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165516897" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165516897">Mario Carneiro (May 13 2019 at 10:48)</a>:</h4>
<p>I see, <code>valued_ring</code> is a wrapper. This is not being very nice to lean, it has no idea what to unwrap here. I'm guessing <code>valuation_field</code> is much more complicated, so lean's heuristics say to unfold the more complicated one and it gets lost</p>

<a name="165517102"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517102" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517102">Kevin Buzzard (May 13 2019 at 10:52)</a>:</h4>
<p>That wrapper caused us problems.</p>

<a name="165517120"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517120" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517120">Kevin Buzzard (May 13 2019 at 10:53)</a>:</h4>
<p>It's funny that changing the universe made it work though.</p>

<a name="165517212"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517212" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517212">Kevin Buzzard (May 13 2019 at 10:55)</a>:</h4>
<p>In fact even <code>with_zero</code> caused us problems (a wrapper for <code>option</code>) -- we used <code>with_zero</code> a lot and at some point we seriously considered redefining it by just copying some <code>option</code> code; the <code>option</code> kept leaking out.</p>

<a name="165517221"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517221" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517221">Mario Carneiro (May 13 2019 at 10:55)</a>:</h4>
<p>have you tried printing the definition? It makes me weep to see</p>

<a name="165517225"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517225" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517225">Kevin Buzzard (May 13 2019 at 10:55)</a>:</h4>
<p>The definition of what?</p>

<a name="165517276"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517276" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517276">Mario Carneiro (May 13 2019 at 10:56)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">noncomputable</span> <span class="n">def</span> <span class="n">valuation_on_completion</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">valuation</span> <span class="n">R</span> <span class="err">Γ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">valuation</span>
    <span class="o">(</span><span class="n">ring_completion</span>
      <span class="o">(</span><span class="n">valuation</span><span class="bp">.</span><span class="n">valuation_field</span> <span class="n">v</span><span class="o">))</span>
    <span class="o">(</span><span class="n">value_group</span> <span class="n">v</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">valuation</span><span class="bp">.</span><span class="n">completion_extend</span> <span class="o">(</span><span class="n">valuation_field</span><span class="bp">.</span><span class="n">canonical_valuation</span> <span class="n">v</span><span class="o">)</span>

<span class="kn">set_option</span> <span class="n">pp</span><span class="bp">.</span><span class="n">all</span> <span class="n">true</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">valuation_on_completion</span>
</pre></div>

<a name="165517286"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517286" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517286">Mario Carneiro (May 13 2019 at 10:56)</a>:</h4>
<p>oh, actually that's not so bad</p>

<a name="165517300"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517300" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517300">Mario Carneiro (May 13 2019 at 10:57)</a>:</h4>
<p>this version looks much worse</p>
<div class="codehilite"><pre><span></span><span class="k">begin</span>
  <span class="k">have</span> <span class="o">:=</span> <span class="n">valuation</span><span class="bp">.</span><span class="n">completion_extend</span> <span class="o">(</span><span class="n">valuation_field</span><span class="bp">.</span><span class="n">canonical_valuation</span> <span class="n">v</span><span class="o">),</span>
  <span class="n">dunfold</span> <span class="n">valued_ring</span> <span class="n">at</span> <span class="n">this</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">this</span>
<span class="kn">end</span>
</pre></div>

<a name="165517320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517320" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517320">Mario Carneiro (May 13 2019 at 10:57)</a>:</h4>
<p>I need a deduplicating pp printer</p>

<a name="165517366"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517366" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517366">Kevin Buzzard (May 13 2019 at 10:58)</a>:</h4>
<p>I don't really understand what you're saying.</p>

<a name="165517373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517373" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517373">Mario Carneiro (May 13 2019 at 10:58)</a>:</h4>
<p>These printouts always make expressions look worse than they are</p>

<a name="165517377"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517377" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517377">Kevin Buzzard (May 13 2019 at 10:58)</a>:</h4>
<p>We just typed in normal maths</p>

<a name="165517387"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517387" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517387">Mario Carneiro (May 13 2019 at 10:58)</a>:</h4>
<p>but if expressions are much much worse under the hood than they appear then that's a bad sign</p>

<a name="165517400"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517400" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517400">Mario Carneiro (May 13 2019 at 10:59)</a>:</h4>
<p>and stuff like timeouts is just the symptom</p>

<a name="165517421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517421" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517421">Mario Carneiro (May 13 2019 at 10:59)</a>:</h4>
<p>the moral of the story is "don't make lean work too hard"</p>

<a name="165517445"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517445" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517445">Mario Carneiro (May 13 2019 at 11:00)</a>:</h4>
<p>sometimes you accidentally ask lean to do something silly and then you get a timeout for no reason</p>

<a name="165517535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517535" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517535">Kevin Buzzard (May 13 2019 at 11:01)</a>:</h4>
<p>We're just extending a valuation on a ring to a valuation on its completion. What's not to like?</p>

<a name="165517604"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517604" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517604">Kevin Buzzard (May 13 2019 at 11:02)</a>:</h4>
<p>You're saying we should be looking at our terms to see if any of them are getting suspiciously large?</p>

<a name="165517614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517614" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517614">Kevin Buzzard (May 13 2019 at 11:02)</a>:</h4>
<p>But what can we do to stop this happening?</p>

<a name="165517646"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517646" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517646">Kevin Buzzard (May 13 2019 at 11:03)</a>:</h4>
<p>You shouldn't have unfolded our wrapper!</p>

<a name="165517730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517730" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517730">Mario Carneiro (May 13 2019 at 11:04)</a>:</h4>
<p>The reason this happened was the first error message I posted:</p>
<div class="codehilite"><pre><span></span><span class="n">invalid</span> <span class="n">type</span> <span class="n">ascription</span><span class="o">,</span> <span class="n">term</span> <span class="n">has</span> <span class="n">type</span>
  <span class="n">valuation</span> <span class="o">(</span><span class="n">ring_completion</span> <span class="o">(</span><span class="n">valued_ring</span> <span class="err">?</span><span class="n">m_3</span> <span class="err">?</span><span class="n">m_5</span><span class="o">))</span> <span class="err">?</span><span class="n">m_1</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">(</span><span class="n">max</span> <span class="err">?</span> <span class="err">?</span><span class="o">)</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="n">valuation</span> <span class="o">(</span><span class="n">ring_completion</span> <span class="o">(</span><span class="n">valuation_field</span> <span class="n">v</span><span class="o">))</span> <span class="o">(</span><span class="n">value_group</span> <span class="n">v</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="err">?</span>
</pre></div>


<p>I think the problem is not actually <code>valued_ring</code> itself but all the instances on it</p>

<a name="165517761"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517761" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517761">Mario Carneiro (May 13 2019 at 11:05)</a>:</h4>
<p><code>valuation_field</code> has a bunch of instances, and <code>valued_ring</code> has different instances, and a lot of unfolding needs to happen to see they are the same</p>

<a name="165517850"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517850" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517850">Mario Carneiro (May 13 2019 at 11:06)</a>:</h4>
<p>Why are you applying a theorem which isn't obviously applicable?</p>

<a name="165517877"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517877" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517877">Mario Carneiro (May 13 2019 at 11:07)</a>:</h4>
<p>what's the logic here? How does the stuff on <code>valuation_field</code> relate to <code>valued_ring</code>?</p>

<a name="165517972"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165517972" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165517972">Johan Commelin (May 13 2019 at 11:08)</a>:</h4>
<p>A valued ring is a ring together with a valuation. This valuation induces a topology, etc...</p>
<p>A valuation field is a particular example.</p>

<a name="165518015"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165518015" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165518015">Mario Carneiro (May 13 2019 at 11:09)</a>:</h4>
<p>maybe you need a typeclass for that</p>

<a name="165518020"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165518020" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165518020">Mario Carneiro (May 13 2019 at 11:09)</a>:</h4>
<p>rather than a type constructor</p>

<a name="165518142"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165518142" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165518142">Mario Carneiro (May 13 2019 at 11:11)</a>:</h4>
<p>i.e. <code>valued_ring R v</code> is a prop assertion that says that a topological ring is generated by a valuation</p>

<a name="165518216"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165518216" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165518216">Mario Carneiro (May 13 2019 at 11:12)</a>:</h4>
<p>that way you can assert that <code>valuation_field</code> is a valued ring, even though it isn't literally constructed as "adjoin this valuation to the ring"</p>

<a name="165518236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165518236" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165518236">Mario Carneiro (May 13 2019 at 11:13)</a>:</h4>
<p>aka stricklandize it</p>

<a name="165518241"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165518241" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165518241">Johan Commelin (May 13 2019 at 11:13)</a>:</h4>
<p>Or we change it to <code>valued_ring.mk</code>? And we have class</p>
<div class="codehilite"><pre><span></span><span class="n">class</span> <span class="n">valued_ring</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">valuation</span> <span class="n">R</span> <span class="err">Γ</span><span class="o">)</span>
</pre></div>

<a name="165518255"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165518255" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165518255">Mario Carneiro (May 13 2019 at 11:13)</a>:</h4>
<p>I was going to say that, and then I realized that the gamma will give you problems</p>

<a name="165519572"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165519572" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165519572">Kevin Buzzard (May 13 2019 at 11:36)</a>:</h4>
<p>Sorry, my exam just finished and I had to pick up several hundred pieces of paper</p>

<a name="165519699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165519699" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165519699">Kevin Buzzard (May 13 2019 at 11:38)</a>:</h4>
<p>With a random ring R there are lots of valuations, so lots of topologies. But given a valuation v we wanted a topology on R so we went with a wrapper because topological_space is a class I guess.</p>

<a name="165519806"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165519806" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165519806">Kevin Buzzard (May 13 2019 at 11:40)</a>:</h4>
<div class="codehilite"><pre><span></span>invalid type ascription, term has type
  valuation (ring_completion (valued_ring ?m_3 ?m_5)) ?m_1 : Type (max ? ?)
but is expected to have type
  valuation (ring_completion (valuation_field v)) (value_group v) : Type ?
</pre></div>


<p><code>valued_ring ?m_3 ?m_5</code> is just by definition <code>?m_3</code> but this is all about topology, and I can't put a topology on <code>?m_3</code> because it depends on <code>?m_5</code></p>

<a name="165519885"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165519885" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165519885">Kevin Buzzard (May 13 2019 at 11:42)</a>:</h4>
<p>We mathematicians need to learn the right way to think about this stuff.</p>

<a name="165519900"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165519900" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165519900">Johan Commelin (May 13 2019 at 11:42)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Can you formulate a general principal here? Why is <code>valued_ring</code> a bad type wrapper, but <code>multiplicative</code> a good one?</p>

<a name="165519923"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165519923" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165519923">Kevin Buzzard (May 13 2019 at 11:43)</a>:</h4>
<blockquote>
<p>but if expressions are much much worse under the hood than they appear then that's a bad sign</p>
</blockquote>
<p>Do you mean "much worse after you've unfolded absolutely everything" or something else?</p>

<a name="165519949"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165519949" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165519949">Mario Carneiro (May 13 2019 at 11:43)</a>:</h4>
<p>I mean much worse explicitly, before any unfolding</p>

<a name="165519954"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165519954" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165519954">Mario Carneiro (May 13 2019 at 11:43)</a>:</h4>
<p>or after any unfolding that needs to be done in the moment</p>

<a name="165520051"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520051" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520051">Kevin Buzzard (May 13 2019 at 11:45)</a>:</h4>
<p>like unfolding <code>valued_ring</code>.</p>

<a name="165520124"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520124" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520124">Mario Carneiro (May 13 2019 at 11:45)</a>:</h4>
<p><code>valued_ring</code> is not a bad type wrapper, but it's not sufficient for all things. In particular, this is the same problem we've seen before with <code>localization</code>. Sometimes you want to perform the construction, and sometimes you want to say that an independently constructed type is isomorphic to the construction</p>

<a name="165520182"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520182" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520182">Mario Carneiro (May 13 2019 at 11:46)</a>:</h4>
<p><code>quotient</code> is another example of this</p>

<a name="165520194"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520194" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520194">Mario Carneiro (May 13 2019 at 11:46)</a>:</h4>
<p>It doesn't apply if the type isn't actually <code>quotient bla</code></p>

<a name="165520236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520236" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520236">Kevin Buzzard (May 13 2019 at 11:47)</a>:</h4>
<blockquote>
<p>I was going to say that, and then I realized that the gamma will give you problems</p>
</blockquote>
<p>Because of universe issues or because we just need to input it directly with</p>
<div class="codehilite"><pre><span></span><span class="n">class</span> <span class="n">valued_ring</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:=</span>
<span class="o">(</span><span class="err">Γ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span>
<span class="o">[</span><span class="n">totally_ordered_group</span> <span class="err">Γ</span><span class="o">]</span> <span class="c1">-- or whatever we called it</span>
<span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">valuation</span> <span class="n">R</span> <span class="err">Γ</span><span class="o">)</span>
</pre></div>

<a name="165520237"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520237" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520237">Mario Carneiro (May 13 2019 at 11:47)</a>:</h4>
<p>In this case you have <code>valued_ring R v</code>, the construction, and you want to apply it to <code>valuation_field v</code>, which after unfolding is <em>not</em> defined as <code>valued_ring bla bla</code></p>

<a name="165520310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520310" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520310">Kevin Buzzard (May 13 2019 at 11:48)</a>:</h4>
<p>There's something a bit wrong. Those v's are perhaps not the same.</p>

<a name="165520323"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520323" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520323">Kevin Buzzard (May 13 2019 at 11:48)</a>:</h4>
<p><code>valuation_field v</code> has got a valuation on it but it's not <code>v</code></p>

<a name="165520335"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520335" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520335">Mario Carneiro (May 13 2019 at 11:48)</a>:</h4>
<p>right, I'm not saying they are</p>

<a name="165520336"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520336" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520336">Kevin Buzzard (May 13 2019 at 11:48)</a>:</h4>
<p>Oh Ok</p>

<a name="165520344"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520344" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520344">Kevin Buzzard (May 13 2019 at 11:49)</a>:</h4>
<p>No, you're supposed to be unfolding valued_ring here, not valuation_field</p>

<a name="165520357"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520357" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520357">Mario Carneiro (May 13 2019 at 11:49)</a>:</h4>
<p>I'm saying that <code>valuation_field v =?= valued_ring ?m1 ?m2</code> doesn't have a solution by unfolding <code>valuation_field</code></p>

<a name="165520367"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520367" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520367">Kevin Buzzard (May 13 2019 at 11:49)</a>:</h4>
<p>Right!</p>

<a name="165520370"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520370" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520370">Kevin Buzzard (May 13 2019 at 11:49)</a>:</h4>
<p>Unfold the other one.</p>

<a name="165520374"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520374" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520374">Mario Carneiro (May 13 2019 at 11:49)</a>:</h4>
<p>Even if you unfold <code>valued_ring</code> here, it doesn't solve the problem of all the instances</p>

<a name="165520441"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520441" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520441">Kevin Buzzard (May 13 2019 at 11:50)</a>:</h4>
<p>I think that you're saying that if we're going to use a wrapper type, then we must be very careful to wrap everything up.</p>

<a name="165520449"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520449" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520449">Mario Carneiro (May 13 2019 at 11:50)</a>:</h4>
<p><code>valued_ring</code> has a bunch of instances on it, a uniform structure and so on - does <code>valuation_field v</code> have the same structure?</p>

<a name="165520457"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520457" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520457">Kevin Buzzard (May 13 2019 at 11:50)</a>:</h4>
<p>No</p>

<a name="165520461"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520461" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520461">Mario Carneiro (May 13 2019 at 11:50)</a>:</h4>
<p>then you shouldn't apply this theorem</p>

<a name="165520462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520462" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520462">Kevin Buzzard (May 13 2019 at 11:50)</a>:</h4>
<p>Hmm...we could put those structures on it.</p>

<a name="165520507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520507" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520507">Kevin Buzzard (May 13 2019 at 11:51)</a>:</h4>
<p>We wrote the wrapper because for a general ring R and a general valuation v, we definitely don't want R to inherit the uniform structure from v, because often R will be fixed and v will change</p>

<a name="165520517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520517" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520517">Mario Carneiro (May 13 2019 at 11:51)</a>:</h4>
<p>My guess is you want to prove <code>is_valued_ring (valuation_field v) (valuation_field.canonical_valuation v)</code></p>

<a name="165520572"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520572" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520572">Kevin Buzzard (May 13 2019 at 11:52)</a>:</h4>
<p><code>valuation_field v</code> is exactly the point where we've manipulated the ring so much that now we'll never put another valuation on it.</p>

<a name="165520579"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520579" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520579">Kevin Buzzard (May 13 2019 at 11:52)</a>:</h4>
<p>None of this conversation is about mathematics, in some sense.</p>

<a name="165520585"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520585" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520585">Mario Carneiro (May 13 2019 at 11:52)</a>:</h4>
<p>It's proof engineering stuff</p>

<a name="165520587"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520587" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520587">Kevin Buzzard (May 13 2019 at 11:52)</a>:</h4>
<p>So I'm a beginner here.</p>

<a name="165520591"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520591" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520591">Kevin Buzzard (May 13 2019 at 11:52)</a>:</h4>
<p>Yes exactly.</p>

<a name="165520629"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520629" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520629">Mario Carneiro (May 13 2019 at 11:53)</a>:</h4>
<p>You can have <code>valued_ring R v</code> as before, and prove <code>is_valued_ring (valued_ring R v) v</code></p>

<a name="165520710"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520710" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520710">Kevin Buzzard (May 13 2019 at 11:54)</a>:</h4>
<p>So we keep the wrapper?</p>

<a name="165520712"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520712" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520712">Mario Carneiro (May 13 2019 at 11:54)</a>:</h4>
<p>and then <code>completion_extend</code> has the type <code>valuation (ring_completion K) Γ </code> where <code>is_valued_ring K v</code></p>

<a name="165520737"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520737" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520737">Mario Carneiro (May 13 2019 at 11:54)</a>:</h4>
<p>I don't know if you need the wrapper, but I imagine that sometimes you just have a ring and need to put a valuation on it</p>

<a name="165520771"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520771" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520771">Mario Carneiro (May 13 2019 at 11:55)</a>:</h4>
<p>rather than asserting that a pre-existing topological ring is generated by a valuation</p>

<a name="165520781"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520781" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520781">Kevin Buzzard (May 13 2019 at 11:55)</a>:</h4>
<p>That's right.</p>

<a name="165520788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520788" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520788">Mario Carneiro (May 13 2019 at 11:55)</a>:</h4>
<p>so you want both</p>

<a name="165520815"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520815" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520815">Kevin Buzzard (May 13 2019 at 11:55)</a>:</h4>
<p>In fact I think that always we just have the ring and need to put a topology on it coming from a valuation.</p>

<a name="165520876"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520876" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520876">Kevin Buzzard (May 13 2019 at 11:56)</a>:</h4>
<p>That's why we used a wrapper -- because the valuation can vary, but topological_space is a class.</p>

<a name="165520886"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520886" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520886">Mario Carneiro (May 13 2019 at 11:56)</a>:</h4>
<p>I think that's what you thought originally and that's why the code looks like it does, but it turns out not to be the case</p>

<a name="165520893"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520893" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520893">Mario Carneiro (May 13 2019 at 11:56)</a>:</h4>
<p>because <code>valuation_field</code> is clearly not of that form</p>

<a name="165520902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520902" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520902">Johan Commelin (May 13 2019 at 11:56)</a>:</h4>
<p>It is of that form mathematically</p>

<a name="165520907"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520907" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520907">Johan Commelin (May 13 2019 at 11:56)</a>:</h4>
<p>But not Lean-ny</p>

<a name="165520915"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520915" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520915">Kevin Buzzard (May 13 2019 at 11:57)</a>:</h4>
<p>valuation_field was a field that didn't have a valuation for most of the projects, and then I realised far too late (because I never wrote a proper roadmap) that we needed a topology on it.</p>

<a name="165520931"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520931" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520931">Mario Carneiro (May 13 2019 at 11:57)</a>:</h4>
<p>and that's what <code>is_valued_ring</code> is for, to say "this ring is generated by this valuation"</p>

<a name="165520956"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165520956" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165520956">Mario Carneiro (May 13 2019 at 11:57)</a>:</h4>
<p>You might also consider writing <code>valuation_field</code> so it has the form <code>valued_ring bla bla</code>, but that will affect other things</p>

<a name="165521005"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165521005" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165521005">Kevin Buzzard (May 13 2019 at 11:58)</a>:</h4>
<p>Then Patrick found the part of Bourbaki that did what we wanted, and worked in what a library-builder would say was the correct generality: given a valuation on a ring, the ring gets a topology, and the valuation extends to the completion of the ring.</p>

<a name="165521020"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165521020" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165521020">Johan Commelin (May 13 2019 at 11:58)</a>:</h4>
<p>I guess an alternative would be to rename <code>valuation_field</code> to <code>valuation_field.aux</code> and then define <code>valuation_field</code> as <code>valued_ring (valuation_field_aux _) _</code></p>

<a name="165521066"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165521066" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165521066">Mario Carneiro (May 13 2019 at 11:59)</a>:</h4>
<p>I thought about that too, but there are some nontrivial theorems here about how the topological ring structure is preserved</p>

<a name="165521068"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165521068" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165521068">Johan Commelin (May 13 2019 at 11:59)</a>:</h4>
<p>But I guess that Mario is saying that the predicate approach is better (because more flexible?)</p>

<a name="165521071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165521071" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165521071">Kevin Buzzard (May 13 2019 at 11:59)</a>:</h4>
<p>I suspect that the only time we ever apply the valued_ring stuff is to <code>valuation_field v</code> (which is a field), however there were a bunch of general theorems about the topology on a ring induced by a valuation in Bourbaki and Patrick formalised those.</p>

<a name="165521090"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165521090" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165521090">Mario Carneiro (May 13 2019 at 11:59)</a>:</h4>
<p>the predicate approach means that the instances are not impacted - they are just the <code>valuation_field</code> instances</p>

<a name="165521163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165521163" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165521163">Kevin Buzzard (May 13 2019 at 12:00)</a>:</h4>
<p>So Patrick was faced with the dilemma of having a ring R, and a valuation v on R, and he wanted to talk about the induced topology on R. So the wrapper was born.</p>

<a name="165521193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165521193" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165521193">Kevin Buzzard (May 13 2019 at 12:00)</a>:</h4>
<p>This was almost certainly the correct generality for Bourbaki. But in retrospect it was more than we needed for our application.</p>

<a name="165521751"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another%20timeout/near/165521751" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/98841anothertimeout.html#165521751">Kevin Buzzard (May 13 2019 at 12:09)</a>:</h4>
<p>Thanks for all these comments. I'll digest them slowly.</p>


{% endraw %}
