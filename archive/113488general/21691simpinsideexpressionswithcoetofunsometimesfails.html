---
layout: archive
title: Lean Prover Zulip Chat Archive 
permalink: archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html">simp inside expressions with coe_to_fun sometimes fails</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">
{% raw %}
<a name="130948850"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130948850" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130948850">Scott Morrison (Aug 05 2018 at 23:57)</a>:</h4>
<p>I've been trying to implement <span class="user-mention" data-user-id="110294">@Johannes Hölzl</span> request that in my baby PR for category theory I use coercions to allow applying a functor to an object, as <code>F X</code>, rather than having to either write explicitly <code>F.onObjects X</code>, or introduce some awkward notation, such as <code>F +&gt; X</code>.</p>

<a name="130948858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130948858" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130948858">Scott Morrison (Aug 05 2018 at 23:57)</a>:</h4>
<p>I would very much like to do this, but I also want to be confident that this doesn't mess up the nice and easy automation I have throughout my category theory library.</p>

<a name="130948897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130948897" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130948897">Scott Morrison (Aug 05 2018 at 23:58)</a>:</h4>
<p>Unfortunately, I seem to have run into a problem, which is a strange interaction between coercions and the simplifier.</p>

<a name="130948901"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130948901" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130948901">Scott Morrison (Aug 05 2018 at 23:58)</a>:</h4>
<p>Hopefully someone here will explain how to get around this! I fear that the fix would require tweaking the simplifier, which is out of bounds at the moment.</p>

<a name="130948911"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130948911" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130948911">Scott Morrison (Aug 05 2018 at 23:59)</a>:</h4>
<p>In any case, here is a self-contained piece of code, containing some very cut down definitions from the category theory library, that demonstrates the problem.</p>

<a name="130948964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130948964" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130948964">Scott Morrison (Aug 06 2018 at 00:00)</a>:</h4>
<p>Essentially, it is that <code>simp</code> sometimes can't rewrite under a coercion, because it can't build the proof terms (in particular, it can't build some <code>congr_arg</code> terms, because of a type checking subtlety).</p>

<a name="130948985"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130948985" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130948985">Scott Morrison (Aug 06 2018 at 00:01)</a>:</h4>
<p>This has the result that in order to be able to use <code>simp</code> successfully, I'll have to provide two versions of many lemmas: one for use by humans, that refer to the coercions, and one for use by <code>simp</code> (after applying <code>unfold_coes</code> to unfold all the coercions), that don't refer to the coercions.</p>

<a name="130948986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130948986" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130948986">Scott Morrison (Aug 06 2018 at 00:01)</a>:</h4>
<p>In my mind, that's worse than not having the coercions available in the first place.</p>

<a name="130949027"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949027" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949027">Scott Morrison (Aug 06 2018 at 00:02)</a>:</h4>
<div class="codehilite"><pre><span></span>import tactic.interactive

universe u

class category (Obj : Type u) : Type (u+1) :=
(Hom : Obj → Obj → Type u)
(identity : Π X : Obj, Hom X X)

notation `𝟙` := category.identity     -- type as \b1
infixr ` ⟶ `:10  := category.Hom     -- type as \h

variable (C : Type u)
variable [𝒞 : category C]
variable (D : Type u)
variable [𝒟 : category D]
include 𝒞 𝒟

instance ProductCategory : category (C × D) :=
{ Hom            := λ X Y, ((X.1) ⟶ (Y.1)) × ((X.2) ⟶ (Y.2)),
  identity       := λ X, ⟨ 𝟙 (X.1), 𝟙 (X.2) ⟩ }

@[simp] lemma ProductCategory.identity (X : C) (Y : D) : 𝟙 (X, Y) = (𝟙 X, 𝟙 Y) := by refl

structure Functor  :=
(onObjects     : C → D)
(onMorphisms   : Π {X Y : C}, (X ⟶ Y) → ((onObjects X) ⟶ (onObjects Y)))
(identities    : ∀ (X : C), onMorphisms (𝟙 X) = 𝟙 (onObjects X))

attribute [simp] Functor.identities

infixr ` +&gt; `:70 := Functor.onObjects
infixr ` &amp;&gt; `:70 := Functor.onMorphisms
infixr ` ↝ `:70 := Functor -- type as \lea

variables {C} {D}

structure NaturalTransformation (F G : C ↝ D) : Type u :=
(components: Π X : C, (F +&gt; X) ⟶ (G +&gt; X))

infixr ` ⟹ `:50  := NaturalTransformation

instance {F G : C ↝ D} : has_coe_to_fun (F ⟹ G) :=
{ F   := λ α, Π X : C, (F +&gt; X) ⟶ (G +&gt; X),
  coe := λ α, α.components }

definition IdentityNaturalTransformation (F : C ↝ D) : F ⟹ F :=
{ components := λ X, 𝟙 (F +&gt; X) }

instance FunctorCategory : category (C ↝ D) :=
{ Hom            := λ F G, F ⟹ G,
  identity       := λ F, IdentityNaturalTransformation F }

@[simp] lemma FunctorCategory.identity.components (F : C ↝ D) (X : C) : (𝟙 F : F ⟹ F) X = 𝟙 (F +&gt; X) := by refl

lemma test (E : Type u) [ℰ : category E] (X : C) (Y : D) (F : C ↝ (D ↝ E)) : (F &amp;&gt; (prod.fst (𝟙 (X, Y)))) Y = 𝟙 ((F +&gt; X) +&gt; Y) :=
begin
  -- Really, `simp` should just work, finishing the goal.
  -- However this doesn&#39;t work:
  success_if_fail {simp},
  -- Notice that rewriting with that simp lemma succeeds:
  rw ProductCategory.identity,
  dsimp,
  -- Again, this `simp` fails:
  success_if_fail {simp},
  rw Functor.identities,
  -- Finally, at this stage `simp` manages to apply FunctorCategory.identity.components
  simp,
end

lemma test&#39; (E : Type u) [ℰ : category E] (X : C) (Y : D) (F : C ↝ (D ↝ E)) : (F &amp;&gt; (prod.fst (𝟙 (X, Y)))) Y = 𝟙 ((F +&gt; X) +&gt; Y) :=
begin
  -- If we unfold all the coercions first, at least `simp` gets started
  unfold_coes,
  simp,
  -- But doesn&#39;t finish, because with the coercions gone, FunctorCategory.identity.components doesn&#39;t apply anymore!
  admit
end

-- We can define an alternative version of that @[simp] lemma, with the coercion removed.
@[simp] lemma FunctorCategory.identity.components&#39; (F : C ↝ D) (X : C) : (𝟙 F : F ⟹ F).components X = 𝟙 (F +&gt; X) := by refl

lemma test&#39;&#39; (E : Type u) [ℰ : category E] (X : C) (Y : D) (F : C ↝ (D ↝ E)) : (F &amp;&gt; (prod.fst (𝟙 (X, Y)))) Y = 𝟙 ((F +&gt; X) +&gt; Y) :=
begin
  unfold_coes,
  simp,
  -- At this stage, we&#39;ve recovered reasonable automation, at the expense of having to
  -- state lemmas twice, once with the coercions (for the humans) and once without (for the simplifier).
end
</pre></div>

<a name="130949286"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949286" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949286">Mario Carneiro (Aug 06 2018 at 00:10)</a>:</h4>
<p>I've seen this issue before. Unfortunately <code>simp</code> does not rewrite inside coercions because they are apparently dependent functions (the nondependency is only visible after you unfold the definition)</p>

<a name="130949293"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949293" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949293">Scott Morrison (Aug 06 2018 at 00:11)</a>:</h4>
<p>Exactly!</p>

<a name="130949304"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949304" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949304">Scott Morrison (Aug 06 2018 at 00:11)</a>:</h4>
<p>This is related to why I was writing a <code>mk_congr_arg_using_dsimp</code> tactic <a href="#narrow/stream/113488-general/subject/congr_arg.20and.20superficially.20dependent.20functions/near/130827909" title="#narrow/stream/113488-general/subject/congr_arg.20and.20superficially.20dependent.20functions/near/130827909">above</a>. (The idea being that if you <code>dsimp</code> the function first, sometimes you see that it's not actually a dependent function.)</p>

<a name="130949367"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949367" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949367">Mario Carneiro (Aug 06 2018 at 00:13)</a>:</h4>
<p>I would look into fixing the congr lemma generation to use this</p>

<a name="130949411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949411" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949411">Scott Morrison (Aug 06 2018 at 00:14)</a>:</h4>
<p>Is that something which is fixable? Or is it frozen waiting for Lean 4?</p>

<a name="130949414"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949414" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949414">Mario Carneiro (Aug 06 2018 at 00:14)</a>:</h4>
<p>there is always the option of making <code>simp'</code></p>

<a name="130949419"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949419" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949419">Scott Morrison (Aug 06 2018 at 00:14)</a>:</h4>
<p>I see. But isn't much of <code>simp</code> written in C++?</p>

<a name="130949428"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949428" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949428">Scott Morrison (Aug 06 2018 at 00:15)</a>:</h4>
<p>Could we make a patched <code>simp'</code> that had similar performance?</p>

<a name="130949435"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949435" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949435">Mario Carneiro (Aug 06 2018 at 00:15)</a>:</h4>
<p>probably not, but if you use it only when necessary it should be palatable</p>

<a name="130949483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949483" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949483">Mario Carneiro (Aug 06 2018 at 00:16)</a>:</h4>
<p>I think you can use <code>ext_simplify_core</code> to hook into the traversal part without messing with the core of <code>simp</code></p>

<a name="130949485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949485" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949485">Scott Morrison (Aug 06 2018 at 00:16)</a>:</h4>
<p>eek... but my automation really relies on <code>simp</code> just doing its thing. As things are, I don't think there's any way to distinguish between the situations "simp failed to do anything" and "simp would have worked, but broke trying to construct a <code>congr_arg</code>"</p>

<a name="130949493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949493" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949493">Scott Morrison (Aug 06 2018 at 00:17)</a>:</h4>
<p>So it's not like I could just write a tactic that says "do <code>simp</code>, unless that breaks, in which case retry with <code>simp'</code>".</p>

<a name="130949495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949495" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949495">Scott Morrison (Aug 06 2018 at 00:17)</a>:</h4>
<p>Okay, I will investigate <code>ext_simplify_core</code> again. I once knew how that worked, but have forgotten.</p>

<a name="130949551"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949551" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949551">Mario Carneiro (Aug 06 2018 at 00:18)</a>:</h4>
<p>By the way, <code>dsimp</code> works under dependent functions</p>

<a name="130949557"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949557" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949557">Mario Carneiro (Aug 06 2018 at 00:19)</a>:</h4>
<p>so in particular it works in <code>test</code></p>

<a name="130949606"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949606" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949606">Sebastian Ullrich (Aug 06 2018 at 00:20)</a>:</h4>
<p>Without having thought about it too hard, could a custom congr lemma for non-dependent coercions work?</p>

<a name="130949607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949607" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949607">Mario Carneiro (Aug 06 2018 at 00:20)</a>:</h4>
<p>Does <code>simp</code> use <code>@[congr]</code> lemmas?</p>

<a name="130949628"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949628" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949628">Scott Morrison (Aug 06 2018 at 00:21)</a>:</h4>
<p>While I've got your attention on this, would you mind having a look at my <a href="#narrow/stream/113488-general/subject/congr_arg.20and.20superficially.20dependent.20functions/near/130827909" title="#narrow/stream/113488-general/subject/congr_arg.20and.20superficially.20dependent.20functions/near/130827909"><code>mk_congr_arg_using_dsimp</code></a> and see if there is a way to avoid polluting the goal with extra hypotheses as a side effect? I'm pretty unhappy about that hack.</p>

<a name="130949672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949672" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949672">Scott Morrison (Aug 06 2018 at 00:22)</a>:</h4>
<p>Yes; I know <code>dsimp</code> works fine, and indeed in my automation I always attempt <code>dsimp</code> before <code>simp</code>; sorry if this minimised example is too minimised, but I certainly have cases where <code>simp</code> is failing because of this effect.</p>

<a name="130949675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949675" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949675">Scott Morrison (Aug 06 2018 at 00:23)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span>, sorry, I don't know what you mean by "Does <code>simp</code> use <code>@[congr]</code> lemmas?".</p>

<a name="130949740"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949740" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949740">Mario Carneiro (Aug 06 2018 at 00:25)</a>:</h4>
<p>Simp works by using congruence lemmas generated by <code>mk_congr_lemma</code> for traversal. If it also accepts user lemmas marked <code>@{congr]</code>, then this would solve all our problems, because we could craft congr lemmas for looking through apparently dependent functions</p>

<a name="130949748"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949748" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949748">Scott Morrison (Aug 06 2018 at 00:25)</a>:</h4>
<p>Ah, I see!</p>

<a name="130949806"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949806" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949806">Mario Carneiro (Aug 06 2018 at 00:26)</a>:</h4>
<p>Also, looking at the coercion in your example, it is in fact a dependent function:</p>
<div class="codehilite"><pre><span></span>instance {F G : C ↝ D} : has_coe_to_fun (F ⟹ G) :=
{ F   := λ α, Π X : C, (F +&gt; X) ⟶ (G +&gt; X),
  coe := λ α, α.components }
</pre></div>


<p>so why is this legitimate in this case?</p>

<a name="130949818"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949818" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949818">Sebastian Ullrich (Aug 06 2018 at 00:27)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> I think so? <a href="https://github.com/leanprover/lean/blob/ceacfa7445953cbc8860ddabc55407430a9ca5c3/src/library/tactic/simplify.cpp#L739-L740" target="_blank" title="https://github.com/leanprover/lean/blob/ceacfa7445953cbc8860ddabc55407430a9ca5c3/src/library/tactic/simplify.cpp#L739-L740">https://github.com/leanprover/lean/blob/ceacfa7445953cbc8860ddabc55407430a9ca5c3/src/library/tactic/simplify.cpp#L739-L740</a> <code>simp</code> is the reason <code>[congr]</code> was introduced, afaik</p>

<a name="130949820"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949820" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949820">Scott Morrison (Aug 06 2018 at 00:27)</a>:</h4>
<p>The problem is that for particular values of <code>α</code>, that dependent function might <code>dsimp</code> to a non-dependent function.</p>

<a name="130949862"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130949862" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130949862">Mario Carneiro (Aug 06 2018 at 00:28)</a>:</h4>
<p>I thought <code>[congr]</code> was used for <code>calc</code></p>

<a name="130950017"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130950017" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130950017">Sebastian Ullrich (Aug 06 2018 at 00:33)</a>:</h4>
<p>I'm not aware of <code>calc</code> using anything other than <code>[trans]</code></p>

<a name="130950538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130950538" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130950538">Scott Morrison (Aug 06 2018 at 00:48)</a>:</h4>
<p>Are there any places I can look to find <code>@[congr]</code> used in conjunction with <code>simp</code>? I'm finding the C++ code pretty hard going.</p>

<a name="130950675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130950675" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130950675">Scott Morrison (Aug 06 2018 at 00:53)</a>:</h4>
<p>I guess I just found <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span>'s example at <a href="https://github.com/leanprover/lean/commit/6bd3fe24493c1748c8cfd778f63a3b832c6e6ba7#diff-db6c06d0649a66f8bbfc76e59b15cef2" target="_blank" title="https://github.com/leanprover/lean/commit/6bd3fe24493c1748c8cfd778f63a3b832c6e6ba7#diff-db6c06d0649a66f8bbfc76e59b15cef2">https://github.com/leanprover/lean/commit/6bd3fe24493c1748c8cfd778f63a3b832c6e6ba7#diff-db6c06d0649a66f8bbfc76e59b15cef2</a>, but I'm still not sure what's going on. :-)</p>

<a name="130951668"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130951668" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130951668">Scott Morrison (Aug 06 2018 at 01:27)</a>:</h4>
<p>Okay, I am for now failing to work out how to use @[congr] to help <code>simp</code> work better, or to write my own <code>simp'</code> that uses <code>ext_simplify_core</code>. I'm happy to continue investigating both options, and very happy if someone else does this. :-)</p>

<a name="130951718"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130951718" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130951718">Scott Morrison (Aug 06 2018 at 01:30)</a>:</h4>
<p>In the meantime, could I propose, <span class="user-mention" data-user-id="110294">@Johannes Hölzl</span> and <span class="user-mention" data-user-id="110049">@Mario Carneiro</span>, that in my category theory PR we defer the issue of adding coercions for functors acting on objects, and not consider that an obstacle for merging this PR?</p>
<p>If we can solve the issue here, of course I would love to add these coercions. In the meantime, it is not very expensive to write out the coercions, or have notations for them. I would really like to get this PR done, without breaking the possibility of good automation.</p>

<a name="130951764"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130951764" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130951764">Mario Carneiro (Aug 06 2018 at 01:30)</a>:</h4>
<p>Damn! I figured out what congr lemma to use, but lean doesn't accept it :/</p>
<div class="codehilite"><pre><span></span>@[congr] theorem NaturalTransformation.components_congr
  {F G : C ↝ D} {α β : F ⟹ G} (h : α = β) (X) : α.components X = β.components X :=
congr_fun (congr_arg coe_fn h) _
-- ok, generated automatically

@[congr] theorem NaturalTransformation.coe_congr
  {F G : C ↝ D} {α β : F ⟹ G} (h : α = β) (X) : α X = β X :=
congr_fun (congr_arg coe_fn h) _
-- invalid congruence lemma, &#39;NaturalTransformation.coe_congr&#39; the left-hand-side of the congruence
-- resulting type must be of the form (coe_fn x_1 ... x_n), where each x_i is a distinct variable or a sort
</pre></div>

<a name="130951827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130951827" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130951827">Mario Carneiro (Aug 06 2018 at 01:33)</a>:</h4>
<p>even worse, the error is garbage because it didn't parse the statement correctly</p>

<a name="130951879"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130951879" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130951879">Mario Carneiro (Aug 06 2018 at 01:34)</a>:</h4>
<p>notice that <code>congr</code> fails on this proof for completely the wrong reason:</p>
<div class="codehilite"><pre><span></span>theorem NaturalTransformation.coe_congr
  {F G : C ↝ D} {α β : F ⟹ G} (h : α = β) (X) : α X = β X :=
by do {
  tgt ← target,
  (lhs, rhs) ← match_eq tgt,
  guard lhs.is_app,
  clemma ← mk_specialized_congr_lemma lhs,
  trace clemma.type,
  apply_eq_congr_core tgt }
-- invalid apply tactic, failed to unify
--   ⇑α X = ⇑β X
-- with
--   ⇑?m_2 = ⇑?m_2
</pre></div>

<a name="130952264"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130952264" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130952264">Mario Carneiro (Aug 06 2018 at 01:48)</a>:</h4>
<p>For the purpose of this PR, how about adding the coercions, but add a simp lemma that unfolds the coercions and make simp lemmas that don't use the coercions. That way users can use the coercions but they won't interfere with <code>simp</code></p>

<a name="130952475"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130952475" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130952475">Mario Carneiro (Aug 06 2018 at 01:54)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I think the coe_fn typeclass needs to be fixed so that lean knows it's a pi type:</p>
<div class="codehilite"><pre><span></span>class has_coe_to_fun (a : Sort u) : Sort (max u (v+1) (w+1)) :=
(dom : a → Sort v) (F : ∀ a, dom a → Sort w) (coe : Π x y, F x y)
</pre></div>


<p>I tried this modification in my local copy and it seems to work fine, but of course this requires a modification to core. Also related is an issue brought up by Floris a long time ago - <code>has_coe_to_sort</code> doesn't actually require that the target type is a sort. It should read:</p>
<div class="codehilite"><pre><span></span>class has_coe_to_sort (a : Sort u) : Type (max u v) :=
(coe : a → Sort v)
</pre></div>


<p>Any chance of at least getting these into lean 4?</p>

<a name="130952782"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130952782" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130952782">Scott Morrison (Aug 06 2018 at 02:04)</a>:</h4>
<p>Okay, I will try out that approach. You're right that it will probably work. The only downside is that <code>simp</code> will produce 'ugly' output that looks different from what the humans are used to.</p>

<a name="130952921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130952921" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130952921">Mario Carneiro (Aug 06 2018 at 02:09)</a>:</h4>
<p>of course it already does this enough that we have techniques like "use <code>simp</code> terminally" and "use <code>simpa</code>" to mitigate this problem</p>

<a name="130953261"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130953261" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130953261">Scott Morrison (Aug 06 2018 at 02:18)</a>:</h4>
<p>Okay. So now I'm left with the question of how much _I_ should use the coercion in the library development.</p>

<a name="130953269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130953269" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130953269">Scott Morrison (Aug 06 2018 at 02:19)</a>:</h4>
<p>I'm inclined to barely use it! That is, provide the coercion, and a simp lemma that unfolds it, but otherwise ignore it.</p>

<a name="130953275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130953275" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130953275">Scott Morrison (Aug 06 2018 at 02:19)</a>:</h4>
<p>Is that okay? Or is that making life unpleasant for a user?</p>

<a name="130953318"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130953318" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130953318">Scott Morrison (Aug 06 2018 at 02:20)</a>:</h4>
<p>The alternative is to carefully go through, introducing use of the coercion everywhere except in simp lemmas, I guess.</p>

<a name="130953809"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130953809" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130953809">Mario Carneiro (Aug 06 2018 at 02:39)</a>:</h4>
<p>I think you should handle it like <code>sub</code>. Write lemmas using it, but also add simp lemma versions of the theorems when applicable</p>

<a name="130953855"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130953855" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130953855">Mario Carneiro (Aug 06 2018 at 02:40)</a>:</h4>
<p>these should be one liners or restatements</p>

<a name="130953858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130953858" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130953858">Mario Carneiro (Aug 06 2018 at 02:40)</a>:</h4>
<p>the user will want to use coercions whenever possible, so there should be lemmas supporting this</p>

<a name="130953864"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/simp%20inside%20expressions%20with%20coe_to_fun%20sometimes%20fails/near/130953864" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/21691simpinsideexpressionswithcoetofunsometimesfails.html#130953864">Mario Carneiro (Aug 06 2018 at 02:41)</a>:</h4>
<p>besides, I haven't lost hope of an automation solution to this, we're talking about a workaround here</p>


{% endraw %}
