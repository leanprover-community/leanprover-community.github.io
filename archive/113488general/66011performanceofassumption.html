---
layout: page
title: Lean Prover Zulip Chat Archive 
permalink: archive/113488general/66011performanceofassumption.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html">performance of `assumption`</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">
{% raw %}
<a name="136852607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136852607" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136852607">Sebastien Gouezel (Oct 31 2018 at 13:45)</a>:</h4>
<p>I just encountered a weird performance issue. In the middle of a rather long proof, I have just proved a fact that I want to use next. If I use <code>exact this</code>, this takes less than 3ms. But <code>assumption</code> takes 7 seconds... Of course, in this specific case this is not a problem, but first I was using a tactic that calls <code>assumption</code>, several times in the proof, and the whole proof then took more than 30s. Is there a way to understand what is going on?</p>
<p>My goal looks like <code>dist (⇑f x') (⇑g x') ≤ ε / 4</code>. The output of the profiler on <code>assumption</code> is</p>
<div class="codehilite"><pre><span></span><span class="n">elaboration</span><span class="o">:</span> <span class="n">tactic</span> <span class="n">compilation</span> <span class="n">took</span> <span class="mi">3</span><span class="bp">.</span><span class="mi">03</span><span class="n">ms</span>
<span class="n">essai</span><span class="bp">.</span><span class="n">lean</span><span class="o">:</span><span class="mi">520</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span> <span class="n">information</span> <span class="n">tactic</span> <span class="n">profile</span> <span class="n">data</span>

<span class="n">elaboration</span><span class="o">:</span> <span class="n">tactic</span> <span class="n">execution</span> <span class="n">took</span> <span class="mi">7</span><span class="bp">.</span><span class="mi">06</span><span class="n">s</span>
<span class="n">num</span><span class="bp">.</span> <span class="n">allocated</span> <span class="n">objects</span><span class="o">:</span>  <span class="mi">153</span>
<span class="n">num</span><span class="bp">.</span> <span class="n">allocated</span> <span class="n">closures</span><span class="o">:</span> <span class="mi">126</span>
 <span class="mi">7060</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="err">%</span>   <span class="n">tactic</span><span class="bp">.</span><span class="n">find_same_type</span><span class="bp">._</span><span class="n">main</span><span class="bp">._</span><span class="n">lambda_1</span>
 <span class="mi">7060</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="err">%</span>   <span class="n">tactic</span><span class="bp">.</span><span class="n">find_same_type</span>
 <span class="mi">7060</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="err">%</span>   <span class="n">tactic</span><span class="bp">.</span><span class="n">assumption</span><span class="bp">._</span><span class="n">lambda_1</span>
 <span class="mi">7060</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="err">%</span>   <span class="n">tactic</span><span class="bp">.</span><span class="n">unify</span>
 <span class="mi">7060</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="err">%</span>   <span class="n">tactic</span><span class="bp">.</span><span class="n">istep</span>
 <span class="mi">7060</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="err">%</span>   <span class="bp">_</span><span class="n">interaction</span><span class="bp">._</span><span class="n">lambda_2</span>
 <span class="mi">7060</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="err">%</span>   <span class="n">scope_trace</span>
 <span class="mi">7060</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="err">%</span>   <span class="n">interaction_monad_orelse</span>
 <span class="mi">7060</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="err">%</span>   <span class="n">tactic</span><span class="bp">.</span><span class="n">istep</span><span class="bp">._</span><span class="n">lambda_1</span>
 <span class="mi">7060</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="err">%</span>   <span class="n">tactic</span><span class="bp">.</span><span class="n">step</span>
</pre></div>


<p>For the record, here is the list of the local facts I have. The issue is probably coming from one of them...</p>
<div class="codehilite"><pre><span></span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_2</span> <span class="o">:</span> <span class="n">metric_space</span> <span class="n">β</span><span class="o">,</span>
<span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_4</span> <span class="o">:</span> <span class="n">metric_space</span> <span class="n">α</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_5</span> <span class="o">:</span> <span class="n">compact_space</span> <span class="n">α</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_6</span> <span class="o">:</span> <span class="n">compact_space</span> <span class="n">β</span><span class="o">,</span>
<span class="n">b</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">,</span>
<span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">,</span>
<span class="n">εpos</span> <span class="o">:</span> <span class="n">ε</span> <span class="bp">&gt;</span> <span class="mi">0</span><span class="o">,</span>
<span class="n">εpos8</span> <span class="o">:</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">8</span> <span class="bp">&gt;</span> <span class="mi">0</span><span class="o">,</span>
<span class="n">b_lim</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">),</span> <span class="n">ε</span> <span class="bp">&gt;</span> <span class="mi">0</span> <span class="bp">→</span> <span class="o">(</span><span class="bp">∃</span> <span class="o">(</span><span class="n">δ</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">δ</span> <span class="bp">&gt;</span> <span class="mi">0</span><span class="o">),</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">x</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">},</span> <span class="n">dist</span> <span class="n">x</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">dist</span> <span class="o">(</span><span class="n">b</span> <span class="n">x</span><span class="o">)</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">ε</span><span class="o">),</span>
<span class="n">δ</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">,</span>
<span class="n">δpos</span> <span class="o">:</span> <span class="n">δ</span> <span class="bp">&gt;</span> <span class="mi">0</span><span class="o">,</span>
<span class="n">hδ</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">x</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">},</span> <span class="n">dist</span> <span class="n">x</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">dist</span> <span class="o">(</span><span class="n">b</span> <span class="n">x</span><span class="o">)</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">8</span><span class="o">,</span>
<span class="n">tα</span> <span class="o">:</span> <span class="n">set</span> <span class="n">α</span><span class="o">,</span>
<span class="n">this_h_w</span> <span class="o">:</span> <span class="n">tα</span> <span class="err">⊆</span> <span class="n">univ</span><span class="o">,</span>
<span class="n">finite_tα</span> <span class="o">:</span> <span class="n">finite</span> <span class="n">tα</span><span class="o">,</span>
<span class="n">htα</span> <span class="o">:</span> <span class="n">univ</span> <span class="err">⊆</span> <span class="err">⋃</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">x</span> <span class="err">∈</span> <span class="n">tα</span><span class="o">),</span> <span class="n">ball</span> <span class="n">x</span> <span class="n">δ</span><span class="o">,</span>
<span class="n">tβ</span> <span class="o">:</span> <span class="n">set</span> <span class="n">β</span><span class="o">,</span>
<span class="n">this_h_w_1</span> <span class="o">:</span> <span class="n">tβ</span> <span class="err">⊆</span> <span class="n">univ</span><span class="o">,</span>
<span class="n">finite_tβ</span> <span class="o">:</span> <span class="n">finite</span> <span class="n">tβ</span><span class="o">,</span>
<span class="n">htβ</span> <span class="o">:</span> <span class="n">univ</span> <span class="err">⊆</span> <span class="err">⋃</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">y</span> <span class="err">∈</span> <span class="n">tβ</span><span class="o">),</span> <span class="n">ball</span> <span class="n">y</span> <span class="o">(</span><span class="n">ε</span> <span class="bp">/</span> <span class="mi">8</span><span class="o">),</span>
<span class="n">fin_univ</span> <span class="o">:</span> <span class="n">finite</span> <span class="n">univ</span><span class="o">,</span>
<span class="n">F</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">β</span><span class="o">,</span>
<span class="n">hF</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">F</span> <span class="n">y</span> <span class="err">∈</span> <span class="n">tβ</span> <span class="bp">∧</span> <span class="n">dist</span> <span class="n">y</span> <span class="o">(</span><span class="n">F</span> <span class="n">y</span><span class="o">)</span> <span class="bp">&lt;</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">8</span><span class="o">,</span>
<span class="n">approx</span> <span class="o">:</span> <span class="n">bounded_continuous_map</span> <span class="n">α</span> <span class="n">β</span> <span class="bp">→</span> <span class="err">↥</span><span class="n">tα</span> <span class="bp">→</span> <span class="err">↥</span><span class="n">tβ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">bounded_continuous_map</span> <span class="n">α</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="err">↥</span><span class="n">tα</span><span class="o">),</span> <span class="bp">⟨</span><span class="n">F</span> <span class="o">(</span><span class="err">⇑</span><span class="n">f</span> <span class="err">↑</span><span class="n">a</span><span class="o">),</span> <span class="bp">_⟩</span><span class="o">,</span>
<span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">bounded_continuous_map</span> <span class="n">α</span> <span class="n">β</span><span class="o">,</span>
<span class="n">f_eq_g</span> <span class="o">:</span> <span class="n">approx</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">approx</span> <span class="n">g</span><span class="o">,</span>
<span class="n">hg</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span> <span class="n">dist</span> <span class="o">(</span><span class="err">⇑</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="err">⇑</span><span class="n">g</span> <span class="n">y</span><span class="o">)</span> <span class="bp">≤</span> <span class="n">b</span> <span class="o">(</span><span class="n">dist</span> <span class="n">x</span> <span class="n">y</span><span class="o">),</span>
<span class="n">hf</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span> <span class="n">dist</span> <span class="o">(</span><span class="err">⇑</span><span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="err">⇑</span><span class="n">f</span> <span class="n">y</span><span class="o">)</span> <span class="bp">≤</span> <span class="n">b</span> <span class="o">(</span><span class="n">dist</span> <span class="n">x</span> <span class="n">y</span><span class="o">),</span>
<span class="n">x</span> <span class="n">x&#39;</span> <span class="o">:</span> <span class="n">α</span><span class="o">,</span>
<span class="n">x&#39;tα</span> <span class="o">:</span> <span class="n">x&#39;</span> <span class="err">∈</span> <span class="n">tα</span><span class="o">,</span>
<span class="n">hx&#39;</span> <span class="o">:</span> <span class="n">dist</span> <span class="n">x</span> <span class="n">x&#39;</span> <span class="bp">&lt;</span> <span class="n">δ</span><span class="o">,</span>
<span class="n">F_f_g</span> <span class="o">:</span> <span class="n">F</span> <span class="o">(</span><span class="err">⇑</span><span class="n">f</span> <span class="n">x&#39;</span><span class="o">)</span> <span class="bp">=</span> <span class="n">F</span> <span class="o">(</span><span class="err">⇑</span><span class="n">g</span> <span class="n">x&#39;</span><span class="o">),</span>
<span class="n">this</span> <span class="o">:</span> <span class="n">b</span> <span class="o">(</span><span class="n">dist</span> <span class="n">x</span> <span class="n">x&#39;</span><span class="o">)</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">8</span><span class="o">,</span>
<span class="n">this</span> <span class="o">:</span> <span class="n">b</span> <span class="o">(</span><span class="n">dist</span> <span class="n">x&#39;</span> <span class="n">x</span><span class="o">)</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">8</span><span class="o">,</span>
<span class="n">this</span> <span class="o">:</span> <span class="n">dist</span> <span class="o">(</span><span class="err">⇑</span><span class="n">f</span> <span class="n">x&#39;</span><span class="o">)</span> <span class="o">(</span><span class="err">⇑</span><span class="n">g</span> <span class="n">x&#39;</span><span class="o">)</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">4</span>
</pre></div>


<p>(one bonus point for you if you can guess which theorem I am proving from this output :)</p>

<a name="136854109"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136854109" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136854109">Rob Lewis (Oct 31 2018 at 14:08)</a>:</h4>
<p>You could try <code>clear</code>ing hypotheses one by one until <code>assumption</code> succeeds quickly. This would at least point out which hypothesis is causing the problem.</p>

<a name="136854136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136854136" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136854136">Rob Lewis (Oct 31 2018 at 14:08)</a>:</h4>
<p>Just to check -- if you remove the hypothesis that you want it to find, it takes 7 seconds and then fails, right?</p>

<a name="136855236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136855236" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136855236">Sebastien Gouezel (Oct 31 2018 at 14:27)</a>:</h4>
<p>Excellent idea. Here is the minimized outcome, which really looks like a bug somewhere.</p>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">foo</span> <span class="o">{</span><span class="n">x</span> <span class="n">y</span> <span class="n">z</span> <span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">8</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">y</span> <span class="bp">≤</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">8</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">z</span> <span class="bp">≤</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">4</span><span class="o">)</span> <span class="o">:</span> <span class="n">z</span> <span class="bp">≤</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">4</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">assumption</span>
</pre></div>


<p>takes 8 seconds. Remove <code>a</code> or <code>b</code>, it goes down by 4 seconds. Without any of them, 3ms...</p>

<a name="136855749"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136855749" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136855749">Sebastien Gouezel (Oct 31 2018 at 14:35)</a>:</h4>
<p>The problem is that 4 and 8 are big numbers for reals. You can trigger the same problem with rationals if you increase slightly the numbers:</p>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">foo</span> <span class="o">{</span><span class="n">x</span> <span class="n">z</span> <span class="n">ε</span> <span class="o">:</span> <span class="n">ℚ</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">2</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">z</span> <span class="bp">≤</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">100</span><span class="o">)</span> <span class="o">:</span> <span class="n">z</span> <span class="bp">≤</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">100</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">assumption</span>
</pre></div>


<p>triggers a timeout on my machine...</p>

<a name="136856013"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136856013" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136856013">Floris van Doorn (Oct 31 2018 at 14:39)</a>:</h4>
<p>If I make the definition of inequality irreducible in <code>real.basic</code>:</p>
<div class="codehilite"><pre><span></span>protected def le (x y : ℝ) : Prop := x &lt; y ∨ x = y
instance : has_le ℝ := ⟨real.le⟩
[...]
attribute [irreducible] real.le
</pre></div>


<p>then <code>assumption</code> is instant again. Apparently <code>assumption</code> had to do an awful lot of unfolding. <br>
Probably <code>lt</code> and <code>le</code> in <code>real</code> should be irreducible, after some basic facts have been proven about it.</p>

<a name="136856465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136856465" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136856465">Chris Hughes (Oct 31 2018 at 14:46)</a>:</h4>
<p>I think I remember Mario saying something about <code>assumption</code> trying to reduce all the hypotheses. I guess <code>le</code> and division are hard to reduce on reals. This example takes 11s to fail on my machine.</p>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">{</span><span class="n">x</span> <span class="n">z</span> <span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">:</span> <span class="o">(</span><span class="n">x</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">8</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">z</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">4</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">refl</span>
</pre></div>


<p>Maybe <code>le</code> and division should be irreducible.</p>

<a name="136856827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136856827" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136856827">Sebastien Gouezel (Oct 31 2018 at 14:50)</a>:</h4>
<p>Your example is not specific to reals:</p>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">{</span><span class="n">x</span> <span class="n">z</span> <span class="n">ε</span> <span class="o">:</span> <span class="n">ℚ</span><span class="o">}</span> <span class="o">:</span> <span class="o">(</span><span class="n">x</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span><span class="mi">2</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">z</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">100</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">refl</span>
</pre></div>


<p>also fails.</p>

<a name="136858710"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136858710" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136858710">Rob Lewis (Oct 31 2018 at 15:17)</a>:</h4>
<p>Making the orders on <code>rat</code> and <code>real</code> irreducible only breaks things at one spot in <code>analysis.complex</code>, and then all of these examples are instant. I think this is the correct setup. I'll PR this in a sec.</p>

<a name="136859630"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136859630" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136859630">Sebastien Gouezel (Oct 31 2018 at 15:32)</a>:</h4>
<p>Thanks a lot!</p>

<a name="136859919"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136859919" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136859919">Kevin Buzzard (Oct 31 2018 at 15:36)</a>:</h4>
<p><span class="user-mention" data-user-id="110064">@Kenny Lau</span> maybe it's about time you went through all of mathlib changing all <code>assumption</code>s to what they are supposed to say?</p>

<a name="136859956"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136859956" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136859956">Kenny Lau (Oct 31 2018 at 15:37)</a>:</h4>
<p>good idea</p>

<a name="136859973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136859973" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136859973">Kenny Lau (Oct 31 2018 at 15:37)</a>:</h4>
<p>but why am I the only one to make mathlib faster?</p>

<a name="136861850"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136861850" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136861850">Johan Commelin (Oct 31 2018 at 16:02)</a>:</h4>
<blockquote>
<p><span class="user-mention" data-user-id="110064">@Kenny Lau</span> maybe it's about time you went through all of mathlib changing all <code>assumption</code>s to what they are supposed to say?</p>
</blockquote>
<p>What is this? <span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> I really think we should improve the system. These things should be solved by making the computer smarter, instead of making our proofs more explicit. Automation is good.</p>

<a name="136861889"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136861889" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136861889">Kevin Buzzard (Oct 31 2018 at 16:03)</a>:</h4>
<p>But <code>assumption</code> will never be as fast as <code>exact H57</code> ;-)</p>

<a name="136861957"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136861957" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136861957">Johan Commelin (Oct 31 2018 at 16:04)</a>:</h4>
<p>It should be fast enough that we don't have to care. And caching should make sure that we also don't need to care about 10s proofs.</p>

<a name="136887687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136887687" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136887687">Mario Carneiro (Oct 31 2018 at 23:05)</a>:</h4>
<p>I think this is a major problem for Sebastien's proof style, which uses <code>&lt;x ≤ ε /2&gt;</code> in place of <code>h1</code> all over the place, and avoids labeling hypotheses. This is turned into <code>show x ≤ ε /2, by assumption</code> and hence can be very slow if there are "similar" hypotheses that require a lot of unfolding. This is one of the reasons I prefer naming hypotheses - it's shorter, and faster.</p>

<a name="136887835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136887835" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136887835">Mario Carneiro (Oct 31 2018 at 23:08)</a>:</h4>
<p>The short answer is "<code>assumption</code> considered harmful". This is why stuff like <code>rw [...], refl</code> sometimes succeeds where <code>rw [...]</code> fails, because <code>rw</code> tries to close with reflexivity but it doesn't try very hard for performance reasons. <code>assumption</code> has no such limiter.</p>

<a name="136903475"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136903475" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136903475">Johan Commelin (Nov 01 2018 at 06:06)</a>:</h4>
<p>I am really unhappy with "<code>assumption</code> considered harmful". Is this a theoretical problem? Or could someone with enough skills and free time write a faster version of <code>assumption</code>?</p>

<a name="136903672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136903672" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136903672">Andrew Ashworth (Nov 01 2018 at 06:13)</a>:</h4>
<p>you could potentially write a "dumber" version of assumption that doesn't do as much definitional unfolding, and that would indeed be faster, but also potentially less useful</p>

<a name="136907300"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136907300" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136907300">Kenny Lau (Nov 01 2018 at 08:14)</a>:</h4>
<p>... or we can dovetail it?</p>

<a name="136907364"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136907364" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136907364">Kevin Buzzard (Nov 01 2018 at 08:16)</a>:</h4>
<p>Isn't <code>assumption</code> being asked to do the impossible? The claim is that there's a term in the local context whose type is that of the goal. A human might go through each of the terms and say "no, no, maybe, no, no, no, ...ooh! Yes!"</p>

<a name="136907406"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136907406" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136907406">Kevin Buzzard (Nov 01 2018 at 08:16)</a>:</h4>
<p>but Lean gets interested in the "maybe" and what can you do?</p>

<a name="136907846"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136907846" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136907846">Kenny Lau (Nov 01 2018 at 08:28)</a>:</h4>
<p>we can dovetail it.</p>

<a name="136909675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136909675" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136909675">Johan Commelin (Nov 01 2018 at 09:14)</a>:</h4>
<p>I think this is a good idea. But I have no idea how to implement the dovetailing in Lean. (For those who don't know what dovetailing is: basically just look at all the assumptions in parallel, if one works, stop looking at the others.)</p>

<a name="136909782"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136909782" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136909782">Kevin Buzzard (Nov 01 2018 at 09:17)</a>:</h4>
<p>Ha ha, and then the one tactic which I understand the Lean code for will be gone :-)</p>

<a name="136910450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136910450" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136910450">Mario Carneiro (Nov 01 2018 at 09:31)</a>:</h4>
<p>Yes it's possible to do <code>assumption</code> in parallel, but it's overkill</p>

<a name="136910504"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136910504" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136910504">Mario Carneiro (Nov 01 2018 at 09:32)</a>:</h4>
<p><code>assumption</code> is one of the oldest and simplest tactics, and I think its simplicity is turning out to not be a good thing</p>

<a name="136910540"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136910540" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136910540">Mario Carneiro (Nov 01 2018 at 09:32)</a>:</h4>
<p>The easy solution is just not to use full defeq in <code>assumption</code></p>

<a name="136910568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136910568" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136910568">Mario Carneiro (Nov 01 2018 at 09:33)</a>:</h4>
<p>just set <code>md := semireducible</code> like all the newer tactics</p>

<a name="136920250"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136920250" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136920250">Reid Barton (Nov 01 2018 at 13:09)</a>:</h4>
<p>The slow examples above aren't really specific to <code>le</code>, by the way--this one is also slow</p>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">{</span><span class="n">x</span> <span class="n">y</span> <span class="n">z</span> <span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">:</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">y</span> <span class="bp">=</span> <span class="n">z</span> <span class="bp">+</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">8</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">y</span> <span class="bp">=</span> <span class="n">z</span> <span class="bp">+</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">4</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">refl</span>
</pre></div>

<a name="136920384"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136920384" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136920384">Reid Barton (Nov 01 2018 at 13:12)</a>:</h4>
<p>With bigger numbers, even addition is slow.</p>

<a name="136923924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136923924" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136923924">Floris van Doorn (Nov 01 2018 at 14:13)</a>:</h4>
<blockquote>
<p>just set <code>md := semireducible</code> like all the newer tactics</p>
</blockquote>
<p>Looking at the implementation, it seems like <code>assumption</code> is already calling <code>unify</code> with the (implicit) argument <code>md := semireducible</code>.</p>

<a name="136923989"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20%60assumption%60/near/136923989" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/66011performanceofassumption.html#136923989">Floris van Doorn (Nov 01 2018 at 14:14)</a>:</h4>
<p>I think a whole lot more should be irreducible, like <code>add</code>, <code>neg</code>, <code>mul</code> and <code>inv</code> for <code>cau_seq.completion</code>.</p>


{% endraw %}
