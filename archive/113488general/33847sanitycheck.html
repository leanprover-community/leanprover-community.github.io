---
layout: archive
title: Lean Prover Zulip Chat Archive
permalink: archive/113488general/33847sanitycheck.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html">sanity check</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">

{% raw %}
<a name="174342907"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174342907" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174342907">Patrick Massot (Aug 28 2019 at 08:30)</a>:</h4>
<p>I'm working a bit on the <a href="https://gist.github.com/fpvandoorn/04837ea7f20479bcac9a99539d2c17b3" target="_blank" title="https://gist.github.com/fpvandoorn/04837ea7f20479bcac9a99539d2c17b3">#sanity_check cleanup</a> of topology. <span class="user-mention" data-user-id="111080">@Floris van Doorn</span> Is there a reason why the command is not imported by default? Each file needs to add an import and then remember to remove it. It would also help tremendously if the command could print the type of the unused argument instead of only the number. But it's already very nice! What is weird is that removing useless type classes can have unexpected consequences on elaboration later one. I already had to add a couple of <code>apply_instance</code>.</p>

<a name="174343061"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174343061" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174343061">Patrick Massot (Aug 28 2019 at 08:34)</a>:</h4>
<p>Maybe we could have a hole command dumping the output of #sanity_check into the Lean file, that would save a copy-paste</p>

<a name="174343122"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174343122" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174343122">Patrick Massot (Aug 28 2019 at 08:35)</a>:</h4>
<p>Another potential improvement: when the command find an unused argument, check whether it's duplicated and report it.</p>

<a name="174367405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174367405" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174367405">Floris van Doorn (Aug 28 2019 at 14:26)</a>:</h4>
<p>Thanks for actually cleaning up the library!</p>

<a name="174367416"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174367416" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174367416">Floris van Doorn (Aug 28 2019 at 14:26)</a>:</h4>
<p>I indeed forgot to add an import to <code>tactic.basic</code>. I will do that. The other improvements also seem doable.</p>

<a name="174367540"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174367540" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174367540">Patrick Massot (Aug 28 2019 at 14:27)</a>:</h4>
<p>It would be very nice to enter a self-sustaining cycle of cleanup/sanity_check improvements</p>

<a name="174387055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174387055" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174387055">Floris van Doorn (Aug 28 2019 at 18:03)</a>:</h4>
<p>One disadvantage with a hole command is that you cannot write a hole when a command is expected, but only where an expression is expected. So you have to write something like <code>run_cmd {!!}</code> or <code>example : {!!}</code>. And then after the hole command replaces itself, you still have a broken <code>run_cmd</code> or <code>example</code>...</p>

<a name="174403421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174403421" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174403421">Floris van Doorn (Aug 28 2019 at 21:38)</a>:</h4>
<p>Added all feature requests (except the self-sustaining cycle of cleanup/sanity_check improvements) in <a href="https://github.com/leanprover-community/mathlib/issues/1369" target="_blank" title="https://github.com/leanprover-community/mathlib/issues/1369">#1369</a>.</p>

<a name="174405436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174405436" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174405436">Floris van Doorn (Aug 28 2019 at 22:07)</a>:</h4>
<p>The unused argument command will now return something like</p>
<div class="codehilite"><pre><span></span><span class="c1">-- tactic\core.lean</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">symmetry_hyp</span> <span class="c">/-</span><span class="cm"> argument 2: (md : opt_param transparency transparency.semireducible) -/</span>

<span class="c1">-- meta\rb_map.lean</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">native</span><span class="bp">.</span><span class="n">rb_map</span><span class="bp">.</span><span class="n">find_def</span> <span class="c">/-</span><span class="cm"> argument 4: [_inst_2 : decidable_rel has_lt.lt] -/</span>

<span class="c1">-- logic\basic.lean</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">imp_intro</span> <span class="c">/-</span><span class="cm"> argument 4: (h₂ : β) -/</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">not_iff</span> <span class="c">/-</span><span class="cm"> argument 3: [_inst_1 : decidable a] -/</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">ball_of_forall</span> <span class="c">/-</span><span class="cm"> argument 6: (_x : q x) -/</span>

<span class="c1">-- data\list\defs.lean</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">list</span><span class="bp">.</span><span class="n">func</span><span class="bp">.</span><span class="n">neg</span> <span class="c">/-</span><span class="cm"> argument 2: [_inst_1 : inhabited α] -/</span>

<span class="c1">-- category\basic.lean</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">map_seq</span> <span class="c">/-</span><span class="cm"> argument 6: [_inst_2 : is_lawful_applicative F] (duplicate) -/</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">seq_map_assoc</span> <span class="c">/-</span><span class="cm"> argument 6: [_inst_2 : is_lawful_applicative F] (duplicate) -/</span>
</pre></div>

<a name="174405553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174405553" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174405553">Floris van Doorn (Aug 28 2019 at 22:08)</a>:</h4>
<p>I also added a new check: whether a namespace occurs twice in the name:</p>
<div class="codehilite"><pre><span></span><span class="c1">-- tactic\core.lean</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">tactic</span><span class="bp">.</span><span class="n">has_to_tactic_format</span> <span class="c">/-</span><span class="cm"> The namespace tactic is duplicated in the name -/</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">tactic</span><span class="bp">.</span><span class="n">use</span> <span class="c">/-</span><span class="cm"> The namespace tactic is duplicated in the name -/</span>
</pre></div>

<a name="174405699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174405699" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174405699">Floris van Doorn (Aug 28 2019 at 22:10)</a>:</h4>
<p>Fun fact: for this improvement I had to <a href="https://github.com/leanprover-community/mathlib/pull/1369/files#diff-59de0008ca25270e4603707014bf0ba1R398" target="_blank" title="https://github.com/leanprover-community/mathlib/pull/1369/files#diff-59de0008ca25270e4603707014bf0ba1R398">remove an unused argument</a> from the instance <code>list.decidable_chain'</code> <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>

<a name="174447205"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174447205" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174447205">Patrick Massot (Aug 29 2019 at 12:10)</a>:</h4>
<p>Amazing! I promise I'll the topology fix as soon as this gets merged.</p>

<a name="174733345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174733345" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174733345">Johan Commelin (Sep 02 2019 at 17:38)</a>:</h4>
<p>I'm getting deterministic timeouts if I run <code>#sanity_check</code> at the bottom of <a href="https://github.com/leanprover-community/lean-perfectoid-spaces/blob/master/src/adic_space.lean" target="_blank" title="https://github.com/leanprover-community/lean-perfectoid-spaces/blob/master/src/adic_space.lean">https://github.com/leanprover-community/lean-perfectoid-spaces/blob/master/src/adic_space.lean</a></p>

<a name="174735054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174735054" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174735054">Floris van Doorn (Sep 02 2019 at 18:17)</a>:</h4>
<p>That's not good. I'll take a look.<br>
Which of the following get a timeout?</p>
<div class="codehilite"><pre><span></span>run_cmd print_decls_current_file prettify_unused_arguments &gt;&gt;= trace
run_cmd print_decls_current_file incorrect_def_lemma &gt;&gt;= trace
run_cmd print_decls_current_file dup_namespace &gt;&gt;= trace
</pre></div>

<a name="174735944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174735944" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174735944">Johan Commelin (Sep 02 2019 at 18:39)</a>:</h4>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> </p>
<div class="codehilite"><pre><span></span>type mismatch at application
  print_decls_current_file prettify_unused_arguments &gt;&gt;= trace
term
  trace
has type
  string → thunk ?m_1 → ?m_1 : Type ?
but is expected to have type
  format → tactic ?m_1 : Type
</pre></div>

<a name="174736027"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174736027" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174736027">Floris van Doorn (Sep 02 2019 at 18:41)</a>:</h4>
<p>oh yes, it should be <code>tactic.trace</code>.</p>

<a name="174736030"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174736030" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174736030">Johan Commelin (Sep 02 2019 at 18:41)</a>:</h4>
<p>1sec</p>

<a name="174736079"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174736079" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174736079">Floris van Doorn (Sep 02 2019 at 18:42)</a>:</h4>
<p>I'm also building the project myself rn.</p>

<a name="174736083"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174736083" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174736083">Johan Commelin (Sep 02 2019 at 18:42)</a>:</h4>
<p>None of them time out</p>

<a name="174736105"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174736105" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174736105">Floris van Doorn (Sep 02 2019 at 18:43)</a>:</h4>
<p>Ok, then for the moment you can use those, they give the same information. I'll make <code>#sanity_check</code> more efficient (currently I'm running through the whole environment 3 times)</p>

<a name="174736192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174736192" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174736192">Johan Commelin (Sep 02 2019 at 18:45)</a>:</h4>
<p>They don't print anything at all... which might mean our code is sane...</p>

<a name="174736377"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174736377" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174736377">Floris van Doorn (Sep 02 2019 at 18:49)</a>:</h4>
<p>Yes, I just ran them myself, and that file in sane :)</p>

<a name="174736473"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174736473" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174736473">Johan Commelin (Sep 02 2019 at 18:50)</a>:</h4>
<p>Can you reproduce the timeout?</p>

<a name="174736863"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174736863" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174736863">Floris van Doorn (Sep 02 2019 at 18:59)</a>:</h4>
<p>yes</p>

<a name="174739957"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174739957" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174739957">Floris van Doorn (Sep 02 2019 at 20:13)</a>:</h4>
<p>I managed to speed up <code>#sanity_check</code> by about 2 orders of magnitude. (it now takes 100-200ms in <code>adic_space</code>)</p>
<p>One of the slowdowns was surprising me: if you run <code>if p ∧ q then ... else ...</code> and <code>p</code> is false, then <code>q</code> will also be checked. You have to use <code>&amp;&amp;</code> instead:</p>
<div class="codehilite"><pre><span></span><span class="kn">open</span> <span class="n">tactic</span>
<span class="kn">set_option</span> <span class="n">profiler</span> <span class="n">true</span>
<span class="c1">-- very fast</span>
<span class="n">run_cmd</span> <span class="n">do</span> <span class="n">e</span> <span class="err">←</span> <span class="n">get_env</span><span class="o">,</span> <span class="n">e</span><span class="bp">.</span><span class="n">mfold</span> <span class="o">[]</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">d</span> <span class="n">ds</span><span class="o">,</span> <span class="n">return</span> <span class="err">$</span> <span class="k">if</span> <span class="n">ff</span> <span class="bp">&amp;&amp;</span> <span class="n">d</span><span class="bp">.</span><span class="n">is_auto_generated</span> <span class="n">e</span> <span class="k">then</span> <span class="n">d</span><span class="bp">::</span><span class="n">ds</span> <span class="k">else</span> <span class="n">ds</span>
<span class="c1">-- very slow (assuming you are importing enough files)</span>
<span class="n">run_cmd</span> <span class="n">do</span> <span class="n">e</span> <span class="err">←</span> <span class="n">get_env</span><span class="o">,</span> <span class="n">e</span><span class="bp">.</span><span class="n">mfold</span> <span class="o">[]</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">d</span> <span class="n">ds</span><span class="o">,</span> <span class="n">return</span> <span class="err">$</span> <span class="k">if</span> <span class="n">ff</span> <span class="bp">∧</span> <span class="n">d</span><span class="bp">.</span><span class="n">is_auto_generated</span> <span class="n">e</span> <span class="k">then</span> <span class="n">d</span><span class="bp">::</span><span class="n">ds</span> <span class="k">else</span> <span class="n">ds</span>
</pre></div>

<a name="174745688"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174745688" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174745688">Scott Morrison (Sep 02 2019 at 22:30)</a>:</h4>
<p>I wonder why. Is <code>and_decidable</code> doing something dumb?</p>

<a name="174745774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174745774" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174745774">Chris Hughes (Sep 02 2019 at 22:33)</a>:</h4>
<p>I checked, and it looks fine.</p>

<a name="174746101"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174746101" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174746101">Scott Morrison (Sep 02 2019 at 22:42)</a>:</h4>
<p>Yeah, I couldn't understand either.</p>

<a name="174747159"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174747159" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174747159">Reid Barton (Sep 02 2019 at 23:11)</a>:</h4>
<p>Are we talking about the kernel or the VM here?</p>

<a name="174747276"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174747276" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174747276">Scott Morrison (Sep 02 2019 at 23:14)</a>:</h4>
<p>Looks like the VM, I guess, since it's inside a <code>run_cmd</code>.</p>

<a name="174747287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174747287" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174747287">Scott Morrison (Sep 02 2019 at 23:15)</a>:</h4>
<p>I admit I have no idea what the VM does when it sees <code>if</code> or <code>∧</code>.</p>

<a name="174747570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174747570" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174747570">Mario Carneiro (Sep 02 2019 at 23:24)</a>:</h4>
<p>It's actually surprising that either one is short circuiting. It's probably because of inlining</p>

<a name="174747613"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174747613" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174747613">Mario Carneiro (Sep 02 2019 at 23:24)</a>:</h4>
<p>The standard semantics of lean would require that both sides of the and be evaluated before the function is called (i.e. eager evaluation)</p>

<a name="174747626"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174747626" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174747626">Mario Carneiro (Sep 02 2019 at 23:25)</a>:</h4>
<p>One way to force delayed evaluation is to use a thunk</p>

<a name="174750270"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174750270" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174750270">Floris van Doorn (Sep 03 2019 at 00:47)</a>:</h4>
<p>Yeah, in the proof of <code>and_decidable</code> it probably evaluates the <code>then</code> clause before it evaluates the <code>if-then-else</code>. We should indeed rewrite it using a thunk.</p>

<a name="174764440"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174764440" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174764440">Chris Hughes (Sep 03 2019 at 07:21)</a>:</h4>
<p>Why is this super fast in that case?</p>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">ack</span> <span class="o">:</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span>
<span class="bp">|</span> <span class="mi">0</span>     <span class="n">y</span>     <span class="o">:=</span> <span class="n">y</span><span class="bp">+</span><span class="mi">1</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">x</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="mi">0</span>     <span class="o">:=</span> <span class="n">ack</span> <span class="n">x</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">x</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="n">ack</span> <span class="n">x</span> <span class="o">(</span><span class="n">ack</span> <span class="o">(</span><span class="n">x</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="n">y</span><span class="o">)</span>

<span class="n">def</span> <span class="n">X</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="k">if</span> <span class="n">false</span> <span class="k">then</span> <span class="n">ack</span> <span class="mi">100</span> <span class="mi">100</span> <span class="k">else</span> <span class="mi">0</span>

<span class="bp">#</span><span class="kn">eval</span> <span class="n">X</span>
</pre></div>

<a name="174764694"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174764694" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174764694">Mario Carneiro (Sep 03 2019 at 07:26)</a>:</h4>
<p><code>if</code> uses thunks</p>

<a name="174764711"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174764711" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174764711">Chris Hughes (Sep 03 2019 at 07:27)</a>:</h4>
<p>So why is the <code>and.decidable</code> instance slow?</p>

<a name="174764727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174764727" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174764727">Mario Carneiro (Sep 03 2019 at 07:27)</a>:</h4>
<p>it uses thunks on the then and else branches, not on the condition (which must be evaluated first)</p>

<a name="174764798"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174764798" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174764798">Chris Hughes (Sep 03 2019 at 07:28)</a>:</h4>
<p>So that means it shouldn't be slow right?</p>

<a name="174764812"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174764812" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174764812">Mario Carneiro (Sep 03 2019 at 07:29)</a>:</h4>
<p>The difference is that <code>band</code> is <code>@[inline]</code> and <code>and.decidable</code> isn't</p>

<a name="174764830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174764830" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174764830">Mario Carneiro (Sep 03 2019 at 07:29)</a>:</h4>
<p>I recommend looking at the generated bytecode</p>

<a name="174765151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174765151" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174765151">Mario Carneiro (Sep 03 2019 at 07:35)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">foo</span> <span class="o">:=</span> <span class="n">ff</span>
<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">compiler</span><span class="bp">.</span><span class="n">optimize_bytecode</span> <span class="n">true</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="k">if</span> <span class="n">false</span> <span class="bp">&amp;&amp;</span> <span class="n">foo</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
<span class="c1">-- [compiler.optimize_bytecode]  _main 0</span>
<span class="c1">-- 0: scnstr #1</span>
<span class="c1">-- 1: ginvoke decidable.false</span>
<span class="c1">-- 2: scnstr #0</span>
<span class="c1">-- 3: ginvoke decidable.to_bool</span>
<span class="c1">-- 4: cases2 7</span>
<span class="c1">-- 5: scnstr #0</span>
<span class="c1">-- 6: goto 12</span>
<span class="c1">-- 7: ginvoke foo</span>
<span class="c1">-- 8: cases2 11</span>
<span class="c1">-- 9: scnstr #0</span>
<span class="c1">-- 10: goto 12</span>
<span class="c1">-- 11: scnstr #1</span>
<span class="c1">-- 12: ginvoke bool.decidable_eq._main</span>
<span class="c1">-- 13: cases2 16</span>
<span class="c1">-- 14: scnstr #0</span>
<span class="c1">-- 15: goto 17</span>
<span class="c1">-- 16: scnstr #1</span>
<span class="c1">-- 17: cfun nat.repr</span>
<span class="c1">-- 18: ret</span>

<span class="bp">#</span><span class="kn">eval</span> <span class="k">if</span> <span class="n">false</span> <span class="bp">∧</span> <span class="n">foo</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
<span class="c1">-- [compiler.optimize_bytecode]  _main 0</span>
<span class="c1">-- 0: scnstr #1</span>
<span class="c1">-- 1: ginvoke foo</span>
<span class="c1">-- 2: ginvoke bool.decidable_eq._main</span>
<span class="c1">-- 3: ginvoke decidable.false</span>
<span class="c1">-- 4: scnstr #0</span>
<span class="c1">-- 5: scnstr #0</span>
<span class="c1">-- 6: ginvoke and.decidable</span>
<span class="c1">-- 7: cases2 10</span>
<span class="c1">-- 8: scnstr #0</span>
<span class="c1">-- 9: goto 11</span>
<span class="c1">-- 10: scnstr #1</span>
<span class="c1">-- 11: cfun nat.repr</span>
<span class="c1">-- 12: ret</span>
</pre></div>


<p>Notice in the second one that there is an explicit call to <code>and.decidable</code> at line 6, which needs <code>foo</code> to be called first (line 1). In the second one there is no call to <code>band</code> at all; instead it's all been inlined to an if-then (the <code>cases2</code> at line 4) and the call to <code>foo</code> only happens in the second branch (line 7)</p>

<a name="174765218"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174765218" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174765218">Mario Carneiro (Sep 03 2019 at 07:36)</a>:</h4>
<p>If you use <code>ff</code> instead of <code>false</code> in these examples, the call to <code>foo</code> disappears entirely, because lean optimizes <code>ff &amp;&amp; foo</code> to <code>ff</code> directly after unfolding the definition of <code>&amp;&amp;</code></p>

<a name="174765297"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174765297" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174765297">Mario Carneiro (Sep 03 2019 at 07:38)</a>:</h4>
<p>If you use <code>attribute [inline] decidable.false and.decidable</code> then you get the expected code</p>

<a name="174765304"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174765304" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174765304">Mario Carneiro (Sep 03 2019 at 07:38)</a>:</h4>
<p>arguably that should have been set</p>

<a name="174766438"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174766438" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174766438">Scott Morrison (Sep 03 2019 at 07:59)</a>:</h4>
<p>We can provide a higher priority instance that inclines, can't we?</p>

<a name="174804525"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174804525" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174804525">Floris van Doorn (Sep 03 2019 at 16:24)</a>:</h4>
<p>I think we can just add the line <code>attribute [inline] and.decidable or.decidable decidable.false</code> to some file that everything imports. Shall I add it to <code>logic/basic</code>? Are there other declarations that need the <code>[inline]</code> attribute?</p>

<a name="174812215"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174812215" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174812215">Mario Carneiro (Sep 03 2019 at 17:45)</a>:</h4>
<p><code>logic.basic</code> looks like a good place for it. The initial part contains a few other "omissions" from the core logic library</p>

<a name="174812478"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174812478" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174812478">Mario Carneiro (Sep 03 2019 at 17:48)</a>:</h4>
<p>Inline annotations are a bit of a black art. Probably implies.decidable is also good, definitely not.decidable, not so sure about iff and xor but I'm leaning toward inlining them</p>

<a name="174812680"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174812680" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174812680">Mario Carneiro (Sep 03 2019 at 17:50)</a>:</h4>
<p>also <code>decidable.true</code> of course</p>

<a name="174815534"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174815534" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174815534">Floris van Doorn (Sep 03 2019 at 18:22)</a>:</h4>
<p>Added them to <a href="https://github.com/leanprover-community/mathlib/issues/1393" target="_blank" title="https://github.com/leanprover-community/mathlib/issues/1393">#1393</a>.</p>

<a name="174817482"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174817482" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174817482">Floris van Doorn (Sep 03 2019 at 18:43)</a>:</h4>
<p>Do you think <code>decidable.to_bool</code>should be added?</p>

<a name="174820201"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174820201" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174820201">Mario Carneiro (Sep 03 2019 at 19:13)</a>:</h4>
<p>It should be the identity function, although I'm not sure if lean knows to render it as such</p>

<a name="174893034"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/174893034" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#174893034">Floris van Doorn (Sep 04 2019 at 15:28)</a>:</h4>
<p>I don't think so. I think it will then run both <code>decidable.to_bool</code> and <code>bool.decidable_eq</code>.</p>

<a name="175221568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/175221568" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#175221568">Sebastien Gouezel (Sep 09 2019 at 07:56)</a>:</h4>
<p>I have started using sanity_check to clean up some files, and I found it super-useful. Just for the record, two small additions that I would find worthy:</p>
<ul>
<li>define an attribute <code>sanity_check_skip</code> for statements that should be skipped by <code>sanity_check</code>. For instance, <code>theorem imp_intro {α β} (h : α) (h₂ : β) : α := h</code> in <code>logic/basic.lean</code> has an unused argument by design. Or in fiber bundles the function <code>topological_fiber_bundle.fiber</code> has a lot of unused arguments, but this is to get a new name for a type, in order for typeclass inference to work correctly. If we don't add such an attribute, they will show up forever in the output of <code>sanity_check</code>.</li>
<li>would it be possible to show as a mistake the use of <code>&gt;</code> or <code>&gt;=</code> in the assumptions or conclusions of theorems? Rewrites would be really easier if <code>&lt;</code> and <code>&lt;=</code> were used consistently all over mathlib, and I think this is a move we will have to do some day.</li>
</ul>

<a name="175307530"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/175307530" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#175307530">Floris van Doorn (Sep 10 2019 at 05:20)</a>:</h4>
<ul>
<li>I was indeed thinking that some declarations would show up forever in the output of <code>sanity_check</code>, but it's actually a good idea to whitelist declarations that we know are fine.</li>
<li>Yes, it is easy to check whether <code>&gt;</code>/<code>&gt;=</code> (i.e. <code>ge</code>/<code>gt</code>) are used in lemma statements. Are there other declarations we want to always avoid in lemma statements?</li>
</ul>

<a name="175307666"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/175307666" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#175307666">Scott Morrison (Sep 10 2019 at 05:24)</a>:</h4>
<p>So is the attribute suppressing output of <code>#sanity_check</code> going to be <code>@[sane]</code> or <code>@[insane]</code>? :-)</p>

<a name="175312240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/sanity%20check/near/175312240" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/33847sanitycheck.html#175312240">Mario Carneiro (Sep 10 2019 at 07:12)</a>:</h4>
<p>By analogy to Rust's <code>unsafe</code> block, which brackets code that is safe but for which the programmer, not the compiler, ensures safety, it seems that <code>insane</code> is the correct polarity</p>


{% endraw %}

{% include archive_update.html %}